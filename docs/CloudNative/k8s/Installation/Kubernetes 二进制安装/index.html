<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-CloudNative/k8s/Installation/Kubernetes 二进制安装">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Kubernetes 二进制安装 | AGou&#x27;s Docsv4</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs.agou-ops.cn/docs/CloudNative/k8s/Installation/Kubernetes 二进制安装"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Kubernetes 二进制安装 | AGou&#x27;s Docsv4"><meta data-rh="true" name="description" content="[[toc]]"><meta data-rh="true" property="og:description" content="[[toc]]"><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://docs.agou-ops.cn/docs/CloudNative/k8s/Installation/Kubernetes 二进制安装"><link data-rh="true" rel="alternate" href="https://docs.agou-ops.cn/docs/CloudNative/k8s/Installation/Kubernetes 二进制安装" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.agou-ops.cn/docs/CloudNative/k8s/Installation/Kubernetes 二进制安装" hreflang="x-default"><link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-KQED41RW95","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script><link rel="stylesheet" href="/assets/css/styles.6908ad1e.css">
<link rel="preload" href="/assets/js/runtime~main.2d282a18.js" as="script">
<link rel="preload" href="/assets/js/main.509f804f.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Welcome to AGou&#x27;s Docs!" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="Welcome to AGou&#x27;s Docs!" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">AGou&#x27;s Docsv4</b></a><a href="https://agou-ops.cn" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">✨ 我的博客<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"> 📖 目录</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs">🌲 目录树</a></li><li><hr style="margin: 0.3rem 0;"></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/category/云原生相关">☁️ 云原生相关</a></li><li><a class="dropdown__link" href="/docs/category/linux基础">😊 Linux基础</a></li><li><a class="dropdown__link" href="/docs/category/编程语言">♨️ 编程语言</a></li><li><a class="dropdown__link" href="/docs/category/脚本相关">🕹️ 脚本相关</a></li><li><a class="dropdown__link" href="/docs/category/面试相关">👨‍⚖️ 面试相关</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">版本</a><ul class="dropdown__menu"><li><a href="https://agou-ops.cn/myDocs" target="_blank" rel="noopener noreferrer" class="dropdown__link">Ver1.0<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://agou-ops.cn/myDocsv2" target="_blank" rel="noopener noreferrer" class="dropdown__link">Ver2.0<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://agou-ops.cn/myDocsv3" target="_blank" rel="noopener noreferrer" class="dropdown__link">Ver3.0<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><a href="https://github.com/AGou-ops" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub 仓库"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/"><img src="/img/logo.png" alt="Welcome to AGou&#x27;s Docs!" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="Welcome to AGou&#x27;s Docs!" class="themedImage_ToTc themedImage--dark_i4oU"><b>AGou&#x27;s Docsv4</b></a><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/云原生相关">云原生相关</a><button aria-label="Toggle the collapsible sidebar category &#x27;云原生相关&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/cicd">CICD</a><button aria-label="Toggle the collapsible sidebar category &#x27;CICD&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/cloudcomptering">CloudComptering</a><button aria-label="Toggle the collapsible sidebar category &#x27;CloudComptering&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/docker">Docker</a><button aria-label="Toggle the collapsible sidebar category &#x27;Docker&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/elfk">ELFK</a><button aria-label="Toggle the collapsible sidebar category &#x27;ELFK&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/prometheus">Prometheus</a><button aria-label="Toggle the collapsible sidebar category &#x27;Prometheus&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/category/k8s">k8s</a><button aria-label="Toggle the collapsible sidebar category &#x27;k8s&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/helm">Helm</a><button aria-label="Toggle the collapsible sidebar category &#x27;Helm&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/category/installation">Installation</a><button aria-label="Toggle the collapsible sidebar category &#x27;Installation&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CloudNative/k8s/Installation/Kubeadm 快速部署手册">Kubeadm 快速部署手册</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/CloudNative/k8s/Installation/Kubernetes 二进制安装">Kubernetes 二进制安装</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CloudNative/k8s/Installation/k8s Debian12二进制安装">k8s Debian12二进制安装</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CloudNative/k8s/Installation/使用 Kubeadm 部署（单master）">使用 Kubeadm 部署(单master)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CloudNative/k8s/Installation/使用 Kubespray 部署">使用 Kubespray 部署</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CloudNative/k8s/Installation/使用国内源及相关小工具">使用国内源及相关小工具</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CloudNative/k8s/Installation/常用组件安装">常用组件安装</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/quicklystart">Quicklystart</a><button aria-label="Toggle the collapsible sidebar category &#x27;Quicklystart&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/实战案例">实战案例</a><button aria-label="Toggle the collapsible sidebar category &#x27;实战案例&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CloudNative/k8s/Kubeadm 快速部署k8s集群">Kubeadm 快速部署k8s集群</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CloudNative/k8s/Kubernetes REST API">Kubernetes REST API</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CloudNative/k8s/Kubernetes Yaml quicklystart">Kubernetes YAML file quicklystart</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CloudNative/k8s/Kubernetes with Jenkins CICD">基于kubernetes平台的CICD持续集成</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CloudNative/k8s/Minikube Basic">Minikube Basic</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CloudNative/k8s/Prometheus-Grafana全方位监控Kubernetes集群">Prometheus+Grafana全方位监控Kubernetes集群</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CloudNative/k8s/Remote access k8s">kubectl远程连接k8s</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CloudNative/k8s/k3d">k3d</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CloudNative/k8s/k8s command">Kubernetes CLI command -- kubectl</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CloudNative/k8s/k8s 图解大全">k8s图解大全</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CloudNative/k8s/k8s 网络相关">k8s 网络相关</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CloudNative/k8s/k8s概念及原理相关">k8s 概念及原理相关</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CloudNative/k8s/kompose Basic">Kompose Basic</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CloudNative/k8s/kubenetes远程调试工具">kubenetes远程调试工具</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CloudNative/Consul 入门">Consul 入门</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CloudNative/Dubbo Basic">Dubbo Basic</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CloudNative/Grafana Loki Basic">Grafana Loki</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CloudNative/Istio Basic">Istio Basic</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CloudNative/">CloudNative.</a></li></ul></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/云原生相关"><span itemprop="name">云原生相关</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/k8s"><span itemprop="name">k8s</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/installation"><span itemprop="name">Installation</span></a><meta itemprop="position" content="3"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Kubernetes 二进制安装</span><meta itemprop="position" content="4"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Kubernetes 二进制安装</h1></header><p>[<!-- -->[toc]<!-- -->]</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1环境准备">1.环境准备<a href="#1环境准备" class="hash-link" aria-label="Direct link to 1.环境准备" title="Direct link to 1.环境准备">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="11kubernetes高可用集群部署方式">1.1.Kubernetes高可用集群部署方式<a href="#11kubernetes高可用集群部署方式" class="hash-link" aria-label="Direct link to 1.1.Kubernetes高可用集群部署方式" title="Direct link to 1.1.Kubernetes高可用集群部署方式">​</a></h3><blockquote><p>目前生产环境部署Kubernetes建主要有两种方式：</p><p>kubeadm：提供kubeadm init和kubeadm join，用于快速部署Kubernetes集群，kubeadm安装的k8s集群，所有的k8s组件都是以pod形式运行。</p><p>二进制包：从github上下载发行版的二进制包，手动部署每个组件，组成kubernetes集群。</p><p>Kubeadm降低部署成本，从而屏蔽了很多细节，遇到问题很难排查，如果想更容易可控，推荐使用二进制包部署Kubernetes集群，虽然手动部署麻烦点，期间可以学习很多工作原理，也利于后期维护。</p></blockquote><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="12kubernetes集群弃用docker容器">1.2.Kubernetes集群弃用docker容器<a href="#12kubernetes集群弃用docker容器" class="hash-link" aria-label="Direct link to 1.2.Kubernetes集群弃用docker容器" title="Direct link to 1.2.Kubernetes集群弃用docker容器">​</a></h3><blockquote><p>在k8s平台中，为了解决与容器运行时，比如docker的集成问题，在早期社区推出CRI接口，以支持更多的容器，当我们使用Docker作为容器运行时，首先kubelet调用dockershim的CRI容器接口连接docker进程，最后由docker启动容器。</p><p>在k8s1.23版本中，k8s计划弃用kubelet中的dockershim接口，dockershim接口一旦弃用，kubelet去调用CRL时就没有可以与docker建立连接的一个接口，从而导致k8s弃用docker容器。</p></blockquote><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="13kubernetes集群所需的证书">1.3.Kubernetes集群所需的证书<a href="#13kubernetes集群所需的证书" class="hash-link" aria-label="Direct link to 1.3.Kubernetes集群所需的证书" title="Direct link to 1.3.Kubernetes集群所需的证书">​</a></h3><blockquote><p>k8s所有组件均采用https加密通信，这些组件一般由两套根证书生成：一个用于k8s apiserver一个用于etcd数据库。</p><p>按照角色来分，证书分为管理节点和工作节点。</p><ul><li>管理节点：指controller-manager和scheduler连接apiserver所需的客户端证书。</li><li>工作节点：指kubelet和kube-proxy连接apiserver所需要的客户端证书，而一般都会启用Bootstrap TLS机制，所以kubelet的证书初次启动会向apiserver申请颁发证书，由controller-manager组件自动颁发。</li><li>图中红线是k8s各个组件通过携带k8s自建证书颁发机构生成的客户端证书访问apiserver，图中蓝线是k8sapiserver组件通过etcd颁发的客户端证书与etcd建立连接。</li></ul><p><img loading="lazy" src="https://cdn.agou-ops.cn/others/3b600f8680a443168cb556a183c19b3f.png" alt="请添加图片描述" class="img_ev3q"></p></blockquote><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="14环境准备">1.4.环境准备<a href="#14环境准备" class="hash-link" aria-label="Direct link to 1.4.环境准备" title="Direct link to 1.4.环境准备">​</a></h3><table><thead><tr><th>角色</th><th>IP</th><th>组件</th></tr></thead><tbody><tr><td>binary-k8s-master1</td><td>192.168.20.10</td><td>kube-apiserver、kube-controller-manage、kube-scheduler、kubelet、kube-proxy、docker、etcd、nginx、keepalived</td></tr><tr><td>binary-k8s-master2</td><td>192.168.20.11</td><td>kube-apiserver、kube-controller-manage、kube-scheduler、kubelet、kube-proxy、docker、nginx、keepalived、etcd（扩容节点）</td></tr><tr><td>binary-k8s-node1</td><td>192.168.20.12</td><td>kubelet、kube-proxy、docker、etcd</td></tr><tr><td>binary-k8s-node2</td><td>192.168.20.13</td><td>kubelet、kube-proxy、docker、etcd</td></tr><tr><td>负载均衡器IP</td><td>192.168.20.9</td><td>（作用于kube-apiserver的地址）</td></tr></tbody></table><p>首先部署一套单master节点的kubernetes集群，然后在增加一台master节点，形成高可用集群。</p><p>单master节点的kubernetes集群服务器规划。</p><table><thead><tr><th>角色</th><th>IP</th><th>组件</th></tr></thead><tbody><tr><td>binary-k8s-master1</td><td>192.168.20.10</td><td>kube-apiserver、kube-controller-manage、kube-schedule、etcd</td></tr><tr><td>binary-k8s-node1</td><td>192.168.20.12</td><td>kubelet、kube-proxy、docker、etcd</td></tr><tr><td>binary-k8s-node2</td><td>192.168.20.13</td><td>kubelet、kube-proxy、docker、etcd</td></tr></tbody></table><p><img loading="lazy" src="https://cdn.agou-ops.cn/others/ea0354a4d3cc4b6397ee9397f42e35dc.png" alt="在这里插入图片描述" class="img_ev3q"></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="15安装cfssl证书生成工具">1.5.安装cfssl证书生成工具<a href="#15安装cfssl证书生成工具" class="hash-link" aria-label="Direct link to 1.5.安装cfssl证书生成工具" title="Direct link to 1.5.安装cfssl证书生成工具">​</a></h3><p>cfssl是一个开源的证书管理工具，使用json文件生成证书，相比openssl更方便使用。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">chmod</span><span class="token plain"> +x cfssl_linux-amd64 cfssljson_linux-amd64 cfssl-certinfo_linux-amd64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">mv</span><span class="token plain"> cfssl_linux-amd64 /usr/local/bin/cfssl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">mv</span><span class="token plain"> cfssljson_linux-amd64 /usr/local/bin/cfssljson</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">mv</span><span class="token plain"> cfssl-certinfo_linux-amd64 /usr/bin/cfssl-certinfo</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2操作系统初始化配置">2.操作系统初始化配置<a href="#2操作系统初始化配置" class="hash-link" aria-label="Direct link to 2.操作系统初始化配置" title="Direct link to 2.操作系统初始化配置">​</a></h2><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.关闭防火墙</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl stop firewalld </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl disable firewalld</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.关闭selinux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> -i </span><span class="token string" style="color:#e3116c">&#x27;s/enforcing/disabled/&#x27;</span><span class="token plain"> /etc/selinux/config </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">setenforce </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3</span><span class="token plain">.关闭交换分区</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">swapoff -a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> -ri </span><span class="token string" style="color:#e3116c">&#x27;s/.*swap.*/#&amp;/&#x27;</span><span class="token plain"> /etc/fstab</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">4</span><span class="token plain">.配置hosts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token plain"> /etc/hosts </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF </span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">192.168.20.10 binary-k8s-master1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">192.168.20.12 binary-k8s-node1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">192.168.20.13 binary-k8s-node2</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">5</span><span class="token plain">.优化内核参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> /etc/sysctl.d/k8s.conf </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF </span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">net.bridge.bridge-nf-call-ip6tables = 1 </span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">net.bridge.bridge-nf-call-iptables = 1 </span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sysctl --system</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3部署etcd集群">3.部署Etcd集群<a href="#3部署etcd集群" class="hash-link" aria-label="Direct link to 3.部署Etcd集群" title="Direct link to 3.部署Etcd集群">​</a></h2><p>etcd是一个分布式键值存储系统，kubernetes使用etcd进行数据存储，为解决etcd单点故障，采用集群方式部署，3台组组建集群，可以坏1台，如果有5台可以坏2台。</p><table><thead><tr><th>节点名称</th><th>IP</th></tr></thead><tbody><tr><td>etcd-1</td><td>192.168.20.10</td></tr><tr><td>etcd-2</td><td>192.168.20.12</td></tr><tr><td>etcd-3</td><td>192.168.20.13</td></tr></tbody></table><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="31使用cfssl证书工具生成etcd证书">3.1.使用cfssl证书工具生成etcd证书<a href="#31使用cfssl证书工具生成etcd证书" class="hash-link" aria-label="Direct link to 3.1.使用cfssl证书工具生成etcd证书" title="Direct link to 3.1.使用cfssl证书工具生成etcd证书">​</a></h3><p><strong>1.生成CA自签颁发机构证书</strong></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~/TLS/etcd</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> ca-config.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;signing&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;default&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;expiry&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;87600h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;profiles&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;www&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token string" style="color:#e3116c">&quot;expiry&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;87600h&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token string" style="color:#e3116c">&quot;usages&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;signing&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;key encipherment&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;server auth&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;client auth&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~/TLS/etcd</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> ca-csr.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;CN&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;etcd CA&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;key&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;algo&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;rsa&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;size&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2048</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;names&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;C&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;CN&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;L&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Beijing&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;ST&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Beijing&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~/TLS/etcd</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># cfssl gencert -initca ca-csr.json </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> cfssljson -bare ca -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/08/27 </span><span class="token number" style="color:#36acaa">17</span><span class="token plain">:16:49 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> generating a new CA key and certificate from CSR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/08/27 </span><span class="token number" style="color:#36acaa">17</span><span class="token plain">:16:49 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> generate received request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/08/27 </span><span class="token number" style="color:#36acaa">17</span><span class="token plain">:16:49 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> received CSR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/08/27 </span><span class="token number" style="color:#36acaa">17</span><span class="token plain">:16:49 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> generating key: rsa-2048</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/08/27 </span><span class="token number" style="color:#36acaa">17</span><span class="token plain">:16:49 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> encoded CSR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/08/27 </span><span class="token number" style="color:#36acaa">17</span><span class="token plain">:16:49 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> signed certificate with serial number </span><span class="token number" style="color:#36acaa">595276170535764345591605360849177409156623041535</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>2.使用自签CA签发Etcd HTTPS证书</strong></p><p>申请证书的json文件中有一个hosts字段，这个字段的值就是etcd集群的IP地址，可以多写几个IP，作为预留IP，方便扩容etcd集群。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.创建证书申请文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~/TLS/etcd</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> server-csr.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;CN&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;etcd&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;hosts&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;192.168.20.10&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;192.168.20.11&quot;</span><span class="token plain">,            </span><span class="token comment" style="color:#999988;font-style:italic">#预留ip</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;192.168.20.12&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;192.168.20.13&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;key&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;algo&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;rsa&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;size&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2048</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;names&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;C&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;CN&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;L&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;BeiJing&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;ST&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;BeiJing&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.生成证书</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~/TLS/etcd</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># cfssl gencert -ca</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ca.pem -ca-key</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ca-key.pem -config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ca-config.json -profile</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">www server-csr.json </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> cfssljson -bare server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/08/27 </span><span class="token number" style="color:#36acaa">17</span><span class="token plain">:17:08 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> generate received request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/08/27 </span><span class="token number" style="color:#36acaa">17</span><span class="token plain">:17:08 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> received CSR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/08/27 </span><span class="token number" style="color:#36acaa">17</span><span class="token plain">:17:08 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> generating key: rsa-2048</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/08/27 </span><span class="token number" style="color:#36acaa">17</span><span class="token plain">:17:08 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> encoded CSR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/08/27 </span><span class="token number" style="color:#36acaa">17</span><span class="token plain">:17:08 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> signed certificate with serial number </span><span class="token number" style="color:#36acaa">390637014214409356442509482537912246480465374076</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/08/27 </span><span class="token number" style="color:#36acaa">17</span><span class="token plain">:17:08 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">WARNING</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> This certificate lacks a </span><span class="token string" style="color:#e3116c">&quot;hosts&quot;</span><span class="token plain"> field. This makes it unsuitable </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">websites. For </span><span class="token function" style="color:#d73a49">more</span><span class="token plain"> information see the Baseline Requirements </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> the Issuance and Management</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">https://cabforum.org</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">specifically, section </span><span class="token number" style="color:#36acaa">10.2</span><span class="token plain">.3 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Information Requirements&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>3.查看生产的证书文件</strong></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~/TLS/etcd</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># ll</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">总用量 </span><span class="token number" style="color:#36acaa">36</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root  </span><span class="token number" style="color:#36acaa">288</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token plain">月  </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">17</span><span class="token plain">:16 ca-config.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root  </span><span class="token number" style="color:#36acaa">956</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token plain">月  </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">17</span><span class="token plain">:16 ca.csr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root  </span><span class="token number" style="color:#36acaa">210</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token plain">月  </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">17</span><span class="token plain">:16 ca-csr.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-------. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">1675</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token plain">月  </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">17</span><span class="token plain">:16 ca-key.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">1265</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token plain">月  </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">17</span><span class="token plain">:16 ca.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">1021</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token plain">月  </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">17</span><span class="token plain">:17 server.csr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root  </span><span class="token number" style="color:#36acaa">311</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token plain">月  </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">17</span><span class="token plain">:17 server-csr.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-------. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">1679</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token plain">月  </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">17</span><span class="token plain">:17 server-key.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">1346</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token plain">月  </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">17</span><span class="token plain">:17 server.pem</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="32部署etcd集群">3.2.部署etcd集群<a href="#32部署etcd集群" class="hash-link" aria-label="Direct link to 3.2.部署etcd集群" title="Direct link to 3.2.部署etcd集群">​</a></h3><p><strong>1.下载etcd二进制文件</strong></p><p>下载地址：<a href="https://github.com/etcd-io/etcd/releases/download/v3.4.9/etcd-v3.4.9-linux-amd64.tar.gz" target="_blank" rel="noopener noreferrer">https://github.com/etcd-io/etcd/releases/download/v3.4.9/etcd-v3.4.9-linux-amd64.tar.gz</a></p><p>部署二进制的程序集群最简单的方式就是在其中一台上面部署，然后将所有的文件scp到其他机器上修改配置，一套集群也就完成了。</p><p>将下载好的文件上传至所有etcd节点。</p><p>etcd配置文件解释</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">#[Member]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_NAME</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;etcd-1&quot;</span><span class="token plain">                          </span><span class="token comment" style="color:#999988;font-style:italic">#节点名称</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_DATA_DIR</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;/data/etcd/data&quot;</span><span class="token plain">                 </span><span class="token comment" style="color:#999988;font-style:italic">#数据目录</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_LISTEN_PEER_URLS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;https://192.168.20.10:2380&quot;</span><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">#集群通信地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_LISTEN_CLIENT_URLS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;https://192.168.20.10:2379,http://127.0.0.1:2379&quot;</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">#客户端访问的监听地址，在这里加一个http://127.0.0.1:2379，在当前节点查集群信息时就不需要指定证书去查询了</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#[Clustering]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;https://192.168.20.10:2380&quot;</span><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic">#集群通告地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_ADVERTISE_CLIENT_URLS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;https://192.168.20.10:2379,http://127.0.0.1:2379&quot;</span><span class="token plain">                   </span><span class="token comment" style="color:#999988;font-style:italic">#客户端通告地址，，在这里加一个http://127.0.0.1:2379，在当前节点查集群信息时就不需要指定证书去查询了</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_INITIAL_CLUSTER</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;etcd-1=https://192.168.20.10:2380,etcd-2=https://192.168.20.12:2380,etcd-3=https://192.168.20.13:2380&quot;</span><span class="token plain">                        </span><span class="token comment" style="color:#999988;font-style:italic">#集群节点地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_INITIAL_CLUSTER_TOKEN</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;etcd-cluster&quot;</span><span class="token plain">               </span><span class="token comment" style="color:#999988;font-style:italic">#集群的唯一标识</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_INITIAL_CLUSTER_STATE</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;new&quot;</span><span class="token plain">                        </span><span class="token comment" style="color:#999988;font-style:italic">#加入集群的状态，new为新集群，existing表示加入现有集群</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>2.部署etcd-1节点</strong></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.创建程序目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> /data/etcd/</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">bin,conf,ssl,data</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> -p</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.解压二进制文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> xf etcd-v3.4.9-linux-amd64.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3</span><span class="token plain">.将二进制命令移动到制定出程序目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">mv</span><span class="token plain"> etcd-v3.4.9-linux-amd64/etcd* /data/etcd/bin/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">4</span><span class="token plain">.编辑配置文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /data/etcd/conf/etcd.conf </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#[Member]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_NAME</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;etcd-1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_DATA_DIR</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;/data/etcd/data&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_LISTEN_PEER_URLS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;https://192.168.20.10:2380&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_LISTEN_CLIENT_URLS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;https://192.168.20.10:2379,http://127.0.0.1:2379&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#[Clustering]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;https://192.168.20.10:2380&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_ADVERTISE_CLIENT_URLS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;https://192.168.20.10:2379,http://127.0.0.1:2379&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_INITIAL_CLUSTER</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;etcd-1=https://192.168.20.10:2380,etcd-2=https://192.168.20.12:2380,etcd-3=https://192.168.20.13:2380&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_INITIAL_CLUSTER_TOKEN</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;etcd-cluster&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_INITIAL_CLUSTER_STATE</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;new&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">5</span><span class="token plain">.编写systemctl控制脚本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /usr/lib/systemd/system/etcd.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Unit</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Description</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">Etcd Server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">After</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">network.target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">After</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">network-online.target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Wants</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">network-online.target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">notify</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">EnvironmentFile</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/etcd/conf/etcd.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ExecStart</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/etcd/bin/etcd </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--cert-file</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/etcd/ssl/server.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--key-file</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/etcd/ssl/server-key.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--peer-cert-file</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/etcd/ssl/server.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--peer-key-file</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/etcd/ssl/server-key.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--trusted-ca-file</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/etcd/ssl/ca.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--peer-trusted-ca-file</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/etcd/ssl/ca.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--logger</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">zap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Restart</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">on-failure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">LimitNOFILE</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">65536</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Install</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">WantedBy</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">multi-user.target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">6</span><span class="token plain">.复制证书文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> TLS/etcd/*.pem /data/etcd/ssl/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">7</span><span class="token plain">.启动etcd-1节点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl daemon-reload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl start etcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl </span><span class="token builtin class-name">enable</span><span class="token plain"> etcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#第一个节点启动会一直处于其中中的状态，只有当第二个节点也启动了，第一个节点才能启动成功，因为集群版的etcd至少需要2个节点才能成功运行</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>3.配置etcd-2节点和etcd-3节点</strong></p><p>部署完一个节点，可以直接将目录拷贝至其他节点，省去安装的一些步骤。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.推送etcd目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">scp</span><span class="token plain"> -rp /data/etcd root@192.168.20.12:/data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">scp</span><span class="token plain"> -rp /data/etcd root@192.168.20.13:/data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.推送systemctl启动文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">scp</span><span class="token plain"> -rp /usr/lib/systemd/system/etcd.service root@192.168.20.12:/usr/lib/systemd/system/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">scp</span><span class="token plain"> -rp /usr/lib/systemd/system/etcd.service root@192.168.20.13:/usr/lib/systemd/system/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3</span><span class="token plain">.修改etcd-2配置文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /data/etcd/conf/etcd.conf </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#[Member]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_NAME</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;etcd-2&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_DATA_DIR</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;/data/etcd/data&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_LISTEN_PEER_URLS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;https://192.168.20.12:2380&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_LISTEN_CLIENT_URLS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;https://192.168.20.12:2379,http://127.0.0.1:2379&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#[Clustering]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;https://192.168.20.12:2380&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_ADVERTISE_CLIENT_URLS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;https://192.168.20.12:2379,http://127.0.0.1:2379&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_INITIAL_CLUSTER</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;etcd-1=https://192.168.20.10:2380,etcd-2=https://192.168.20.12:2380,etcd-3=https://192.168.20.13:2380&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_INITIAL_CLUSTER_TOKEN</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;etcd-cluster&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_INITIAL_CLUSTER_STATE</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;new&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">4</span><span class="token plain">.修改etcd-3配置文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /data/etcd/conf/etcd.conf </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#[Member]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_NAME</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;etcd-3&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_DATA_DIR</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;/data/etcd/data&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_LISTEN_PEER_URLS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;https://192.168.20.13:2380&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_LISTEN_CLIENT_URLS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;https://192.168.20.13:2379,http://127.0.0.1:2379&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#[Clustering]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;https://192.168.20.13:2380&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_ADVERTISE_CLIENT_URLS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;https://192.168.20.13:2379,http://127.0.0.1:2379&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_INITIAL_CLUSTER</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;etcd-1=https://192.168.20.10:2380,etcd-2=https://192.168.20.12:2380,etcd-3=https://192.168.20.13:2380&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_INITIAL_CLUSTER_TOKEN</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;etcd-cluster&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_INITIAL_CLUSTER_STATE</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;new&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">5</span><span class="token plain">.启动etcd-1和etcd-2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl daemon-reload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl start etcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl </span><span class="token builtin class-name">enable</span><span class="token plain"> etcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl daemon-reload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl start etcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl </span><span class="token builtin class-name">enable</span><span class="token plain"> etcd</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>4.查看集群状态</strong><br>
<!-- -->etcd-1启动时会一直处于等待状态，当etcd-2执行启动命令时会立即启动成功，并且etcd-1也会立刻启动成功。</p><p>查看etcd的日志可以使用这个命令：<code>[root@binary-k8s-master1 ~]\# journalctl -u etcd -f</code></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.查看服务端口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">netstat</span><span class="token plain"> -lnpt </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> etcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcp        </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.20.10:2379      </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0:*               LISTEN      </span><span class="token number" style="color:#36acaa">9625</span><span class="token plain">/etcd           </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcp        </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.20.10:2380      </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0:*               LISTEN      </span><span class="token number" style="color:#36acaa">9625</span><span class="token plain">/etcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.查看集群状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#如果配置文件中2379端口没有加一个127.0.0.1则这样查看集群状态</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token assign-left variable" style="color:#36acaa">ETCDCTL_API</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> /data/etcd/bin/etcdctl --cacert</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/etcd/ssl/ca.pem --cert</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/etcd/ssl/server.pem --key</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/etcd/ssl/server-key.pem --endpoints</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;https://192.168.20.10:2379,https://192.168.20.12:2379,https://192.168.20.13:2379&quot;</span><span class="token plain"> endpoint health --write-out</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----------------------------+--------+-------------+-------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain">          ENDPOINT          </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> HEALTH </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    TOOK     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> ERROR </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----------------------------+--------+-------------+-------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> https://192.168.20.10:2379 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">   </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">32</span><span class="token plain">.322714ms </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">       </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> https://192.168.20.12:2379 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">   </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">31</span><span class="token plain">.524079ms </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">       </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> https://192.168.20.13:2379 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">   </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">38</span><span class="token plain">.985949ms </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">       </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----------------------------+--------+-------------+-------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#如果配置文件汇总2379端口加了一个127.0.0.1则可以使用如下方式查看集群信息无需指定证书</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 /data/etcd/conf</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">#  /data/etcd/bin/etcdctl member list --write-out</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+------------------+---------+--------+----------------------------+---------------------------------------------------+------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain">        ID        </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> STATUS  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">  NAME  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">         PEER ADDRS         </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">                   CLIENT ADDRS                    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> IS LEARNER </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+------------------+---------+--------+----------------------------+---------------------------------------------------+------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> 12446003b2a53d43 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> started </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> etcd-2 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> https://192.168.20.12:2380 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> https://127.0.0.1:2379,https://192.168.20.12:2379 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">      </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> 51ae3f86f3783687 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> started </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> etcd-1 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> https://192.168.20.10:2380 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">  http://127.0.0.1:2379,https://192.168.20.10:2379 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">      </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> 667c9c7ba890c3f7 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> started </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> etcd-3 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> https://192.168.20.13:2380 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">  http://127.0.0.1:2379,https://192.168.20.13:2379 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">      </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+------------------+---------+--------+----------------------------+---------------------------------------------------+------------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>配置文件状态<br>
<img loading="lazy" src="https://cdn.agou-ops.cn/others/da2f8ef902c04e77a4e555d67cc32273.png" alt="在这里插入图片描述" class="img_ev3q"></p><p>etcd启动成功的日志</p><p><img loading="lazy" src="https://cdn.agou-ops.cn/others/25e40829361b4c78b782ae1b180a90b7.png" alt="在这里插入图片描述" class="img_ev3q"></p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="4部署docker服务">4.部署Docker服务<a href="#4部署docker服务" class="hash-link" aria-label="Direct link to 4.部署Docker服务" title="Direct link to 4.部署Docker服务">​</a></h2><p>所有kubernetes节点都需要安装docker服务，包括master和node节点。</p><p>docker二进制文件下载地址：<a href="https://download.docker.com/linux/static/stable/x86%5C_64/docker-19.03.9.tgz" target="_blank" rel="noopener noreferrer">https://download.docker.com/linux/static/stable/x86\_64/docker-19.03.9.tgz</a></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="41安装docker">4.1.安装docker<a href="#41安装docker" class="hash-link" aria-label="Direct link to 4.1.安装docker" title="Direct link to 4.1.安装docker">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.解压二进制包</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> zxf docker-19.03.9.tgz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.将可执行命令移动到系统路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">mv</span><span class="token plain"> docker/* /usr/bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3</span><span class="token plain">.创建配置文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> /etc/docker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /etc/docker/daemon.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;registry-mirrors&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;https://9wn5tbfh.mirror.aliyuncs.com&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="42为docker创建systemctl启动脚本">4.2.为docker创建systemctl启动脚本<a href="#42为docker创建systemctl启动脚本" class="hash-link" aria-label="Direct link to 4.2.为docker创建systemctl启动脚本" title="Direct link to 4.2.为docker创建systemctl启动脚本">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.编写启动脚本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /usr/lib/systemd/system/docker.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Unit</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Description</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">Docker Application Container Engine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Documentation</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">https://docs.docker.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">After</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">network-online.target firewalld.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Wants</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">network-online.target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">notify</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ExecStart</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/usr/bin/dockerd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ExecReload</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/bin/kill -s HUP </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">LimitNOFILE</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">infinity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">LimitNPROC</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">infinity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">LimitCORE</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">infinity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">TimeoutStartSec</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Delegate</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">KillMode</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">process</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Restart</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">on-failure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">StartLimitBurst</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">StartLimitInterval</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">60s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Install</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">WantedBy</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">multi-user.target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.启动docker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl daemon-reload </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl start </span><span class="token function" style="color:#d73a49">docker</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl </span><span class="token builtin class-name">enable</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">docker</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="5部署kubernetes-master节点">5.部署kubernetes master节点<a href="#5部署kubernetes-master节点" class="hash-link" aria-label="Direct link to 5.部署kubernetes master节点" title="Direct link to 5.部署kubernetes master节点">​</a></h2><p>部署二进制的kubernetes组件大致可分为如下几个步骤：</p><ul><li>1.解压二进制文件</li><li>2.复制二进制程序到指定目录</li><li>3.创建组件配置文件</li><li>4.生成组件的kubeconfig文件</li><li>5.创建systemctl脚本管理服务</li><li>6.启动组件</li></ul><p>kubernetes集群的master节点和node节点的二进制文件都从github上下载，master和node相关的所有组件都在一个程序包中。</p><p>下载地址： <a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.20.md" target="_blank" rel="noopener noreferrer">https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.20.md</a></p><p><img loading="lazy" src="https://cdn.agou-ops.cn/others/36b71f10da9442808c7a950d2dedd254.png" alt="在这里插入图片描述" class="img_ev3q"></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="51使用cfssl生成apiserver的证书文件">5.1.使用cfssl生成apiserver的证书文件<a href="#51使用cfssl生成apiserver的证书文件" class="hash-link" aria-label="Direct link to 5.1.使用cfssl生成apiserver的证书文件" title="Direct link to 5.1.使用cfssl生成apiserver的证书文件">​</a></h3><p><strong>1.生成CA自签颁发机构证书</strong></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.准备CA配置文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~/TLS/k8s</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> ca-config.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;signing&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;default&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;expiry&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;87600h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;profiles&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;kubernetes&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token string" style="color:#e3116c">&quot;expiry&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;87600h&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token string" style="color:#e3116c">&quot;usages&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;signing&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;key encipherment&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;server auth&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;client auth&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~/TLS/k8s</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> ca-csr.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;CN&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;kubernetes&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;key&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;algo&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;rsa&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;size&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2048</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;names&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;C&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;CN&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;L&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Beijing&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;ST&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Beijing&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;O&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;k8s&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;OU&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;System&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.生成证书文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~/TLS/k8s</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># cfssl gencert -initca ca-csr.json </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> cfssljson -bare ca -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/09/01 </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:20:42 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> generating a new CA key and certificate from CSR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/09/01 </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:20:42 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> generate received request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/09/01 </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:20:42 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> received CSR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/09/01 </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:20:42 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> generating key: rsa-2048</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/09/01 </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:20:43 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> encoded CSR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/09/01 </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:20:43 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> signed certificate with serial number </span><span class="token number" style="color:#36acaa">90951268335404710707183639990677546638148434604</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>2.使用自签CA签发apiserver HTTPS证书</strong></p><p>签发的客户端证书配置文件中的hosts字段要包含所有Master/LB/VIP的IP地址，Node节点的地址可写可不写。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.准备客户端配置文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~/TLS/k8s</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> kube-apiserver-csr.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;CN&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;kubernetes&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;hosts&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;10.0.0.1&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;127.0.0.1&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;192.168.20.10&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;192.168.20.11&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;192.168.20.12&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;192.168.20.13&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;192.168.20.9&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;kubernetes&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;kubernetes.default&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;kubernetes.default.svc&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;kubernetes.default.svc.cluster&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;kubernetes.default.svc.cluster.local&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;key&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;algo&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;rsa&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;size&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2048</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;names&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;C&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;CN&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;L&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;BeiJing&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;ST&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;BeiJing&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;O&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;k8s&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;OU&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;System&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.生成证书文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~/TLS/k8s</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># cfssl gencert -ca</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ca.pem -ca-key</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ca-key.pem -config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ca-config.json -profile</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">kubernetes kube-apiserver-csr.json </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> cfssljson -bare kube-apiserver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/09/01 </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:30:24 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> generate received request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/09/01 </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:30:24 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> received CSR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/09/01 </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:30:24 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> generating key: rsa-2048</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/09/01 </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:30:25 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> encoded CSR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/09/01 </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:30:25 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> signed certificate with serial number </span><span class="token number" style="color:#36acaa">714472722509814799589567099679496298525490716083</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/09/01 </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:30:25 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">WARNING</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> This certificate lacks a </span><span class="token string" style="color:#e3116c">&quot;hosts&quot;</span><span class="token plain"> field. This makes it unsuitable </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">websites. For </span><span class="token function" style="color:#d73a49">more</span><span class="token plain"> information see the Baseline Requirements </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> the Issuance and Management</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">https://cabforum.org</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">specifically, section </span><span class="token number" style="color:#36acaa">10.2</span><span class="token plain">.3 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Information Requirements&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>3.查看生产的证书文件</strong></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~/TLS/k8s</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># ll</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">总用量 </span><span class="token number" style="color:#36acaa">36</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root  </span><span class="token number" style="color:#36acaa">294</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:20 ca-config.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">1001</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:20 ca.csr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root  </span><span class="token number" style="color:#36acaa">264</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:20 ca-csr.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-------. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">1679</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:20 ca-key.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">1359</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:20 ca.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">1277</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:30 kube-apiserver.csr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root  </span><span class="token number" style="color:#36acaa">602</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:30 kube-apiserver-csr.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-------. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">1679</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:30 kube-apiserver-key.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">1643</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:30 kube-apiserver.pem</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="52解压二进制文件复制相关组件程序">5.2.解压二进制文件复制相关组件程序<a href="#52解压二进制文件复制相关组件程序" class="hash-link" aria-label="Direct link to 5.2.解压二进制文件复制相关组件程序" title="Direct link to 5.2.解压二进制文件复制相关组件程序">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> /data/kubernetes/</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">bin,config,ssl,logs</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> -p</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> xf kubernetes-server-linux-amd64.tar.gz </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token builtin class-name">cd</span><span class="token plain"> kubernetes/server/bin/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~/kubernetes/server/bin</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> kube-apiserver kube-scheduler kube-controller-manager /data/kubernetes/bin/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~/kubernetes/server/bin</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> kubectl /usr/bin/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="https://cdn.agou-ops.cn/others/e7c7eb9ad3ae4b0a8800c575d4e86023.png" alt="在这里插入图片描述" class="img_ev3q"></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="53部署kube-apiserver组件">5.3.部署kube-apiserver组件<a href="#53部署kube-apiserver组件" class="hash-link" aria-label="Direct link to 5.3.部署kube-apiserver组件" title="Direct link to 5.3.部署kube-apiserver组件">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="531创建kube-apiserver配置文件">5.3.1.创建kube-apiserver配置文件<a href="#531创建kube-apiserver配置文件" class="hash-link" aria-label="Direct link to 5.3.1.创建kube-apiserver配置文件" title="Direct link to 5.3.1.创建kube-apiserver配置文件">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /data/kubernetes/config/kube-apiserver.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">KUBE_APISERVER_OPTS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;--logtostderr=false \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--v=2 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--log-dir=/data/kubernetes/logs \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--etcd-servers=https://192.168.20.10:2379,https://192.168.20.12:2379,https://192.168.20.13:2379 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--bind-address=192.168.20.10 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--secure-port=6443 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--advertise-address=192.168.20.10 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--allow-privileged=true \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--service-cluster-ip-range=10.0.0.0/24 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,NodeRestriction \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--authorization-mode=RBAC,Node \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--enable-bootstrap-token-auth=true \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--token-auth-file=/data/kubernetes/config/token.csv \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--service-node-port-range=30000-32767 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--kubelet-client-certificate=/data/kubernetes/ssl/kube-apiserver.pem \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--kubelet-client-key=/data/kubernetes/ssl/kube-apiserver-key.pem \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--tls-cert-file=/data/kubernetes/ssl/kube-apiserver.pem  \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--tls-private-key-file=/data/kubernetes/ssl/kube-apiserver-key.pem \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--client-ca-file=/data/kubernetes/ssl/ca.pem \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--service-account-key-file=/data/kubernetes/ssl/ca-key.pem \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--service-account-issuer=api \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--service-account-signing-key-file=/data/kubernetes/ssl/kube-apiserver-key.pem \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--etcd-cafile=/data/etcd/ssl/ca.pem \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--etcd-certfile=/data/etcd/ssl/server.pem \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--etcd-keyfile=/data/etcd/ssl/server-key.pem \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--requestheader-client-ca-file=/data/kubernetes/ssl/ca.pem \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--proxy-client-cert-file=/data/kubernetes/ssl/kube-apiserver.pem \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--proxy-client-key-file=/data/kubernetes/ssl/kube-apiserver-key.pem \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--requestheader-allowed-names=kubernetes \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--requestheader-extra-headers-prefix=X-Remote-Extra- \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--requestheader-group-headers=X-Remote-Group \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--requestheader-username-headers=X-Remote-User \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--enable-aggregator-routing=true \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--audit-log-maxage=30 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--audit-log-maxbackup=3 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--audit-log-maxsize=100 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--audit-log-path=/data/kubernetes/logs/k8s-audit.log&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>配置文件各参数含义</strong></p><table><thead><tr><th>配置参数</th><th>含义</th></tr></thead><tbody><tr><td>–logtostderr</td><td>是否开启日志</td></tr><tr><td>–v</td><td>日志的等级，等级越高内容越详细</td></tr><tr><td>–log-dir</td><td>日志存放路径</td></tr><tr><td>–etcd-servers</td><td>etcd集群地址</td></tr><tr><td>–bind-address</td><td>监听地址，也就是本机</td></tr><tr><td>–secure-port</td><td>https安全端口</td></tr><tr><td>–advertise-address</td><td>集群通告地址</td></tr><tr><td>–allow-privileged</td><td>企业授权</td></tr><tr><td>–service-cluster-ip-range</td><td>service资源IP地址段</td></tr><tr><td>–enable-admission-plugins</td><td>准入控制模块</td></tr><tr><td>–authorization-mode</td><td>认证授权，启用RBAC授权和节点自管理</td></tr><tr><td>–enable-bootstrap-token-auth</td><td>启用TLS bootstrap机制，启用之后kubelet可以自动给node节颁发证书</td></tr><tr><td>–token-auth-file</td><td>bootstrap token文件路径</td></tr><tr><td>–service-node-port-range</td><td>Service nodeport类型默认分配端口范围</td></tr><tr><td>–kubelet-client-certificate</td><td>apiserver访问kubelet的客户端证书文件</td></tr><tr><td>–kubelet-client-key</td><td>apiserver访问kubelet的客户端私钥文件</td></tr><tr><td>–tls-cert-file</td><td>apiserver https证书</td></tr><tr><td>–tls-private-key-file</td><td>apiserver https证书</td></tr><tr><td>–client-ca-file</td><td>ca证书路径</td></tr><tr><td>–service-account-key-file</td><td>ca私钥路径</td></tr><tr><td>–service-account-issuer</td><td>sa账号授权过期时间的一个配置，1.20以后才有的特性</td></tr><tr><td>–service-account-signing-key-file</td><td>证书文件路径</td></tr><tr><td>–etcd-cafile</td><td>etcd ca证书文件路径</td></tr><tr><td>–etcd-certfile</td><td>etcd 客户端证书文件路径</td></tr><tr><td>–etcd-keyfile</td><td>etcd 客户端私钥文件路径</td></tr><tr><td>–requestheader-client-ca-file</td><td>聚合层相关配置</td></tr><tr><td>–proxy-client-cert-file</td><td>聚合层相关配置</td></tr><tr><td>–proxy-client-key-file</td><td>聚合层相关配置</td></tr><tr><td>–requestheader-allowed-names</td><td>聚合层相关配置</td></tr><tr><td>–requestheader-extra-headers-prefix</td><td>聚合层相关配置</td></tr><tr><td>–enable-aggregator-routing</td><td>聚合层相关配置</td></tr></tbody></table><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="532创建tls-bootstrapping文件">5.3.2.创建TLS Bootstrapping文件<a href="#532创建tls-bootstrapping文件" class="hash-link" aria-label="Direct link to 5.3.2.创建TLS Bootstrapping文件" title="Direct link to 5.3.2.创建TLS Bootstrapping文件">​</a></h4><p>TLS Bootstraping：Master apiserver启用TLS认证后，Node节点kubelet和kube-proxy要与kube-apiserver进行通信，必须使用CA签发的有效证书才可以，当Node节点很多时，这种客户端证书颁发需要大量工作，同样也会增加集群扩展复杂度。为了简化流程，Kubernetes引入了TLS bootstraping机制来自动颁发客户端证书，kubelet会以一个低权限用户自动向apiserver申请证书，kubelet的证书由apiserver动态签署。所以强烈建议在Node上使用这种方式，目前主要用于kubelet，kube-proxy还是由我们统一颁发一个证书。</p><p>TLS bootstraping 工作流程：</p><p>kubelet首先取查找bootstraping配置文件，然后去连接apiserver，开始验证bootstrap token文件，再验证证书文件，最后颁发证书启动成功，否则就会启动失败。<br>
<img loading="lazy" src="https://cdn.agou-ops.cn/others/17a18dfd43ae4604863e590283b63ebd.png" alt="在这里插入图片描述" class="img_ev3q"></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.生成一个token值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">head</span><span class="token plain"> -c </span><span class="token number" style="color:#36acaa">16</span><span class="token plain"> /dev/urandom </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> od -An -t x </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tr</span><span class="token plain"> -d </span><span class="token string" style="color:#e3116c">&#x27; &#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">d7f96b0d86c574d0f64a713608db092</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.创建token文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /data/kubernetes/config/token.csv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">d7f96b0d86c574d0f64a713608db0922,kubelet-bootstrap,10001,</span><span class="token string" style="color:#e3116c">&quot;system:node-bootstrapper&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#格式：token，用户名，UID，用户组</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="534创建systemctl脚本管理apiserver">5.3.4.创建systemctl脚本管理apiserver<a href="#534创建systemctl脚本管理apiserver" class="hash-link" aria-label="Direct link to 5.3.4.创建systemctl脚本管理apiserver" title="Direct link to 5.3.4.创建systemctl脚本管理apiserver">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /usr/lib/systemd/system/kube-apiserver.service </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Unit</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Description</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">Kubernetes API Server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Documentation</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">https://github.com/kubernetes/kubernetes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">EnvironmentFile</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/config/kube-apiserver.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ExecStart</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/bin/kube-apiserver </span><span class="token variable" style="color:#36acaa">$KUBE_APISERVER_OPTS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Restart</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">on-failure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Install</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">WantedBy</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">multi-user.target</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="535启动kube-apiserver组件">5.3.5.启动kube-apiserver组件<a href="#535启动kube-apiserver组件" class="hash-link" aria-label="Direct link to 5.3.5.启动kube-apiserver组件" title="Direct link to 5.3.5.启动kube-apiserver组件">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.拷贝我们需要的证书文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> TLS/k8s/*.pem /data/kubernetes/ssl/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.启动kube-apiserver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl daemon-reload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl start kube-apiserver </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl </span><span class="token builtin class-name">enable</span><span class="token plain"> kube-apiserver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3</span><span class="token plain">.查看端口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">netstat</span><span class="token plain"> -lnpt </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> kube</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcp        </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.20.10:6443      </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0:*               LISTEN      </span><span class="token number" style="color:#36acaa">28546</span><span class="token plain">/kube-apiserve </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="54部署kube-controller-manage组件">5.4.部署kube-controller-manage组件<a href="#54部署kube-controller-manage组件" class="hash-link" aria-label="Direct link to 5.4.部署kube-controller-manage组件" title="Direct link to 5.4.部署kube-controller-manage组件">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="541创建kube-controller-manage配置文件">5.4.1.创建kube-controller-manage配置文件<a href="#541创建kube-controller-manage配置文件" class="hash-link" aria-label="Direct link to 5.4.1.创建kube-controller-manage配置文件" title="Direct link to 5.4.1.创建kube-controller-manage配置文件">​</a></h4><blockquote><p><strong>配置文件含义</strong></p><p>–kubeconfig：指定用于连接apiserver的kubeconfig配置文件</p><p>–leader-elect：用于高可用集群，自动选举</p><p>–cluster-signing-cert-file：指定CA证书文件，为kubelet自动颁发证书</p><p>–cluster-signing-key-file：指定CA私钥文件，为kubelet自动颁发证书</p><p>–cluster-signing-duration：证书过期时间</p></blockquote><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /data/kubernetes/config/kube-controller-manager.conf </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">KUBE_CONTROLLER_MANAGER_OPTS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;--logtostderr=false \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--v=2 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--log-dir=/data/kubernetes/logs \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--leader-elect=true \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--kubeconfig=/data/kubernetes/config/kube-controller-manager.kubeconfig \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--bind-address=192.168.20.10 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--allocate-node-cidrs=true \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--cluster-cidr=10.244.0.0/16 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--service-cluster-ip-range=10.0.0.0/24 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--cluster-signing-cert-file=/data/kubernetes/ssl/ca.pem \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--cluster-signing-key-file=/data/kubernetes/ssl/ca-key.pem  \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--root-ca-file=/data/kubernetes/ssl/ca.pem \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--service-account-private-key-file=/data/kubernetes/ssl/ca-key.pem \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--cluster-signing-duration=87600h0m0s&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="542生成kubeconfig文件">5.4.2.生成kubeconfig文件<a href="#542生成kubeconfig文件" class="hash-link" aria-label="Direct link to 5.4.2.生成kubeconfig文件" title="Direct link to 5.4.2.生成kubeconfig文件">​</a></h4><p>kube-controller-manage利用kubeconfig配置文件连接apiserver。</p><p>kubeconfig文件中包括集群apiserver地址、证书文件、用户。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.由于kubeconfig需要证书文件的支持，因此要生成一个证书</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~/TLS/k8s</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> kube-controller-manager-csr.json </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;CN&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;system:kube-controller-manager&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;hosts&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;key&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;algo&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;rsa&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;size&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2048</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;names&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;C&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;CN&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;L&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;BeiJing&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;ST&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;BeiJing&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;O&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;system:masters&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;OU&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;System&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~/TLS/k8s</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># cfssl gencert -ca</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ca.pem -ca-key</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ca-key.pem -config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ca-config.json -profile</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">kubernetes kube-controller-manager-csr.json </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> cfssljson -bare kube-controller-manager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/09/01 </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:36:18 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> generate received request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/09/01 </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:36:18 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> received CSR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/09/01 </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:36:18 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> generating key: rsa-2048</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">l2021/09/01 </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:36:19 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> encoded CSR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/09/01 </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:36:19 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> signed certificate with serial number </span><span class="token number" style="color:#36acaa">719101376219834763931271155238486242405063666906</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/09/01 </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:36:19 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">WARNING</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> This certificate lacks a </span><span class="token string" style="color:#e3116c">&quot;hosts&quot;</span><span class="token plain"> field. This makes it unsuitable </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">websites. For </span><span class="token function" style="color:#d73a49">more</span><span class="token plain"> information see the Baseline Requirements </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> the Issuance and Management</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">https://cabforum.org</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">specifically, section </span><span class="token number" style="color:#36acaa">10.2</span><span class="token plain">.3 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Information Requirements&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~/TLS/k8s</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> kube-controller-manager*pem /data/kubernetes/ssl/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.生成kubeconfig文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#在kubeconfig文件中增加集群apiserver信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl config set-cluster kubernetes </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--certificate-authority</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/ssl/ca.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--embed-certs</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--server</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;https://192.168.20.10:6443&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--kubeconfig</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/config/kube-controller-manager.kubeconfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#在kubeconfig文件中增加证书文件信息  </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl config set-credentials kube-controller-manager </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--client-certificate</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/ssl/kube-controller-manager.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--client-key</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/ssl/kube-controller-manager-key.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--embed-certs</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--kubeconfig</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/config/kube-controller-manager.kubeconfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#在kubeconfig文件中增加用户信息  </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl config set-context default </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--cluster</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">kubernetes </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--user</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">kube-controller-manager </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--kubeconfig</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/config/kube-controller-manager.kubeconfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3</span><span class="token plain">.指定生成的kubeconfig文件为集群使用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl config use-context default --kubeconfig</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/config/kube-controller-manager.kubeconfig  </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="https://cdn.agou-ops.cn/others/877a98a70b2f47919bcaae2d9d02a4d1.png" alt="在这里插入图片描述" class="img_ev3q"></p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="543创建systemctl脚本管理服务">5.4.3.创建systemctl脚本管理服务<a href="#543创建systemctl脚本管理服务" class="hash-link" aria-label="Direct link to 5.4.3.创建systemctl脚本管理服务" title="Direct link to 5.4.3.创建systemctl脚本管理服务">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /usr/lib/systemd/system/kube-controller-manager.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Unit</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Description</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">Kubernetes Controller Manager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Documentation</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">https://github.com/kubernetes/kubernetes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">EnvironmentFile</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/config/kube-controller-manager.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ExecStart</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/bin/kube-controller-manager </span><span class="token variable" style="color:#36acaa">$KUBE_CONTROLLER_MANAGER_OPTS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Restart</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">on-failure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Install</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">WantedBy</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">multi-user.target</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="544启动kube-controller-manage组件">5.4.4.启动kube-controller-manage组件<a href="#544启动kube-controller-manage组件" class="hash-link" aria-label="Direct link to 5.4.4.启动kube-controller-manage组件" title="Direct link to 5.4.4.启动kube-controller-manage组件">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.启动服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl daemon-reload </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl start kube-controller-manager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl </span><span class="token builtin class-name">enable</span><span class="token plain"> kube-controller-manager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.查看端口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">netstat</span><span class="token plain"> -lnpt </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> kube</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcp        </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.20.10:6443      </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0:*               LISTEN      </span><span class="token number" style="color:#36acaa">28546</span><span class="token plain">/kube-apiserve </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcp        </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.20.10:10257     </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0:*               LISTEN      </span><span class="token number" style="color:#36acaa">28941</span><span class="token plain">/kube-controll </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcp6       </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> :::10252                :::*                    LISTEN      </span><span class="token number" style="color:#36acaa">28941</span><span class="token plain">/kube-controll </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="55部署kube-scheduler组件">5.5.部署kube-scheduler组件<a href="#55部署kube-scheduler组件" class="hash-link" aria-label="Direct link to 5.5.部署kube-scheduler组件" title="Direct link to 5.5.部署kube-scheduler组件">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="551创建kube-scheduler配置文件">5.5.1.创建kube-scheduler配置文件<a href="#551创建kube-scheduler配置文件" class="hash-link" aria-label="Direct link to 5.5.1.创建kube-scheduler配置文件" title="Direct link to 5.5.1.创建kube-scheduler配置文件">​</a></h4><blockquote><p>配置文件解释</p><p>–kubeconfig：指定kubeconfig文件</p><p>–leader-elect：选举</p></blockquote><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /data/kubernetes/config/kube-scheduler.conf </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">KUBE_SCHEDULER_OPTS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;--logtostderr=false \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--v=2 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--log-dir=/data/kubernetes/logs \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--leader-elect \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--kubeconfig=/data/kubernetes/config/kube-scheduler.kubeconfig \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--bind-address=192.168.20.10&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="552生成kubeconfig文件">5.5.2.生成kubeconfig文件<a href="#552生成kubeconfig文件" class="hash-link" aria-label="Direct link to 5.5.2.生成kubeconfig文件" title="Direct link to 5.5.2.生成kubeconfig文件">​</a></h4><p>生成kubeconfig连接集群apiserver。</p><p>kube-schedule利用kubeconfig配置文件连接apiserver。</p><p>kubeconfig文件中包括集群apiserver地址、证书文件、用户。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.创建证书配置文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~/TLS/k8s</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> kube-scheduler-csr.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;CN&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;system:kube-scheduler&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;hosts&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;key&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;algo&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;rsa&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;size&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2048</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;names&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;C&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;CN&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;L&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;BeiJing&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;ST&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;BeiJing&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;O&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;system:masters&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;OU&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;System&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.生成证书</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~/TLS/k8s</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># cfssl gencert -ca</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ca.pem -ca-key</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ca-key.pem -config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ca-config.json -profile</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">kubernetes kube-scheduler-csr.json </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> cfssljson -bare kube-scheduler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/09/02 </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:50:40 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> generate received request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/09/02 </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:50:40 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> received CSR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/09/02 </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:50:40 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> generating key: rsa-2048</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/09/02 </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:50:42 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> encoded CSR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/09/02 </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:50:42 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> signed certificate with serial number </span><span class="token number" style="color:#36acaa">91388852050290848663498441480862532526947759393</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/09/02 </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:50:42 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">WARNING</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> This certificate lacks a </span><span class="token string" style="color:#e3116c">&quot;hosts&quot;</span><span class="token plain"> field. This makes it unsuitable </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">websites. For </span><span class="token function" style="color:#d73a49">more</span><span class="token plain"> information see the Baseline Requirements </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> the Issuance and Management</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">https://cabforum.org</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">specifically, section </span><span class="token number" style="color:#36acaa">10.2</span><span class="token plain">.3 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Information Requirements&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3</span><span class="token plain">.查看证书文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~/TLS/k8s</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># ll</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">总用量 </span><span class="token number" style="color:#36acaa">68</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root  </span><span class="token number" style="color:#36acaa">294</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:20 ca-config.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">1001</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:20 ca.csr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root  </span><span class="token number" style="color:#36acaa">264</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:20 ca-csr.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-------. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">1679</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:20 ca-key.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">1359</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:20 ca.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">1277</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:30 kube-apiserver.csr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root  </span><span class="token number" style="color:#36acaa">602</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:30 kube-apiserver-csr.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-------. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">1679</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:30 kube-apiserver-key.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">1643</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:30 kube-apiserver.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">1045</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:36 kube-controller-manager.csr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root  </span><span class="token number" style="color:#36acaa">255</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:46 kube-controller-manager-csr.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-------. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">1675</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:36 kube-controller-manager-key.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">1436</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:36 kube-controller-manager.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">1029</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:50 kube-scheduler.csr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root  </span><span class="token number" style="color:#36acaa">245</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:50 kube-scheduler-csr.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-------. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">1675</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:50 kube-scheduler-key.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">1424</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:50 kube-scheduler.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">4</span><span class="token plain">.拷贝证书文件至指定路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~/TLS/k8s</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> kube-scheduler*.pem /data/kubernetes/ssl/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">5</span><span class="token plain">.生成kubeconfig文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#在kubeconfig文件中增加集群apiserver信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl config set-cluster kubernetes </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--certificate-authority</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/ssl/ca.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--embed-certs</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--server</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;https://192.168.20.10:6443&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--kubeconfig</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/config/kube-scheduler.kubeconfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#在kubeconfig文件中增加证书文件信息 </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl config set-credentials kube-scheduler </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--client-certificate</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/ssl/kube-scheduler.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--client-key</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/ssl/kube-scheduler-key.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--embed-certs</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--kubeconfig</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/config/kube-scheduler.kubeconfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#在kubeconfig文件中增加用户信息 </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl config set-context default </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--cluster</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">kubernetes </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--user</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">kube-scheduler </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--kubeconfig</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/config/kube-scheduler.kubeconfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">6</span><span class="token plain">.指定生成的kubeconfig文件为集群使用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl config use-context default --kubeconfig</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/config/kube-scheduler.kubeconfig</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="553创建systemctl脚本管理服务">5.5.3.创建systemctl脚本管理服务<a href="#553创建systemctl脚本管理服务" class="hash-link" aria-label="Direct link to 5.5.3.创建systemctl脚本管理服务" title="Direct link to 5.5.3.创建systemctl脚本管理服务">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /usr/lib/systemd/system/kube-scheduler.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Unit</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Description</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">Kubernetes Scheduler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Documentation</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">https://github.com/kubernetes/kubernetes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">EnvironmentFile</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/config/kube-scheduler.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ExecStart</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/bin/kube-scheduler </span><span class="token variable" style="color:#36acaa">$KUBE_SCHEDULER_OPTS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Restart</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">on-failure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Install</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">WantedBy</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">multi-user.target</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="554启动kube-scheduler组件">5.5.4.启动kube-scheduler组件<a href="#554启动kube-scheduler组件" class="hash-link" aria-label="Direct link to 5.5.4.启动kube-scheduler组件" title="Direct link to 5.5.4.启动kube-scheduler组件">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.启动服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl daemon-reload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl start kube-scheduler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl </span><span class="token builtin class-name">enable</span><span class="token plain"> kube-scheduler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.查看端口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">netstat</span><span class="token plain"> -lnpt </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> kube</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcp        </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.20.10:6443      </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0:*               LISTEN      </span><span class="token number" style="color:#36acaa">28546</span><span class="token plain">/kube-apiserve </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcp        </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.20.10:10257     </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0:*               LISTEN      </span><span class="token number" style="color:#36acaa">28941</span><span class="token plain">/kube-controll </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcp        </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.20.10:10259     </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0:*               LISTEN      </span><span class="token number" style="color:#36acaa">6127</span><span class="token plain">/kube-scheduler </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcp6       </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> :::10251                :::*                    LISTEN      </span><span class="token number" style="color:#36acaa">6127</span><span class="token plain">/kube-scheduler </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcp6       </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> :::10252                :::*                    LISTEN      </span><span class="token number" style="color:#36acaa">28941</span><span class="token plain">/kube-controll </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="56准备kubectl所需的kubeconfig文件连接集群">5.6.准备kubectl所需的kubeconfig文件连接集群<a href="#56准备kubectl所需的kubeconfig文件连接集群" class="hash-link" aria-label="Direct link to 5.6.准备kubectl所需的kubeconfig文件连接集群" title="Direct link to 5.6.准备kubectl所需的kubeconfig文件连接集群">​</a></h3><p>kubectl想要连接集群对各种资源进行操作，需要有一个kubeconfig文件连接apiserver才可以对集群进行操作，也就是kubeadm安装k8s集群后在master节点生成的/root/.kube目录，这个目录中的config文件就是kubectl用于连接apiserver的kubeconfig文件。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="561生成证书文件">5.6.1.生成证书文件<a href="#561生成证书文件" class="hash-link" aria-label="Direct link to 5.6.1.生成证书文件" title="Direct link to 5.6.1.生成证书文件">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.创建证书配置文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~/TLS/k8s</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> kubectl-csr.json </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;CN&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;kubectl&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;hosts&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;key&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;algo&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;rsa&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;size&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2048</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;names&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;C&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;CN&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;L&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;BeiJing&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;ST&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;BeiJing&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;O&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;system:masters&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;OU&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;System&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.生成证书</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~/TLS/k8s</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># cfssl gencert -ca</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ca.pem -ca-key</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ca-key.pem -config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ca-config.json -profile</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">kubernetes kubectl-csr.json </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> cfssljson -bare kubectl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/09/02 </span><span class="token number" style="color:#36acaa">17</span><span class="token plain">:20:44 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> generate received request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/09/02 </span><span class="token number" style="color:#36acaa">17</span><span class="token plain">:20:44 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> received CSR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/09/02 </span><span class="token number" style="color:#36acaa">17</span><span class="token plain">:20:44 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> generating key: rsa-2048</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/09/02 </span><span class="token number" style="color:#36acaa">17</span><span class="token plain">:20:45 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> encoded CSR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/09/02 </span><span class="token number" style="color:#36acaa">17</span><span class="token plain">:20:45 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> signed certificate with serial number </span><span class="token number" style="color:#36acaa">398472525484598388169457456772550114435870340604</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/09/02 </span><span class="token number" style="color:#36acaa">17</span><span class="token plain">:20:45 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">WARNING</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> This certificate lacks a </span><span class="token string" style="color:#e3116c">&quot;hosts&quot;</span><span class="token plain"> field. This makes it unsuitable </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">websites. For </span><span class="token function" style="color:#d73a49">more</span><span class="token plain"> information see the Baseline Requirements </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> the Issuance and Management</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">https://cabforum.org</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">specifically, section </span><span class="token number" style="color:#36acaa">10.2</span><span class="token plain">.3 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Information Requirements&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3</span><span class="token plain">.查看生成的证书文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~/TLS/k8s</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># ll</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">总用量 </span><span class="token number" style="color:#36acaa">84</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root  </span><span class="token number" style="color:#36acaa">294</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:20 ca-config.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">1001</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:20 ca.csr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root  </span><span class="token number" style="color:#36acaa">264</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:20 ca-csr.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-------. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">1679</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:20 ca-key.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">1359</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:20 ca.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">1277</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:30 kube-apiserver.csr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root  </span><span class="token number" style="color:#36acaa">602</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:30 kube-apiserver-csr.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-------. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">1679</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:30 kube-apiserver-key.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">1643</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:30 kube-apiserver.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">1045</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:36 kube-controller-manager.csr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root  </span><span class="token number" style="color:#36acaa">255</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:46 kube-controller-manager-csr.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-------. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">1675</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:36 kube-controller-manager-key.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">1436</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:36 kube-controller-manager.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">1013</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">17</span><span class="token plain">:20 kubectl.csr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root  </span><span class="token number" style="color:#36acaa">231</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">17</span><span class="token plain">:20 kubectl-csr.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-------. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">1679</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">17</span><span class="token plain">:20 kubectl-key.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">1403</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">17</span><span class="token plain">:20 kubectl.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">1029</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:50 kube-scheduler.csr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root  </span><span class="token number" style="color:#36acaa">245</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:50 kube-scheduler-csr.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-------. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">1675</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:50 kube-scheduler-key.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">1424</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:50 kube-scheduler.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">4</span><span class="token plain">.拷贝证书文件到指定目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~/TLS/k8s</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">cp kubectl*.pem /data/kubernetes/ssl/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="562生成kubeconfig文件">5.6.2.生成kubeconfig文件<a href="#562生成kubeconfig文件" class="hash-link" aria-label="Direct link to 5.6.2.生成kubeconfig文件" title="Direct link to 5.6.2.生成kubeconfig文件">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.在kubeconfig文件中增加集群apiserver信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl config set-cluster kubernetes </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--certificate-authority</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/ssl/ca.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--embed-certs</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--server</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;https://192.168.20.10:6443&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--kubeconfig</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/root/.kube/config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.在kubeconfig文件中增加证书文件信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl config set-credentials cluster-admin </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--client-certificate</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/ssl/kubectl.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--client-key</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/ssl/kubectl-key.pem  </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--embed-certs</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--kubeconfig</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/root/.kube/config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3</span><span class="token plain">.在kubeconfig文件中增加用户信息 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl config set-context default </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--cluster</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">kubernetes </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--user</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">cluster-admin </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--kubeconfig</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/root/.kube/config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">4</span><span class="token plain">.指定生成的kubeconfig文件为集群使用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl config use-context default --kubeconfig</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/root/.kube/config</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="563使用kubectl查看集群连接信息">5.6.3.使用kubectl查看集群连接信息<a href="#563使用kubectl查看集群连接信息" class="hash-link" aria-label="Direct link to 5.6.3.使用kubectl查看集群连接信息" title="Direct link to 5.6.3.使用kubectl查看集群连接信息">​</a></h4><p>至此master节点相关组件部署完成。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl get </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">No resources found</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl get cs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Warning: v1 ComponentStatus is deprecated </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> v1.19+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                 STATUS    MESSAGE             ERROR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scheduler            Healthy   ok                  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">controller-manager   Healthy   ok                  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcd-1               Healthy   </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;true&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcd-0               Healthy   </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;true&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcd-2               Healthy   </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;true&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">  </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="https://cdn.agou-ops.cn/others/8ea5953c67f6460facc684905acb502c.png" alt="在这里插入图片描述" class="img_ev3q"></p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="6在master节点部署node节点相关组件">6.在master节点部署node节点相关组件<a href="#6在master节点部署node节点相关组件" class="hash-link" aria-label="Direct link to 6.在master节点部署node节点相关组件" title="Direct link to 6.在master节点部署node节点相关组件">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="61在集群授权kubelet-bootstrap用户允许请求证书">6.1.在集群授权kubelet-bootstrap用户允许请求证书<a href="#61在集群授权kubelet-bootstrap用户允许请求证书" class="hash-link" aria-label="Direct link to 6.1.在集群授权kubelet-bootstrap用户允许请求证书" title="Direct link to 6.1.在集群授权kubelet-bootstrap用户允许请求证书">​</a></h3><p>在此处做了这一步之后，node节点加入集群时就不需要做了。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl create clusterrolebinding kubelet-bootstrap </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--clusterrole</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">system:node-bootstrapper </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--user</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">kubelet-bootstrap</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="62在master节点部署kubelet组件">6.2.在master节点部署kubelet组件<a href="#62在master节点部署kubelet组件" class="hash-link" aria-label="Direct link to 6.2.在master节点部署kubelet组件" title="Direct link to 6.2.在master节点部署kubelet组件">​</a></h3><p>由于master也需要启动某些pod，比如calico组件都是以pod方式运行的，因此在master节点也需要kubelet和kube-proxy组件。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="621将kubelet和kube-proxy的二进制文件拷贝至对应目录">6.2.1.将kubelet和kube-proxy的二进制文件拷贝至对应目录<a href="#621将kubelet和kube-proxy的二进制文件拷贝至对应目录" class="hash-link" aria-label="Direct link to 6.2.1.将kubelet和kube-proxy的二进制文件拷贝至对应目录" title="Direct link to 6.2.1.将kubelet和kube-proxy的二进制文件拷贝至对应目录">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> kubernetes/server/bin/</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">kubelet,kube-proxy</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> /data/kubernetes/bin/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="622创建kubelet配置文件">6.2.2.创建kubelet配置文件<a href="#622创建kubelet配置文件" class="hash-link" aria-label="Direct link to 6.2.2.创建kubelet配置文件" title="Direct link to 6.2.2.创建kubelet配置文件">​</a></h4><blockquote><p>配置文件含义：</p><p>–hostname-override：节点名称，集群中唯一</p><p>–network-plugin：启用CNI网络</p><p>–kubeconfig：指定自动生成的kubeconfig文件路径，用于连接apiserver</p><p>–bootstrap-kubeconfig：指定首次启动向apiserver申请证书的kubeconfig文件路径</p><p>–config：配置参数文件路径</p><p>–cert-dir：kubelet证书生成目录路径</p><p>–pod-infra-container-image：pod容器的根容器</p></blockquote><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /data/kubernetes/config/kubelet.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">KUBELET_OPTS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;--logtostderr=false \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--v=2 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--log-dir=/data/kubernetes/logs \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--hostname-override=binary-k8s-master1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--network-plugin=cni \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--kubeconfig=/data/kubernetes/config/kubelet.kubeconfig \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--bootstrap-kubeconfig=/data/kubernetes/config/bootstrap.kubeconfig \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--config=/data/kubernetes/config/kubelet-config.yml \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--cert-dir=/data/kubernetes/ssl \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--pod-infra-container-image=pause-amd64:3.0&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="623创建kubelet-configyaml参数配置文件">6.2.3.创建kubelet-config.yaml参数配置文件<a href="#623创建kubelet-configyaml参数配置文件" class="hash-link" aria-label="Direct link to 6.2.3.创建kubelet-config.yaml参数配置文件" title="Direct link to 6.2.3.创建kubelet-config.yaml参数配置文件">​</a></h4><p>kubelet和kube-proxy服务的参数配置是以yaml形式来配置的</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /data/kubernetes/config/kubelet-config.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: KubeletConfiguration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: kubelet.config.k8s.io/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">address: </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0                </span><span class="token comment" style="color:#999988;font-style:italic">#监听地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">port: </span><span class="token number" style="color:#36acaa">10250</span><span class="token plain">                     </span><span class="token comment" style="color:#999988;font-style:italic">#监听端口</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">readOnlyPort: </span><span class="token number" style="color:#36acaa">10255</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cgroupDriver: cgroupfs          </span><span class="token comment" style="color:#999988;font-style:italic">#驱动引擎</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterDNS:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- </span><span class="token number" style="color:#36acaa">10.0</span><span class="token plain">.0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterDomain: cluster.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">failSwapOn: </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">authentication:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  anonymous:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enabled: </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  webhook:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cacheTTL: 2m0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enabled: </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  x509:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    clientCAFile: /data/kubernetes/ssl/ca.pem       </span><span class="token comment" style="color:#999988;font-style:italic">#ca证书文件路径</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">authorization:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mode: Webhook</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  webhook:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cacheAuthorizedTTL: 5m0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cacheUnauthorizedTTL: 30s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">evictionHard:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  imagefs.available: </span><span class="token number" style="color:#36acaa">15</span><span class="token plain">%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  memory.available: 100Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nodefs.available: </span><span class="token number" style="color:#36acaa">10</span><span class="token plain">%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nodefs.inodesFree: </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">maxOpenFiles: </span><span class="token number" style="color:#36acaa">1000000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">maxPods: </span><span class="token number" style="color:#36acaa">110</span><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic">#可运行的pod的数量</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="624创建bootstrap-kubeconfig文件">6.2.4.创建bootstrap-kubeconfig文件<a href="#624创建bootstrap-kubeconfig文件" class="hash-link" aria-label="Direct link to 6.2.4.创建bootstrap-kubeconfig文件" title="Direct link to 6.2.4.创建bootstrap-kubeconfig文件">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.在kubeconfig文件中增加集群apiserver信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl config set-cluster kubernetes </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--certificate-authority</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/ssl/ca.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--embed-certs</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--server</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;https://192.168.20.10:6443&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--kubeconfig</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/config/bootstrap.kubeconfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.在kubeconfig文件中增加token信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl config set-credentials </span><span class="token string" style="color:#e3116c">&quot;kubelet-bootstrap&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--token</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">d7f96b0d86c574d0f64a713608db0922 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--kubeconfig</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/config/bootstrap.kubeconfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#这个token就是之前生成的/data/kubernetes/config/token.csv中的token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3</span><span class="token plain">.在kubeconfig文件中增加用户信息 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl config set-context default </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--cluster</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">kubernetes </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--user</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;kubelet-bootstrap&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--kubeconfig</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/config/bootstrap.kubeconfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">4</span><span class="token plain">.指定生成的kubeconfig文件为集群使用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl config use-context default --kubeconfig</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/config/bootstrap.kubeconfig</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="625创建systemctl脚本并启动服务">6.2.5.创建systemctl脚本并启动服务<a href="#625创建systemctl脚本并启动服务" class="hash-link" aria-label="Direct link to 6.2.5.创建systemctl脚本并启动服务" title="Direct link to 6.2.5.创建systemctl脚本并启动服务">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.创建systemctl脚本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /usr/lib/systemd/system/kubelet.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Unit</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Description</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">Kubernetes Kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">After</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">docker.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">EnvironmentFile</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/config/kubelet.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ExecStart</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/bin/kubelet </span><span class="token variable" style="color:#36acaa">$KUBELET_OPTS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Restart</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">on-failure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">LimitNOFILE</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">65536</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Install</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">WantedBy</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">multi-user.target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.启动kubelet服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl daemon-reload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl start kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl </span><span class="token builtin class-name">enable</span><span class="token plain"> kubelet</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="626将master节点作为node加入集群内部">6.2.6.将master节点作为node加入集群内部<a href="#626将master节点作为node加入集群内部" class="hash-link" aria-label="Direct link to 6.2.6.将master节点作为node加入集群内部" title="Direct link to 6.2.6.将master节点作为node加入集群内部">​</a></h4><p>当kubelet组件启动成功后，就会想apiserver发送一个请求加入集群的信息，只有当master节点授权同意后，才可以正常加入，虽然是master节点部署的node组件，但是也会发生一个加入集群的信息，需要master同意。</p><p>当kubelet启动之后，首先会在证书目录生成一个kubelet-client.key.tmp这个文件，当使用kubectl certificate approve命令授权成功node的请求之后，kubelet-client.key.tmp小时，随之会生成一个kubelet-client-current.pem的证书文件，用于与apiserver建立连接，此时再使用kubectl get node就会看到节点信息了。</p><p>扩展：如果后期想要修改node的名称，那么就把生成的kubelet证书文件全部删除，然后使用kubectl delete node删除该节点，在修改kubelet配置文件中该节点的名称，然后使用kubectl delete csr删除授权信息，再重启kubelet生成新的授权信息，然后授权通过即可看到新的名字的node节点。</p><p>只有当授权通过后，kubelet生成了证书文件，kubelet的端口才会被启动</p><p>注意：当kubelet的授权被master请求通后，kube-proxy启动成功后，节点才会正真的加入集群，即使kubectl get node看到的节点是Ready，该节点也是不可用的，必须当kube-proxy启动完毕后，这个节点才算正真的启动完毕&lt;</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.直接在master节点上执行如下命令获取请求列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl get csr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                                   AGE   SIGNERNAME                                    REQUESTOR           CONDITION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node-csr-JN8q9WljA6oupdWZ2mVO-TOIq2sLodFdkyL5fu6Ius4   4s    kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.授权同意此节点加入集群</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl certificate approve node-csr-JN8q9WljA6oupdWZ2mVO-TOIq2sLodFdkyL5fu6Ius4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">certificatesigningrequest.certificates.k8s.io/node-csr-JN8q9WljA6oupdWZ2mVO-TOIq2sLodFdkyL5fu6Ius4 approved</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3</span><span class="token plain">.查看node节点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl get </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                 STATUS     ROLES    AGE   VERSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">binary-k8s-master1   NotReady   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">   6s    v1.20.4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#此时master节点已经出现在集群节点列表中了</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">4</span><span class="token plain">.查看kubelet端口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">netstat</span><span class="token plain"> -lnpt </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcp        </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1:10248         </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0:*               LISTEN      </span><span class="token number" style="color:#36acaa">29092</span><span class="token plain">/kubelet       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcp        </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1:41132         </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0:*               LISTEN      </span><span class="token number" style="color:#36acaa">29092</span><span class="token plain">/kubelet       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcp6       </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> :::10250                :::*                    LISTEN      </span><span class="token number" style="color:#36acaa">29092</span><span class="token plain">/kubelet       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcp6       </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> :::10255                :::*                    LISTEN      </span><span class="token number" style="color:#36acaa">29092</span><span class="token plain">/kubelet </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="https://cdn.agou-ops.cn/others/857b38edfb4c46e99ccd40e7fa296628.png" alt="在这里插入图片描述" class="img_ev3q"></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="63在master节点部署kube-proxy">6.3.在master节点部署kube-proxy<a href="#63在master节点部署kube-proxy" class="hash-link" aria-label="Direct link to 6.3.在master节点部署kube-proxy" title="Direct link to 6.3.在master节点部署kube-proxy">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="631创建kube-proxy配置文件">6.3.1.创建kube-proxy配置文件<a href="#631创建kube-proxy配置文件" class="hash-link" aria-label="Direct link to 6.3.1.创建kube-proxy配置文件" title="Direct link to 6.3.1.创建kube-proxy配置文件">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /data/kubernetes/config/kube-proxy.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">KUBE_PROXY_OPTS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;--logtostderr=false \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--v=2 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--log-dir=/data/kubernetes/logs \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--config=/data/kubernetes/config/kube-proxy-config.yml&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="632创建kube-proxy参数配置文件">6.3.2.创建kube-proxy参数配置文件<a href="#632创建kube-proxy参数配置文件" class="hash-link" aria-label="Direct link to 6.3.2.创建kube-proxy参数配置文件" title="Direct link to 6.3.2.创建kube-proxy参数配置文件">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /data/kubernetes/config/kube-proxy-config.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: KubeProxyConfiguration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bindAddress: </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0                                    </span><span class="token comment" style="color:#999988;font-style:italic">#监听地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metricsBindAddress: </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0:10249                           </span><span class="token comment" style="color:#999988;font-style:italic">#监听端口</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clientConnection:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kubeconfig: /data/kubernetes/config/kube-proxy.kubeconfig         </span><span class="token comment" style="color:#999988;font-style:italic">#kubeconfig文件用于和apiserver通信</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hostnameOverride: binary-k8s-master1                </span><span class="token comment" style="color:#999988;font-style:italic">#当前节点名称</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterCIDR: </span><span class="token number" style="color:#36acaa">10.244</span><span class="token plain">.0.0/16</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="633生成kubeconfig文件">6.3.3.生成kubeconfig文件<a href="#633生成kubeconfig文件" class="hash-link" aria-label="Direct link to 6.3.3.生成kubeconfig文件" title="Direct link to 6.3.3.生成kubeconfig文件">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.创建证书配置文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~/TLS/k8s</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> kube-proxy-csr.json </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;CN&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;system:kube-proxy&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;hosts&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;key&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;algo&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;rsa&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;size&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2048</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;names&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;C&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;CN&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;L&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;BeiJing&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;ST&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;BeiJing&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;O&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;k8s&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;OU&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;System&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.生成证书</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~/TLS/k8s</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># cfssl gencert -ca</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ca.pem -ca-key</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ca-key.pem -config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ca-config.json -profile</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">kubernetes kube-proxy-csr.json </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> cfssljson -bare kube-proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/09/03 </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:04:23 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> generate received request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/09/03 </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:04:23 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> received CSR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/09/03 </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:04:23 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> generating key: rsa-2048</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/09/03 </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:04:24 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> encoded CSR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/09/03 </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:04:24 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> signed certificate with serial number </span><span class="token number" style="color:#36acaa">677418055440191127932354470575565723194258386145</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">/09/03 </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:04:24 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">WARNING</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> This certificate lacks a </span><span class="token string" style="color:#e3116c">&quot;hosts&quot;</span><span class="token plain"> field. This makes it unsuitable </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">websites. For </span><span class="token function" style="color:#d73a49">more</span><span class="token plain"> information see the Baseline Requirements </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> the Issuance and Management</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">https://cabforum.org</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">specifically, section </span><span class="token number" style="color:#36acaa">10.2</span><span class="token plain">.3 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Information Requirements&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3</span><span class="token plain">.查看证书文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~/TLS/k8s</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># ll *proxy*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">1009</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:04 kube-proxy.csr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root  </span><span class="token number" style="color:#36acaa">230</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:04 kube-proxy-csr.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-------. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">1679</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:04 kube-proxy-key.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">1403</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:04 kube-proxy.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">4</span><span class="token plain">.拷贝证书文件至指定路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~/TLS/k8s</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> kube-proxy*.pem /data/kubernetes/ssl/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">5</span><span class="token plain">.生成kubeconfig文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#在kubeconfig文件中增加集群apiserver信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl config set-cluster kubernetes </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--certificate-authority</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/ssl/ca.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--embed-certs</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--server</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;https://192.168.20.10:6443&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--kubeconfig</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/config/kube-proxy.kubeconfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#在kubeconfig文件中增加证书文件信息 </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl config set-credentials kube-proxy </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--client-certificate</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/ssl/kube-proxy.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--client-key</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/ssl/kube-proxy-key.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--embed-certs</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--kubeconfig</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/config/kube-proxy.kubeconfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#在kubeconfig文件中增加用户信息 </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl config set-context default </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--cluster</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">kubernetes </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--user</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">kube-proxy </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--kubeconfig</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/config/kube-proxy.kubeconfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">6</span><span class="token plain">.指定生成的kubeconfig文件为集群使用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl config use-context default --kubeconfig</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/config/kube-proxy.kubeconfig</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="634创建systemctl脚本管理服务">6.3.4.创建systemctl脚本管理服务<a href="#634创建systemctl脚本管理服务" class="hash-link" aria-label="Direct link to 6.3.4.创建systemctl脚本管理服务" title="Direct link to 6.3.4.创建systemctl脚本管理服务">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /usr/lib/systemd/system/kube-proxy.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Unit</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Description</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">Kubernetes Proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">After</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">network.target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">EnvironmentFile</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/config/kube-proxy.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ExecStart</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/bin/kube-proxy </span><span class="token variable" style="color:#36acaa">$KUBE_PROXY_OPTS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Restart</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">on-failure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">LimitNOFILE</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">65536</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Install</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">WantedBy</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">multi-user.target</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="634启动kube-proxy组件">6.3.4.启动kube-proxy组件<a href="#634启动kube-proxy组件" class="hash-link" aria-label="Direct link to 6.3.4.启动kube-proxy组件" title="Direct link to 6.3.4.启动kube-proxy组件">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.启动服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl daemon-reload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl start kube-proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl </span><span class="token builtin class-name">enable</span><span class="token plain"> kube-proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.查看端口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">netstat</span><span class="token plain"> -lnpt </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> kube-proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcp6       </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> :::10249                :::*                    LISTEN      </span><span class="token number" style="color:#36acaa">29354</span><span class="token plain">/kube-proxy    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcp6       </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> :::10256                :::*                    LISTEN      </span><span class="token number" style="color:#36acaa">29354</span><span class="token plain">/kube-proxy </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="64授权apiserver访问kubelet">6.4.授权apiserver访问kubelet<a href="#64授权apiserver访问kubelet" class="hash-link" aria-label="Direct link to 6.4.授权apiserver访问kubelet" title="Direct link to 6.4.授权apiserver访问kubelet">​</a></h3><p>如果不收取apiserver访问kubelet，那么将无法使用kubectl查看集群的一些信息，比如kubectl logs就无法使用。</p><p>实际上就是创建一个rbac资源让apiserver能否访问kubelet的资源。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.编写资源yaml文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> apiserver-to-kubelet-rbac.yaml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: rbac.authorization.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: ClusterRole</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rbac.authorization.kubernetes.io/autoupdate: </span><span class="token string" style="color:#e3116c">&quot;true&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubernetes.io/bootstrapping: rbac-defaults</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: system:kube-apiserver-to-kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - apiGroups:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - nodes/proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - nodes/stats</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - nodes/log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - nodes/spec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - nodes/metrics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - pods/log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    verbs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - </span><span class="token string" style="color:#e3116c">&quot;*&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: rbac.authorization.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: ClusterRoleBinding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: system:kube-apiserver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">roleRef:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  apiGroup: rbac.authorization.k8s.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kind: ClusterRole</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: system:kube-apiserver-to-kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">subjects:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - apiGroup: rbac.authorization.k8s.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kind: User</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name: kubernetes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.创建资源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl apply -f apiserver-to-kubelet-rbac.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterrole.rbac.authorization.k8s.io/system:kube-apiserver-to-kubelet created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterrolebinding.rbac.authorization.k8s.io/system:kube-apiserver created</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="7部署kubernetes-calico网络组件">7.部署kubernetes calico网络组件<a href="#7部署kubernetes-calico网络组件" class="hash-link" aria-label="Direct link to 7.部署kubernetes calico网络组件" title="Direct link to 7.部署kubernetes calico网络组件">​</a></h2><p>在6中master节点已经加入集群，但是状态一直处于NotReady状态，就是由于集群没有网络组件导致的，部署好网络组件，master节点立马会成为Ready状态。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.部署calico</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl apply -f calico.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">configmap/calico-config created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">customresourcedefinition.apiextensions.k8s.io/bgpconfigurations.crd.projectcalico.org created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">customresourcedefinition.apiextensions.k8s.io/bgppeers.crd.projectcalico.org created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">customresourcedefinition.apiextensions.k8s.io/blockaffinities.crd.projectcalico.org created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">customresourcedefinition.apiextensions.k8s.io/clusterinformations.crd.projectcalico.org created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">customresourcedefinition.apiextensions.k8s.io/felixconfigurations.crd.projectcalico.org created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">customresourcedefinition.apiextensions.k8s.io/globalnetworkpolicies.crd.projectcalico.org created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">customresourcedefinition.apiextensions.k8s.io/globalnetworksets.crd.projectcalico.org created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">customresourcedefinition.apiextensions.k8s.io/hostendpoints.crd.projectcalico.org created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">customresourcedefinition.apiextensions.k8s.io/ipamblocks.crd.projectcalico.org created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">customresourcedefinition.apiextensions.k8s.io/ipamconfigs.crd.projectcalico.org created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">customresourcedefinition.apiextensions.k8s.io/ipamhandles.crd.projectcalico.org created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">customresourcedefinition.apiextensions.k8s.io/ippools.crd.projectcalico.org created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">customresourcedefinition.apiextensions.k8s.io/kubecontrollersconfigurations.crd.projectcalico.org created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">customresourcedefinition.apiextensions.k8s.io/networkpolicies.crd.projectcalico.org created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">customresourcedefinition.apiextensions.k8s.io/networksets.crd.projectcalico.org created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterrole.rbac.authorization.k8s.io/calico-kube-controllers created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterrolebinding.rbac.authorization.k8s.io/calico-kube-controllers created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterrole.rbac.authorization.k8s.io/calico-node created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterrolebinding.rbac.authorization.k8s.io/calico-node created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">daemonset.apps/calico-node created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">serviceaccount/calico-node created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment.apps/calico-kube-controllers created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">serviceaccount/calico-kube-controllers created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.查看资源状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl get pod -n kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                      READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">calico-kube-controllers-97769f7c7-bnwcl   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          11m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">calico-node-mghdj                         </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          11m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3</span><span class="token plain">.查看master节点的状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl get </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME          STATUS   ROLES    AGE   VERSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k8s-master1   Ready    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">   99m   v1.20.4</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="8部署kubernetes-node节点">8.部署kubernetes node节点<a href="#8部署kubernetes-node节点" class="hash-link" aria-label="Direct link to 8.部署kubernetes node节点" title="Direct link to 8.部署kubernetes node节点">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="81解压二进制文件复制相关组件程序">8.1.解压二进制文件复制相关组件程序<a href="#81解压二进制文件复制相关组件程序" class="hash-link" aria-label="Direct link to 8.1.解压二进制文件复制相关组件程序" title="Direct link to 8.1.解压二进制文件复制相关组件程序">​</a></h3><p>以下操作仅在node1节点操作即可。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.准备二进制程序</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> xf kubernetes-server-linux-amd64.tar.gz </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> -p /data/kubernetes/</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">bin,config,ssl,logs</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> kubernetes/server/bin/</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">kubelet,kube-proxy</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> /data/kubernetes/bin/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> kubernetes/server/bin/kubectl /usr/bin/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.将master节点上的证书文件拷贝至node节点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">scp</span><span class="token plain"> -rp /data/kubernetes/ssl/* binary-k8s-node1:/data/kubernetes/ssl/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">scp</span><span class="token plain"> -rp /data/kubernetes/config/token.csv root@binary-k8s-node1:/data/kubernetes/config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3</span><span class="token plain">.删除从master节点上拷贝过来的kubelet证书</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">rm</span><span class="token plain"> -rf /data/kubernetes/ssl/kubelet-client-*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#kubelet证书需要删除，当node节点的kubelet启动后会生成临时证书文件，当master授权通过后，证书文件产生</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="82部署kubelet组件">8.2.部署kubelet组件<a href="#82部署kubelet组件" class="hash-link" aria-label="Direct link to 8.2.部署kubelet组件" title="Direct link to 8.2.部署kubelet组件">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="821创建kubelet配置文件">8.2.1.创建kubelet配置文件<a href="#821创建kubelet配置文件" class="hash-link" aria-label="Direct link to 8.2.1.创建kubelet配置文件" title="Direct link to 8.2.1.创建kubelet配置文件">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /data/kubernetes/config/kubelet.conf </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">KUBELET_OPTS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;--logtostderr=false \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--v=2 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--log-dir=/data/kubernetes/logs \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--hostname-override=binary-k8s-node1        #注意修改节点名称 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--network-plugin=cni \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--kubeconfig=/data/kubernetes/config/kubelet.kubeconfig \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--bootstrap-kubeconfig=/data/kubernetes/config/bootstrap.kubeconfig \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--config=/data/kubernetes/config/kubelet-config.yml \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--cert-dir=/data/kubernetes/ssl \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--pod-infra-container-image=pause-amd64:3.0&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="822创建kubelet参数配置文件">8.2.2.创建kubelet参数配置文件<a href="#822创建kubelet参数配置文件" class="hash-link" aria-label="Direct link to 8.2.2.创建kubelet参数配置文件" title="Direct link to 8.2.2.创建kubelet参数配置文件">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /data/kubernetes/config/kubelet-config.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: KubeletConfiguration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: kubelet.config.k8s.io/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">address: </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">port: </span><span class="token number" style="color:#36acaa">10250</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">readOnlyPort: </span><span class="token number" style="color:#36acaa">10255</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cgroupDriver: cgroupfs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterDNS:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- </span><span class="token number" style="color:#36acaa">10.0</span><span class="token plain">.0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterDomain: cluster.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">failSwapOn: </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">authentication:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  anonymous:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enabled: </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  webhook:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cacheTTL: 2m0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enabled: </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  x509:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    clientCAFile: /data/kubernetes/ssl/ca.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">authorization:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mode: Webhook</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  webhook:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cacheAuthorizedTTL: 5m0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cacheUnauthorizedTTL: 30s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">evictionHard:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  imagefs.available: </span><span class="token number" style="color:#36acaa">15</span><span class="token plain">%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  memory.available: 100Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nodefs.available: </span><span class="token number" style="color:#36acaa">10</span><span class="token plain">%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nodefs.inodesFree: </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">maxOpenFiles: </span><span class="token number" style="color:#36acaa">1000000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">maxPods: </span><span class="token number" style="color:#36acaa">110</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="823创建bootstrap-kubeconfig文件">8.2.3.创建bootstrap-kubeconfig文件<a href="#823创建bootstrap-kubeconfig文件" class="hash-link" aria-label="Direct link to 8.2.3.创建bootstrap-kubeconfig文件" title="Direct link to 8.2.3.创建bootstrap-kubeconfig文件">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.在kubeconfig文件中增加集群apiserver信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl config set-cluster kubernetes </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--certificate-authority</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/ssl/ca.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--embed-certs</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--server</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;https://192.168.20.10:6443&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--kubeconfig</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/config/bootstrap.kubeconfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.在kubeconfig文件中增加token信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl config set-credentials </span><span class="token string" style="color:#e3116c">&quot;kubelet-bootstrap&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--token</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">d7f96b0d86c574d0f64a713608db0922 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--kubeconfig</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/config/bootstrap.kubeconfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#这个token就是之前生成的/data/kubernetes/config/token.csv中的token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3</span><span class="token plain">.在kubeconfig文件中增加用户信息 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl config set-context default </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--cluster</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">kubernetes </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--user</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;kubelet-bootstrap&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--kubeconfig</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/config/bootstrap.kubeconfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">4</span><span class="token plain">.指定生成的kubeconfig文件为集群使用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl config use-context default --kubeconfig</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/config/bootstrap.kubeconfig</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="824创建systemctl脚本并启动服务">8.2.4.创建systemctl脚本并启动服务<a href="#824创建systemctl脚本并启动服务" class="hash-link" aria-label="Direct link to 8.2.4.创建systemctl脚本并启动服务" title="Direct link to 8.2.4.创建systemctl脚本并启动服务">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.编写systemctl服务脚本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /usr/lib/systemd/system/kubelet.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Unit</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Description</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">Kubernetes Kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">After</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">docker.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">EnvironmentFile</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/config/kubelet.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ExecStart</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/bin/kubelet </span><span class="token variable" style="color:#36acaa">$KUBELET_OPTS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Restart</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">on-failure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">LimitNOFILE</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">65536</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Install</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">WantedBy</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">multi-user.target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.启动kubelet服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl daemon-reload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl start kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl </span><span class="token builtin class-name">enable</span><span class="token plain"> kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl status kubelet</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="825master节点授权同意node节点加入集群">8.2.5.master节点授权同意node节点加入集群<a href="#825master节点授权同意node节点加入集群" class="hash-link" aria-label="Direct link to 8.2.5.master节点授权同意node节点加入集群" title="Direct link to 8.2.5.master节点授权同意node节点加入集群">​</a></h4><p>kubelet服务启动后，会生成一个临时证书文件，然后向master节点发送一个csr授权请求，当master节点授权同意后，kubelet-clinet证书文件生成，端口也随之启动，节点正常加入集群。</p><p>csr列表的授权信息也会自动清空，如果master节点的授权不及时，也可以重启一下kubelet重新发送一个csr请求。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.在node节点查看临时证书文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># ll /data/kubernetes/ssl/*.tmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-------. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root  </span><span class="token number" style="color:#36acaa">227</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token plain">:28 kubelet-client.key.tmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#只要kubelet启动就会产生一个临时证书文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.在master节点查看csr授权请求列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl get csr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                                   AGE    SIGNERNAME                                    REQUESTOR           CONDITION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node-csr-JmO7N8iDvyD0D-2Pu7_yHJ3ngZ5xXfA_TwRevqmHAXI   11s    kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3</span><span class="token plain">.授权通过</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl certificate approve node-csr-JmO7N8iDvyD0D-2Pu7_yHJ3ngZ5xXfA_TwRevqmHAXI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">certificatesigningrequest.certificates.k8s.io/node-csr-JmO7N8iDvyD0D-2Pu7_yHJ3ngZ5xXfA_TwRevqmHAXI approved</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">4</span><span class="token plain">.此时临时文件已删除，已经生成kubelet证书文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># ll /data/kubernetes/ssl/kubelet-client*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-------. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root </span><span class="token number" style="color:#36acaa">1236</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token plain">:28 kubelet-client-2021-09-06-11-28-54.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lrwxrwxrwx. </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> root root   </span><span class="token number" style="color:#36acaa">59</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">月   </span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token plain">:28 kubelet-client-current.pem -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> /data/kubernetes/ssl/kubelet-client-2021-09-06-11-28-54.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">5</span><span class="token plain">.node1节点成功加入集群</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl get </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                 STATUS   ROLES    AGE     VERSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">binary-k8s-master1   Ready    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">   2d22h   v1.20.4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">binary-k8s-node1     Ready    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">   4h59m   v1.20.4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">6</span><span class="token plain">.在node节点查看kubelet服务的端口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">netstat</span><span class="token plain"> -lnpt </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcp        </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1:10248         </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0:*               LISTEN      </span><span class="token number" style="color:#36acaa">29220</span><span class="token plain">/kubelet       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcp        </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1:44151         </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0:*               LISTEN      </span><span class="token number" style="color:#36acaa">29220</span><span class="token plain">/kubelet       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcp6       </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> :::10250                :::*                    LISTEN      </span><span class="token number" style="color:#36acaa">29220</span><span class="token plain">/kubelet       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcp6       </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> :::10255                :::*                    LISTEN      </span><span class="token number" style="color:#36acaa">29220</span><span class="token plain">/kubelet</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="83部署kube-proxy组件">8.3.部署kube-proxy组件<a href="#83部署kube-proxy组件" class="hash-link" aria-label="Direct link to 8.3.部署kube-proxy组件" title="Direct link to 8.3.部署kube-proxy组件">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="831创建kube-proxy配置文件">8.3.1.创建kube-proxy配置文件<a href="#831创建kube-proxy配置文件" class="hash-link" aria-label="Direct link to 8.3.1.创建kube-proxy配置文件" title="Direct link to 8.3.1.创建kube-proxy配置文件">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /data/kubernetes/config/kube-proxy.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">KUBE_PROXY_OPTS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;--logtostderr=false \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--v=2 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--log-dir=/data/kubernetes/logs \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--config=/data/kubernetes/config/kube-proxy-config.yml&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="832创建kube-proxy参数配置文件">8.3.2.创建kube-proxy参数配置文件<a href="#832创建kube-proxy参数配置文件" class="hash-link" aria-label="Direct link to 8.3.2.创建kube-proxy参数配置文件" title="Direct link to 8.3.2.创建kube-proxy参数配置文件">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /data/kubernetes/config/kube-proxy-config.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: KubeProxyConfiguration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bindAddress: </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0                                    </span><span class="token comment" style="color:#999988;font-style:italic">#监听地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metricsBindAddress: </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0:10249                           </span><span class="token comment" style="color:#999988;font-style:italic">#监听端口</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clientConnection:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kubeconfig: /data/kubernetes/config/kube-proxy.kubeconfig         </span><span class="token comment" style="color:#999988;font-style:italic">#kubeconfig文件用于和apiserver通信</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hostnameOverride: binary-k8s-node1              </span><span class="token comment" style="color:#999988;font-style:italic">#当前节点名称</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterCIDR: </span><span class="token number" style="color:#36acaa">10.244</span><span class="token plain">.0.0/16</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="833生成kube-config文件">8.3.3.生成kube-config文件<a href="#833生成kube-config文件" class="hash-link" aria-label="Direct link to 8.3.3.生成kube-config文件" title="Direct link to 8.3.3.生成kube-config文件">​</a></h4><p>由于kube-proxy的证书文件在8.1中已经从master节点拷贝到node节点了，因此直接生成kubeconfig文件即可。</p><p>集群中不同节点的组件都要用同一个证书文件。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.生成kubeconfig文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#在kubeconfig文件中增加集群apiserver信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl config set-cluster kubernetes </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--certificate-authority</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/ssl/ca.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--embed-certs</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--server</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;https://192.168.20.10:6443&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--kubeconfig</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/config/kube-proxy.kubeconfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#在kubeconfig文件中增加证书文件信息 </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl config set-credentials kube-proxy </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--client-certificate</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/ssl/kube-proxy.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--client-key</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/ssl/kube-proxy-key.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--embed-certs</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--kubeconfig</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/config/kube-proxy.kubeconfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#在kubeconfig文件中增加用户信息 </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl config set-context default </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--cluster</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">kubernetes </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--user</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">kube-proxy </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--kubeconfig</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/config/kube-proxy.kubeconfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.指定生成的kubeconfig文件为集群使用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl config use-context default --kubeconfig</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/config/kube-proxy.kubeconfig</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="834创建systemctl脚本管理服务">8.3.4.创建systemctl脚本管理服务<a href="#834创建systemctl脚本管理服务" class="hash-link" aria-label="Direct link to 8.3.4.创建systemctl脚本管理服务" title="Direct link to 8.3.4.创建systemctl脚本管理服务">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /usr/lib/systemd/system/kube-proxy.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Unit</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Description</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">Kubernetes Proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">After</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">network.target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">EnvironmentFile</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/config/kube-proxy.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ExecStart</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/data/kubernetes/bin/kube-proxy </span><span class="token variable" style="color:#36acaa">$KUBE_PROXY_OPTS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Restart</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">on-failure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">LimitNOFILE</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">65536</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Install</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">WantedBy</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">multi-user.targ</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="835启动kube-proxy组件">8.3.5.启动kube-proxy组件<a href="#835启动kube-proxy组件" class="hash-link" aria-label="Direct link to 8.3.5.启动kube-proxy组件" title="Direct link to 8.3.5.启动kube-proxy组件">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.启动服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl daemon-reload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl start kube-proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl </span><span class="token builtin class-name">enable</span><span class="token plain"> kube-proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.查看端口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">netstat</span><span class="token plain"> -lnpt </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> kube-proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcp6       </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> :::10249                :::*                    LISTEN      </span><span class="token number" style="color:#36acaa">26954</span><span class="token plain">/kube-proxy    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcp6       </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> :::10256                :::*                    LISTEN      </span><span class="token number" style="color:#36acaa">26954</span><span class="token plain">/kube-proxy  </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="84快速增加新的node节点">8.4.快速增加新的node节点<a href="#84快速增加新的node节点" class="hash-link" aria-label="Direct link to 8.4.快速增加新的node节点" title="Direct link to 8.4.快速增加新的node节点">​</a></h3><p>二进制部署的程序特别好的一个地方就在于，能够快速部署一个新的服务，做法就是直接拷贝已经部署好的目录到一个新的位置，改改其中的参数即可启动使用了。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="841将kubelet和kube-proxy目录拷贝至新的node节点">8.4.1.将kubelet和kube-proxy目录拷贝至新的node节点<a href="#841将kubelet和kube-proxy目录拷贝至新的node节点" class="hash-link" aria-label="Direct link to 8.4.1.将kubelet和kube-proxy目录拷贝至新的node节点" title="Direct link to 8.4.1.将kubelet和kube-proxy目录拷贝至新的node节点">​</a></h4><p>要拷贝kubelet和kube-proxy部署目录以及systemctl启动脚本文件。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">scp</span><span class="token plain"> -rp /data/kubernetes root@binary-k8s-node2:/data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">scp</span><span class="token plain"> /usr/lib/systemd/system/kube* root@binary-k8s-node2:/usr/lib/systemd/system/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="842配置并启动kubelet组件">8.4.2.配置并启动kubelet组件<a href="#842配置并启动kubelet组件" class="hash-link" aria-label="Direct link to 8.4.2.配置并启动kubelet组件" title="Direct link to 8.4.2.配置并启动kubelet组件">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.删除没用的证书文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">rm</span><span class="token plain"> -rf /data/kubernetes/ssl/kubelet-client-*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.修改kubelet配置文件中的节点名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /data/kubernetes/config/kubelet.conf </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">KUBELET_OPTS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;--logtostderr=false \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--v=2 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--log-dir=/data/kubernetes/logs \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--hostname-override=binary-k8s-node2 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--network-plugin=cni \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--kubeconfig=/data/kubernetes/config/kubelet.kubeconfig \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--bootstrap-kubeconfig=/data/kubernetes/config/bootstrap.kubeconfig \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--config=/data/kubernetes/config/kubelet-config.yml \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--cert-dir=/data/kubernetes/ssl \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">--pod-infra-container-image=pause-amd64:3.0&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#将--hostname-override值修改为当前节点名称即可</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3</span><span class="token plain">.启动kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl daemon-reload </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl start kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl </span><span class="token builtin class-name">enable</span><span class="token plain"> kubelet</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="843master节点授权新node节点的请求">8.4.3.master节点授权新node节点的请求<a href="#843master节点授权新node节点的请求" class="hash-link" aria-label="Direct link to 8.4.3.master节点授权新node节点的请求" title="Direct link to 8.4.3.master节点授权新node节点的请求">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.master节点查看授权信息列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl get csr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                                   AGE   SIGNERNAME                                    REQUESTOR           CONDITION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node-csr-u_AHUS7T5rku-hnhnGsGi8uGBqlgMquOq_3oq6jrOyE   48s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.授权通过node节点的kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl certificate approve node-csr-u_AHUS7T5rku-hnhnGsGi8uGBqlgMquOq_3oq6jrOyE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">certificatesigningrequest.certificates.k8s.io/node-csr-u_AHUS7T5rku-hnhnGsGi8uGBqlgMquOq_3oq6jrOyE approved</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3</span><span class="token plain">.成功加入集群</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl get </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                 STATUS   ROLES    AGE     VERSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">binary-k8s-master1   Ready    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">   2d23h   v1.20.4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">binary-k8s-node1     Ready    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">   5h54m   v1.20.4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">binary-k8s-node2     Ready    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">   1s      v1.20.4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">4</span><span class="token plain">.查看kubelet的端口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">netstat</span><span class="token plain"> -lnpt </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> kube</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcp        </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1:41121         </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0:*               LISTEN      </span><span class="token number" style="color:#36acaa">16694</span><span class="token plain">/kubelet       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcp        </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1:10248         </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0:*               LISTEN      </span><span class="token number" style="color:#36acaa">16694</span><span class="token plain">/kubelet       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcp6       </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> :::10250                :::*                    LISTEN      </span><span class="token number" style="color:#36acaa">16694</span><span class="token plain">/kubelet       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcp6       </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> :::10255                :::*                    LISTEN      </span><span class="token number" style="color:#36acaa">16694</span><span class="token plain">/kubelet</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="844配置并启动kube-proxy组件">8.4.4.配置并启动kube-proxy组件<a href="#844配置并启动kube-proxy组件" class="hash-link" aria-label="Direct link to 8.4.4.配置并启动kube-proxy组件" title="Direct link to 8.4.4.配置并启动kube-proxy组件">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.修改kube-proxy参数配置文件中的主机名</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /data/kubernetes/config/kube-proxy-config.yml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: KubeProxyConfiguration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bindAddress: </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metricsBindAddress: </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0:10249</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clientConnection:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kubeconfig: /data/kubernetes/config/kube-proxy.kubeconfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hostnameOverride: binary-k8s-node2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterCIDR: </span><span class="token number" style="color:#36acaa">10.244</span><span class="token plain">.0.0/16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.启动kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl daemon-reload </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl start kube-proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl </span><span class="token builtin class-name">enable</span><span class="token plain"> kube-proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3</span><span class="token plain">查看kube-proxy端口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">netstat</span><span class="token plain"> -lnpt </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> kube</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcp        </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1:41121         </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0:*               LISTEN      </span><span class="token number" style="color:#36acaa">16694</span><span class="token plain">/kubelet       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcp        </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1:10248         </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0:*               LISTEN      </span><span class="token number" style="color:#36acaa">16694</span><span class="token plain">/kubelet       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcp6       </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> :::10249                :::*                    LISTEN      </span><span class="token number" style="color:#36acaa">20410</span><span class="token plain">/kube-proxy    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcp6       </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> :::10250                :::*                    LISTEN      </span><span class="token number" style="color:#36acaa">16694</span><span class="token plain">/kubelet       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcp6       </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> :::10255                :::*                    LISTEN      </span><span class="token number" style="color:#36acaa">16694</span><span class="token plain">/kubelet       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcp6       </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> :::10256                :::*                    LISTEN      </span><span class="token number" style="color:#36acaa">20410</span><span class="token plain">/kube-proxy</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="9为集群部署coredns组件">9.为集群部署coredns组件<a href="#9为集群部署coredns组件" class="hash-link" aria-label="Direct link to 9.为集群部署coredns组件" title="Direct link to 9.为集群部署coredns组件">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="91部署coredns组件">9.1.部署coredns组件<a href="#91部署coredns组件" class="hash-link" aria-label="Direct link to 9.1.部署coredns组件" title="Direct link to 9.1.部署coredns组件">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.coredns.yaml文件内容</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> coredns.yaml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Warning: This is a file generated from the base underscore template file: coredns.yaml.base</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: ServiceAccount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: coredns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      kubernetes.io/cluster-service: </span><span class="token string" style="color:#e3116c">&quot;true&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      addonmanager.kubernetes.io/mode: Reconcile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: rbac.authorization.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: ClusterRole</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubernetes.io/bootstrapping: rbac-defaults</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    addonmanager.kubernetes.io/mode: Reconcile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: system:coredns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- apiGroups:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - endpoints</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - pods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - namespaces</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  verbs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - </span><span class="token function" style="color:#d73a49">watch</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- apiGroups:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  verbs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - get</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: rbac.authorization.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: ClusterRoleBinding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rbac.authorization.kubernetes.io/autoupdate: </span><span class="token string" style="color:#e3116c">&quot;true&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubernetes.io/bootstrapping: rbac-defaults</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    addonmanager.kubernetes.io/mode: EnsureExists</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: system:coredns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">roleRef:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  apiGroup: rbac.authorization.k8s.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kind: ClusterRole</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: system:coredns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">subjects:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- kind: ServiceAccount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: coredns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: ConfigMap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: coredns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      addonmanager.kubernetes.io/mode: EnsureExists</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Corefile: </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .:53 </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        errors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        health </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            lameduck 5s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kubernetes cluster.local in-addr.arpa ip6.arpa </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pods insecure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            fallthrough in-addr.arpa ip6.arpa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ttl </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        prometheus :9153</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        forward </span><span class="token builtin class-name">.</span><span class="token plain"> /etc/resolv.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cache </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        loop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        reload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        loadbalance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: coredns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    k8s-app: kube-dns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubernetes.io/cluster-service: </span><span class="token string" style="color:#e3116c">&quot;true&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    addonmanager.kubernetes.io/mode: Reconcile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubernetes.io/name: </span><span class="token string" style="color:#e3116c">&quot;CoreDNS&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># replicas: not specified here:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 1. In order to make Addon Manager do not reconcile this replicas parameter.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 2. Default is 1.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 3. Will be tuned in real time if DNS horizontal auto-scaling is turned on.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  strategy:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type: RollingUpdate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rollingUpdate:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      maxUnavailable: </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      k8s-app: kube-dns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        k8s-app: kube-dns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        seccomp.security.alpha.kubernetes.io/pod: </span><span class="token string" style="color:#e3116c">&#x27;runtime/default&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      priorityClassName: system-cluster-critical</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      serviceAccountName: coredns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      tolerations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - key: </span><span class="token string" style="color:#e3116c">&quot;CriticalAddonsOnly&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          operator: </span><span class="token string" style="color:#e3116c">&quot;Exists&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      nodeSelector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kubernetes.io/os: linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: coredns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        image: coredns:1.6.7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        imagePullPolicy: IfNotPresent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          limits:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            memory: 512Mi </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          requests:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cpu: 100m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            memory: 70Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        args: </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;-conf&quot;</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">&quot;/etc/coredns/Corefile&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        volumeMounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: config-volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          mountPath: /etc/coredns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          readOnly: </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - containerPort: </span><span class="token number" style="color:#36acaa">53</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          name: dns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          protocol: UDP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - containerPort: </span><span class="token number" style="color:#36acaa">53</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          name: dns-tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          protocol: TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - containerPort: </span><span class="token number" style="color:#36acaa">9153</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          name: metrics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          protocol: TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        livenessProbe:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          httpGet:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            path: /health</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            port: </span><span class="token number" style="color:#36acaa">8080</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            scheme: HTTP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          initialDelaySeconds: </span><span class="token number" style="color:#36acaa">60</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          timeoutSeconds: </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          successThreshold: </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          failureThreshold: </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        readinessProbe:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          httpGet:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            path: /ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            port: </span><span class="token number" style="color:#36acaa">8181</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            scheme: HTTP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        securityContext:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          allowPrivilegeEscalation: </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          capabilities:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            add:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - NET_BIND_SERVICE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            drop:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - all</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          readOnlyRootFilesystem: </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      dnsPolicy: Default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      volumes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: config-volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          configMap:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            name: coredns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            items:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - key: Corefile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              path: Corefile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: kube-dns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    prometheus.io/port: </span><span class="token string" style="color:#e3116c">&quot;9153&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    prometheus.io/scrape: </span><span class="token string" style="color:#e3116c">&quot;true&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    k8s-app: kube-dns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubernetes.io/cluster-service: </span><span class="token string" style="color:#e3116c">&quot;true&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    addonmanager.kubernetes.io/mode: Reconcile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubernetes.io/name: </span><span class="token string" style="color:#e3116c">&quot;CoreDNS&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    k8s-app: kube-dns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  clusterIP: </span><span class="token number" style="color:#36acaa">10.0</span><span class="token plain">.0.2 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - name: dns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    port: </span><span class="token number" style="color:#36acaa">53</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protocol: UDP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - name: dns-tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    port: </span><span class="token number" style="color:#36acaa">53</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protocol: TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - name: metrics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    port: </span><span class="token number" style="color:#36acaa">9153</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protocol: TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.部署coredns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl apply -f coredns.yaml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">serviceaccount/coredns created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterrole.rbac.authorization.k8s.io/system:coredns created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterrolebinding.rbac.authorization.k8s.io/system:coredns created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">configmap/coredns created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment.apps/coredns created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/kube-dns created</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="92运行一个busybox容器测试dns">9.2.运行一个busybox容器测试dns<a href="#92运行一个busybox容器测试dns" class="hash-link" aria-label="Direct link to 9.2.运行一个busybox容器测试dns" title="Direct link to 9.2.运行一个busybox容器测试dns">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl run -it --rm dns-test --image</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">busybox:1.28.4 </span><span class="token function" style="color:#d73a49">sh</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">If you don&#x27;t see a </span><span class="token builtin class-name">command</span><span class="token plain"> prompt, try pressing enter.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/ </span><span class="token comment" style="color:#999988;font-style:italic"># nslookup kubernetes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Server:    </span><span class="token number" style="color:#36acaa">10.0</span><span class="token plain">.0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Address </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">: </span><span class="token number" style="color:#36acaa">10.0</span><span class="token plain">.0.2 kube-dns.kube-system.svc.cluster.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name:      kubernetes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Address </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">: </span><span class="token number" style="color:#36acaa">10.0</span><span class="token plain">.0.1 kubernetes.default.svc.cluster.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/ </span><span class="token comment" style="color:#999988;font-style:italic"># nslookup kube-dns.kube-system</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Server:    </span><span class="token number" style="color:#36acaa">10.0</span><span class="token plain">.0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Address </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">: </span><span class="token number" style="color:#36acaa">10.0</span><span class="token plain">.0.2 kube-dns.kube-system.svc.cluster.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name:      kube-dns.kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Address </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">: </span><span class="token number" style="color:#36acaa">10.0</span><span class="token plain">.0.2 kube-dns.kube-system.svc.cluster.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/ </span><span class="token comment" style="color:#999988;font-style:italic"># exit</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="10扩容master节点组建kubernetes高可用集群">10.扩容master节点组建kubernetes高可用集群<a href="#10扩容master节点组建kubernetes高可用集群" class="hash-link" aria-label="Direct link to 10.扩容master节点组建kubernetes高可用集群" title="Direct link to 10.扩容master节点组建kubernetes高可用集群">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="101kubernetes高可用架构概念">10.1.kubernetes高可用架构概念<a href="#101kubernetes高可用架构概念" class="hash-link" aria-label="Direct link to 10.1.kubernetes高可用架构概念" title="Direct link to 10.1.kubernetes高可用架构概念">​</a></h3><p>kubernetes集群通过健康检查和重启策略实现了Pod故障自愈能力，也通过调度算法实现将Pod分布式部署，并可以通过设置Pod的副本数，实现高并发能力，即使Node节点出现故障，Master节点也会将故障的Node节点上的Pod迁移到正常工作的Node节点上，实现应用层的高可用性</p><p>针对Kubernetes集群，高可用性包括Etcd数据库高可用、Matser节点组件的高可用，Etcd可以通过集群方式实现高可用，而只有单台Master节点，一旦Master节点上的组件出现了故障，整个集群将会不可用。</p><p>Master节点是属于控制整个集群的角色，所有的组件都需要与Master节点的ApiServer进行交互，不断与Node节点上的Kubelet和Kube-Proxy进行通信来维护整个集群的工作状态，如果ApiServer发生故障，将无法与Node节点进行通信，也就无法管理集群。</p><p>因此Kubernetes集群最主要的就是对Master节点进行高可用配置。</p><p>Master节点主要有三个服务：kube-apiserver、kube-controller-manage、kube-scheduler，当集群有多台Master节点时，其中kube-controller-manage和kube-scheduler都可以通过自身的选举机制实现高可用，但是kube-apiserver就没有这种机制，因此主要针对kube-apiserver配置高可用即可，kube-apiserver提供的是HTTP API接口服务，因此可以像web服务那种，使用nginx+keepalived方式实现Master节点高可用，并且也可以水平扩容。</p><p>配置kubernetes集群高可用的主要步骤就是：</p><p> 1、增加一台或多台Master节点，部署Master节点相关组件，在这个master节点上配置的监听地址还是自身的地址；</p><p> 2、在新增的Master节点上部署etcd，使etcd加入现有的etcd集群，使etcd的性能更强；</p><p> 3、配置nginx+keepalived实现Apiserver组件高可用；</p><p> 4、配置所有的Node节点，将所配置的Apiserver地址改成keepalived虚拟出来的VIP地址，实现集群高可用；</p><p>高可用kubernetes集群一般3台master节点足矣，但是etcd数据库一定要多多益善</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="102在集群中新增一个etcd节点">10.2.在集群中新增一个etcd节点<a href="#102在集群中新增一个etcd节点" class="hash-link" aria-label="Direct link to 10.2.在集群中新增一个etcd节点" title="Direct link to 10.2.在集群中新增一个etcd节点">​</a></h3><p>扩容etcd步骤：</p><p> 1、部署一台单节点的etcd，能够正常启动服务</p><p> 2、在现有etcd集群中增加新的etcd节点</p><p> 3、将单点的etcd配置成集群模式</p><p> 4、删除单点造成的数据文件</p><p> 5、所有节点修改配置文件增加新的etcd节点信息</p><p> 6、重启所有etcd节点</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1021首先新增加一台单点的etcd">10.2.1.首先新增加一台单点的etcd<a href="#1021首先新增加一台单点的etcd" class="hash-link" aria-label="Direct link to 10.2.1.首先新增加一台单点的etcd" title="Direct link to 10.2.1.首先新增加一台单点的etcd">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.安装etcd程序</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> xf etcd-v3.4.9-linux-amd64.tar.gz </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> /data/etcd/</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">bin,conf,ssl,data</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> -p</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">mv</span><span class="token plain"> etcd-v3.4.9-linux-amd64/etcd* /data/etcd/bin/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.创建单点配置文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /data/etcd/conf/etcd.conf </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#[Service]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_NAME</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;etcd-4&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_DATA_DIR</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;/data/etcd/data&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_LISTEN_PEER_URLS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;https://192.168.20.11:2380&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_LISTEN_CLIENT_URLS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;https://192.168.20.11:2379,http://127.0.0.1:2379&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#[cluster]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;https://192.168.20.11:2380&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_ADVERTISE_CLIENT_URLS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;https://192.168.20.11:2379,http://127.0.0.1:2379&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_INITIAL_CLUSTER</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;etcd-4=https://192.168.20.11:2380&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_INITIAL_CLUSTER_STATE</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;new&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">4</span><span class="token plain">.拷贝证书文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">scp</span><span class="token plain"> root@192.168.20.10:/data/etcd/ssl/* /data/etcd/ssl/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">5</span><span class="token plain">.拷贝systemctl管理脚本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">scp</span><span class="token plain"> root@192.168.20.10:/usr/lib/systemd/system/etcd.service /usr/lib/systemd/system/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">6</span><span class="token plain">.启动etcd服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl daemon-reload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">#  systemctl start etcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">7</span><span class="token plain">.查看端口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">netstat</span><span class="token plain"> -lnpt </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> etcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcp        </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.20.11:2379      </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0:*               LISTEN      </span><span class="token number" style="color:#36acaa">15753</span><span class="token plain">/etcd          </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcp        </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1:2379          </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0:*               LISTEN      </span><span class="token number" style="color:#36acaa">15753</span><span class="token plain">/etcd          </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcp        </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.20.11:2380      </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0:*               LISTEN      </span><span class="token number" style="color:#36acaa">15753</span><span class="token plain">/etcd </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">8</span><span class="token plain">.查看节点状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># /data/etcd/bin/etcdctl endpoint health --write-out</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----------------+--------+------------+-------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    ENDPOINT    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> HEALTH </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    TOOK    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> ERROR </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----------------+--------+------------+-------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1:2379 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">   </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">7</span><span class="token plain">.146222ms </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">       </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----------------+--------+------------+-------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1022在现有etcd集群任意一个节点上增加新etcd节点">10.2.2.在现有etcd集群任意一个节点上增加新etcd节点<a href="#1022在现有etcd集群任意一个节点上增加新etcd节点" class="hash-link" aria-label="Direct link to 10.2.2.在现有etcd集群任意一个节点上增加新etcd节点" title="Direct link to 10.2.2.在现有etcd集群任意一个节点上增加新etcd节点">​</a></h4><blockquote><p>增加节点的命令为：<code>/data/etcd/bin/etcdctl member add 节点名称 --peer-urls=&quot;通信地址&quot;</code></p></blockquote><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.增加etcd-4节点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># /data/etcd/bin/etcdctl member </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> etcd-4 --peer-urls</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;https://192.168.20.11:2380&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Member aae107adddd0d3d8 added to cluster 20b119eb5f91aa4b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_NAME</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;etcd-4&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_INITIAL_CLUSTER</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;etcd-2=https://192.168.20.12:2380,etcd-1=https://192.168.20.10:2380,etcd-3=https://192.168.20.13:2380,etcd-4=https://192.168.20.11:2380&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;https://192.168.20.11:2380&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_INITIAL_CLUSTER_STATE</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;existing&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#输出的配置信息一定要在新的etcd-4节点的配置文件写入，否则会加入集群失败</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.查看集群节点列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># /data/etcd/bin/etcdctl member list --write-out</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+------------------+-----------+--------+----------------------------+--------------------------------------------------+------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain">        ID        </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">  STATUS   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">  NAME  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">         PEER ADDRS         </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">                   CLIENT ADDRS                   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> IS LEARNER </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+------------------+-----------+--------+----------------------------+--------------------------------------------------+------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> 12446003b2a53d43 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">   started </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> etcd-2 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> https://192.168.20.12:2380 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> http://127.0.0.1:2379,https://192.168.20.12:2379 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">      </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> 51ae3f86f3783687 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">   started </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> etcd-1 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> https://192.168.20.10:2380 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> http://127.0.0.1:2379,https://192.168.20.10:2379 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">      </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> 667c9c7ba890c3f7 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">   started </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> etcd-3 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> https://192.168.20.13:2380 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> http://127.0.0.1:2379,https://192.168.20.13:2379 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">      </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> aae107adddd0d3d8 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> unstarted </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">        </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> https://192.168.20.11:2380 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">                                                  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">      </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+------------------+-----------+--------+----------------------------+--------------------------------------------------+------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#发现刚刚新加入的etcd-4节点处于unstarted状态，我们需要再配置etcd-4节点使用能够加入集群</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1023配置新增的etcd节点加入集群">10.2.3.配置新增的etcd节点加入集群<a href="#1023配置新增的etcd节点加入集群" class="hash-link" aria-label="Direct link to 10.2.3.配置新增的etcd节点加入集群" title="Direct link to 10.2.3.配置新增的etcd节点加入集群">​</a></h4><p>在已有集群增加完新节点之后，还需要将新的etcd节点配置文件增加集群相关属性，然后删除由单点时造成的etcd数据文件，最后在所有节点的配置文件中增加新节点的通信地址，重启所有节点的etcd服务，到此扩容成功。</p><p>主要在新的etcd节点中配置ETCD<!-- -->_<!-- -->NAME、ETCD<!-- -->_<!-- -->INITIAL<!-- -->_<!-- -->CLUSTER、ETCD<!-- -->_<!-- -->INITIAL<!-- -->_<!-- -->CLUSTER<!-- -->_<!-- -->TOKEN、ETCD<!-- -->_<!-- -->INITIAL<!-- -->_<!-- -->CLUSTER<!-- -->_<!-- -->STATE这三个参数。</p><p>ETCD<!-- -->_<!-- -->NAME：集群节点名称</p><p>ETCD<!-- -->_<!-- -->INITIAL<!-- -->_<!-- -->CLUSTER：由单点的一个节点信息改成集群所有节点的信息</p><p>ETCD<!-- -->_<!-- -->INITIAL<!-- -->_<!-- -->CLUSTER<!-- -->_<!-- -->TOKEN：填写集群的唯一标识，表示加入哪个etcd集群</p><p>ETCD<!-- -->_<!-- -->INITIAL<!-- -->_<!-- -->CLUSTER<!-- -->_<!-- -->STATE：集群状态调整为加入已存在的集群</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.修改etcd配置文件，增加集群配置参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /data/etcd/conf/etcd.conf </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#[Service]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_NAME</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;etcd-4&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_DATA_DIR</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;/data/etcd/data&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_LISTEN_PEER_URLS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;https://192.168.20.11:2380&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_LISTEN_CLIENT_URLS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;https://192.168.20.11:2379,http://127.0.0.1:2379&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#[cluster]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;https://192.168.20.11:2380&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_ADVERTISE_CLIENT_URLS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;https://192.168.20.11:2379,http://127.0.0.1:2379&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_INITIAL_CLUSTER</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;etcd-2=https://192.168.20.12:2380,etcd-1=https://192.168.20.10:2380,etcd-3=https://192.168.20.13:2380,etcd-4=https://192.168.20.11:2380&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_INITIAL_CLUSTER_TOKEN</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;etcd-cluster&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_INITIAL_CLUSTER_STATE</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;existing&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.删除由单点时产生的数据文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#如果不删除，加入集群时会失败</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">rm</span><span class="token plain"> -rf /data/etcd/data/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3</span><span class="token plain">.所有etcd的配置文件中增加新节点的通信地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">注意：所有etcd节点的配置文件都要增加这一行配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /data/etcd/conf/etcd.conf </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCD_INITIAL_CLUSTER</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;etcd-1=https://192.168.20.10:2380,etcd-2=https://192.168.20.12:2380,etcd-3=https://192.168.20.13:2380,etcd-4=https://192.168.20.11:2380&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">4</span><span class="token plain">.重启所有节点的ectd服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl restart etcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl restart etcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl restart etcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl restart etcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">5</span><span class="token plain">.再次查看集群的节点信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># /data/etcd/bin/etcdctl member list --write-out</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+------------------+---------+--------+----------------------------+--------------------------------------------------+------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain">        ID        </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> STATUS  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">  NAME  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">         PEER ADDRS         </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">                   CLIENT ADDRS                   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> IS LEARNER </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+------------------+---------+--------+----------------------------+--------------------------------------------------+------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> 12446003b2a53d43 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> started </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> etcd-2 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> https://192.168.20.12:2380 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> http://127.0.0.1:2379,https://192.168.20.12:2379 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">      </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> 51ae3f86f3783687 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> started </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> etcd-1 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> https://192.168.20.10:2380 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> http://127.0.0.1:2379,https://192.168.20.10:2379 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">      </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> 667c9c7ba890c3f7 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> started </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> etcd-3 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> https://192.168.20.13:2380 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> http://127.0.0.1:2379,https://192.168.20.13:2379 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">      </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> aae107adddd0d3d8 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> started </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> etcd-4 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> https://192.168.20.11:2380 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> http://127.0.0.1:2379,https://192.168.20.11:2379 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">      </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+------------------+---------+--------+----------------------------+--------------------------------------------------+------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#etcd到此扩容成功</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1024配置kube-apiserver增加新的etcd节点">10.2.4.配置kube-apiserver增加新的etcd节点<a href="#1024配置kube-apiserver增加新的etcd节点" class="hash-link" aria-label="Direct link to 10.2.4.配置kube-apiserver增加新的etcd节点" title="Direct link to 10.2.4.配置kube-apiserver增加新的etcd节点">​</a></h4><p>etcd节点新增完，需要配置下kube-apiserver组件，增加新的etcd节点信息。</p><p>注意所有k8s master节点都必须修改配置kube-apiserver.conf文件增加新的etcd节点，否则etcd也不会为k8s所用。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.master节点修改配置文件增加新的etcd节点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /data/kubernetes/config/kube-apiserver.conf </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">······</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--etcd-servers</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">https://192.168.20.10:2379,https://192.168.20.12:2379,https://192.168.20.13:2379,https://192.168.20.11:2379 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">······</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.重启apiserver组件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl restart kube-apiserver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3</span><span class="token plain">.查看组件信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl get cs -o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Warning: v1 ComponentStatus is deprecated </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> v1.19+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                 STATUS    MESSAGE             ERROR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">controller-manager   Healthy   ok                  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scheduler            Healthy   ok                  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcd-2               Healthy   </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;true&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcd-0               Healthy   </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;true&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcd-3               Healthy   </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;true&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcd-1               Healthy   </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;true&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">   </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="103部署master-2节点">10.3.部署master-2节点<a href="#103部署master-2节点" class="hash-link" aria-label="Direct link to 10.3.部署master-2节点" title="Direct link to 10.3.部署master-2节点">​</a></h3><p>由于所有组件都是二进制方式部署的，因此可以在master1上将目录直接拷贝至master2上即可使用。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1031部署docker">10.3.1.部署docker<a href="#1031部署docker" class="hash-link" aria-label="Direct link to 10.3.1.部署docker" title="Direct link to 10.3.1.部署docker">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.安装docker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> xf docker-19.03.9.tgz </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> docker/* /usr/bin/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.拷贝master1节点上的docker配置文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">scp</span><span class="token plain"> -rp root@binary-k8s-master1:/etc/docker /etc/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3</span><span class="token plain">.拷贝master1节点上的docker systemctl脚本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">scp</span><span class="token plain"> -rp root@binary-k8s-master1:/usr/lib/systemd/system/docker.service /usr/lib/systemd/system/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">4</span><span class="token plain">.启动docker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl daemon-reload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl start </span><span class="token function" style="color:#d73a49">docker</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl </span><span class="token builtin class-name">enable</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">docker</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1032部署kubernetes各个组件">10.3.2.部署kubernetes各个组件<a href="#1032部署kubernetes各个组件" class="hash-link" aria-label="Direct link to 10.3.2.部署kubernetes各个组件" title="Direct link to 10.3.2.部署kubernetes各个组件">​</a></h4><p>由于是二进制部署，直接拷贝master1节点上的/data/kubernetes目录即可，/data/kubernetes目录下包含了所有的master以及node相关组件</p><p>master节点需要安装所有的master组件和node组件。</p><p><strong>1.准备二进制程序</strong></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.拷贝组件文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">scp</span><span class="token plain"> -rp /data/kubernetes root@binary-k8s-master2:/data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">scp</span><span class="token plain"> /usr/bin/kubectl root@binary-k8s-master2:/usr/bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">scp</span><span class="token plain"> -rp /usr/lib/systemd/system/kube* root@binary-k8s-master2:/usr/lib/systemd/system/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">scp</span><span class="token plain"> -rp .kube root@binary-k8s-master2:/root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.如果没有扩容新的etcd节点的情况需要拷贝etcd证书</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">scp</span><span class="token plain"> -rp /data/etcd/ssl root@binary-k8s-master2:/data/etcd/ss</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3</span><span class="token plain">.删除kubelet文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#kubelet某些问题都是动态生成的，且每个节点都不相同，因此需要删除重新生成</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">rm</span><span class="token plain"> -rf /data/kubernetes/config/kubelet.kubeconfig </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">rm</span><span class="token plain"> -rf /data/kubernetes/ssl/kubelet-client-*</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>2.修改各个组件的配置文件</strong></p><p>主要就是修改各个组件监听的本机ip地址和节点名称，生成的kubeconfig文件中的apiserver地址无需更改，保持master1即可，因为最后高可用的时候还是会改成VIP地址，当前无需更改。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.修改kube-apiserver配置文件中的IP地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /data/kubernetes/config/kube-apiserver.conf </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">······</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--bind-address</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.20.11  </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--advertise-address</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.20.11 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">······</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.修改kube-controller-manager配置文件中的IP地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /data/kubernetes/config/kube-controller-manager.conf </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">······</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--bind-address</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.20.11 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">······</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3</span><span class="token plain">.修改kube-scheduler配置文件中的IP地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /data/kubernetes/config/kube-scheduler.conf </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">······</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--bind-address</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.20.11&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">······</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">4</span><span class="token plain">.修改kubelet配置文件中的IP地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /data/kubernetes/config/kubelet.conf </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">······</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--hostname-override</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">binary-k8s-master2 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">······</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">5</span><span class="token plain">.修改kube-apiserver配置文件中的IP地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /data/kubernetes/config/kube-proxy-config.yml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">······</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hostnameOverride: binary-k8s-master2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">······</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>3.启动各个组件</strong></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl daemon-reload </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl start kube-apiserver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl start kube-controller-manager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl start kube-scheduler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl start kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl start kube-proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl </span><span class="token builtin class-name">enable</span><span class="token plain"> kube-apiserver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl </span><span class="token builtin class-name">enable</span><span class="token plain"> kube-controller-manager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl </span><span class="token builtin class-name">enable</span><span class="token plain"> kube-scheduler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl </span><span class="token builtin class-name">enable</span><span class="token plain"> kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl </span><span class="token builtin class-name">enable</span><span class="token plain"> kube-proxy</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1033授权master2节点加入集群">10.3.3.授权master2节点加入集群<a href="#1033授权master2节点加入集群" class="hash-link" aria-label="Direct link to 10.3.3.授权master2节点加入集群" title="Direct link to 10.3.3.授权master2节点加入集群">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.查看授权新系列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl get csr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                                   AGE     SIGNERNAME                                    REQUESTOR           CONDITION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node-csr-fgCu0hUU4sK9-jaLzl8n-H4MVWi314NhzYssddgThOE   4m45s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.授权通过</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl certificate approve node-csr-fgCu0hUU4sK9-jaLzl8n-H4MVWi314NhzYssddgThOE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">certificatesigningrequest.certificates.k8s.io/node-csr-fgCu0hUU4sK9-jaLzl8n-H4MVWi314NhzYssddgThOE approved</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3</span><span class="token plain">.查看是否加入集群</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl get </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                 STATUS   ROLES    AGE     VERSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">binary-k8s-master1   Ready    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">   4d21h   v1.20.4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">binary-k8s-master2   Ready    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">   4m33s   v1.20.4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">binary-k8s-node1     Ready    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">   2d3h    v1.20.4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">binary-k8s-node2     Ready    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">   45h     v1.20.4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">4</span><span class="token plain">.查看核心组件状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl get cs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Warning: v1 ComponentStatus is deprecated </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> v1.19+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                 STATUS    MESSAGE             ERROR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">controller-manager   Healthy   ok                  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scheduler            Healthy   ok                  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcd-1               Healthy   </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;true&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcd-2               Healthy   </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;true&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcd-0               Healthy   </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;true&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">   </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="104部署nginxkeepalived实现kubernetes高可用集群">10.4.部署Nginx+Keepalived实现kubernetes高可用集群<a href="#104部署nginxkeepalived实现kubernetes高可用集群" class="hash-link" aria-label="Direct link to 10.4.部署Nginx+Keepalived实现kubernetes高可用集群" title="Direct link to 10.4.部署Nginx+Keepalived实现kubernetes高可用集群">​</a></h3><p>keepalived是主流的高可用软件，基于VIP绑定实现服务器的双机热备，可以理解为keepalived是针对服务器IP的高可用集群，如果A机器宕机了，B机器会立刻成为master角色，抢占VIP地址，使其不间断的提供服务，从而形成高可用集群。</p><p>使用nginx+keepalived做得k8s master节点高可用集群，只要master节点上面没有etcd组件，那么整个集群master节点只要有一个工作正常，整个集群就不会宕机。</p><p>生产环境中nginx+keepalived是独立于集群之外的两台服务器，高可用集群一般情况下都是一主一备，两个节点就可以满足正常需求，正好master节点有2个，可以在两个master上都部署nginx和keepalived形成高可用集群。</p><p>我们采用nginx四层负载均衡，四层负载均衡的作用就是对IP进行负载，不涉及应用层，由于我们使用keepalived做高可用集群，keepalived就是针对IP地址实现高可用，因此需要配合nginx四层负载均衡来实现，当用户访问keepalived的VIP时，直接将请求转发到对应的master角色主机上，将VIP地址转换成master节点IP+端口，这样一来，即使master1挂掉了，master2成为了master角色，请求转发进来，也会将VIP转换成master2节点的地址，高可用也就实现了。</p><p><strong>kube-apiserver高可用架构图</strong></p><p><img loading="lazy" src="https://cdn.agou-ops.cn/others/4166bf6696044bc1b4f47efb7cf03acd.png" alt="在这里插入图片描述" class="img_ev3q"></p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1041部署nginx负载均衡">10.4.1.部署Nginx负载均衡<a href="#1041部署nginx负载均衡" class="hash-link" aria-label="Direct link to 10.4.1.部署Nginx负载均衡" title="Direct link to 10.4.1.部署Nginx负载均衡">​</a></h4><p>master1和master2上的nginx部署和配置文件内容一样，这里只写master1的操作步骤。</p><p>nginx负载均衡采用四层负载。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.安装nginx和keepalived及nginx四层负载均衡模块等软件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">#  yum -y </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> nginx keepalived nginx-mod-stream</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.修改nginx主配置文件增加include模块引入4层负载配置文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /etc/nginx/nginx.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">include /etc/nginx/conf.c/*.conf</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic">#17行左右，与http模块同级</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3</span><span class="token plain">.编写配置文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> /etc/nginx/conf.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /etc/nginx/conf.c/k8s-apiserver.conf </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stream </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log_format  main  </span><span class="token string" style="color:#e3116c">&#x27;$remote_addr $upstream_addr - [$time_local] $status $upstream_bytes_sent&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    access_log /var/log/nginx/k8s-apiserver.log main</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    upstream k8s-apiserver </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        server </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.20.11:6443</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        server </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.20.12:6443</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    server </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        listen </span><span class="token number" style="color:#36acaa">16443</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic">#由于我们的nginx与k8s master在同一台机器上，防止端口冲突，因此改为16443端口</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        proxy_pass k8s-apiserver</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">4</span><span class="token plain">.启动nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># nginx -t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nginx: the configuration </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> /etc/nginx/nginx.conf syntax is ok</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nginx: configuration </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> /etc/nginx/nginx.conf </span><span class="token builtin class-name">test</span><span class="token plain"> is successful</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">5</span><span class="token plain">.查看端口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">netstat</span><span class="token plain"> -lnpt </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcp        </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0:16443           </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0:*               LISTEN      </span><span class="token number" style="color:#36acaa">3181</span><span class="token plain">/nginx: worker </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1042部署keepalived双机热备">10.4.2.部署keepalived双机热备<a href="#1042部署keepalived双机热备" class="hash-link" aria-label="Direct link to 10.4.2.部署keepalived双机热备" title="Direct link to 10.4.2.部署keepalived双机热备">​</a></h4><p>在配置keepalived的时候也需要配置一个<strong>vrrp<!-- -->_<!-- -->script</strong>模块，keepalived只能做到对网络故障和keepalived本身的监控，即当出现网络故障或者keepalived本身出现问题时，进行切换。但是这些还不够，我们还需要监控keepalived所在服务器上的其他业务进程，比如说nginx，keepalived+nginx实现nginx的负载均衡高可用，如果nginx异常，仅仅keepalived保持正常，是无法完成系统的正常工作的，因此需要根据业务进程的运行状态决定是否需要进行主备切换。这个时候，我们可以通过编写脚本对nginx进程进行检测监控。</p><p><strong>1.MASTER节点部署</strong></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.安装keepalived</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">#  yum -y </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> keepalived</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.配置keepalived</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /etc/keepalived/keepalived.conf </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">global_defs </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   notification_email </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     acassen@firewall.loc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     failover@firewall.loc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     sysadmin@firewall.loc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   notification_email_from Alexandre.Cassen@firewall.loc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   smtp_server </span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   smtp_connect_timeout </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   router_id NGINX_MASTER</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vrrp_script check_nginx </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">               </span><span class="token comment" style="color:#999988;font-style:italic">#定义健康检查脚本</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    script </span><span class="token string" style="color:#e3116c">&quot;/etc/keepalived/check_nginx.sh&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vrrp_instance VI_1 </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    state MASTER                    </span><span class="token comment" style="color:#999988;font-style:italic">#状态为MASTER</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    interface ens192                </span><span class="token comment" style="color:#999988;font-style:italic">#将VIP绑定在哪块网卡上</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    virtual_router_id </span><span class="token number" style="color:#36acaa">51</span><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">#实例ID，集群所有节点都要保持一致</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    priority </span><span class="token number" style="color:#36acaa">100</span><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic">#优先级，255最高</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    advert_int </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic">#指定VRRP心跳包通告间隔时间，默认1秒</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    authentication </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auth_type PASS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auth_pass </span><span class="token number" style="color:#36acaa">1111</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    virtual_ipaddress </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.20.9/23                 </span><span class="token comment" style="color:#999988;font-style:italic">#定义VIP地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    track_script </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        check_nginx                 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3</span><span class="token plain">.编写检查nginx状态的检查脚本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#当nginx异常时，自动将当前主机的keepalived进程关闭，使BACKUP上的keepalived成为MASTER继续提供服务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /etc/keepalived/check_nginx.sh </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">nginx_ch</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">`</span><span class="token variable function" style="color:#d73a49">netstat</span><span class="token variable" style="color:#36acaa"> -lnpt </span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable function" style="color:#d73a49">grep</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable number" style="color:#36acaa">16443</span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable function" style="color:#d73a49">egrep</span><span class="token variable" style="color:#36acaa"> -cv </span><span class="token variable function" style="color:#d73a49">grep</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$nginx_ch</span><span class="token plain"> -eq </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    systemctl stop keepalived</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">exit</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">exit</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">4</span><span class="token plain">.启动keepalived</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl start keepalived</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl </span><span class="token builtin class-name">enable</span><span class="token plain"> keepalived</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">5</span><span class="token plain">.查看VIP地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">ip</span><span class="token plain"> a </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> ens192</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">: ens192: </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">BROADCAST,MULTICAST,UP,LOWER_UP</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> mtu </span><span class="token number" style="color:#36acaa">1500</span><span class="token plain"> qdisc mq state UP group default qlen </span><span class="token number" style="color:#36acaa">1000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inet </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.20.10/23 brd </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.21.255 scope global noprefixroute ens192</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inet </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.20.9/23 scope global secondary ens192</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#VIP已经准备就绪</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>2.BACKUP节点部署</strong></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.安装keepalived</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">#  yum -y </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> keepalived</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.配置keepalived</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /etc/keepalived/keepalived.conf </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">global_defs </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   notification_email </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     acassen@firewall.loc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     failover@firewall.loc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     sysadmin@firewall.loc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   notification_email_from Alexandre.Cassen@firewall.loc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   smtp_server </span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   smtp_connect_timeout </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   router_id NGINX_MASTER</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vrrp_script check_nginx </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    script </span><span class="token string" style="color:#e3116c">&quot;/etc/keepalived/check_nginx.sh&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vrrp_instance VI_1 </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    state BACKUP                </span><span class="token comment" style="color:#999988;font-style:italic">#状态为BACKUP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    interface ens192</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    virtual_router_id </span><span class="token number" style="color:#36acaa">51</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    priority </span><span class="token number" style="color:#36acaa">90</span><span class="token plain">             </span><span class="token comment" style="color:#999988;font-style:italic">#优先级要比MASTER低</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    advert_int </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    authentication </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auth_type PASS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auth_pass </span><span class="token number" style="color:#36acaa">1111</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    virtual_ipaddress </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.20.9/23</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    track_script </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        check_nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3</span><span class="token plain">.编写检查nginx状态的检查脚本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#当nginx异常时，自动将当前主机的keepalived进程关闭，使BACKUP上的keepalived成为MASTER继续提供服务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /etc/keepalived/check_nginx.sh </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">nginx_ch</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">`</span><span class="token variable function" style="color:#d73a49">netstat</span><span class="token variable" style="color:#36acaa"> -lnpt </span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable function" style="color:#d73a49">grep</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable number" style="color:#36acaa">16443</span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable function" style="color:#d73a49">egrep</span><span class="token variable" style="color:#36acaa"> -cv </span><span class="token variable function" style="color:#d73a49">grep</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$nginx_ch</span><span class="token plain"> -eq </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    systemctl stop keepalived</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">exit</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">exit</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">4</span><span class="token plain">.启动keepalived</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl start keepalived</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl </span><span class="token builtin class-name">enable</span><span class="token plain"> keepalived</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1043使用vip访问kubernetes服务">10.4.3.使用VIP访问kubernetes服务<a href="#1043使用vip访问kubernetes服务" class="hash-link" aria-label="Direct link to 10.4.3.使用VIP访问kubernetes服务" title="Direct link to 10.4.3.使用VIP访问kubernetes服务">​</a></h4><p>可以正确获取到K8s版本信息，说明负载均衡器搭建正常。该请求数据流程：curl -&gt; vip(nginx) -&gt; apiserver。</p><p>日志中也会记录访问记录。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -k https://192.168.20.9:16443/version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;major&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;1&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;minor&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;20&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;gitVersion&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;v1.20.4&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;gitCommit&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;e87da0bd6e03ec3fea7933c4b5263d151aafd07c&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;gitTreeState&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;clean&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;buildDate&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;2021-02-18T16:03:00Z&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;goVersion&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;go1.15.8&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;compiler&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;gc&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;platform&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;linux/amd64&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">tail</span><span class="token plain"> -f /var/log/nginx/k8s-apiserver.log </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1 </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.20.11:6443 - </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">09/Sep/2021:11:28:15 +0800</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">200</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">79</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1 </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.20.11:6443 - </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">09/Sep/2021:11:28:20 +0800</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">200</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">178</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.20.10 </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.20.11:6443 - </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">09/Sep/2021:15:20:29 +0800</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">200</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">178</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.20.10 </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.20.12:6443, </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.20.11:6443 - </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">09/Sep/2021:16:19:00 +0800</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">200</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">, </span><span class="token number" style="color:#36acaa">420</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1044测试keepalived高可用">10.4.4.测试keepalived高可用<a href="#1044测试keepalived高可用" class="hash-link" aria-label="Direct link to 10.4.4.测试keepalived高可用" title="Direct link to 10.4.4.测试keepalived高可用">​</a></h4><p><strong>1.停掉master1上的keepalived，查看VIP是否会切换到master2节点</strong></p><p><img loading="lazy" src="https://cdn.agou-ops.cn/others/dba9f62a2a0744c3b3ccc86981ad86a4.png" alt="在这里插入图片描述" class="img_ev3q"></p><p><strong>2.重新启动master1上的keepalived，查看VIP是否会自动切换到master1</strong></p><p><img loading="lazy" src="https://cdn.agou-ops.cn/others/54cdc63de7c040519287127263385c0c.png" alt="在这里插入图片描述" class="img_ev3q"></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="105切换kubernetes集群为高可用模式">10.5.切换kubernetes集群为高可用模式<a href="#105切换kubernetes集群为高可用模式" class="hash-link" aria-label="Direct link to 10.5.切换kubernetes集群为高可用模式" title="Direct link to 10.5.切换kubernetes集群为高可用模式">​</a></h3><p>虽然我们增加了Master2 Node和负载均衡器，但是我们是从单Master架构扩容的，也就是说目前所有的Worker Node组件连接都还是Master1 Node，如果不改为连接VIP走负载均衡器，那么Master还是单点故障。</p><p>由于已经可以通过keepalived的VIP地址访问到apiserver，高可用效果已达成，目前只需要将集群的所有节点（kubectl get node）能看到的一切节点，将配置文件中的apiserver的地址换成VIP地址加端口，才能真正的实现kubernetes高可用。</p><p>之前前期使用VIP测试kube-apiserver没问题，即使在切换高可用的情况下，所有节点也不会处于NotReady状态。</p><p><strong>1.切换高可用环境</strong></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.binary-k8s-master1节点切换</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> -ri </span><span class="token string" style="color:#e3116c">&#x27;s#192.168.20.10:6443#192.168.20.9:16443#&#x27;</span><span class="token plain"> /data/kubernetes/config/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> -ri </span><span class="token string" style="color:#e3116c">&#x27;s#192.168.20.10:6443#192.168.20.9:16443#&#x27;</span><span class="token plain"> /root/.kube/config </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl restart  kube-controller-manager kube-scheduler kubelet kube-proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.binary-k8s-master2切换</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> -ri </span><span class="token string" style="color:#e3116c">&#x27;s#192.168.20.10:6443#192.168.20.9:16443#&#x27;</span><span class="token plain"> /data/kubernetes/config/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> -ri </span><span class="token string" style="color:#e3116c">&#x27;s#192.168.20.10:6443#192.168.20.9:16443#&#x27;</span><span class="token plain"> /root/.kube/config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl restart  kube-controller-manager kube-scheduler kubelet kube-proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3</span><span class="token plain">.binary-k8s-node1切换</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> -ri </span><span class="token string" style="color:#e3116c">&#x27;s#192.168.20.10:6443#192.168.20.9:16443#&#x27;</span><span class="token plain"> /data/kubernetes/config/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl restart kubelet kube-proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">4</span><span class="token plain">.binary-k8s-node2切换</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> -ri </span><span class="token string" style="color:#e3116c">&#x27;s#192.168.20.10:6443#192.168.20.9:16443#&#x27;</span><span class="token plain"> /data/kubernetes/config/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-node2 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># systemctl restart kubelet kube-proxy</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>2.查看集群状态及资源</strong></p><p>到此为止kubernetes高可用集群实现完毕</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl get </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                 STATUS   ROLES    AGE     VERSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">binary-k8s-master1   Ready    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">   5d22h   v1.20.4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">binary-k8s-master2   Ready    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">   25h     v1.20.4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">binary-k8s-node1     Ready    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">   3d5h    v1.20.4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">binary-k8s-node2     Ready    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">   2d23h   v1.20.4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl get cs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Warning: v1 ComponentStatus is deprecated </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> v1.19+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                 STATUS    MESSAGE             ERROR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">controller-manager   Healthy   ok                  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scheduler            Healthy   ok                  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcd-0               Healthy   </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;true&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcd-1               Healthy   </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;true&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcd-2               Healthy   </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;true&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="11测试kubernetes高可用集群">11.测试kubernetes高可用集群<a href="#11测试kubernetes高可用集群" class="hash-link" aria-label="Direct link to 11.测试kubernetes高可用集群" title="Direct link to 11.测试kubernetes高可用集群">​</a></h2><p><strong>1.停掉master1上的keepalived验证集群是否可用</strong></p><p>状态：“ok”</p><p><img loading="lazy" src="https://cdn.agou-ops.cn/others/c146811a76994c2eb7ecea1a95bae2ab.png" alt="在这里插入图片描述" class="img_ev3q"></p><p><strong>2.停掉master1上所有k8s组件验证集群是否可用</strong></p><p>状态：“ok”</p><p><img loading="lazy" src="https://cdn.agou-ops.cn/others/a5cfe03d354441798591ae5add26898e.png" alt="在这里插入图片描述" class="img_ev3q"></p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="12在kubernetes集群运行一套服务验证集群的可用性">12.在kubernetes集群运行一套服务验证集群的可用性<a href="#12在kubernetes集群运行一套服务验证集群的可用性" class="hash-link" aria-label="Direct link to 12.在kubernetes集群运行一套服务验证集群的可用性" title="Direct link to 12.在kubernetes集群运行一套服务验证集群的可用性">​</a></h2><p>简单部署一个基于nginx的web服务。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="121创建资源yaml文件">12.1.创建资源yaml文件<a href="#121创建资源yaml文件" class="hash-link" aria-label="Direct link to 12.1.创建资源yaml文件" title="Direct link to 12.1.创建资源yaml文件">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> know-system.yaml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: deploy-know-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replicas: </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      app: know-system-pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        app: know-system-pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: know-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        image: know-system:v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - containerPort: </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      nodeName: binary-k8s-master1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: know-system-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app: know-system-pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type: NodePort</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - port: </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    targetPort: </span><span class="token number" style="color:#36acaa">80</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="122创建资源并进行测试">12.2.创建资源并进行测试<a href="#122创建资源并进行测试" class="hash-link" aria-label="Direct link to 12.2.创建资源并进行测试" title="Direct link to 12.2.创建资源并进行测试">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl apply -f know-system.yaml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment.apps/deploy-know-system created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/know-system-service created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl get pod,svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                     READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/deploy-know-system-b4c9c55d7-5mf2f   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          47s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/deploy-know-system-b4c9c55d7-97ckx   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          48s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/deploy-know-system-b4c9c55d7-kb97t   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          47s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                          TYPE        CLUSTER-IP   EXTERNAL-IP   PORT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">S</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">        AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/know-system-service   NodePort    </span><span class="token number" style="color:#36acaa">10.0</span><span class="token plain">.0.38    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">:32702/TCP   47s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/kubernetes            ClusterIP   </span><span class="token number" style="color:#36acaa">10.0</span><span class="token plain">.0.1     </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">443</span><span class="token plain">/TCP        10d</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>访问https://集群任意节点+32702端口即可浏览web服务。</p><p><img loading="lazy" src="https://cdn.agou-ops.cn/others/8c7dc7f2aad14d74a07b8ab6c35e09a9.png" alt="在这里插入图片描述" class="img_ev3q"></p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="13部署kubernetes-dashboard">13.部署kubernetes dashboard<a href="#13部署kubernetes-dashboard" class="hash-link" aria-label="Direct link to 13.部署kubernetes dashboard" title="Direct link to 13.部署kubernetes dashboard">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="131部署dashboard">13.1.部署dashboard<a href="#131部署dashboard" class="hash-link" aria-label="Direct link to 13.1.部署dashboard" title="Direct link to 13.1.部署dashboard">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token plain">.部署yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl apply -f kubernetes-dashboard.yaml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">namespace/kubernetes-dashboard created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">serviceaccount/kubernetes-dashboard created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/kubernetes-dashboard created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">secret/kubernetes-dashboard-certs created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">secret/kubernetes-dashboard-csrf created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">secret/kubernetes-dashboard-key-holder created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">configmap/kubernetes-dashboard-settings created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">role.rbac.authorization.k8s.io/kubernetes-dashboard created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterrole.rbac.authorization.k8s.io/kubernetes-dashboard created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment.apps/kubernetes-dashboard created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/dashboard-metrics-scraper created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment.apps/dashboard-metrics-scraper created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.创建授权账号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl create serviceaccount dashboard-admin -n kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">serviceaccount/dashboard-admin created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl create clusterrolebinding dashboard-admin --clusterrole</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">cluster-admin --serviceaccount</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">kube-system:dashboard-admin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterrolebinding.rbac.authorization.k8s.io/dashboard-admin created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3</span><span class="token plain">.查看登陆使用的token字符串</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl describe secrets -n kube-system </span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">kubectl -n kube-system get secret </span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable function" style="color:#d73a49">awk</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">&#x27;/dashboard-admin/{print $1}&#x27;</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name:         dashboard-admin-token-lnm2r</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Namespace:    kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Labels:       </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Annotations:  kubernetes.io/service-account.name: dashboard-admin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              kubernetes.io/service-account.uid: 73b370c9-b1b4-4418-b02d-fee9b6cf6342</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Type:  kubernetes.io/service-account-token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IkgwWGJXQ1duVVI4eFh4Ykw2U25JVk9fa2hDOGZVRTRRMVZyVmdwWXM1Nk0ifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkYXNoYm9hcmQtYWRtaW4tdG9rZW4tbG5tMnIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGFzaGJvYXJkLWFkbWluIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiNzNiMzcwYzktYjFiNC00NDE4LWIwMmQtZmVlOWI2Y2Y2MzQyIiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmUtc3lzdGVtOmRhc2hib2FyZC1hZG1pbiJ9.XWJLZDB7mNk_NNpXVv64LrbKy5f1hB2PS5qER5YFATzl3U9ISX05PCrnCEY-6uVSbPkRGZbTQZTBwiGjOfsyLZljvY3cbmGlH2oW2shUS8LDqli4MKA14JyUX1ubbQ8vq9uSqkQMCQBzZTUGIuZt95jw3-IMv2rfZ9ET8_uVuXIoZXbckY6VHFy8QOB6sy1n9j0j4qcOttyKHVXN8Q5KjsIlb44Y5HtiveKxpw_LA81eTwml_aiVvO9rgMKVdSHIg8CY1Mcp06ezz0kD0jsBLt7xaAujSNZnCiXzmpg51xujbR0k-4BVlwPBBpQLaSWGoHR3X7z5E02onXttbbX6-w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ca.crt:     </span><span class="token number" style="color:#36acaa">1359</span><span class="token plain"> bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">namespace:  </span><span class="token number" style="color:#36acaa">11</span><span class="token plain"> bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">4</span><span class="token plain">.查看pod的状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@binary-k8s-master1 ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># kubectl get pod,svc -n kubernetes-dashboard</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                             READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/dashboard-metrics-scraper-7445d59dfd-bg9c8   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          8m51s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/kubernetes-dashboard-5ddcdf9c99-nkgqw        </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          8m52s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                TYPE        CLUSTER-IP   EXTERNAL-IP   PORT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">S</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">         AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/dashboard-metrics-scraper   ClusterIP   </span><span class="token number" style="color:#36acaa">10.0</span><span class="token plain">.0.83    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">8000</span><span class="token plain">/TCP        8m52s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/kubernetes-dashboard        NodePort    </span><span class="token number" style="color:#36acaa">10.0</span><span class="token plain">.0.153   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">443</span><span class="token plain">:30001/TCP   8m53s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="132访问dashboard">13.2.访问dashboard<a href="#132访问dashboard" class="hash-link" aria-label="Direct link to 13.2.访问dashboard" title="Direct link to 13.2.访问dashboard">​</a></h3><p>访问https://集群任意节点+30001端口，然后填写刚刚查到的token值，点击登陆。</p><p><img loading="lazy" src="https://cdn.agou-ops.cn/others/2c6c6346e8854ffcb85a23d3569c056e.png" alt="在这里插入图片描述" class="img_ev3q"></p><p>仪表盘</p><p><img loading="lazy" src="https://cdn.agou-ops.cn/others/f2dfdb9364bb4b0e875851131d711e34.png" alt="在这里插入图片描述" class="img_ev3q"></p><blockquote><p>⚠️转载自：<a href="https://jiangxl.blog.csdn.net/article/details/120428703" target="_blank" rel="noopener noreferrer">https://jiangxl.blog.csdn.net/article/details/120428703</a></p><p>仅略作修改。</p></blockquote></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/AGou-ops/myDocsv4/edit/main/docs/CloudNative/k8s/Installation/Kubernetes 二进制安装.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/CloudNative/k8s/Installation/Kubeadm 快速部署手册"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Kubeadm 快速部署手册</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/CloudNative/k8s/Installation/k8s Debian12二进制安装"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">k8s Debian12二进制安装</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1环境准备" class="table-of-contents__link toc-highlight">1.环境准备</a><ul><li><a href="#11kubernetes高可用集群部署方式" class="table-of-contents__link toc-highlight">1.1.Kubernetes高可用集群部署方式</a></li><li><a href="#12kubernetes集群弃用docker容器" class="table-of-contents__link toc-highlight">1.2.Kubernetes集群弃用docker容器</a></li><li><a href="#13kubernetes集群所需的证书" class="table-of-contents__link toc-highlight">1.3.Kubernetes集群所需的证书</a></li><li><a href="#14环境准备" class="table-of-contents__link toc-highlight">1.4.环境准备</a></li><li><a href="#15安装cfssl证书生成工具" class="table-of-contents__link toc-highlight">1.5.安装cfssl证书生成工具</a></li></ul></li><li><a href="#2操作系统初始化配置" class="table-of-contents__link toc-highlight">2.操作系统初始化配置</a></li><li><a href="#3部署etcd集群" class="table-of-contents__link toc-highlight">3.部署Etcd集群</a><ul><li><a href="#31使用cfssl证书工具生成etcd证书" class="table-of-contents__link toc-highlight">3.1.使用cfssl证书工具生成etcd证书</a></li><li><a href="#32部署etcd集群" class="table-of-contents__link toc-highlight">3.2.部署etcd集群</a></li></ul></li><li><a href="#4部署docker服务" class="table-of-contents__link toc-highlight">4.部署Docker服务</a><ul><li><a href="#41安装docker" class="table-of-contents__link toc-highlight">4.1.安装docker</a></li><li><a href="#42为docker创建systemctl启动脚本" class="table-of-contents__link toc-highlight">4.2.为docker创建systemctl启动脚本</a></li></ul></li><li><a href="#5部署kubernetes-master节点" class="table-of-contents__link toc-highlight">5.部署kubernetes master节点</a><ul><li><a href="#51使用cfssl生成apiserver的证书文件" class="table-of-contents__link toc-highlight">5.1.使用cfssl生成apiserver的证书文件</a></li><li><a href="#52解压二进制文件复制相关组件程序" class="table-of-contents__link toc-highlight">5.2.解压二进制文件复制相关组件程序</a></li><li><a href="#53部署kube-apiserver组件" class="table-of-contents__link toc-highlight">5.3.部署kube-apiserver组件</a></li><li><a href="#54部署kube-controller-manage组件" class="table-of-contents__link toc-highlight">5.4.部署kube-controller-manage组件</a></li><li><a href="#55部署kube-scheduler组件" class="table-of-contents__link toc-highlight">5.5.部署kube-scheduler组件</a></li><li><a href="#56准备kubectl所需的kubeconfig文件连接集群" class="table-of-contents__link toc-highlight">5.6.准备kubectl所需的kubeconfig文件连接集群</a></li></ul></li><li><a href="#6在master节点部署node节点相关组件" class="table-of-contents__link toc-highlight">6.在master节点部署node节点相关组件</a><ul><li><a href="#61在集群授权kubelet-bootstrap用户允许请求证书" class="table-of-contents__link toc-highlight">6.1.在集群授权kubelet-bootstrap用户允许请求证书</a></li><li><a href="#62在master节点部署kubelet组件" class="table-of-contents__link toc-highlight">6.2.在master节点部署kubelet组件</a></li><li><a href="#63在master节点部署kube-proxy" class="table-of-contents__link toc-highlight">6.3.在master节点部署kube-proxy</a></li><li><a href="#64授权apiserver访问kubelet" class="table-of-contents__link toc-highlight">6.4.授权apiserver访问kubelet</a></li></ul></li><li><a href="#7部署kubernetes-calico网络组件" class="table-of-contents__link toc-highlight">7.部署kubernetes calico网络组件</a></li><li><a href="#8部署kubernetes-node节点" class="table-of-contents__link toc-highlight">8.部署kubernetes node节点</a><ul><li><a href="#81解压二进制文件复制相关组件程序" class="table-of-contents__link toc-highlight">8.1.解压二进制文件复制相关组件程序</a></li><li><a href="#82部署kubelet组件" class="table-of-contents__link toc-highlight">8.2.部署kubelet组件</a></li><li><a href="#83部署kube-proxy组件" class="table-of-contents__link toc-highlight">8.3.部署kube-proxy组件</a></li><li><a href="#84快速增加新的node节点" class="table-of-contents__link toc-highlight">8.4.快速增加新的node节点</a></li></ul></li><li><a href="#9为集群部署coredns组件" class="table-of-contents__link toc-highlight">9.为集群部署coredns组件</a><ul><li><a href="#91部署coredns组件" class="table-of-contents__link toc-highlight">9.1.部署coredns组件</a></li><li><a href="#92运行一个busybox容器测试dns" class="table-of-contents__link toc-highlight">9.2.运行一个busybox容器测试dns</a></li></ul></li><li><a href="#10扩容master节点组建kubernetes高可用集群" class="table-of-contents__link toc-highlight">10.扩容master节点组建kubernetes高可用集群</a><ul><li><a href="#101kubernetes高可用架构概念" class="table-of-contents__link toc-highlight">10.1.kubernetes高可用架构概念</a></li><li><a href="#102在集群中新增一个etcd节点" class="table-of-contents__link toc-highlight">10.2.在集群中新增一个etcd节点</a></li><li><a href="#103部署master-2节点" class="table-of-contents__link toc-highlight">10.3.部署master-2节点</a></li><li><a href="#104部署nginxkeepalived实现kubernetes高可用集群" class="table-of-contents__link toc-highlight">10.4.部署Nginx+Keepalived实现kubernetes高可用集群</a></li><li><a href="#105切换kubernetes集群为高可用模式" class="table-of-contents__link toc-highlight">10.5.切换kubernetes集群为高可用模式</a></li></ul></li><li><a href="#11测试kubernetes高可用集群" class="table-of-contents__link toc-highlight">11.测试kubernetes高可用集群</a></li><li><a href="#12在kubernetes集群运行一套服务验证集群的可用性" class="table-of-contents__link toc-highlight">12.在kubernetes集群运行一套服务验证集群的可用性</a><ul><li><a href="#121创建资源yaml文件" class="table-of-contents__link toc-highlight">12.1.创建资源yaml文件</a></li><li><a href="#122创建资源并进行测试" class="table-of-contents__link toc-highlight">12.2.创建资源并进行测试</a></li></ul></li><li><a href="#13部署kubernetes-dashboard" class="table-of-contents__link toc-highlight">13.部署kubernetes dashboard</a><ul><li><a href="#131部署dashboard" class="table-of-contents__link toc-highlight">13.1.部署dashboard</a></li><li><a href="#132访问dashboard" class="table-of-contents__link toc-highlight">13.2.访问dashboard</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs Releases</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://agou-ops.cn/myDocs" target="_blank" rel="noopener noreferrer" class="footer__link-item">Version 1.0<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://agou-ops.cn/myDocsv2" target="_blank" rel="noopener noreferrer" class="footer__link-item">Version 2.0<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://agou-ops.cn/myDocsv3" target="_blank" rel="noopener noreferrer" class="footer__link-item">Version 3.0<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://agou-ops.cn/myDocsv4" target="_blank" rel="noopener noreferrer" class="footer__link-item">⭐️Version 4.0<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Social</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://agou-ops.cn" target="_blank" rel="noopener noreferrer" class="footer__link-item">⭐️我的博客<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/AGou-ops" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 AGou-ops' Documetation v4.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.2d282a18.js"></script>
<script src="/assets/js/main.509f804f.js"></script>
</body>
</html>