<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-CloudNative/k8s/Prometheus-Grafana全方位监控Kubernetes集群">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">Prometheus+Grafana全方位监控Kubernetes集群 | AGou&#x27;s Docsv4</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs.agou-ops.cn/docs/CloudNative/k8s/Prometheus-Grafana全方位监控Kubernetes集群"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Prometheus+Grafana全方位监控Kubernetes集群 | AGou&#x27;s Docsv4"><meta data-rh="true" name="description" content="文章目录"><meta data-rh="true" property="og:description" content="文章目录"><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://docs.agou-ops.cn/docs/CloudNative/k8s/Prometheus-Grafana全方位监控Kubernetes集群"><link data-rh="true" rel="alternate" href="https://docs.agou-ops.cn/docs/CloudNative/k8s/Prometheus-Grafana全方位监控Kubernetes集群" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.agou-ops.cn/docs/CloudNative/k8s/Prometheus-Grafana全方位监控Kubernetes集群" hreflang="x-default"><link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-KQED41RW95","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script><link rel="stylesheet" href="/assets/css/styles.916b7a43.css">
<link rel="preload" href="/assets/js/runtime~main.b04b912f.js" as="script">
<link rel="preload" href="/assets/js/main.4851b47f.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Welcome to AGou&#x27;s Docs!" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="Welcome to AGou&#x27;s Docs!" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">AGou&#x27;s Docsv4</b></a><a href="https://agou-ops.cn" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">✨ 我的博客<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"> 📖 目录</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs">🌲 目录树</a></li><li><hr style="margin: 0.3rem 0;"></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/category/云原生相关">☁️ 云原生相关</a></li><li><a class="dropdown__link" href="/docs/category/linux基础">😊 Linux基础</a></li><li><a class="dropdown__link" href="/docs/category/编程语言">♨️ 编程语言</a></li><li><a class="dropdown__link" href="/docs/category/脚本相关">🕹️ 脚本相关</a></li><li><a class="dropdown__link" href="/docs/category/面试相关">👨‍⚖️ 面试相关</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">版本</a><ul class="dropdown__menu"><li><a href="https://agou-ops.cn/myDocs" target="_blank" rel="noopener noreferrer" class="dropdown__link">Ver1.0<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://agou-ops.cn/myDocsv2" target="_blank" rel="noopener noreferrer" class="dropdown__link">Ver2.0<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://agou-ops.cn/myDocsv3" target="_blank" rel="noopener noreferrer" class="dropdown__link">Ver3.0<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><a href="https://github.com/AGou-ops" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub 仓库"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div><div class="searchHintContainer_Pkmr"><kbd class="searchHint_iIMx">ctrl</kbd><kbd class="searchHint_iIMx">K</kbd></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/"><img src="/img/logo.png" alt="Welcome to AGou&#x27;s Docs!" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="Welcome to AGou&#x27;s Docs!" class="themedImage_ToTc themedImage--dark_i4oU"><b>AGou&#x27;s Docsv4</b></a><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/云原生相关">云原生相关</a><button aria-label="Toggle the collapsible sidebar category &#x27;云原生相关&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/cicd">CICD</a><button aria-label="Toggle the collapsible sidebar category &#x27;CICD&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/cloudcomptering">CloudComptering</a><button aria-label="Toggle the collapsible sidebar category &#x27;CloudComptering&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/docker">Docker</a><button aria-label="Toggle the collapsible sidebar category &#x27;Docker&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/elfk">ELFK</a><button aria-label="Toggle the collapsible sidebar category &#x27;ELFK&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/prometheus">Prometheus</a><button aria-label="Toggle the collapsible sidebar category &#x27;Prometheus&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/category/k8s">k8s</a><button aria-label="Toggle the collapsible sidebar category &#x27;k8s&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/helm">Helm</a><button aria-label="Toggle the collapsible sidebar category &#x27;Helm&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/installation">Installation</a><button aria-label="Toggle the collapsible sidebar category &#x27;Installation&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/quicklystart">Quicklystart</a><button aria-label="Toggle the collapsible sidebar category &#x27;Quicklystart&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/实战案例">实战案例</a><button aria-label="Toggle the collapsible sidebar category &#x27;实战案例&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CloudNative/k8s/Kubeadm 快速部署k8s集群">Kubeadm 快速部署k8s集群</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CloudNative/k8s/Kubernetes REST API">Kubernetes REST API</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CloudNative/k8s/Kubernetes Yaml quicklystart">Kubernetes YAML file quicklystart</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CloudNative/k8s/Kubernetes with Jenkins CICD">基于kubernetes平台的CICD持续集成</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CloudNative/k8s/Minikube Basic">Minikube Basic</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/CloudNative/k8s/Prometheus-Grafana全方位监控Kubernetes集群">Prometheus+Grafana全方位监控Kubernetes集群</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CloudNative/k8s/Remote access k8s">kubectl远程连接k8s</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CloudNative/k8s/k3d">k3d</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CloudNative/k8s/k8s command">Kubernetes CLI command -- kubectl</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CloudNative/k8s/k8s 图解大全">k8s图解大全</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CloudNative/k8s/k8s 网络相关">k8s 网络相关</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CloudNative/k8s/k8s概念及原理相关">k8s 概念及原理相关</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CloudNative/k8s/kompose Basic">Kompose Basic</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CloudNative/k8s/kubenetes远程调试工具">kubenetes远程调试工具</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CloudNative/Consul 入门">Consul 入门</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CloudNative/Dubbo Basic">Dubbo Basic</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CloudNative/Grafana Loki Basic">Grafana Loki</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CloudNative/Istio Basic">Istio Basic</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CloudNative/">CloudNative.</a></li></ul></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/云原生相关"><span itemprop="name">云原生相关</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/k8s"><span itemprop="name">k8s</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Prometheus+Grafana全方位监控Kubernetes集群</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Prometheus+Grafana全方位监控Kubernetes集群</h1><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="文章目录">文章目录<a href="#文章目录" class="hash-link" aria-label="Direct link to 文章目录" title="Direct link to 文章目录">​</a></h3><p>[toc]</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1k8s监控指标">1.k8s监控指标<a href="#1k8s监控指标" class="hash-link" aria-label="Direct link to 1.k8s监控指标" title="Direct link to 1.k8s监控指标">​</a></h2><p><strong>kubernetes本身监控</strong></p><ul><li>Node资源利用率</li><li>Node数量</li><li>Pods数量</li><li>资源对象状态</li></ul><p><strong>Pod监控</strong></p><ul><li>pod数量</li><li>容器资源利用率</li><li>应用程序</li></ul><p><strong>实现思路</strong></p><ul><li>pod性能<ul><li>使用cadvisor进行实现，监控容器的CPU、内存利用率</li></ul></li><li>Node性能<ul><li>使用node-exporter实现，主要监控节点CPU、内存利用率</li></ul></li><li>K8S资源对象<ul><li>使用kube-state-metrics实现，主要用于监控pod、deployment、service</li></ul></li></ul><p>k8s服务发现参考文档： <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#kubernetes_sd_config" target="_blank" rel="noopener noreferrer">https://prometheus.io/docs/prometheus/latest/configuration/configuration/#kubernetes_sd_config</a></p><p>本文将会实现k8s全方位监控，并配合grafana展示k8s资源对象的使用状态，以及配合alertmanager告警</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2k8s基础环境准备">2.k8s基础环境准备<a href="#2k8s基础环境准备" class="hash-link" aria-label="Direct link to 2.k8s基础环境准备" title="Direct link to 2.k8s基础环境准备">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="21环境准备">2.1.环境准备<a href="#21环境准备" class="hash-link" aria-label="Direct link to 2.1.环境准备" title="Direct link to 2.1.环境准备">​</a></h3><table><thead><tr><th>IP</th><th>角色</th></tr></thead><tbody><tr><td>192.168.16.106</td><td>k8s-master</td></tr><tr><td>192.168.16.104</td><td>k8s-node1</td></tr><tr><td>192.168.16.107</td><td>k8s-node2</td></tr><tr><td>192.168.16.105</td><td>nfs</td></tr></tbody></table><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="22部署nfs作为prometheus存储">2.2.部署nfs作为prometheus存储<a href="#22部署nfs作为prometheus存储" class="hash-link" aria-label="Direct link to 2.2.部署nfs作为prometheus存储" title="Direct link to 2.2.部署nfs作为prometheus存储">​</a></h3><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root@nfs ~]\# mkdir /data/prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@nfs ~]\# yum -y install nfs-utils</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@nfs ~]\# vim /etc/exports</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/data/prometheus   192.168.16.0/24(rw,sync,no_root_squash)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@nfs ~]\# systemctl restart nfs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@nfs ~]\# showmount -e</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Export list for nfs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/data/prometheus 192.168.16.0/24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@nfs ~]\# chomd -R 777 /data</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="23获取prometheus-yaml文件">2.3.获取prometheus yaml文件<a href="#23获取prometheus-yaml文件" class="hash-link" aria-label="Direct link to 2.3.获取prometheus yaml文件" title="Direct link to 2.3.获取prometheus yaml文件">​</a></h3><blockquote><p>在这里下载</p><p><a href="https://github.com/kubernetes/kubernetes/tree/release-1.16/cluster/addons/prometheus" target="_blank" rel="noopener noreferrer">https://github.com/kubernetes/kubernetes/tree/release-1.16/cluster/addons/prometheus</a></p><p>直接克隆完整目录也可以</p><p><a href="https://github.com/kubernetes/kubernetes.git" target="_blank" rel="noopener noreferrer">https://github.com/kubernetes/kubernetes.git</a></p><p>⚠️修改：<a href="https://gitlab.com/AGou-ops/k8s_prometheus_yaml.git" target="_blank" rel="noopener noreferrer">https://gitlab.com/AGou-ops/k8s_prometheus_yaml.git</a></p><p>prometheus在github的k8s目录中master分支已经找不到了，可以在release-1.16这里找到</p></blockquote><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1.拉取prometheus yaml文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master ~/k8s]\# git clone https://github.com/kubernetes/kubernetes.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2.将prometheus yaml文件复制到其他目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master ~/k8s]\# cp -rp kubernetes/cluster/addons/prometheus/ . </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>本人的yaml文件</strong></p><p><img loading="lazy" src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106165528931.png" alt="在这里插入图片描述" class="img_ev3q"></p><p><strong>官方yaml文件</strong></p><p><img loading="lazy" src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106165536705.png" alt="在这里插入图片描述" class="img_ev3q"></p><p><strong>文件说明</strong></p><p>主要分为四部分：prometheus部署、alertmanager部署、kube-state-metrics部署、node-exporter部署</p><table><thead><tr><th>文件名</th><th>作用</th></tr></thead><tbody><tr><td>alertmanager-configmap.yaml</td><td>alertmanager配置集合的yaml文件</td></tr><tr><td>alertmanager-deployment.yaml</td><td>alertmanager创建pod的yaml文件</td></tr><tr><td>alertmanager-pvc.yaml</td><td>alertmanager挂载存储卷的yaml文件</td></tr><tr><td>alertmanager-service.yaml</td><td>alertmanager对外暴露端口的yaml文件</td></tr><tr><td>grafana_pv_pvc.yaml</td><td>grafana挂载存储卷的yaml文件</td></tr><tr><td>grafana_statefulset.yaml</td><td>grafana发布pod的yaml文件，采用statefulset资源</td></tr><tr><td>grafana_svc.yaml</td><td>grafana对外暴露端口的yaml文件</td></tr><tr><td>install_node_exportes.sh</td><td>批量在node节点安装node_exporter的脚本</td></tr><tr><td>k8s_time.yaml</td><td>k8s同步宿主机时间的yaml文件</td></tr><tr><td>kube-state-metrics-deployment.yaml</td><td>k8s采集资源状态指标程序的yaml文件</td></tr><tr><td>kube-state-metrics-rbac.yaml</td><td>8s采集程序授权的yaml文件</td></tr><tr><td>kube-state-metrics-service.yaml</td><td>k8s采集程序对外暴露的yaml文件</td></tr><tr><td>node-exporter-ds.yml</td><td>node_exporter部署的yaml文件</td></tr><tr><td>node-exporter-service.yaml</td><td>node_exporter对外暴露的yaml文件</td></tr><tr><td>prometheus-configmap.yaml</td><td>prometheus的配置文件集</td></tr><tr><td>prometheus-pv-pvc.yaml</td><td>prometheus挂载存储的yaml文件</td></tr><tr><td>prometheus-rbac.yaml</td><td>prometheus授权访问api的yaml文件</td></tr><tr><td>prometheus-rules-pvc.yaml</td><td>prometheus告警规则存储卷的yaml文件</td></tr><tr><td>prometheus-rules.yaml</td><td>prometheus将rule做成cm资源的yaml文件</td></tr><tr><td>prometheus-service.yaml</td><td>prometheus对外提供访问的yaml文件</td></tr><tr><td>prometheus-statefulset-static-pv.yaml</td><td>prometheus程序部署的yaml文件</td></tr></tbody></table><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="24创建命名空间prometheus">2.4.创建命名空间prometheus<a href="#24创建命名空间prometheus" class="hash-link" aria-label="Direct link to 2.4.创建命名空间prometheus" title="Direct link to 2.4.创建命名空间prometheus">​</a></h3><p>创建一个ns为prometheus，将除了kube-state-metrics外的yaml中的namespace修改为prometheus</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1.创建ns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master ~/k8s/prometheus]\# kubectl create namespace prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">namespace/prometheus created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2.修改</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">用vim打开输入以下命令</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">:%s/namespace: kube-system/namespace: prometheus/g</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3在k8s中部署prometheus">3.在k8s中部署prometheus<a href="#3在k8s中部署prometheus" class="hash-link" aria-label="Direct link to 3.在k8s中部署prometheus" title="Direct link to 3.在k8s中部署prometheus">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="31prometheus-yaml准备">3.1.prometheus-yaml准备<a href="#31prometheus-yaml准备" class="hash-link" aria-label="Direct link to 3.1.prometheus-yaml准备" title="Direct link to 3.1.prometheus-yaml准备">​</a></h3><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">主要用到以下几个yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master ~/k8s/prometheus]\# ls prometheus-*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-configmap.yaml  prometheus-rbac.yaml  prometheus-service.yaml  prometheus-statefulset.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>创建顺序</p><blockquote><p>先创建prometheus-rbac.yaml</p><p>在创建prometheus-configmap.yaml</p><p>在创建prometheus-statefulset.yaml</p><p>最后创建prometheus-service.yaml</p></blockquote><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="32创建rbac资源">3.2.创建rbac资源<a href="#32创建rbac资源" class="hash-link" aria-label="Direct link to 3.2.创建rbac资源" title="Direct link to 3.2.创建rbac资源">​</a></h3><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master ~/k8s/prometheus]\# kubectl create -f prometheus-rbac.yaml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">serviceaccount/prometheus created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterrole.rbac.authorization.k8s.io/prometheus created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterrolebinding.rbac.authorization.k8s.io/prometheus created</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="33创建configmap资源">3.3.创建configmap资源<a href="#33创建configmap资源" class="hash-link" aria-label="Direct link to 3.3.创建configmap资源" title="Direct link to 3.3.创建configmap资源">​</a></h3><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master ~/k8s/prometheus]\# kubectl create -f prometheus-configmap.yaml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">configmap/prometheus-config created</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="34创建statefulset资源">3.4.创建statefulset资源<a href="#34创建statefulset资源" class="hash-link" aria-label="Direct link to 3.4.创建statefulset资源" title="Direct link to 3.4.创建statefulset资源">​</a></h3><p>github上的statefulset资源使用的是storageclasee动态创建pv，由于不会使用storageclass，因此将statefulset资源进行改造，使用静态pv做存储</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="341改造statefulst资源支持静态pv">3.4.1.改造statefulst资源支持静态pv<a href="#341改造statefulst资源支持静态pv" class="hash-link" aria-label="Direct link to 3.4.1.改造statefulst资源支持静态pv" title="Direct link to 3.4.1.改造statefulst资源支持静态pv">​</a></h4><p>改造思路：在yaml中增加pv、pvc的配置，在将原来的storageclass配置项删除，在120行的volume中增加pvc的配置即可</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">master ~/k8s/prometheus</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">\</span><span class="token comment" style="color:#999988;font-style:italic"># vim prometheus-statefulset-static-pv.yaml </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> PersistentVolumeClaim</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">accessModes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ReadWriteOnce</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">resources</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">requests</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">storage</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 16Gi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> PersistentVolume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pv</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">capacity</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">storage</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 16Gi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">accessModes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ReadWriteOnce</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">nfs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /data/prometheus/prometheus_data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 192.168.16.105</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> StatefulSet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kube</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">k8s-app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">kubernetes.io/cluster-service</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;true&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">addonmanager.kubernetes.io/mode</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Reconcile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v2.2.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">serviceName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;prometheus&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">replicas</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">podManagementPolicy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Parallel&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">updateStrategy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;RollingUpdate&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">matchLabels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">k8s-app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">template</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">k8s-app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">priorityClassName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> system</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cluster</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">critical</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">serviceAccountName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">initContainers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;init-chown-data&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;busybox:latest&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">imagePullPolicy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;IfNotPresent&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;chown&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;-R&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;65534:65534&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/data&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">volumeMounts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">mountPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">subPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">containers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">server</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">configmap</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">reload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;jimmidyson/configmap-reload:v0.1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">imagePullPolicy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;IfNotPresent&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">args</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">volume</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">dir=/etc/config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">webhook</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">url=http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//127.0.0.1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">9090/</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">/reload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">volumeMounts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">mountPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /etc/config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">readOnly</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">resources</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">limits</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">cpu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 10m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">memory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 10Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">requests</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">cpu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 10m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">memory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 10Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;prom/prometheus:v2.23.0&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">imagePullPolicy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;IfNotPresent&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">args</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">config.file=/etc/config/prometheus.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">storage.tsdb.path=/data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">web.console.libraries=/etc/prometheus/console_libraries</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">web.console.templates=/etc/prometheus/consoles</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">web.enable</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">lifecycle</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">containerPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9090</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">readinessProbe</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">httpGet</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">/ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9090</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">initialDelaySeconds</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">timeoutSeconds</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">livenessProbe</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">httpGet</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">/healthy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9090</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">initialDelaySeconds</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">timeoutSeconds</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># based on 10 running nodes with 30 pods each</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">resources</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">limits</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">cpu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 200m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">memory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 1000Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">requests</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">cpu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 200m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">memory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 1000Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">volumeMounts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">mountPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /etc/config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">mountPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">subPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">terminationGracePeriodSeconds</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">300</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">volumes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">configMap</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">persistentVolumeClaim</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">claimName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">data</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="342创建statefulset资源">3.4.2.创建statefulset资源<a href="#342创建statefulset资源" class="hash-link" aria-label="Direct link to 3.4.2.创建statefulset资源" title="Direct link to 3.4.2.创建statefulset资源">​</a></h4><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master ~/k8s/prometheus]\# kubectl create -f  prometheus-statefulset-static-pv.yaml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">persistentvolumeclaim/prometheus-data created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">persistentvolume/pv-prometheus created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">statefulset.apps/prometheus created</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="35创建service资源">3.5.创建service资源<a href="#35创建service资源" class="hash-link" aria-label="Direct link to 3.5.创建service资源" title="Direct link to 3.5.创建service资源">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="351修改service资源支持nodeport">3.5.1.修改service资源支持nodeport<a href="#351修改service资源支持nodeport" class="hash-link" aria-label="Direct link to 3.5.1.修改service资源支持nodeport" title="Direct link to 3.5.1.修改service资源支持nodeport">​</a></h4><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">master ~/k8s/prometheus</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">\</span><span class="token comment" style="color:#999988;font-style:italic"># vim prometheus-service.yaml </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">kubernetes.io/name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Prometheus&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">kubernetes.io/cluster-service</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;true&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">addonmanager.kubernetes.io/mode</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Reconcile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> NodePort</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9090</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">protocol</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">targetPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9090</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">k8s-app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> prometheus</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="352创建service资源">3.5.2.创建service资源<a href="#352创建service资源" class="hash-link" aria-label="Direct link to 3.5.2.创建service资源" title="Direct link to 3.5.2.创建service资源">​</a></h4><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master ~/k8s/prometheus]\# kubectl create -f prometheus-service.yaml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/prometheus created</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="36查看创建的prometheus所有资源类型">3.6.查看创建的prometheus所有资源类型<a href="#36查看创建的prometheus所有资源类型" class="hash-link" aria-label="Direct link to 3.6.查看创建的prometheus所有资源类型" title="Direct link to 3.6.查看创建的prometheus所有资源类型">​</a></h3><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master ~/k8s/prometheus]\# kubectl get pod,svc,pv,pvc -n prometheus -o wide</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106171837694.png" alt="在这里插入图片描述" class="img_ev3q"></p><p>主要访问30387端口看到prometheus</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="37访问prometheus">3.7.访问prometheus<a href="#37访问prometheus" class="hash-link" aria-label="Direct link to 3.7.访问prometheus" title="Direct link to 3.7.访问prometheus">​</a></h3><p>使用任意node节点的ip加30387端口即可访问：<a href="http://192.168.16.106:30387/" target="_blank" rel="noopener noreferrer">http://192.168.16.106:30387/</a></p><p><img loading="lazy" src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106171846551.png" alt="在这里插入图片描述" class="img_ev3q"></p><p>查看监控主机</p><p>可以看到已经有很多了，这些配置都是configmap资源中配置的
<img loading="lazy" src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106171854253.png" alt="在这里插入图片描述" class="img_ev3q"></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="38prometheus配置文件解释">3.8.prometheus配置文件解释<a href="#38prometheus配置文件解释" class="hash-link" aria-label="Direct link to 3.8.prometheus配置文件解释" title="Direct link to 3.8.prometheus配置文件解释">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="381进入prometheus容器">3.8.1.进入prometheus容器<a href="#381进入prometheus容器" class="hash-link" aria-label="Direct link to 3.8.1.进入prometheus容器" title="Direct link to 3.8.1.进入prometheus容器">​</a></h4><p>语法：kubectl exec -it pod名 进入的环境 -c 容器名称 -n 命名空间</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master ~/k8s/prometheus]\# kubectl exec -it prometheus-0 sh -c prometheus-server -n prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/prometheus $ </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>配置文件位于:/etc/config/prometheus.yml</p><p>tsdb存储位于:/data</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="382配置文件解释">3.8.2.配置文件解释<a href="#382配置文件解释" class="hash-link" aria-label="Direct link to 3.8.2.配置文件解释" title="Direct link to 3.8.2.配置文件解释">​</a></h4><p>/prometheus $ more /etc/config/prometheus.yml</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">scrape_configs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">job_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">static_configs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">targets</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> localhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9090</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">静态配置，将本机加到了prometheus监控，这个localhost就是运行prometheus容器的地址</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>kubernetes-apiservers自动发现</strong></p><p>将apiserver的地址进行暴露并获取监控指标</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">job_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kubernetes</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">apiservers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">kubernetes_sd_configs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">role</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> endpoints</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">relabel_configs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">action</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> keep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">regex</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default;kubernetes;https</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">source_labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> __meta_kubernetes_namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> __meta_kubernetes_service_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> __meta_kubernetes_endpoint_port_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">scheme</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> https</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">tls_config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">ca_file</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">insecure_skip_verify</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">bearer_token_file</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /var/run/secrets/kubernetes.io/serviceaccount/token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106171909965.png" alt="在这里插入图片描述" class="img_ev3q"></p><p><strong>k8s的node节点自动发现</strong></p><p>自动发现k8s中的所有node节点并进行监控</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">- job_name: kubernetes-nodes-cadvisor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kubernetes_sd_configs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - role: node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  relabel_configs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - action: labelmap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    regex: __meta_kubernetes_node_label_(.+)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - target_label: __metrics_path__</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    replacement: /metrics/cadvisor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  scheme: https</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tls_config:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    insecure_skip_verify: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106171919584.png" alt="在这里插入图片描述" class="img_ev3q"></p><p><strong>发现endpoint的资源</strong></p><p>主要是发现endpoint资源类型的pod，可以通过kubectl get ep查看谁是endpoint资源</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">job_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kubernetes</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">endpoints</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">kubernetes_sd_configs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">role</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> endpoints</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">relabel_configs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">action</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> keep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">regex</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">source_labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> __meta_kubernetes_service_annotation_prometheus_io_scrape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">action</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> replace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">regex</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> (https</span><span class="token punctuation" style="color:#393A34">?</span><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">source_labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> __meta_kubernetes_service_annotation_prometheus_io_scheme</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">target_label</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> __scheme__</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">action</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> replace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">regex</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> (.+)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">source_labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> __meta_kubernetes_service_annotation_prometheus_io_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">target_label</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> __metrics_path__</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">action</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> replace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">regex</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> (</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">^</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">+)(</span><span class="token punctuation" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">\d+)</span><span class="token punctuation" style="color:#393A34">?</span><span class="token plain">;(\d+)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">replacement</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">$2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">source_labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> __address__</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> __meta_kubernetes_service_annotation_prometheus_io_port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">target_label</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> __address__</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">action</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> labelmap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">regex</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> __meta_kubernetes_service_label_(.+)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">action</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> replace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">source_labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> __meta_kubernetes_namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">target_label</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kubernetes_namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">action</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> replace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">source_labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> __meta_kubernetes_service_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">target_label</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kubernetes_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106171929948.png" alt="在这里插入图片描述" class="img_ev3q"></p><p><strong>发现services</strong></p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">job_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kubernetes</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">kubernetes_sd_configs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">role</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">metrics_path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /probe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">params</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">module</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> http_2xx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">relabel_configs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">action</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> keep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">regex</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">source_labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> __meta_kubernetes_service_annotation_prometheus_io_probe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">source_labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> __address__</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">target_label</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> __param_target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">replacement</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> blackbox</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">target_label</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> __address__</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">source_labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> __param_target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">target_label</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> instance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">action</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> labelmap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">regex</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> __meta_kubernetes_service_label_(.+)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">source_labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> __meta_kubernetes_namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">target_label</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kubernetes_namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">source_labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> __meta_kubernetes_service_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">target_label</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kubernetes_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>发现pod</strong></p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">- job_name: kubernetes-pods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kubernetes_sd_configs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - role: pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  relabel_configs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - action: keep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    regex: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    source_labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - __meta_kubernetes_pod_annotation_prometheus_io_scrape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - action: replace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    regex: (.+)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    source_labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - __meta_kubernetes_pod_annotation_prometheus_io_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    target_label: __metrics_path__</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - action: replace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    regex: ([^:]+)(?::\d+)?;(\d+)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    replacement: $1:$2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    source_labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - __address__</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - __meta_kubernetes_pod_annotation_prometheus_io_port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    target_label: __address__</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - action: labelmap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    regex: __meta_kubernetes_pod_label_(.+)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - action: replace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    source_labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - __meta_kubernetes_namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    target_label: kubernetes_namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - action: replace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    source_labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - __meta_kubernetes_pod_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    target_label: kubernetes_pod_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="39k8s-metrics页面">3.9.k8s metrics页面<a href="#39k8s-metrics页面" class="hash-link" aria-label="Direct link to 3.9.k8s metrics页面" title="Direct link to 3.9.k8s metrics页面">​</a></h3><p>metrics页面访问如下也没关系，metrics貌似只能集群内部进行访问</p><p><img loading="lazy" src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106171942988.png" alt="在这里插入图片描述" class="img_ev3q"></p><p>只要能在prometheus搜索到container数据就可以</p><p><img loading="lazy" src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106171951255.png" alt="在这里插入图片描述" class="img_ev3q"></p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="4在k8s中部署grafana">4.在k8s中部署grafana<a href="#4在k8s中部署grafana" class="hash-link" aria-label="Direct link to 4.在k8s中部署grafana" title="Direct link to 4.在k8s中部署grafana">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="41编写granfana-pv-pvc资源">4.1.编写granfana-pv-pvc资源<a href="#41编写granfana-pv-pvc资源" class="hash-link" aria-label="Direct link to 4.1.编写granfana-pv-pvc资源" title="Direct link to 4.1.编写granfana-pv-pvc资源">​</a></h3><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1.编写资源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">master ~/k8s/prometheus3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">\</span><span class="token comment" style="color:#999988;font-style:italic"># vim grafana_pv_pvc.yaml </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> PersistentVolumeClaim</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> grafana</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ui</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> grafana</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ui</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">accessModes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ReadWriteOnce</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">resources</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">requests</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">storage</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 3Gi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> PersistentVolume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pv</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">grafana</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ui</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> grafana</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ui</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">capacity</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">storage</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 3Gi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">accessModes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ReadWriteOnce</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">nfs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /data/prometheus/grafana</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 192.168.16.105</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2.在nfs上创建对应的挂载点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@nfs ~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">\</span><span class="token comment" style="color:#999988;font-style:italic"># mkdir /data/prometheus/grafana</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="42编写granfana-statefulset资源">4.2.编写granfana-statefulset资源<a href="#42编写granfana-statefulset资源" class="hash-link" aria-label="Direct link to 4.2.编写granfana-statefulset资源" title="Direct link to 4.2.编写granfana-statefulset资源">​</a></h3><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master ~/k8s/prometheus3]\# vim grafana_statefulset.yaml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: StatefulSet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: grafana-ui</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: grafana-ui</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  serviceName: &quot;grafana-ui&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replicas: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      app: grafana-ui</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        app: grafana-ui</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: grafana-ui</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        image: grafana/grafana:6.6.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        imagePullPolicy: &quot;IfNotPresent&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - containerPort: 3000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            protocol: TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          limits:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cpu: 100m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            memory: 256Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          requests:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cpu: 100m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            memory: 256Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        volumeMounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - name: grafana-ui-data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            mountPath: /var/lib/grafana</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            subPath: &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      securityContext:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fsGroup: 472</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        runAsUser: 472</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      volumes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: grafana-ui-data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          persistentVolumeClaim:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            claimName: grafana-ui-data</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="43编写granfana-svc资源">4.3.编写granfana-svc资源<a href="#43编写granfana-svc资源" class="hash-link" aria-label="Direct link to 4.3.编写granfana-svc资源" title="Direct link to 4.3.编写granfana-svc资源">​</a></h3><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master ~/k8s/prometheus3]\# vim grafana_svc.yaml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: grafana-ui</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: grafana-ui</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type: NodePort</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      port: 3000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      protocol: TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      targetPort: 3000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app: grafana-ui</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="44k8s创建grafana">4.4.k8s创建grafana<a href="#44k8s创建grafana" class="hash-link" aria-label="Direct link to 4.4.k8s创建grafana" title="Direct link to 4.4.k8s创建grafana">​</a></h3><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master ~/k8s/prometheus3]\# kubectl create -f grafana_pv_pvc.yaml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">persistentvolumeclaim &quot;grafana-ui-data&quot; created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">persistentvolume &quot;pv-grafana-ui-data&quot; created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master ~/k8s/prometheus3]\# kubectl create -f prometheus-statefulset-static-pv.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">persistentvolumeclaim/prometheus-data created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">persistentvolume/pv-prometheus created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">statefulset.apps/prometheus created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master ~/k8s/prometheus3]\# kubectl create -f grafana_svc.yaml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/grafana-ui created</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="45查看资源运行状态">4.5.查看资源运行状态<a href="#45查看资源运行状态" class="hash-link" aria-label="Direct link to 4.5.查看资源运行状态" title="Direct link to 4.5.查看资源运行状态">​</a></h3><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master ~/k8s/prometheus3]\# kubectl get pv,pvc,pod,statefulset,svc -n grafana-ui</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                  CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS        CLAIM                         STORAGECLASS   REASON   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">persistentvolume/pv-grafana-ui-data   3Gi        RWO            Retain           Terminating   grafana-ui/grafana-ui-data                            151m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">persistentvolume/pv-prometheus        16Gi       RWO            Retain           Bound         kube-system/prometheus-data                           47m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                    STATUS        VOLUME               CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">persistentvolumeclaim/grafana-ui-data   Terminating   pv-grafana-ui-data   3Gi        RWO                           151m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME               READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/grafana-ui-0   1/1     Running   0          16m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                          READY   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">statefulset.apps/grafana-ui   1/1     16m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                 TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/grafana-ui   NodePort   10.96.170.142   &lt;none&gt;        3000:32040/TCP   85m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172010434.png" alt="在这里插入图片描述" class="img_ev3q"></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="46登陆grafana">4.6.登陆grafana<a href="#46登陆grafana" class="hash-link" aria-label="Direct link to 4.6.登陆grafana" title="Direct link to 4.6.登陆grafana">​</a></h3><p>访问：集群任意ip和32040端口即可访问</p><p><img loading="lazy" src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172018940.png" alt="在这里插入图片描述" class="img_ev3q"></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="47导入k8s资源监控pod资源模板">4.7.导入k8s资源监控pod资源模板<a href="#47导入k8s资源监控pod资源模板" class="hash-link" aria-label="Direct link to 4.7.导入k8s资源监控pod资源模板" title="Direct link to 4.7.导入k8s资源监控pod资源模板">​</a></h3><p>推荐模板：</p><ul><li>集群资源监控：3119</li><li>资源状态监控：6417</li><li>node监控：9276</li></ul><p><img loading="lazy" src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172028210.png" alt="在这里插入图片描述" class="img_ev3q"></p><p>导入成功</p><p><img loading="lazy" src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172037255.png" alt="在这里插入图片描述" class="img_ev3q"></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="48解决模板表达式问题无法展现所有pod">4.8.解决模板表达式问题无法展现所有pod<a href="#48解决模板表达式问题无法展现所有pod" class="hash-link" aria-label="Direct link to 4.8.解决模板表达式问题无法展现所有pod" title="Direct link to 4.8.解决模板表达式问题无法展现所有pod">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="481问题描述">4.8.1.问题描述<a href="#481问题描述" class="hash-link" aria-label="Direct link to 4.8.1.问题描述" title="Direct link to 4.8.1.问题描述">​</a></h4><p>模板中的图形关于pod和docker的全部有问题，仅单单显示一个pod</p><p><img loading="lazy" src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172046186.png" alt="在这里插入图片描述" class="img_ev3q"></p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="482问题解决">4.8.2.问题解决<a href="#482问题解决" class="hash-link" aria-label="Direct link to 4.8.2.问题解决" title="Direct link to 4.8.2.问题解决">​</a></h4><p>修改他们的表达式就可以了，将pod_name修改为pod</p><p><img loading="lazy" src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172056945.png" alt="在这里插入图片描述" class="img_ev3q"></p><p>修改为立马显示出所有pod，所有关于pod和docker的都是这么改</p><p><img loading="lazy" src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172106157.png" alt="在这里插入图片描述" class="img_ev3q"></p><p>最终展示效果</p><p><img loading="lazy" src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172114765.png" alt="在这里插入图片描述" class="img_ev3q"></p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="5监控k8s-node节点">5.监控k8s node节点<a href="#5监控k8s-node节点" class="hash-link" aria-label="Direct link to 5.监控k8s node节点" title="Direct link to 5.监控k8s node节点">​</a></h2><p>对于node节点的监控我们不用部署在k8s里，直接在每台node机器上安装node_exporter即可</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="51编写一键部署node_exporter脚本">5.1.编写一键部署node_exporter脚本<a href="#51编写一键部署node_exporter脚本" class="hash-link" aria-label="Direct link to 5.1.编写一键部署node_exporter脚本" title="Direct link to 5.1.编写一键部署node_exporter脚本">​</a></h3><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s-master ~/k8s/prometheus3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"># </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> install_node_exportes.sh </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#批量安装node_exporter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">soft_dir</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/root/soft</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> -e </span><span class="token variable" style="color:#36acaa">$soft_dir</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$soft_dir</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">netstat</span><span class="token plain"> -lnpt </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$?</span><span class="token plain"> -eq </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token assign-left variable" style="color:#36acaa">use</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">`</span><span class="token variable function" style="color:#d73a49">netstat</span><span class="token variable" style="color:#36acaa"> -lnpt </span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable function" style="color:#d73a49">grep</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable number" style="color:#36acaa">9100</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable function" style="color:#d73a49">awk</span><span class="token variable" style="color:#36acaa"> -F/ </span><span class="token variable string" style="color:#e3116c">&#x27;{print $NF}&#x27;</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;9100端口已经被占用，占用者是 </span><span class="token string variable" style="color:#36acaa">$use</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin class-name">exit</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$soft_dir</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> http://192.168.16.106:888/prometheus/node_exporter-1.0.1.linux-amd64.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> xf node_exporter-1.0.1.linux-amd64.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">mv</span><span class="token plain"> node_exporter-1.0.1.linux-amd64 /usr/local/node_exporter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">&gt;</span><span class="token string bash punctuation" style="color:#393A34">/usr/lib/systemd/system/node_exporter.service</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[Unit]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">Description=https://prometheus.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[Service]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">Restart=on-failure</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">ExecStart=/usr/local/node_exporter/node_exporter --collector.systemd --collector.systemd.unit-whitelist=(docker|kubelet|node_exporter).service</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[Install]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">WantedBy=multi-user.target</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl daemon-reload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl </span><span class="token builtin class-name">enable</span><span class="token plain"> node_exporter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl restart node_exporter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">netstat</span><span class="token plain"> -lnpt </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$?</span><span class="token plain"> -eq </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ehoc </span><span class="token string" style="color:#e3116c">&quot;node_eporter install finish...&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="52对k8s的node进行执行node_exporter脚本">5.2.对k8s的node进行执行node_exporter脚本<a href="#52对k8s的node进行执行node_exporter脚本" class="hash-link" aria-label="Direct link to 5.2.对k8s的node进行执行node_exporter脚本" title="Direct link to 5.2.对k8s的node进行执行node_exporter脚本">​</a></h3><p>在这里下载脚本用就行了</p><p><img loading="lazy" src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172136934.png" alt="在这里插入图片描述" class="img_ev3q"></p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-node1 ~]\# wget http://192.168.16.106:888/install_node_exportes.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-node1 ~]\# sh install_node_exportes.sh </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-node1 ~]\#  netstat -lnpt | grep 9100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcp6       0      0 :::9100                 :::*                    LISTEN      14906/node_exporter </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="53在prometheus的configmap资源中增加node节点配置">5.3.在prometheus的configmap资源中增加node节点配置<a href="#53在prometheus的configmap资源中增加node节点配置" class="hash-link" aria-label="Direct link to 5.3.在prometheus的configmap资源中增加node节点配置" title="Direct link to 5.3.在prometheus的configmap资源中增加node节点配置">​</a></h3><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">master ~/k8s/prometheus3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">\</span><span class="token comment" style="color:#999988;font-style:italic"># vim prometheus-configmap.yaml </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">job_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> k8s</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">static_configs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">targets</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> 192.168.16.104</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> 192.168.16.107</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9100</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172150508.png" alt="在这里插入图片描述" class="img_ev3q"></p><p><strong>更新配置</strong></p><p>更新完配置，prometheus页面会立马显示，因此每当configmap一修改，prometheus容器就会重载</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master ~/k8s/prometheus3]\# kubectl apply -f prometheus-configmap.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">configmap/prometheus-config created</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>成功添加node监控</p><p><img loading="lazy" src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172200609.png" alt="在这里插入图片描述" class="img_ev3q"></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="54导入k8s-node主机监控模板">5.4.导入k8s node主机监控模板<a href="#54导入k8s-node主机监控模板" class="hash-link" aria-label="Direct link to 5.4.导入k8s node主机监控模板" title="Direct link to 5.4.导入k8s node主机监控模板">​</a></h3><p>node监控：9276</p><p><img loading="lazy" src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172210569.png" alt="在这里插入图片描述" class="img_ev3q"></p><p><strong>填写信息</strong></p><p><img loading="lazy" src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172219328.png" alt="在这里插入图片描述" class="img_ev3q">
<strong>查看图形</strong>
<img loading="lazy" src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172235454.png" alt="在这里插入图片描述" class="img_ev3q"></p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="6k8s使用kube-state-metrics-监控资源状态">6.k8s使用kube-state-metrics-监控资源状态<a href="#6k8s使用kube-state-metrics-监控资源状态" class="hash-link" aria-label="Direct link to 6.k8s使用kube-state-metrics-监控资源状态" title="Direct link to 6.k8s使用kube-state-metrics-监控资源状态">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="61创建rbac资源">6.1.创建rbac资源<a href="#61创建rbac资源" class="hash-link" aria-label="Direct link to 6.1.创建rbac资源" title="Direct link to 6.1.创建rbac资源">​</a></h3><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master ~/k8s/prometheus3]\# kubectl create kube-state-metrics-rbac.yaml </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="62创建deployment资源">6.2.创建deployment资源<a href="#62创建deployment资源" class="hash-link" aria-label="Direct link to 6.2.创建deployment资源" title="Direct link to 6.2.创建deployment资源">​</a></h3><p>deployment资源里面结合了configmap资源</p><p>需要把镜像的地址修改成lizhenliang/kube-state-metrics:v1.8.0、lizhenliang/addon-resizer:1.8.6</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master ~/k8s/prometheus3]\# kubectl create -f kube-state-metrics-deployment.yaml </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172259875.png" alt="在这里插入图片描述" class="img_ev3q"></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="63创建service资源">6.3.创建service资源<a href="#63创建service资源" class="hash-link" aria-label="Direct link to 6.3.创建service资源" title="Direct link to 6.3.创建service资源">​</a></h3><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master ~/k8s/prometheus3]\# kubectl create -f kube-state-metrics-service.yaml </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="64资源准备就绪">6.4.资源准备就绪<a href="#64资源准备就绪" class="hash-link" aria-label="Direct link to 6.4.资源准备就绪" title="Direct link to 6.4.资源准备就绪">​</a></h3><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master ~/k8s/prometheus3]\# kubectl get all -n kube-system | grep kube-state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172316131.png" alt="在这里插入图片描述" class="img_ev3q"></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="65在prometheus查看是否获取监控指标">6.5.在prometheus查看是否获取监控指标<a href="#65在prometheus查看是否获取监控指标" class="hash-link" aria-label="Direct link to 6.5.在prometheus查看是否获取监控指标" title="Direct link to 6.5.在prometheus查看是否获取监控指标">​</a></h3><p>安装完kube-state-metrics之后，直接就可以在prometheus上查询监控指标，都是以kube开头的</p><p><img loading="lazy" src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172326163.png" alt="在这里插入图片描述" class="img_ev3q"></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="66导入k8s-资源状态模板">6.6.导入k8s 资源状态模板<a href="#66导入k8s-资源状态模板" class="hash-link" aria-label="Direct link to 6.6.导入k8s 资源状态模板" title="Direct link to 6.6.导入k8s 资源状态模板">​</a></h3><p>资源状态监控：6417</p><p><img loading="lazy" src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/2021010617233747.png" alt="在这里插入图片描述" class="img_ev3q"></p><p>查看图形，也是有很多监控不到</p><p><img loading="lazy" src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172345276.png" alt="在这里插入图片描述" class="img_ev3q"></p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="7在k8s中部署alertmanager实现告警系统">7.在k8s中部署alertmanager实现告警系统<a href="#7在k8s中部署alertmanager实现告警系统" class="hash-link" aria-label="Direct link to 7.在k8s中部署alertmanager实现告警系统" title="Direct link to 7.在k8s中部署alertmanager实现告警系统">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="71创建alertmanager-pv-pvc资源">7.1.创建alertmanager-pv-pvc资源<a href="#71创建alertmanager-pv-pvc资源" class="hash-link" aria-label="Direct link to 7.1.创建alertmanager-pv-pvc资源" title="Direct link to 7.1.创建alertmanager-pv-pvc资源">​</a></h3><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1.编写yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master ~/k8s/prometheus3]\# vim alertmanager-pvc.yaml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: PersistentVolumeClaim</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: alertmanager-data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: alertmanager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubernetes.io/cluster-service: &quot;true&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    addonmanager.kubernetes.io/mode: EnsureExists</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  accessModes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - ReadWriteOnce</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    requests:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      storage: &quot;2Gi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: PersistentVolume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: pv-alertmanager-data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: alertmanager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  capacity:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    storage: 2Gi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  accessModes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - ReadWriteOnce</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nfs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    path: /data/prometheus/alertmanager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    server: 192.168.16.105</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2.创建</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master ~/k8s/prometheus3]\# kubectl create -f alertmanager-pvc.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">persistentvolumeclaim/alertmanager created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">persistentvolume/pv-alertmanager-data create</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="72创建alertmanager-cm资源增加微信告警配置">7.2.创建alertmanager-cm资源增加微信告警配置<a href="#72创建alertmanager-cm资源增加微信告警配置" class="hash-link" aria-label="Direct link to 7.2.创建alertmanager-cm资源增加微信告警配置" title="Direct link to 7.2.创建alertmanager-cm资源增加微信告警配置">​</a></h3><p>增加微信报警</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1.增加微信告警配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master ~/k8s/prometheus3]\# vim alertmanager-configmap.yaml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: ConfigMap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: alertmanager-config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: alertmanager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubernetes.io/cluster-service: &quot;true&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    addonmanager.kubernetes.io/mode: EnsureExists</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  alertmanager.yml: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    global:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      resolve_timeout: 5m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    receivers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: &#x27;wechat&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      wechat_configs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - corp_id: &#x27;ww48f74fc8ed3a07ba&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          to_party: &#x27;1&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          agent_id: &#x27;1000003&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          api_secret: &#x27;j3ocaGJJM7KejlqzBIJ38b6D6t9QhqlIAh7k4fA1cT0&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          send_resolved: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    route:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      group_interval: 1m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      group_wait: 10s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      receiver: wechat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      repeat_interval: 1m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2.创建资源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master ~/k8s/prometheus3]\# kubectl create -f alertmanager-configmap.yaml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">configmap/alertmanager-config created</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="73创建alertmanager-deployment资源">7.3.创建alertmanager-deployment资源<a href="#73创建alertmanager-deployment资源" class="hash-link" aria-label="Direct link to 7.3.创建alertmanager-deployment资源" title="Direct link to 7.3.创建alertmanager-deployment资源">​</a></h3><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master ~/k8s/prometheus3]\# kubectl create -f alertmanager-deployment.yaml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment.apps/alertmanager created</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="74创建alertmanager-service资源">7.4.创建alertmanager-service资源<a href="#74创建alertmanager-service资源" class="hash-link" aria-label="Direct link to 7.4.创建alertmanager-service资源" title="Direct link to 7.4.创建alertmanager-service资源">​</a></h3><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master ~/k8s/prometheus3]\# kubectl create -f alertmanager-service.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/alertmanager created</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="75查看alertmanager所有资源">7.5查看alertmanager所有资源<a href="#75查看alertmanager所有资源" class="hash-link" aria-label="Direct link to 7.5查看alertmanager所有资源" title="Direct link to 7.5查看alertmanager所有资源">​</a></h3><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master ~/k8s/prometheus3]\# kubectl get all,pv,pvc,cm -n alertmanager</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172401946.png" alt="在这里插入图片描述" class="img_ev3q"></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="76访问alertmanager">7.6.访问alertmanager<a href="#76访问alertmanager" class="hash-link" aria-label="Direct link to 7.6.访问alertmanager" title="Direct link to 7.6.访问alertmanager">​</a></h3><p>任意node节点+31831端口即可</p><p><img loading="lazy" src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172410897.png" alt="在这里插入图片描述" class="img_ev3q"></p><p>配置文件已经支持微信报警</p><p><img loading="lazy" src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172419513.png" alt="在这里插入图片描述" class="img_ev3q"></p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="8配置alertmanager实现k8s告警系统">8.配置alertmanager实现k8s告警系统<a href="#8配置alertmanager实现k8s告警系统" class="hash-link" aria-label="Direct link to 8.配置alertmanager实现k8s告警系统" title="Direct link to 8.配置alertmanager实现k8s告警系统">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="81在nfs上准备两个告警规则文件">8.1.在NFS上准备两个告警规则文件<a href="#81在nfs上准备两个告警规则文件" class="hash-link" aria-label="Direct link to 8.1.在NFS上准备两个告警规则文件" title="Direct link to 8.1.在NFS上准备两个告警规则文件">​</a></h3><p>我们对于告警规则文件不采用configmap的方式而是采用pv、pvc的方式把告警规则挂载到容器里</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1.在nfs上创建pv存储路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@nfs ~]\# mkdir /data/prometheus/rules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@nfs ~]\# chmod -R 777 /data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@nfs ~]\# cd /data/prometheus/rules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2.准备主机宕机的告警规则文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@nfs rules]\# vim hostdown.yml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">groups:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- name: general.rules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - alert: 主机宕机</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    expr: up == 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for: 1m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      serverity: error</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      summary: &quot;主机 {{ $labels.instance }} 停止工作&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      description: &quot;{{ $labels.instance }} job {{ $labels.job }} 已经宕机5分钟以上!&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3.准备主机基础监控告警规则文件      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@nfs rules]\# vim node.yml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">groups:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- name: node.rules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - alert: NodeFilessystemUsage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    expr: 100 - (node_filesystem_free_bytes{fstype=~&quot;ext4|xfs&quot;,mountpoint=&quot;/&quot;} / node_filesystem_size_bytes{fstype=~&quot;ext4|xfs&quot;,mountpoint=&quot;/&quot;} *100) &gt; 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for: 1m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      serverity: warning</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      summary: &quot;主机 {{ $labels.instance }} : {{ $labels.mountpoint }} 磁盘使用率过高&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      description: &quot;{{ $labels.instance }} : {{ $labels.mountpoint }} 磁盘使用率超过80% (当前值: {{ $value }}) &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - alert: NodeMemoryUsage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    expr: 100 - ((node_memory_MemFree_bytes+node_memory_Cached_bytes+node_memory_Buffers_bytes) / node_memory_MemTotal_bytes * 100) &gt; 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for: 1m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      serverity: warning</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      summary: &quot;主机 {{ $labels.instance }} 内存使用率过高&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      description: &quot;{{ $labels.instance }} 内存使用率超过80% (当前值: {{ $value }}) &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - alert: NodeCpuUsage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    expr: 100 - (avg(irate(node_cpu_seconds_total{mode=&#x27;idle&#x27;}[5m])) by (instance) *100) &gt; 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for: 1m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      serverity: warning</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      summary: &quot;主机 {{ $labels.instance }} CPU使用率过高&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      description: &quot;{{ $labels.instance }} CPU使用率超过80% (当前值: {{ $value }}) &quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="82编写rules告警规则的pvpvcyaml文件">8.2.编写rules告警规则的pv、pvcyaml文件<a href="#82编写rules告警规则的pvpvcyaml文件" class="hash-link" aria-label="Direct link to 8.2.编写rules告警规则的pv、pvcyaml文件" title="Direct link to 8.2.编写rules告警规则的pv、pvcyaml文件">​</a></h3><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1.编写资源文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master ~/k8s/prometheus3]\# vim prometheus-rules-pvc.yaml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: PersistentVolumeClaim</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: prometheus-rules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  accessModes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - ReadWriteOnce</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    requests:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      storage: &quot;2Gi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: PersistentVolume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: pv-prometheus-rules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  capacity:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    storage: 2Gi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  accessModes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - ReadWriteOnce</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nfs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    path: /data/prometheus/rules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    server: 192.168.16.105</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2.创建资源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master ~/k8s/prometheus3]\# kubectl create -f prometheus-rules-pvc.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">persistentvolumeclaim/prometheus-rules created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">persistentvolume/pv-prometheus-rules created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="83修改prometheus的statefulset资源集成rules">8.3.修改prometheus的statefulset资源集成rules<a href="#83修改prometheus的statefulset资源集成rules" class="hash-link" aria-label="Direct link to 8.3.修改prometheus的statefulset资源集成rules" title="Direct link to 8.3.修改prometheus的statefulset资源集成rules">​</a></h3><p>在prometheus的statefulset资源中增加rules的pvc挂载路径</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master ~/k8s/prometheus3]\# vim prometheus-statefulset-static-pv.yaml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          volumeMounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - name: config-volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              mountPath: /etc/config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - name: prometheus-rules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              mountPath: /etc/config/rules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - name: prometheus-data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              mountPath: /data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              subPath: &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      terminationGracePeriodSeconds: 300</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      volumes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: config-volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          configMap:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            name: prometheus-config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: prometheus-rules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          persistentVolumeClaim:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            claimName: prometheus-rules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: prometheus-data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          persistentVolumeClaim:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            claimName: prometheus-data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172451817.png" alt="在这里插入图片描述" class="img_ev3q"></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="84更新prometheus-statefulset资源">8.4.更新prometheus-statefulset资源<a href="#84更新prometheus-statefulset资源" class="hash-link" aria-label="Direct link to 8.4.更新prometheus-statefulset资源" title="Direct link to 8.4.更新prometheus-statefulset资源">​</a></h3><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master ~/k8s/prometheus3]\# kubectl apply -f prometheus-statefulset-static-pv.yaml </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="85修改prometheus-configmap资源配置alertmanager地址">8.5.修改prometheus-configmap资源配置alertmanager地址<a href="#85修改prometheus-configmap资源配置alertmanager地址" class="hash-link" aria-label="Direct link to 8.5.修改prometheus-configmap资源配置alertmanager地址" title="Direct link to 8.5.修改prometheus-configmap资源配置alertmanager地址">​</a></h3><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1.修改配置增加alertmanager地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master ~/k8s/prometheus3]\# vim prometheus-configmap.yaml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    alerting:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      alertmanagers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - static_configs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - targets:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - 192.168.16.106:31831</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2.更新资源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master ~/k8s/prometheus3]\# kubectl apply -f prometheus-configmap.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">configmap/prometheus-config configured      </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="85查看页面是否增加告警规则">8.5.查看页面是否增加告警规则<a href="#85查看页面是否增加告警规则" class="hash-link" aria-label="Direct link to 8.5.查看页面是否增加告警规则" title="Direct link to 8.5.查看页面是否增加告警规则">​</a></h3><p>已经成功填加rules告警规则</p><p><img loading="lazy" src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172502911.png" alt="在这里插入图片描述" class="img_ev3q"></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="86模拟node主机宕机并查看微信告警内容">8.6.模拟node主机宕机并查看微信告警内容<a href="#86模拟node主机宕机并查看微信告警内容" class="hash-link" aria-label="Direct link to 8.6.模拟node主机宕机并查看微信告警内容" title="Direct link to 8.6.模拟node主机宕机并查看微信告警内容">​</a></h3><p><strong>模拟触发告警</strong></p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">将任意一个node节点的node_exporter停掉即可</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-node1 ~]\# systemctl stop node_exporter</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>告警已经产生</strong></p><p><img loading="lazy" src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172537744.png" alt="在这里插入图片描述" class="img_ev3q"></p><p><strong>告警消息已经发送</strong></p><p><img loading="lazy" src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172545238.png" alt="在这里插入图片描述" class="img_ev3q"></p><p><strong>查看告警内容</strong></p><p>已经成功收到告警，k8s监控系列篇到此结束</p><p><img loading="lazy" src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172554537.png" alt="在这里插入图片描述" class="img_ev3q"></p><blockquote><p>该文章为转载内容，仅做备份私人学习使用，原文：<a href="https://jiangxl.blog.csdn.net/article/details/112283085" target="_blank" rel="noopener noreferrer">https://jiangxl.blog.csdn.net/article/details/112283085</a></p></blockquote></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/CloudNative/k8s/Prometheus-Grafana全方位监控Kubernetes集群.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/CloudNative/k8s/Minikube Basic"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Minikube Basic</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/CloudNative/k8s/Remote access k8s"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">kubectl远程连接k8s</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#文章目录" class="table-of-contents__link toc-highlight">文章目录</a></li><li><a href="#1k8s监控指标" class="table-of-contents__link toc-highlight">1.k8s监控指标</a></li><li><a href="#2k8s基础环境准备" class="table-of-contents__link toc-highlight">2.k8s基础环境准备</a><ul><li><a href="#21环境准备" class="table-of-contents__link toc-highlight">2.1.环境准备</a></li><li><a href="#22部署nfs作为prometheus存储" class="table-of-contents__link toc-highlight">2.2.部署nfs作为prometheus存储</a></li><li><a href="#23获取prometheus-yaml文件" class="table-of-contents__link toc-highlight">2.3.获取prometheus yaml文件</a></li><li><a href="#24创建命名空间prometheus" class="table-of-contents__link toc-highlight">2.4.创建命名空间prometheus</a></li></ul></li><li><a href="#3在k8s中部署prometheus" class="table-of-contents__link toc-highlight">3.在k8s中部署prometheus</a><ul><li><a href="#31prometheus-yaml准备" class="table-of-contents__link toc-highlight">3.1.prometheus-yaml准备</a></li><li><a href="#32创建rbac资源" class="table-of-contents__link toc-highlight">3.2.创建rbac资源</a></li><li><a href="#33创建configmap资源" class="table-of-contents__link toc-highlight">3.3.创建configmap资源</a></li><li><a href="#34创建statefulset资源" class="table-of-contents__link toc-highlight">3.4.创建statefulset资源</a></li><li><a href="#35创建service资源" class="table-of-contents__link toc-highlight">3.5.创建service资源</a></li><li><a href="#36查看创建的prometheus所有资源类型" class="table-of-contents__link toc-highlight">3.6.查看创建的prometheus所有资源类型</a></li><li><a href="#37访问prometheus" class="table-of-contents__link toc-highlight">3.7.访问prometheus</a></li><li><a href="#38prometheus配置文件解释" class="table-of-contents__link toc-highlight">3.8.prometheus配置文件解释</a></li><li><a href="#39k8s-metrics页面" class="table-of-contents__link toc-highlight">3.9.k8s metrics页面</a></li></ul></li><li><a href="#4在k8s中部署grafana" class="table-of-contents__link toc-highlight">4.在k8s中部署grafana</a><ul><li><a href="#41编写granfana-pv-pvc资源" class="table-of-contents__link toc-highlight">4.1.编写granfana-pv-pvc资源</a></li><li><a href="#42编写granfana-statefulset资源" class="table-of-contents__link toc-highlight">4.2.编写granfana-statefulset资源</a></li><li><a href="#43编写granfana-svc资源" class="table-of-contents__link toc-highlight">4.3.编写granfana-svc资源</a></li><li><a href="#44k8s创建grafana" class="table-of-contents__link toc-highlight">4.4.k8s创建grafana</a></li><li><a href="#45查看资源运行状态" class="table-of-contents__link toc-highlight">4.5.查看资源运行状态</a></li><li><a href="#46登陆grafana" class="table-of-contents__link toc-highlight">4.6.登陆grafana</a></li><li><a href="#47导入k8s资源监控pod资源模板" class="table-of-contents__link toc-highlight">4.7.导入k8s资源监控pod资源模板</a></li><li><a href="#48解决模板表达式问题无法展现所有pod" class="table-of-contents__link toc-highlight">4.8.解决模板表达式问题无法展现所有pod</a></li></ul></li><li><a href="#5监控k8s-node节点" class="table-of-contents__link toc-highlight">5.监控k8s node节点</a><ul><li><a href="#51编写一键部署node_exporter脚本" class="table-of-contents__link toc-highlight">5.1.编写一键部署node_exporter脚本</a></li><li><a href="#52对k8s的node进行执行node_exporter脚本" class="table-of-contents__link toc-highlight">5.2.对k8s的node进行执行node_exporter脚本</a></li><li><a href="#53在prometheus的configmap资源中增加node节点配置" class="table-of-contents__link toc-highlight">5.3.在prometheus的configmap资源中增加node节点配置</a></li><li><a href="#54导入k8s-node主机监控模板" class="table-of-contents__link toc-highlight">5.4.导入k8s node主机监控模板</a></li></ul></li><li><a href="#6k8s使用kube-state-metrics-监控资源状态" class="table-of-contents__link toc-highlight">6.k8s使用kube-state-metrics-监控资源状态</a><ul><li><a href="#61创建rbac资源" class="table-of-contents__link toc-highlight">6.1.创建rbac资源</a></li><li><a href="#62创建deployment资源" class="table-of-contents__link toc-highlight">6.2.创建deployment资源</a></li><li><a href="#63创建service资源" class="table-of-contents__link toc-highlight">6.3.创建service资源</a></li><li><a href="#64资源准备就绪" class="table-of-contents__link toc-highlight">6.4.资源准备就绪</a></li><li><a href="#65在prometheus查看是否获取监控指标" class="table-of-contents__link toc-highlight">6.5.在prometheus查看是否获取监控指标</a></li><li><a href="#66导入k8s-资源状态模板" class="table-of-contents__link toc-highlight">6.6.导入k8s 资源状态模板</a></li></ul></li><li><a href="#7在k8s中部署alertmanager实现告警系统" class="table-of-contents__link toc-highlight">7.在k8s中部署alertmanager实现告警系统</a><ul><li><a href="#71创建alertmanager-pv-pvc资源" class="table-of-contents__link toc-highlight">7.1.创建alertmanager-pv-pvc资源</a></li><li><a href="#72创建alertmanager-cm资源增加微信告警配置" class="table-of-contents__link toc-highlight">7.2.创建alertmanager-cm资源增加微信告警配置</a></li><li><a href="#73创建alertmanager-deployment资源" class="table-of-contents__link toc-highlight">7.3.创建alertmanager-deployment资源</a></li><li><a href="#74创建alertmanager-service资源" class="table-of-contents__link toc-highlight">7.4.创建alertmanager-service资源</a></li><li><a href="#75查看alertmanager所有资源" class="table-of-contents__link toc-highlight">7.5查看alertmanager所有资源</a></li><li><a href="#76访问alertmanager" class="table-of-contents__link toc-highlight">7.6.访问alertmanager</a></li></ul></li><li><a href="#8配置alertmanager实现k8s告警系统" class="table-of-contents__link toc-highlight">8.配置alertmanager实现k8s告警系统</a><ul><li><a href="#81在nfs上准备两个告警规则文件" class="table-of-contents__link toc-highlight">8.1.在NFS上准备两个告警规则文件</a></li><li><a href="#82编写rules告警规则的pvpvcyaml文件" class="table-of-contents__link toc-highlight">8.2.编写rules告警规则的pv、pvcyaml文件</a></li><li><a href="#83修改prometheus的statefulset资源集成rules" class="table-of-contents__link toc-highlight">8.3.修改prometheus的statefulset资源集成rules</a></li><li><a href="#84更新prometheus-statefulset资源" class="table-of-contents__link toc-highlight">8.4.更新prometheus-statefulset资源</a></li><li><a href="#85修改prometheus-configmap资源配置alertmanager地址" class="table-of-contents__link toc-highlight">8.5.修改prometheus-configmap资源配置alertmanager地址</a></li><li><a href="#85查看页面是否增加告警规则" class="table-of-contents__link toc-highlight">8.5.查看页面是否增加告警规则</a></li><li><a href="#86模拟node主机宕机并查看微信告警内容" class="table-of-contents__link toc-highlight">8.6.模拟node主机宕机并查看微信告警内容</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs Releases</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://agou-ops.cn/myDocs" target="_blank" rel="noopener noreferrer" class="footer__link-item">Version 1.0<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://agou-ops.cn/myDocsv2" target="_blank" rel="noopener noreferrer" class="footer__link-item">Version 2.0<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://agou-ops.cn/myDocsv3" target="_blank" rel="noopener noreferrer" class="footer__link-item">Version 3.0<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://agou-ops.cn/myDocsv4" target="_blank" rel="noopener noreferrer" class="footer__link-item">⭐️Version 4.0<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Social</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://agou-ops.cn" target="_blank" rel="noopener noreferrer" class="footer__link-item">⭐️我的博客<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/AGou-ops" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 AGou-ops' Documetation v4.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.b04b912f.js"></script>
<script src="/assets/js/main.4851b47f.js"></script>
</body>
</html>