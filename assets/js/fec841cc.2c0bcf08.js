"use strict";(self.webpackChunkmy_docsv_4=self.webpackChunkmy_docsv_4||[]).push([[1630],{3905:(e,n,t)=>{t.d(n,{Zo:()=>u,kt:()=>m});var s=t(67294);function a(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function r(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);n&&(s=s.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,s)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?r(Object(t),!0).forEach((function(n){a(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,s,a=function(e,n){if(null==e)return{};var t,s,a={},r=Object.keys(e);for(s=0;s<r.length;s++)t=r[s],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(s=0;s<r.length;s++)t=r[s],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var i=s.createContext({}),d=function(e){var n=s.useContext(i),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},u=function(e){var n=d(e.components);return s.createElement(i.Provider,{value:n},e.children)},c={inlineCode:"code",wrapper:function(e){var n=e.children;return s.createElement(s.Fragment,{},n)}},p=s.forwardRef((function(e,n){var t=e.components,a=e.mdxType,r=e.originalType,i=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),p=d(t),m=a,h=p["".concat(i,".").concat(m)]||p[m]||c[m]||r;return t?s.createElement(h,o(o({ref:n},u),{},{components:t})):s.createElement(h,o({ref:n},u))}));function m(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var r=t.length,o=new Array(r);o[0]=p;var l={};for(var i in n)hasOwnProperty.call(n,i)&&(l[i]=n[i]);l.originalType=e,l.mdxType="string"==typeof e?e:a,o[1]=l;for(var d=2;d<r;d++)o[d]=t[d];return s.createElement.apply(null,o)}return s.createElement.apply(null,t)}p.displayName="MDXCreateElement"},93617:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>i,contentTitle:()=>o,default:()=>c,frontMatter:()=>r,metadata:()=>l,toc:()=>d});var s=t(87462),a=(t(67294),t(3905));const r={},o="dnsmasq \u90e8\u7f72\u4e0e\u4f7f\u7528",l={unversionedId:"LinuxBasics/dnsmasq",id:"LinuxBasics/dnsmasq",title:"dnsmasq \u90e8\u7f72\u4e0e\u4f7f\u7528",description:"\u7f16\u8bd1\u5b89\u88c5",source:"@site/docs/LinuxBasics/dnsmasq.md",sourceDirName:"LinuxBasics",slug:"/LinuxBasics/dnsmasq",permalink:"/docs/LinuxBasics/dnsmasq",draft:!1,editUrl:"https://github.com/AGou-ops/myDocsv4/edit/main/docs/LinuxBasics/dnsmasq.md",tags:[],version:"current",frontMatter:{},sidebar:"linuxBasics",previous:{title:"WireGuard VPN for Ubuntu",permalink:"/docs/LinuxBasics/WireGuard VPN for Ubuntu"},next:{title:"Linux Basics.",permalink:"/docs/LinuxBasics/"}},i={},d=[{value:"\u7f16\u8bd1\u5b89\u88c5",id:"\u7f16\u8bd1\u5b89\u88c5",level:2},{value:"install dnsmasq on ubuntu",id:"install-dnsmasq-on-ubuntu",level:2},{value:"Step 1: Installing Dnsmasq on Ubuntu 18.04",id:"step-1-installing-dnsmasq-on-ubuntu-1804",level:3},{value:"Step 2: Adding DNS records to Dnsmasq",id:"step-2-adding-dns-records-to-dnsmasq",level:3},{value:"Step 3: Testing Dnsmasq DNS functionality",id:"step-3-testing-dnsmasq-dns-functionality",level:3},{value:"Configure Dnsmasq as DHCP Server (Optional)",id:"configure-dnsmasq-as-dhcp-server-optional",level:3},{value:"Conclusion",id:"conclusion",level:3},{value:"install dnsmasq on CentOS",id:"install-dnsmasq-on-centos",level:2},{value:"\u53c2\u8003\u94fe\u63a5",id:"\u53c2\u8003\u94fe\u63a5",level:2}],u={toc:d};function c(e){let{components:n,...t}=e;return(0,a.kt)("wrapper",(0,s.Z)({},u,t,{components:n,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"dnsmasq-\u90e8\u7f72\u4e0e\u4f7f\u7528"},"dnsmasq \u90e8\u7f72\u4e0e\u4f7f\u7528"),(0,a.kt)("h2",{id:"\u7f16\u8bd1\u5b89\u88c5"},"\u7f16\u8bd1\u5b89\u88c5"),(0,a.kt)("p",null,"\u4ece ",(0,a.kt)("a",{parentName:"p",href:"http://www.thekelleys.org.uk/dnsmasq/"},"http://www.thekelleys.org.uk/dnsmasq/")," \u4e0b\u8f7d\u6e90\u7801\u5305, \u5b89\u88c5\u7f16\u8bd1\u73af\u5883, \u7136\u540e\u76f4\u63a5\u4f7f\u7528",(0,a.kt)("inlineCode",{parentName:"p"},"root"),"\u8eab\u4efd\u8fd0\u884c",(0,a.kt)("inlineCode",{parentName:"p"},"make install"),"\u547d\u4ee4\u5373\u53ef, \u9ed8\u8ba4\u5b89\u88c5\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u4f4d\u7f6e\u4e3a",(0,a.kt)("inlineCode",{parentName:"p"},"/usr/local/sbin/dnsmasq"),"."),(0,a.kt)("h2",{id:"install-dnsmasq-on-ubuntu"},"install dnsmasq on ubuntu"),(0,a.kt)("h3",{id:"step-1-installing-dnsmasq-on-ubuntu-1804"},"Step 1: Installing Dnsmasq on Ubuntu 18.04"),(0,a.kt)("p",null,"Ubuntu 18.04 comes with systemd-resolve which you need to disable since it binds to port ",(0,a.kt)("strong",{parentName:"p"},"53")," which will conflict with Dnsmasq port."),(0,a.kt)("p",null,"Run the following commands to disable the resolved service:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"sudo systemctl disable systemd-resolved\nsudo systemctl stop systemd-resolved\n")),(0,a.kt)("p",null,"Also, remove the symlinked ",(0,a.kt)("inlineCode",{parentName:"p"},"resolv.conf")," file"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"$ ls -lh /etc/resolv.conf \nlrwxrwxrwx 1 root root 39 Aug  8 15:52 /etc/resolv.conf -> ../run/systemd/resolve/stub-resolv.conf\n\n$ sudo rm /etc/resolv.conf\n")),(0,a.kt)("p",null,"Then create new ",(0,a.kt)("strong",{parentName:"p"},"resolv.conf")," file."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'echo "nameserver 8.8.8.8" > /etc/resolv.conf\n')),(0,a.kt)("p",null,"Dnsmasq is available on the apt repository, easy installation can be done by running:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"sudo apt-get install dnsmasq\n")),(0,a.kt)("p",null,"The main configuration file for Dnsmasq is ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/dnsmasq.conf"),". Configure Dnsmasq by modifying this file."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"sudo vim /etc/dnsmasq.conf\n")),(0,a.kt)("p",null,"Here is minimal configuration"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'# Listen on this specific port instead of the standard DNS port\n# (53). Setting this to zero completely disables DNS function,\n# leaving only DHCP and/or TFTP.\nport=53\n# Never forward plain names (without a dot or domain part)\ndomain-needed\n# Never forward addresses in the non-routed address spaces.\nbogus-priv\n# By  default,  dnsmasq  will  send queries to any of the upstream\n# servers it knows about and tries to favour servers to are  known\n# to  be  up.  Uncommenting this forces dnsmasq to try each query\n# with  each  server  strictly  in  the  order  they   appear   in\n# /etc/resolv.conf\nstrict-order\n# Set this (and domain: see below) if you want to have a domain\n# automatically added to simple names in a hosts-file.\nexpand-hosts\n# Set the domain for dnsmasq. this is optional, but if it is set, it\n# does the following things.\n# 1) Allows DHCP hosts to have fully qualified domain names, as long\n#     as the domain part matches this setting.\n# 2) Sets the "domain" DHCP option thereby potentially setting the\n#    domain of all systems configured by DHCP\n# 3) Provides the domain part for "expand-hosts"\n#domain=thekelleys.org.uk\ndomain=mypridomain.com\n\n# Set Liste address\nlisten-address=127.0.0.1 # Set to Server IP for network responses\n')),(0,a.kt)("p",null,"If you want to enable DNSSEC validation and caching, uncomment"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"#dnssec\n")),(0,a.kt)("p",null,"Make any other changes you see relevant and restart dnsmasq when done:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"sudo systemctl restart dnsmasq\n")),(0,a.kt)("h3",{id:"step-2-adding-dns-records-to-dnsmasq"},"Step 2: Adding DNS records to Dnsmasq"),(0,a.kt)("p",null,"Add DNS records in the file.",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/hosts"),". Dnsmasq will reply to queries from clients using these records."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"$ sudo vim /etc/hosts\n10.1.3.4 server1.mypridomain.com\n10.1.4.4 erp.mypridomain.com \n192.168.10.2 checkout.mypridomain.com \n192.168.4.3 hello.world\n")),(0,a.kt)("p",null,"You need to restart dnsmasq service after adding the records."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"sudo systemctl restart dnsmasq\n")),(0,a.kt)("h3",{id:"step-3-testing-dnsmasq-dns-functionality"},"Step 3: Testing Dnsmasq DNS functionality"),(0,a.kt)("p",null,"To verify that Dnsmasq responds to the records we added, point DNS server of your servers to Dnsmasq server. Edit ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/network/interfaces")," for persistent configuration, or the file ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/netplan/")," on Ubuntu 18.04 servers."),(0,a.kt)("p",null,"Since this is a test, I\u2019ll modify runtime file ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/resolv.conf")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"$ sudo vim /etc/resolv.conf\nnameserver 127.0.0.1\nnameserver 8.8.8.8\n")),(0,a.kt)("p",null,"Test using dig:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"$ dig A erp.mypridomain.com\n\n; <<>> DiG 9.11.3-1ubuntu1.1-Ubuntu <<>> A erp.mypridomain.com\n;; global options: +cmd\n;; Got answer:\n;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 43392\n;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1\n\n;; OPT PSEUDOSECTION:\n; EDNS: version: 0, flags:; udp: 4096\n;; QUESTION SECTION:\n;erp.mypridomain.com.       IN  A\n\n;; ANSWER SECTION:\nerp.mypridomain.com.    0   IN  A   10.1.4.4\n\n;; Query time: 0 msec\n;; SERVER: 127.0.0.1#53(127.0.0.1)\n;; WHEN: Tue Aug 21 10:35:41 UTC 2018\n;; MSG SIZE  rcvd: 64\n")),(0,a.kt)("p",null,"Here is another example:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"$ dig checkout.mypridomain.com A +noall +answer\n\n; <<>> DiG 9.11.3-1ubuntu1.1-Ubuntu <<>> checkout.mypridomain.com A +noall +answer\n;; global options: +cmd\ncheckout.mypridomain.com. 0 IN A 192.168.10.2\n")),(0,a.kt)("p",null,"You can confirm that we\u2019re getting responses as configured."),(0,a.kt)("h3",{id:"configure-dnsmasq-as-dhcp-server-optional"},"Configure Dnsmasq as DHCP Server (Optional)"),(0,a.kt)("p",null,"You can use Dnsmasq to assign IP addresses to clients, either static or dynamic."),(0,a.kt)("p",null,"Edit the file a",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/dnsmasq.conf")," and provide DHCP options. You need to provide:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Default gateway IP address"),(0,a.kt)("li",{parentName:"ul"},"DNS server IP address (Probably Dnsmasq or different DNS server)"),(0,a.kt)("li",{parentName:"ul"},"Network Subnet mask"),(0,a.kt)("li",{parentName:"ul"},"DHCP Addresses range"),(0,a.kt)("li",{parentName:"ul"},"NTP server")),(0,a.kt)("p",null,"See below example"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"dhcp-range=192.168.3.25,192.168.3.50,24h\ndhcp-option=option:router,192.168.3.1\ndhcp-option=option:ntp-server,192.168.3.5\ndhcp-option=option:dns-server,192.168.3.5\ndhcp-option=option:netmask,255.255.255.0\n")),(0,a.kt)("p",null,"Restart dnsmasq and configure clients to obtain an IP address from this server."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"sudo systemctl restart dnsmasq\n")),(0,a.kt)("h3",{id:"conclusion"},"Conclusion"),(0,a.kt)("p",null,"Dnsmasq is an easy to configure DNS cache which can speed up internet browsing and the resolving of domain records on your systems. You can also enjoy its DHCP subsystem which is easy to configure and use for a small network."),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"\u6765\u6e90: ",(0,a.kt)("a",{parentName:"p",href:"https://computingforgeeks.com/install-and-configure-dnsmasq-on-ubuntu-18-04-lts/"},"https://computingforgeeks.com/install-and-configure-dnsmasq-on-ubuntu-18-04-lts/"))),(0,a.kt)("h2",{id:"install-dnsmasq-on-centos"},"install dnsmasq on CentOS"),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"\u53c2\u8003: ",(0,a.kt)("a",{parentName:"p",href:"https://www.tecmint.com/setup-a-dns-dhcp-server-using-dnsmasq-on-centos-rhel/"},"https://www.tecmint.com/setup-a-dns-dhcp-server-using-dnsmasq-on-centos-rhel/"))),(0,a.kt)("h2",{id:"\u53c2\u8003\u94fe\u63a5"},"\u53c2\u8003\u94fe\u63a5"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"dnsmasq docs: ",(0,a.kt)("a",{parentName:"li",href:"http://www.thekelleys.org.uk/dnsmasq/doc.html"},"http://www.thekelleys.org.uk/dnsmasq/doc.html"))))}c.isMDXComponent=!0}}]);