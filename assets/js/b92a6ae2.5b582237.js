"use strict";(self.webpackChunkmy_docsv_4=self.webpackChunkmy_docsv_4||[]).push([[6947],{3905:(e,n,t)=>{t.d(n,{Zo:()=>c,kt:()=>d});var r=t(67294);function a(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){a(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,r,a=function(e,n){if(null==e)return{};var t,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)t=o[r],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)t=o[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var p=r.createContext({}),i=function(e){var n=r.useContext(p),t=n;return e&&(t="function"==typeof e?e(n):l(l({},n),e)),t},c=function(e){var n=i(e.components);return r.createElement(p.Provider,{value:n},e.children)},u={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},m=r.forwardRef((function(e,n){var t=e.components,a=e.mdxType,o=e.originalType,p=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),m=i(t),d=a,g=m["".concat(p,".").concat(d)]||m[d]||u[d]||o;return t?r.createElement(g,l(l({ref:n},c),{},{components:t})):r.createElement(g,l({ref:n},c))}));function d(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var o=t.length,l=new Array(o);l[0]=m;var s={};for(var p in n)hasOwnProperty.call(n,p)&&(s[p]=n[p]);s.originalType=e,s.mdxType="string"==typeof e?e:a,l[1]=s;for(var i=2;i<o;i++)l[i]=t[i];return r.createElement.apply(null,l)}return r.createElement.apply(null,t)}m.displayName="MDXCreateElement"},95804:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>p,contentTitle:()=>l,default:()=>u,frontMatter:()=>o,metadata:()=>s,toc:()=>i});var r=t(87462),a=(t(67294),t(3905));const o={},l="Prometheus + Consul(\u670d\u52a1\u53d1\u73b0)",s={unversionedId:"CloudNative/Prometheus/Prometheus-Consul\uff08\u670d\u52a1\u53d1\u73b0\uff09",id:"CloudNative/Prometheus/Prometheus-Consul\uff08\u670d\u52a1\u53d1\u73b0\uff09",title:"Prometheus + Consul(\u670d\u52a1\u53d1\u73b0)",description:"\u5355\u673a\u90e8\u7f72\u6d4b\u8bd5",source:"@site/docs/CloudNative/Prometheus/Prometheus-Consul\uff08\u670d\u52a1\u53d1\u73b0\uff09.md",sourceDirName:"CloudNative/Prometheus",slug:"/CloudNative/Prometheus/Prometheus-Consul\uff08\u670d\u52a1\u53d1\u73b0\uff09",permalink:"/docs/CloudNative/Prometheus/Prometheus-Consul\uff08\u670d\u52a1\u53d1\u73b0\uff09",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/CloudNative/Prometheus/Prometheus-Consul\uff08\u670d\u52a1\u53d1\u73b0\uff09.md",tags:[],version:"current",frontMatter:{},sidebar:"cloudNative",previous:{title:"Prometheus + AlertManager",permalink:"/docs/CloudNative/Prometheus/Prometheus-AlertManager"},next:{title:"influxDB/Telegraf basic",permalink:"/docs/CloudNative/Prometheus/influxDB\u3001Telegraf Basic"}},p={},i=[{value:"\u5355\u673a\u90e8\u7f72\u6d4b\u8bd5",id:"\u5355\u673a\u90e8\u7f72\u6d4b\u8bd5",level:2},{value:"Consul \u5206\u5e03\u5f0f\u96c6\u7fa4\u642d\u5efa",id:"consul-\u5206\u5e03\u5f0f\u96c6\u7fa4\u642d\u5efa",level:3},{value:"\u914d\u7f6e Prom \u5b9e\u73b0\u81ea\u52a8\u670d\u52a1\u53d1\u73b0",id:"\u914d\u7f6e-prom-\u5b9e\u73b0\u81ea\u52a8\u670d\u52a1\u53d1\u73b0",level:3},{value:"\u914d\u7f6e\u5e76\u542f\u52a8 Prom",id:"\u914d\u7f6e\u5e76\u542f\u52a8-prom",level:3},{value:"\u62d3\u5c55\uff1a\u914d\u7f6e nginx \u8d1f\u8f7d\u5747\u8861 Consul \u96c6\u7fa4",id:"\u62d3\u5c55\u914d\u7f6e-nginx-\u8d1f\u8f7d\u5747\u8861-consul-\u96c6\u7fa4",level:3},{value:"\u4f7f\u7528 Docker \u90e8\u7f72",id:"\u4f7f\u7528-docker-\u90e8\u7f72",level:2},{value:"\u8fc7\u6ee4\u6807\u7b7e",id:"\u8fc7\u6ee4\u6807\u7b7e",level:3},{value:"\u6dfb\u52a0\u6807\u7b7e",id:"\u6dfb\u52a0\u6807\u7b7e",level:3},{value:"\u670d\u52a1\u6807\u7b7e\u5206\u7c7b",id:"\u670d\u52a1\u6807\u7b7e\u5206\u7c7b",level:3},{value:"\u53c2\u8003\u94fe\u63a5",id:"\u53c2\u8003\u94fe\u63a5",level:2}],c={toc:i};function u(e){let{components:n,...t}=e;return(0,a.kt)("wrapper",(0,r.Z)({},c,t,{components:n,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"prometheus--consul\u670d\u52a1\u53d1\u73b0"},"Prometheus + Consul(\u670d\u52a1\u53d1\u73b0)"),(0,a.kt)("h2",{id:"\u5355\u673a\u90e8\u7f72\u6d4b\u8bd5"},"\u5355\u673a\u90e8\u7f72\u6d4b\u8bd5"),(0,a.kt)("h3",{id:"consul-\u5206\u5e03\u5f0f\u96c6\u7fa4\u642d\u5efa"},"Consul \u5206\u5e03\u5f0f\u96c6\u7fa4\u642d\u5efa"),(0,a.kt)("p",null,"Consul \u4e0b\u8f7d\u4e0e\u57fa\u7840\u914d\u7f6e\u53c2\u8003 ","[Consul \u5165\u95e8]","(./Consul \u5165\u95e8.md)"),(0,a.kt)("p",null,"\u7531\u4e8e\u624b\u5934\u8d44\u6e90\u6709\u9650\uff0c\u6545\u5c06\u96c6\u7fa4\u90e8\u7f72\u5230\u4e00\u53f0\u4e3b\u673a\u4e4b\u4e0a\u7684\u4e0d\u540c\u7aef\u53e3\u6765\u6a21\u62df\u96c6\u7fa4."),(0,a.kt)("p",null,"\u73af\u5883\uff1a"),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:null},"\u89d2\u8272"),(0,a.kt)("th",{parentName:"tr",align:null},"\u4e3b\u673a"))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"leader\u3001node01"),(0,a.kt)("td",{parentName:"tr",align:null},"172.16.1.132:8500")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"follower01\u3001node02"),(0,a.kt)("td",{parentName:"tr",align:null},"172.16.1.132:8501")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"follower02\u3001node03"),(0,a.kt)("td",{parentName:"tr",align:null},"172.16.1.132:8502")))),(0,a.kt)("p",null,"\u9996\u5148\u5efa\u7acb\u5b58\u653e\u6570\u636e\u76ee\u5f55\uff1a",(0,a.kt)("inlineCode",{parentName:"p"}," mkdir -pv /data/prometheus/consul/consul0{1..3}")),(0,a.kt)("p",null,"\u26a0\ufe0f",(0,a.kt)("strong",{parentName:"p"},"\u6ce8\u610f\uff1a"),"\u4ee5\u4e0b json \u683c\u5f0f\u6587\u4ef6\u4e2d\u7684\u6ce8\u91ca\u5185\u5bb9\u9700\u8981\u5728\u5e94\u7528\u7684\u65f6\u5019\u53bb\u6389\uff0c\u5728\u6b64\u4ec5\u4e3a\u4e86\u65b9\u4fbf\u7406\u89e3."),(0,a.kt)("p",null,"\u914d\u7f6e leader \u5b9e\u4f8b\uff0c\u65b0\u5efa\u914d\u7f6e\u6587\u4ef6 ",(0,a.kt)("inlineCode",{parentName:"p"},"consul01.json")," \uff0c\u5185\u5bb9\u5982\u4e0b \uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "datacenter": "dc1",\n  "data_dir": "/data/prometheus/consul/consul01",   // \u672c\u5730\u5b58\u653e\u6570\u636e\u7684\u76ee\u5f55\n  "log_level": "INFO",\n  "server": true,     // \u4ee5server\u8eab\u4efd\u542f\u52a8\u5b9e\u4f8b\n  "node_name": "node1",\n  "ui": true,     // \u662f\u5426\u53ef\u4ee5\u8bbf\u95eeui\u754c\u9762\n  "bind_addr": "172.16.1.132",\n  "client_addr": "0.0.0.0",\n  "advertise_addr": "172.16.1.132",     // \u96c6\u7fa4\u5e7f\u64ad\u5730\u5740\n  "bootstrap_expect": 3,      // \u96c6\u7fa4\u6700\u5c11\u6210\u5458\u6570\n  "ports":{\n    "http": 8500,\n    "dns": 8600,\n    "server": 8300,\n    "serf_lan": 8301,\n    "serf_wan": 8302\n    }\n}\n')),(0,a.kt)("p",null,"\u540e\u53f0\u542f\u52a8",(0,a.kt)("inlineCode",{parentName:"p"},"node01"),"\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"nohup consul agent -config-dir=consul01.json > ./consul01.log 2>&1 &\n")),(0,a.kt)("p",null,"\u914d\u7f6e",(0,a.kt)("inlineCode",{parentName:"p"},"follower01"),"\uff0c\u65b0\u5efa\u914d\u7f6e\u6587\u4ef6",(0,a.kt)("inlineCode",{parentName:"p"},"consul02.json"),"\uff0c\u5185\u5bb9\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "datacenter": "dc1",\n  "data_dir": "/data/prometheus/consul/consul02",   // \u6539\u4e3aconsul03\n  "log_level": "INFO",\n  "server": true,\n  "node_name": "node2",     // \u6539\u4e3anode03\n  "ui": true, \n  "bind_addr": "172.16.1.132", \n  "client_addr": "0.0.0.0", \n  "advertise_addr": "172.16.1.132", \n  "bootstrap_expect": 3, \n  "ports":{\n    "http": 8501,   // \u6539\u4e3a8502\n    "dns": 8601,    // \u6539\u4e3a8602\n    "server": 8310,   // \u6539\u4e3a8320\n    "serf_lan": 8311, // \u6539\u4e3a8321\n    "serf_wan": 8312  // \u6539\u4e3a8322\n    }\n}\n')),(0,a.kt)("p",null,"\u914d\u7f6e",(0,a.kt)("inlineCode",{parentName:"p"},"follower02"),"\u4e0e\u4e0a\u9762\u914d\u7f6e",(0,a.kt)("inlineCode",{parentName:"p"},"follower01"),"\u7c7b\u4f3c\uff0c\u4e0d\u518d\u8d58\u8ff0"),(0,a.kt)("p",null,"\u540e\u53f0\u542f\u52a8",(0,a.kt)("inlineCode",{parentName:"p"},"follower01"),"\u548c",(0,a.kt)("inlineCode",{parentName:"p"},"follower02"),"\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"nohup consul agent -config-dir=consul02.json -join 172.16.1.132:8301 > ./consul02.log 2>&1 &\nnohup consul agent -config-dir=consul03.json -join 172.16.1.132:8301 > ./consul03.log 2>&1 &\n")),(0,a.kt)("p",null,"\u67e5\u770b\u5404\u6210\u5458\u542f\u52a8\u72b6\u6001\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"[root@master consul]\\# consul members\nNode    Address            Status  Type    Build  Protocol  DC   Segment\nnode01  172.16.1.132:8301  alive   server  1.7.2  2         dc1  <all>\nnode02  172.16.1.132:8311  alive   server  1.7.2  2         dc1  <all>\nnode03  172.16.1.132:8321  alive   server  1.7.2  2         dc1  <all>\n# \u67e5\u770b\u96c6\u7fa4\u72b6\u6001\u53ca\u89d2\u8272\u4fe1\u606f\n[root@master consul]\\# consul operator raft list-peers\nNode    ID                                    Address            State     Voter  RaftProtocol\nnode01  767fbfc2-0c11-0c23-989a-cbf51c6af15b  172.16.1.132:8300  leader    true   3\nnode02  4a0a188a-aafe-24c2-1dc5-62f321671573  172.16.1.132:8310  follower  true   3\nnode03  77926cab-0bbb-5c4a-5976-e3b354915c1e  172.16.1.132:8320  follower  true   3\n")),(0,a.kt)("p",null,"\u6b64\u65f6\uff0c\u4f60\u53ef\u4ee5\u8bbf\u95ee\u4efb\u610f\u4e00\u4e2a\u8282\u70b9\uff0c\u67e5\u770b\u5176\u5065\u5eb7\u72b6\u51b5\uff0c",(0,a.kt)("a",{parentName:"p",href:"http://127.0.0.1:8500"},"http://127.0.0.1:8500")," \u6216 ",(0,a.kt)("a",{parentName:"p",href:"http://127.0.0.1:8501"},"http://127.0.0.1:8501")," \u6216 ",(0,a.kt)("a",{parentName:"p",href:"http://127.0.0.1:8502"},"http://127.0.0.1:8502")),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/blog-images/promethues%20%2B%20consul/consul-01.png",alt:null})),(0,a.kt)("h3",{id:"\u914d\u7f6e-prom-\u5b9e\u73b0\u81ea\u52a8\u670d\u52a1\u53d1\u73b0"},"\u914d\u7f6e Prom \u5b9e\u73b0\u81ea\u52a8\u670d\u52a1\u53d1\u73b0"),(0,a.kt)("p",null,"\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u914d\u7f6e",(0,a.kt)("inlineCode",{parentName:"p"},"Prometheus "),"\u6765\u4f7f\u7528",(0,a.kt)("inlineCode",{parentName:"p"}," Consul \u96c6\u7fa4"),"\u6765\u5b9e\u73b0\u81ea\u52a8\u670d\u52a1\u53d1\u73b0\uff0c\u76ee\u7684\u5c31\u662f\u80fd\u591f\u5c06\u6dfb\u52a0\u7684\u670d\u52a1\u81ea\u52a8\u53d1\u73b0\u5230 ",(0,a.kt)("inlineCode",{parentName:"p"},"Prometheus "),"\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"Targets")," \u4e2d\uff0c Prometheus \u901a\u8fc7 consul \u5b9e\u73b0\u81ea\u52a8\u670d\u52a1\u53d1\u73b0 \u4e2d\u7684\u914d\u7f6e\uff0c\u5728\u4fee\u6539 Prometheus \u914d\u7f6e\u4e4b\u524d\uff0c\u6211\u4eec\u9700\u8981\u5f80 Consul \u96c6\u7fa4\u4e2d\u6ce8\u518c\u4e00\u4e9b\u6570\u636e\u3002\u9996\u5148\uff0c\u6211\u4eec\u6ce8\u518c\u4e00\u4e2a",(0,a.kt)("inlineCode",{parentName:"p"},"node-exporter-172.16.1.132"),"\u7684\u670d\u52a1\uff0c\u65b0\u5efa ",(0,a.kt)("inlineCode",{parentName:"p"},"service-1.json "),"\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'{\n  "ID": "node-exporter",\n  "Name": "node-exporter-172.16.1.132",\n  "Tags": [\n    "node-exporter"\n  ],\n  "Address": "172.16.1.132",\n  "Port": 9100,\n  "Meta": {\n    "app": "spring-boot",\n    "team": "appgroup",\n    "project": "bigdata"\n  },\n  "EnableTagOverride": false,\n  "Check": {\n    "HTTP": "http://172.16.1.132:9100/metrics",\n    "Interval": "10s"\n  },\n  "Weights": {\n    "Passing": 10,\n    "Warning": 1\n  }\n}\n\n# \u8c03\u7528 API \u6ce8\u518c\u670d\u52a1\ncurl --request PUT --data @service-1.json http://172.16.1.132:8500/v1/agent/service/register?replace-existing-checks=1\n')),(0,a.kt)("p",null,"\u7136\u540e\uff0c\u6211\u4eec\u518d\u6ce8\u518c\u4e00\u4e2a ",(0,a.kt)("inlineCode",{parentName:"p"},"cadvisor-exporter-172.16.1.132")," \u7684\u670d\u52a1\uff0c\u65b0\u5efa ",(0,a.kt)("inlineCode",{parentName:"p"},"service-2.json")," \u5e76\u6267\u884c\u5982\u4e0b\u547d\u4ee4\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'{\n  "ID": "cadvisor-exporter",\n  "Name": "cadvisor-exporter-172.16.1.132",\n  "Tags": [\n    "cadvisor-exporter"\n  ],\n  "Address": "172.16.1.132",\n  "Port": 8080,\n  "Meta": {\n    "app": "docker",\n    "team": "cloudgroup",\n    "project": "docker-service"\n  },\n  "EnableTagOverride": false,\n  "Check": {\n    "HTTP": "http://172.16.1.132:8080/metrics",\n    "Interval": "10s"\n  },\n  "Weights": {\n    "Passing": 10,\n    "Warning": 1\n  }\n}\n\n# \u8c03\u7528 API \u6ce8\u518c\u670d\u52a1\ncurl --request PUT --data @service-2.json http://172.16.1.132:8500/v1/agent/service/register?replace-existing-checks=1\n')),(0,a.kt)("p",null,"\u6ce8\u610f\uff0c\u6ce8\u518c API \u4e4b\u524d\uff0c\u8981\u5148\u5c06\u670d\u52a1\u542f\u52a8\u8d77\u6765\uff0c\u8fd9\u91cc\u4e3a\u4e86\u65b9\u4fbf\u8d77\u89c1\uff0c\u4f7f\u7528 Docker \u542f\u52a8\u8fd9\u4e24\u4e2a\u6d4b\u8bd5\u670d\u52a1\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"docker run -d -p 9100:9100 --name node-exporter prom/node-exporter \ndocker run -d -p 8080:8080 --name cadvisor-exporter google/cadvisor\n")),(0,a.kt)("p",null,"\u6ce8\u518c\u5b8c\u6bd5\u540e\uff0c\u6253\u5f00 Consul \u7684 web \u754c\u9762\u8fdb\u884c\u67e5\u770b\uff0c",(0,a.kt)("a",{parentName:"p",href:"http://127.0.0.1:8500"},"http://127.0.0.1:8500")),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/blog-images/promethues%20%2B%20consul/consul-02.png",alt:null})),(0,a.kt)("h3",{id:"\u914d\u7f6e\u5e76\u542f\u52a8-prom"},"\u914d\u7f6e\u5e76\u542f\u52a8 Prom"),(0,a.kt)("p",null,"\u4fee\u6539 Prom \u7684\u914d\u7f6e\u6587\u4ef6",(0,a.kt)("inlineCode",{parentName:"p"},"prometheus.yml"),"\uff0c\u5185\u5bb9\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"global:\n  scrape_interval:     15s \n  evaluation_interval: 15s \n  \nscrape_configs:\n  - job_name: 'prometheus'\n    scrape_interval:     5s\n    static_configs:\n      - targets: ['localhost:9090']\n  \n  - job_name: 'consul-node-exporter'\n    consul_sd_configs:\n      - server: '172.16.1.132:8500'     # nginx\u8d1f\u8f7d\u5747\u8861\uff0c\u6539\u4e3a172.16.1.132\n        services: []  \n    relabel_configs:\n      - source_labels: [__meta_consul_tags]\n        regex: .*node-exporter.*\n        action: keep\n      - regex: __meta_consul_service_metadata_(.+)\n        action: labelmap\n\n  - job_name: 'consul-cadvisor-exproter'\n    consul_sd_configs:\n      - server: '172.16.1.132:8501'     # nginx\u8d1f\u8f7d\u5747\u8861\uff0c\u6539\u4e3a172.16.1.132\n        services: []\n      - server: '172.16.1.132:8502'     # \n        services: []\n    relabel_configs:\n      - source_labels: [__meta_consul_tags]\n        regex: .*cadvisor-exporter.*\n        action: keep\n      - action: labelmap\n        regex: __meta_consul_service_metadata_(.+)\n")),(0,a.kt)("p",null,"\u542f\u52a8",(0,a.kt)("inlineCode",{parentName:"p"},"Prom")," \u670d\u52a1\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"./prometheus --config.file=prometheus.yml\n")),(0,a.kt)("p",null,"\u6253\u5f00\u6d4f\u89c8\u5668\uff0c\u8bbf\u95ee ",(0,a.kt)("a",{parentName:"p",href:"http://127.0.0.1:9090"},"http://127.0.0.1:9090")," \u8fdb\u884c\u67e5\u770b"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/blog-images/promethues%20%2B%20consul/consul-03.png",alt:null})),(0,a.kt)("p",null,"\u53ef\u4ee5\u770b\u5230\uff0c\u59a5\u59a5\u6ca1\u6709\u95ee\u9898\uff0c\u8fd9\u91cc ",(0,a.kt)("inlineCode",{parentName:"p"},"consul-node-exporter "),"\u6211\u914d\u7f6e\u6307\u5411\u4e86 ",(0,a.kt)("inlineCode",{parentName:"p"},"node1 Consul")," \u670d\u52a1\u5730\u5740\uff0c",(0,a.kt)("inlineCode",{parentName:"p"},"consul-cadvisor-exproter")," \u914d\u7f6e\u6307\u5411\u4e86",(0,a.kt)("inlineCode",{parentName:"p"},"node2\u3001node3 Consul "),"\u670d\u52a1\uff0c\u4e8c\u8005\u90fd\u80fd\u591f\u6b63\u786e\u53d1\u73b0\u4e4b\u524d\u6ce8\u518c\u7684\u670d\u52a1\uff0c\u56e0\u4e3a Consul \u96c6\u7fa4\u6570\u636e\u662f\u4fdd\u6301\u540c\u6b65\u7684\uff0c\u65e0\u8bba\u8fde\u63a5\u54ea\u4e00\u4e2a\u8282\u70b9\uff0c\u90fd\u80fd\u591f\u83b7\u53d6\u5230\u6ce8\u518c\u7684\u670d\u52a1\u4fe1\u606f\uff0c\u540c\u7406\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u6307\u5b9a ",(0,a.kt)("inlineCode",{parentName:"p"},"consul_sd_configs "),"\u5206\u522b\u6307\u5411\u96c6\u7fa4\u6240\u6709\u8282\u70b9\uff0c\u8fd9\u6837\u5373\u4f7f\u67d0\u4e2a\u8282\u70b9\u6302\u6389\uff0c\u4e5f\u4e0d\u4f1a\u5f71\u54cd Prometheus \u4ece Consul \u96c6\u7fa4\u5176\u4ed6\u8282\u70b9\u83b7\u53d6\u6ce8\u518c\u7684\u670d\u52a1\uff0c\u4ece\u800c\u5b9e\u73b0\u670d\u52a1\u7684\u9ad8\u53ef\u7528\u3002"),(0,a.kt)("h3",{id:"\u62d3\u5c55\u914d\u7f6e-nginx-\u8d1f\u8f7d\u5747\u8861-consul-\u96c6\u7fa4"},"\u62d3\u5c55\uff1a\u914d\u7f6e nginx \u8d1f\u8f7d\u5747\u8861 Consul \u96c6\u7fa4"),(0,a.kt)("p",null,"\u867d\u7136\u6211\u4eec\u53ef\u4ee5\u5c06\u6574\u4e2a Consul \u96c6\u7fa4 IP \u6dfb\u52a0\u5230 Prometheus \u7684\u914d\u7f6e\u4e2d\uff0c\u4ece\u800c\u5b9e\u73b0 Prometheus \u4ece Consul \u96c6\u7fa4\u83b7\u53d6\u6ce8\u518c\u7684\u670d\u52a1\uff0c\u5b9e\u73b0\u670d\u52a1\u7684\u9ad8\u53ef\u7528\uff0c\u4f46\u662f\u8fd9\u91cc\u6709\u4e2a\u95ee\u9898\uff0c\u5982\u679c Consul \u96c6\u7fa4\u8282\u70b9\u65b0\u589e\u6216\u8005\u51cf\u5c11\uff0c\u90a3\u4e48 Prometheus \u914d\u7f6e\u4e5f\u5f97\u8ddf\u7740\u4fee\u6539\u4e86\uff0c\u8fd9\u6837\u4e0d\u662f\u5f88\u53cb\u597d\uff0c\u6211\u4eec\u53ef\u4ee5\u5728 Consul \u96c6\u7fa4\u524d\u9762\u4f7f\u7528 nginx \u53cd\u5411\u4ee3\u7406\u5c06\u8bf7\u6c42\u8d1f\u8f7d\u5747\u8861\u5230\u540e\u7aef Consul \u96c6\u7fa4\u5404\u8282\u70b9\u670d\u52a1\u4e0a\uff0c\u8fd9\u6837 Prometheus \u53ea\u9700\u8981\u914d\u7f6e\u4ee3\u7406\u5730\u5740\u5373\u53ef\uff0c\u540e\u671f\u4e0d\u9700\u8981\u66f4\u6539\u4e86\u3002"),(0,a.kt)("p",null,"\u7f16\u8f91 NGX \u7684\u914d\u7f6e\u6587\u4ef6",(0,a.kt)("inlineCode",{parentName:"p"},"nginx.conf"),"\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"upstream service_consul {\n    server 172.16.1.132:8500;\n    server 172.16.1.132:8501;\n    server 172.16.1.132:8502;\n    ip_hash;\n}\n\nserver {\n    listen       80;\n    server_name _;\n    index  index.html index.htm;    \n\n    #access_log  /var/log/nginx/host.access.log  main;\n\n    location / {\n        add_header Access-Control-Allow-Origin *;\n        proxy_next_upstream http_502 http_504 error timeout invalid_header;\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_pass http://service_consul;    \n    }\n\n    access_log /var/log/consul.access.log;\n    error_log /var/log/consul.error.log;    \n\n    error_page  404              /404.html;\n\n    error_page   500 502 503 504  /50x.html;\n    location = /50x.html {\n        root   /usr/share/nginx/html;\n    }\n}\n")),(0,a.kt)("p",null,"\u542f\u52a8 NGX \u670d\u52a1\uff1a",(0,a.kt)("inlineCode",{parentName:"p"},"systemctl start nginx")),(0,a.kt)("p",null,"\u7136\u540e\u5c06 Server \u5730\u5740\u6307\u5411 NGX \u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u4fee\u6539 Prom \u914d\u7f6e\u6587\u4ef6\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"\u538b\u7f29\u7bc7\u5e45\uff0c\u53c2\u8003\u4e0a\u9762\u5b8c\u6574\u7684`prometheus.yml`\u6ce8\u91ca\u4fe1\u606f\n")),(0,a.kt)("p",null,"\u6700\u540e\u91cd\u542f",(0,a.kt)("inlineCode",{parentName:"p"},"prometheus"),"\u670d\u52a1\u5373\u53ef."),(0,a.kt)("h2",{id:"\u4f7f\u7528-docker-\u90e8\u7f72"},"\u4f7f\u7528 Docker \u90e8\u7f72"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"\u9996\u5148\u4ece Docker Hub \u4e0a\u62c9\u53d6\u955c\u50cf\uff1a",(0,a.kt)("inlineCode",{parentName:"li"},"docker pull consul"))),(0,a.kt)("p",null,"\u5728\u672c\u5730\u542f\u52a8 Consul \u96c6\u7fa4\u8fdb\u884c\u6d4b\u8bd5\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"# docker run --name consul -d -p 8500:8500 consul\ndocker run --name consul1 -d -p 8500:8500 -p 8300:8300 -p 8301:8301 -p 8302:8302 -p 8600:8600 consul agent -server -bootstrap-expect 2 -ui -bind=0.0.0.0 -client=0.0.0.0\n# \u52a0\u5165consul1\ndocker run --name consul2 -d -p 8501:8500 consul agent -server -ui -bind=0.0.0.0 -client=0.0.0.0 -join 172.17.0.2\n")),(0,a.kt)("p",null,"\u6d4f\u89c8\u5668\u8bbf\u95ee\uff1a",(0,a.kt)("a",{parentName:"p",href:"http://172.16.1.132:8500"},"http://172.16.1.132:8500")," \u8fdb\u884c\u9a8c\u8bc1"),(0,a.kt)("ol",{start:2},(0,a.kt)("li",{parentName:"ol"},"\u542f\u52a8",(0,a.kt)("inlineCode",{parentName:"li"},"node-exporter"),"\u548c",(0,a.kt)("inlineCode",{parentName:"li"},"prometheus"))),(0,a.kt)("p",null,"\u53c2\u8003","[Prometheus + Docker]","(./Prometheus + Docker.md)"),(0,a.kt)("p",null,"\u5bb9\u5668\u5168\u90e8\u542f\u52a8\u5b8c\u6bd5\u53ea\u6709\uff0c\u5dee\u4e0d\u591a\u5927\u6982\u662f\u8fd9\u6837\u5b50\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'[root@master ~]\\# docker ps\nCONTAINER ID        IMAGE                COMMAND                  CREATED                  STATUS                  PORTS                                                                                                       NAMES\n594b53c2689c        prom/prometheus      "/bin/prometheus --c\u2026"   Less than a second ago   Up 26 minutes           0.0.0.0:9090->9090/tcp                                                                                      silly_jang\nf32263fec6a9        prom/node-exporter   "/bin/node_exporter"     Less than a second ago   Up Less than a second                                                                                                               naughty_pascal\n8da8b27d331b        consul               "docker-entrypoint.s\u2026"   5 minutes ago            Up 4 minutes            8300-8302/tcp, 8301-8302/udp, 8600/tcp, 8600/udp, 0.0.0.0:8502->8500/tcp                                    consul2\n99b657a2e7a5        consul               "docker-entrypoint.s\u2026"   6 minutes ago            Up 6 minutes            0.0.0.0:8300-8302->8300-8302/tcp, 8301-8302/udp, 0.0.0.0:8500->8500/tcp, 0.0.0.0:8600->8600/tcp, 8600/udp   consul1\n')),(0,a.kt)("ol",{start:3},(0,a.kt)("li",{parentName:"ol"},"API \u6ce8\u518c\u670d\u52a1\u5230 Consul\uff1a")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'curl -X PUT -d \'{"id": "node-exporter","name": "node-exporter-172.16.1.132","address": "172.16.1.132","port": 9100,"tags": ["test"],"checks": [{"http": "http://172.16.1.132:9100/metrics", "interval": "5s"}]}\'  http://172.16.1.132:8500/v1/agent/service/register\n')),(0,a.kt)("p",null,"\u6253\u5f00\u6d4f\u89c8\u5668\u8bbf\u95ee ",(0,a.kt)("a",{parentName:"p",href:"http://172.16.1.132:8500/ui/dc1/services"},"http://172.16.1.132:8500/ui/dc1/services")," \u67e5\u770b\u662f\u5426\u6210\u529f\u6ce8\u518c."),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/blog-images/promethues%20%2B%20consul/consul-1.png",alt:null})),(0,a.kt)("p",null,"\u5982\u679c\u60f3\u8981\u6ce8\u9500\u8be5\u670d\u52a1\uff0c\u9700\u8981\u4f7f\u7528\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"curl -X PUT http://172.16.1.132:8500/v1/agent/service/deregister/node-exporter \n")),(0,a.kt)("ol",{start:4},(0,a.kt)("li",{parentName:"ol"},"\u914d\u7f6e ",(0,a.kt)("inlineCode",{parentName:"li"},"Prometheus "),"\u5b9e\u73b0\u81ea\u52a8\u670d\u52a1\u53d1\u73b0")),(0,a.kt)("p",null,"\u73b0\u5728 Consul \u670d\u52a1\u5df2\u7ecf\u542f\u52a8\u5b8c\u6bd5\uff0c\u5e76\u6210\u529f\u6ce8\u518c\u4e86\u4e00\u4e2a\u670d\u52a1\uff0c\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u9700\u8981\u914d\u7f6e Prometheus \u6765\u4f7f\u7528 Consul \u81ea\u52a8\u670d\u52a1\u53d1\u73b0\uff0c\u76ee\u7684\u5c31\u662f\u80fd\u591f\u5c06\u4e0a\u8fb9\u6dfb\u52a0\u7684\u670d\u52a1\u81ea\u52a8\u53d1\u73b0\u5230 Prometheus \u7684 Targets \u4e2d\uff0c\u589e\u52a0 ",(0,a.kt)("inlineCode",{parentName:"p"},"prometheus.yml")," \u914d\u7f6e\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"...\n- job_name: 'consul-prometheus'\n  consul_sd_configs:\n  - server: '172.16.1.132:8500'\n    services: []  \n")),(0,a.kt)("p",null,"\u91cd\u542f",(0,a.kt)("inlineCode",{parentName:"p"},"Promtheus"),"\u7684 Docker \u5bb9\u5668\uff1a",(0,a.kt)("inlineCode",{parentName:"p"},"docker restart 594b53c2689c "),"\uff0c\u540e\u9762\u90a3\u4e2a\u77edID\u4e3a Prom \u5bb9\u5668\u7684ID."),(0,a.kt)("ol",{start:5},(0,a.kt)("li",{parentName:"ol"},"\u6253\u5f00\u6d4f\u89c8\u5668\u8bbf\u95ee ",(0,a.kt)("a",{parentName:"li",href:"http://172.16.1.132:9090/targets"},"http://172.16.1.132:9090/targets"))),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/blog-images/promethues%20%2B%20consul/consul-2.png",alt:null})),(0,a.kt)("hr",null),(0,a.kt)("p",null,"\u2139\ufe0f-----------\u4ee5\u4e0b\u5185\u5bb9\u4e3a\u8f6c\u8f7d"),(0,a.kt)("p",null,"\u53ef\u4ee5\u770b\u5230\uff0c\u5728 Targets \u4e2d\u80fd\u591f\u6210\u529f\u7684\u81ea\u52a8\u53d1\u73b0 Consul \u4e2d\u7684 Services \u4fe1\u606f\uff0c\u540e\u671f\u9700\u8981\u6dfb\u52a0\u65b0\u7684 Targets \u65f6\uff0c\u53ea\u9700\u8981\u901a\u8fc7 API \u5f80 Consul \u4e2d\u6ce8\u518c\u670d\u52a1\u5373\u53ef\uff0cPrometheus \u5c31\u80fd\u81ea\u52a8\u53d1\u73b0\u8be5\u670d\u52a1\uff0c\u662f\u4e0d\u662f\u5f88\u65b9\u4fbf\u3002"),(0,a.kt)("p",null,"\u4e0d\u8fc7\uff0c\u6211\u4eec\u4f1a\u53d1\u73b0\u6709\u5982\u4e0b\u51e0\u4e2a\u95ee\u9898\uff1a"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"\u4f1a\u53d1\u73b0 Prometheus \u540c\u65f6\u52a0\u8f7d\u51fa\u6765\u4e86\u9ed8\u8ba4\u670d\u52a1 consul\uff0c\u8fd9\u4e2a\u662f\u4e0d\u9700\u8981\u7684\u3002"),(0,a.kt)("li",{parentName:"ol"},"\u9ed8\u8ba4\u53ea\u663e\u793a job \u53ca instance \u4e24\u4e2a\u6807\u7b7e\uff0c\u5176\u4ed6\u6807\u7b7e\u90fd\u9ed8\u8ba4\u5c5e\u4e8e before relabeling \u4e0b\uff0c\u6709\u4e9b\u5fc5\u8981\u7684\u670d\u52a1\u4fe1\u606f\uff0c\u4e5f\u60f3\u8981\u5728\u6807\u7b7e\u4e2d\u5c55\u793a\uff0c\u8be5\u5982\u4f55\u64cd\u4f5c\u5462\uff1f"),(0,a.kt)("li",{parentName:"ol"},"\u5982\u679c\u9700\u8981\u81ea\u5b9a\u4e49\u4e00\u4e9b\u6807\u7b7e\uff0c\u4f8b\u5982 team\u3001group\u3001project \u7b49\u5173\u952e\u5206\u7ec4\u4fe1\u606f\uff0c\u65b9\u4fbf\u540e\u8fb9 alertmanager \u8fdb\u884c\u544a\u8b66\u89c4\u5219\u5339\u914d\uff0c\u8be5\u5982\u4f55\u5904\u7406\u5462\uff1f"),(0,a.kt)("li",{parentName:"ol"},"\u6240\u6709 Consul \u4e2d\u6ce8\u518c\u7684 Service \u90fd\u4f1a\u9ed8\u8ba4\u52a0\u8f7d\u5230 Prometheus \u4e0b\u914d\u7f6e\u7684 consul_prometheus \u7ec4\uff0c\u5982\u679c\u6709\u591a\u79cd\u7c7b\u578b\u7684 exporter\uff0c\u5982\u4f55\u5728 Prometheus \u4e2d\u914d\u7f6e\u5206\u914d\u7ed9\u6307\u5b9a\u7c7b\u578b\u7684\u7ec4\uff0c\u65b9\u4fbf\u76f4\u89c2\u7684\u533a\u522b\u5b83\u4eec\uff1f")),(0,a.kt)("p",null,"\u4ee5\u4e0a\u95ee\u9898\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 Prometheus \u914d\u7f6e\u4e2d\u7684 relabel_configs \u53c2\u6570\u6765\u89e3\u51b3\u3002"),(0,a.kt)("h3",{id:"\u8fc7\u6ee4\u6807\u7b7e"},"\u8fc7\u6ee4\u6807\u7b7e"),(0,a.kt)("p",null,"1\ufe0f\u20e3 \u95ee\u9898\u4e00\uff0c\u6211\u4eec\u53ef\u4ee5\u914d\u7f6e",(0,a.kt)("inlineCode",{parentName:"p"}," relabel_configs")," \u6765\u5b9e\u73b0\u6807\u7b7e\u8fc7\u6ee4\uff0c\u53ea\u52a0\u8f7d\u7b26\u5408\u89c4\u5219\u7684\u670d\u52a1\u3002\u4ee5\u4e0a\u8fb9\u4e3a\u4f8b\uff0c\u53ef\u4ee5\u901a\u8fc7\u8fc7\u6ee4 ",(0,a.kt)("inlineCode",{parentName:"p"},"__meta_consul_tags")," \u6807\u7b7e\u4e3a ",(0,a.kt)("inlineCode",{parentName:"p"},"test "),"\u7684\u670d\u52a1\uff0crelabel_config \u5411 Consul \u6ce8\u518c\u670d\u52a1\u7684\u65f6\u5019\uff0c\u53ea\u52a0\u8f7d\u5339\u914d regex \u8868\u8fbe\u5f0f\u7684\u6807\u7b7e\u7684\u670d\u52a1\u5230\u81ea\u5df1\u7684\u914d\u7f6e\u6587\u4ef6\u3002\u4fee\u6539 ",(0,a.kt)("inlineCode",{parentName:"p"},"prometheus.yml "),"\u914d\u7f6e\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"...\n- job_name: 'consul-prometheus'\n  consul_sd_configs:\n    - server: '172.30.12.167:8500'\n      services: []  \n  relabel_configs:\n    - source_labels: [__meta_consul_tags]\n      regex: .*test.*\n      action: keep\n")),(0,a.kt)("p",null,"\u89e3\u91ca\u4e0b\uff0c\u8fd9\u91cc\u7684",(0,a.kt)("inlineCode",{parentName:"p"},"relabel_configs"),"\u914d\u7f6e\u4f5c\u7528\u4e3a\u4e22\u5f03\u6e90\u6807\u7b7e\u4e2d ",(0,a.kt)("inlineCode",{parentName:"p"},"__meta_consul_tags")," \u4e0d\u5305\u542b test \u6807\u7b7e\u7684\u670d\u52a1\uff0c",(0,a.kt)("inlineCode",{parentName:"p"},"__meta_consul_tags "),"\u5bf9\u5e94\u5230 Consul \u670d\u52a1\u4e2d\u7684\u503c\u4e3a ",(0,a.kt)("inlineCode",{parentName:"p"},'"tags": ["test"]'),"\uff0c\u9ed8\u8ba4 consul \u670d\u52a1\u662f\u4e0d\u5e26\u8be5\u6807\u7b7e\u7684\uff0c\u4ece\u800c\u5b9e\u73b0\u8fc7\u6ee4\u3002\u91cd\u542f Prometheus \u53ef\u4ee5\u770b\u5230\u73b0\u5728\u53ea\u83b7\u53d6\u4e86 node-exporter-172.30.12.167 \u8fd9\u4e2a\u670d\u52a1\u4e86\u3002"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://img-blog.csdnimg.cn/20191112092557226.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FpeGlhb3lhbmcxNjg=,size_16,color_FFFFFF,t_70",alt:null})),(0,a.kt)("h3",{id:"\u6dfb\u52a0\u6807\u7b7e"},"\u6dfb\u52a0\u6807\u7b7e"),(0,a.kt)("p",null,"2\ufe0f\u20e3&3\ufe0f\u20e3\u95ee\u9898\u4e8c\u548c\u95ee\u9898\u4e09\u53ef\u4ee5\u5f52\u4e3a\u4e00\u7c7b\uff0c\u5c31\u662f\u5c06\u7cfb\u7edf\u9ed8\u8ba4\u6807\u7b7e\u6216\u8005\u7528\u6237\u81ea\u5b9a\u4e49\u6807\u7b7e\u8f6c\u6362\u6210\u53ef\u89c6\u5316\u6807\u7b7e\uff0c\u65b9\u4fbf\u67e5\u770b\u53ca\u540e\u7eed ",(0,a.kt)("inlineCode",{parentName:"p"},"Alertmanager "),"\u8fdb\u884c\u544a\u8b66\u89c4\u5219\u5339\u914d\u5206\u7ec4\u3002\u4e0d\u8fc7\u8981\u5b9e\u73b0\u7ed9\u670d\u52a1\u6dfb\u52a0\u81ea\u5b9a\u4e49\u6807\u7b7e\uff0c\u6211\u4eec\u8fd8\u5f97\u505a\u4e00\u4e0b\u4fee\u6539\uff0c\u5c31\u662f\u5728\u6ce8\u518c\u670d\u52a1\u65f6\uff0c\u5c06\u81ea\u5b9a\u4e49\u6807\u7b7e\u4fe1\u606f\u6dfb\u52a0\u5230 Meta Data \u6570\u636e\u4e2d\uff0c\u5177\u4f53\u53ef\u4ee5\u53c2\u8003 ","[\u8fd9\u91cc]","(Consul Service - Agent HTTP API) \u5b98\u7f51\u8bf4\u660e\uff0c\u4e0b\u8fb9\u6765\u6f14\u793a\u4e00\u4e0b\u5982\u4f55\u64cd\u4f5c\u3002"),(0,a.kt)("p",null,"\u65b0\u5efa ",(0,a.kt)("inlineCode",{parentName:"p"},"consul-0.json")," \u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'$ vim consul-0.json\n{\n  "ID": "node-exporter",\n  "Name": "node-exporter-172.30.12.167",\n  "Tags": [\n    "test"\n  ],\n  "Address": "172.30.12.167",\n  "Port": 9100,\n  "Meta": {\n    "app": "spring-boot",\n    "team": "appgroup",\n    "project": "bigdata"\n  },\n  "EnableTagOverride": false,\n  "Check": {\n    "HTTP": "http://172.30.12.167:9100/metrics",\n    "Interval": "10s"\n  },\n  "Weights": {\n    "Passing": 10,\n    "Warning": 1\n  }\n}\n')),(0,a.kt)("p",null,"\u8bf4\u660e\u4e00\u4e0b\uff1a\u8be5 Json \u6587\u4ef6\u4e3a\u8981\u6ce8\u518c\u7684\u670d\u52a1\u4fe1\u606f\uff0c\u540c\u65f6\u5f80 Meta \u4fe1\u606f\u4e2d\u6dfb\u52a0\u4e86 ",(0,a.kt)("inlineCode",{parentName:"p"},"app=spring-boot"),"\uff0c",(0,a.kt)("inlineCode",{parentName:"p"},"team=appgroup"),"\uff0c",(0,a.kt)("inlineCode",{parentName:"p"},"project=bigdata")," \u4e09\u7ec4\u6807\u7b7e\uff0c\u76ee\u7684\u5c31\u662f\u4e3a\u4e86\u65b9\u4fbf\u544a\u8b66\u5206\u7ec4\u4f7f\u7528\u3002\u6267\u884c\u5982\u4e0b\u547d\u4ee4\u8fdb\u884c\u6ce8\u518c\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"$ curl --request PUT --data @consul-0.json http://172.30.12.167:8500/v1/agent/service/register?replace-existing-checks=1\n")),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://img-blog.csdnimg.cn/20191112092615107.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FpeGlhb3lhbmcxNjg=,size_16,color_FFFFFF,t_70",alt:null})),(0,a.kt)("p",null,"\u7136\u540e\u4fee\u6539 ",(0,a.kt)("inlineCode",{parentName:"p"},"prometheus.yml")," \u914d\u7f6e\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"...\n- job_name: 'consul-prometheus'\n  consul_sd_configs:\n    - server: '172.30.12.167:8500'\n      services: []  \n  relabel_configs:\n    - source_labels: [__meta_consul_tags]\n      regex: .*test.*\n      action: keep\n    - regex: __meta_consul_service_metadata_(.+)\n      action: labelmap\n")),(0,a.kt)("p",null,"\u89e3\u91ca\u4e00\u4e0b\uff0c\u589e\u52a0\u7684\u914d\u7f6e\u4f5c\u7528\u4e3a\u5339\u914d ",(0,a.kt)("inlineCode",{parentName:"p"},"__meta_consul_service_metadata_ "),"\u5f00\u5934\u7684\u6807\u7b7e\uff0c\u5c06\u6355\u83b7\u5230\u7684\u5185\u5bb9\u4f5c\u4e3a\u65b0\u7684\u6807\u7b7e\u540d\u79f0\uff0c\u5339\u914d\u5230\u6807\u7b7e\u7684\u7684\u503c\u4f5c\u4e3a\u65b0\u6807\u7b7e\u7684\u503c\uff0c\u800c\u6211\u4eec\u521a\u6dfb\u52a0\u7684\u4e09\u4e2a\u81ea\u5b9a\u4e49\u6807\u7b7e\uff0c\u7cfb\u7edf\u4f1a\u81ea\u52a8\u6dfb\u52a0 ",(0,a.kt)("inlineCode",{parentName:"p"},"__meta_consul_service_metadata_app=spring-boot"),"\u3001",(0,a.kt)("inlineCode",{parentName:"p"},"__meta_consul_service_metadata_team=appgroup"),"\u3001",(0,a.kt)("inlineCode",{parentName:"p"},"__meta_consul_service_metadata_project=bigdata")," \u4e09\u4e2a\u6807\u7b7e\uff0c\u7ecf\u8fc7 relabel \u540e\uff0cPrometheus \u5c06\u4f1a\u65b0\u589e ",(0,a.kt)("inlineCode",{parentName:"p"},"app=spring-boot"),"\u3001",(0,a.kt)("inlineCode",{parentName:"p"},"team=appgroup"),"\u3001",(0,a.kt)("inlineCode",{parentName:"p"},"project=bigdata "),"\u4e09\u4e2a\u6807\u7b7e\u3002\u91cd\u542f Prometheus \u670d\u52a1\uff0c\u53ef\u4ee5\u770b\u5230\u65b0\u589e\u4e86\u5bf9\u5e94\u4e86\u4e09\u4e2a\u81ea\u5b9a\u4e49\u6807\u7b7e\u3002"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://img-blog.csdnimg.cn/20191112092629349.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FpeGlhb3lhbmcxNjg=,size_16,color_FFFFFF,t_70",alt:null})),(0,a.kt)("h3",{id:"\u670d\u52a1\u6807\u7b7e\u5206\u7c7b"},"\u670d\u52a1\u6807\u7b7e\u5206\u7c7b"),(0,a.kt)("p",null,"4\ufe0f\u20e3\u95ee\u9898\u56db\uff0c\u5c06\u81ea\u52a8\u53d1\u73b0\u7684\u670d\u52a1\u8fdb\u884c\u5206\u7c7b\uff0c\u672c\u8d28\u4e0a\u8ddf\u4e0a\u8fb9\u7684\u5904\u7406\u65b9\u5f0f\u4e00\u81f4\uff0c\u53ef\u4ee5\u6dfb\u52a0\u81ea\u5b9a\u4e49\u7684\u6807\u7b7e\u65b9\u5f0f\uff0c\u901a\u8fc7\u6807\u7b7e\u6765\u533a\u5206\uff0c\u4e8c\u53ef\u4ee5\u901a\u8fc7\u670d\u52a1 Tag \u6765\u8fdb\u884c\u5339\u914d\u6765\u521b\u5efa\u4e0d\u540c\u7684\u7c7b\u578b exporter \u5206\u7ec4\u3002\u8fd9\u91cc\u6211\u4ee5\u7b2c\u4e8c\u79cd\u4e3a\u4f8b\uff0c\u901a\u8fc7\u7ed9\u6bcf\u4e2a\u670d\u52a1\u6807\u8bb0\u4e0d\u540c\u7684 Tag\uff0c\u7136\u540e\u901a\u8fc7 ",(0,a.kt)("inlineCode",{parentName:"p"},"relabel_configs "),"\u6765\u8fdb\u884c\u5339\u914d\u533a\u5206\u3002\u6211\u4eec\u6765\u66f4\u65b0\u4e00\u4e0b\u539f ",(0,a.kt)("inlineCode",{parentName:"p"},"node-exporter-172.30.12.167 "),"\u670d\u52a1\u6807\u7b7e\uff0c\u540c\u65f6\u6ce8\u518c\u4e00\u4e2a\u5176\u4ed6\u7c7b\u578b exporter \u7684\u670d\u52a1\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'$ vim consul-1.json\n{\n  "ID": "node-exporter",\n  "Name": "node-exporter-172.30.12.167",\n  "Tags": [\n    "node-exporter"\n  ],\n  "Address": "172.30.12.167",\n  "Port": 9100,\n  "Meta": {\n    "app": "spring-boot",\n    "team": "appgroup",\n    "project": "bigdata"\n  },\n  "EnableTagOverride": false,\n  "Check": {\n    "HTTP": "http://172.30.12.167:9100/metrics",\n    "Interval": "10s"\n  },\n  "Weights": {\n    "Passing": 10,\n    "Warning": 1\n  }\n}\n\n# \u66f4\u65b0\u6ce8\u518c\u670d\u52a1\n$ curl --request PUT --data @consul-1.json http://172.30.12.167:8500/v1/agent/service/register?replace-existing-checks=1\n\n$ vim consul-2.json\n{\n  "ID": "cadvisor-exporter",\n  "Name": "cadvisor-exporter-172.30.12.167",\n  "Tags": [\n    "cadvisor-exporter"\n  ],\n  "Address": "172.30.12.167",\n  "Port": 8080,\n  "Meta": {\n    "app": "docker",\n    "team": "cloudgroup",\n    "project": "docker-service"\n  },\n  "EnableTagOverride": false,\n  "Check": {\n    "HTTP": "http://172.30.12.167:8080/metrics",\n    "Interval": "10s"\n  },\n  "Weights": {\n    "Passing": 10,\n    "Warning": 1\n  }\n}\n\n# \u6ce8\u518c\u670d\u52a1\n$ curl --request PUT --data @consul-2.json http://172.30.12.167:8500/v1/agent/service/register?replace-existing-checks=1\n')),(0,a.kt)("p",null,"\u8bf4\u660e\u4e00\u4e0b\uff0c\u6211\u4eec\u66f4\u65b0\u4e86\u539f ",(0,a.kt)("inlineCode",{parentName:"p"},"node-exporter-172.30.12.167")," \u670d\u52a1\u7684\u6807\u7b7e\u4e3a",(0,a.kt)("inlineCode",{parentName:"p"}," node-exporter"),"\uff0c\u540c\u65f6\u6ce8\u518c\u4e00\u4e2a\u65b0\u7c7b\u578b ",(0,a.kt)("inlineCode",{parentName:"p"},"cadvisor-exporter-172.30.12.167")," \u670d\u52a1\uff0c\u5e76\u8bbe\u7f6e\u6807\u7b7e\u4e3a",(0,a.kt)("inlineCode",{parentName:"p"}," cadvisor-exporter"),"\uff0c\u4ee5\u793a\u533a\u522b\u3002\u6ce8\u518c\u5b8c\u6bd5\uff0c\u901a\u8fc7 Consul Web \u63a7\u5236\u53f0\u53ef\u4ee5\u770b\u5230\u6210\u529f\u6ce8\u518c\u4e86\u8fd9\u4e24\u4e2a\u670d\u52a1\u3002"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://img-blog.csdnimg.cn/20191112092651357.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FpeGlhb3lhbmcxNjg=,size_16,color_FFFFFF,t_70",alt:null})),(0,a.kt)("p",null,"\u6700\u540e\uff0c\u6211\u4eec\u4fee\u6539 ",(0,a.kt)("inlineCode",{parentName:"p"},"prometheus.yml")," \u914d\u7f6e\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"...\n  - job_name: 'consul-node-exporter'\n    consul_sd_configs:\n      - server: '172.30.12.167:8500'\n        services: []  \n    relabel_configs:\n      - source_labels: [__meta_consul_tags]\n        regex: .*node-exporter.*\n        action: keep\n      - regex: __meta_consul_service_metadata_(.+)\n        action: labelmap\n\n  - job_name: 'consul-cadvisor-exproter'\n    consul_sd_configs:\n      - server: '172.30.12.167:8500'\n        services: []\n    relabel_configs:\n      - source_labels: [__meta_consul_tags]\n        regex: .*cadvisor-exporter.*\n        action: keep\n      - regex: __meta_consul_service_metadata_(.+)\n        action: labelmap\n")),(0,a.kt)("p",null,"\u8fd9\u91cc\u9700\u8981\u6839\u636e\u6bcf\u79cd\u7c7b\u578b\u7684 exporter \u65b0\u589e\u4e00\u4e2a\u5173\u8054 job\uff0c\u540c\u65f6 ",(0,a.kt)("inlineCode",{parentName:"p"},"relabel_configs")," \u4e2d\u914d\u7f6e\u4ee5 Tag \u6765\u505a\u5339\u914d\u533a\u5206\u3002\u91cd\u542f Prometheus \u670d\u52a1\uff0c\u53ef\u4ee5\u770b\u5230\u670d\u52a1\u5df2\u7ecf\u6309\u7167\u7c7b\u578b\u5206\u7c7b\u4e86\uff0c\u65b9\u4fbf\u67e5\u770b\u3002"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://img-blog.csdnimg.cn/20191112092709119.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FpeGlhb3lhbmcxNjg=,size_16,color_FFFFFF,t_70",alt:null})),(0,a.kt)("h2",{id:"\u53c2\u8003\u94fe\u63a5"},"\u53c2\u8003\u94fe\u63a5"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"relabel_config \uff1a",(0,a.kt)("a",{parentName:"li",href:"https://prometheus.io/docs/prometheus/latest/configuration/configuration/#relabel_config"},"https://prometheus.io/docs/prometheus/latest/configuration/configuration/#relabel_config")),(0,a.kt)("li",{parentName:"ul"},"Consul Service - Agent HTTP API\uff1a",(0,a.kt)("a",{parentName:"li",href:"https://www.consul.io/api/agent/service.html"},"https://www.consul.io/api/agent/service.html"),")"),(0,a.kt)("li",{parentName:"ul"},"CSDN @aixiaoyang168 \uff1a",(0,a.kt)("a",{parentName:"li",href:"https://blog.csdn.net/aixiaoyang168/article/details/103022342"},"https://blog.csdn.net/aixiaoyang168/article/details/103022342"))))}u.isMDXComponent=!0}}]);