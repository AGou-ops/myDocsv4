"use strict";(self.webpackChunkmy_docsv_4=self.webpackChunkmy_docsv_4||[]).push([[6706],{3905:(e,n,t)=>{t.d(n,{Zo:()=>u,kt:()=>d});var a=t(67294);function l(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function r(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function s(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?r(Object(t),!0).forEach((function(n){l(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function o(e,n){if(null==e)return{};var t,a,l=function(e,n){if(null==e)return{};var t,a,l={},r=Object.keys(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||(l[t]=e[t]);return l}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(l[t]=e[t])}return l}var i=a.createContext({}),p=function(e){var n=a.useContext(i),t=n;return e&&(t="function"==typeof e?e(n):s(s({},n),e)),t},u=function(e){var n=p(e.components);return a.createElement(i.Provider,{value:n},e.children)},c={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},k=a.forwardRef((function(e,n){var t=e.components,l=e.mdxType,r=e.originalType,i=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),k=p(t),d=l,m=k["".concat(i,".").concat(d)]||k[d]||c[d]||r;return t?a.createElement(m,s(s({ref:n},u),{},{components:t})):a.createElement(m,s({ref:n},u))}));function d(e,n){var t=arguments,l=n&&n.mdxType;if("string"==typeof e||l){var r=t.length,s=new Array(r);s[0]=k;var o={};for(var i in n)hasOwnProperty.call(n,i)&&(o[i]=n[i]);o.originalType=e,o.mdxType="string"==typeof e?e:l,s[1]=o;for(var p=2;p<r;p++)s[p]=t[p];return a.createElement.apply(null,s)}return a.createElement.apply(null,t)}k.displayName="MDXCreateElement"},8104:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>i,contentTitle:()=>s,default:()=>c,frontMatter:()=>r,metadata:()=>o,toc:()=>p});var a=t(87462),l=(t(67294),t(3905));const r={},s="\u4e09 \u96c6\u7fa4\u90e8\u7f72",o={unversionedId:"CloudNative/k8s/Quicklystart/\u4e09 \u96c6\u7fa4\u90e8\u7f72",id:"CloudNative/k8s/Quicklystart/\u4e09 \u96c6\u7fa4\u90e8\u7f72",title:"\u4e09 \u96c6\u7fa4\u90e8\u7f72",description:"\u4e3a\u7b80\u5355\u4e0a\u624b\u4f53\u9a8c\u529f\u80fd\uff0c\u53ef\u4ee5\u5148\u5229\u7528kubeadm\u5b89\u88c5\u6d4b\u8bd5\uff0c\u751f\u4ea7\u73af\u5883\u5efa\u8bae\u4e8c\u8fdb\u5236\u6216\u8005\u4e00\u4e9b\u6210\u719f\u7684\u96c6\u7fa4\u9ad8\u53ef\u7528\u5b89\u88c5\u65b9\u5f0f\uff0cKubeadm \u662f K8S \u5b98\u65b9\u63d0\u4f9b\u7684\u5feb\u901f\u90e8\u7f72\u5de5\u5177\uff0c\u5b83\u63d0\u4f9b\u4e86 kubeadm init \u4ee5\u53ca kubeadm join \u8fd9\u4e24\u4e2a\u547d\u4ee4\u4f5c\u4e3a\u5feb\u901f\u521b\u5efa kubernetes \u96c6\u7fa4\u7684\u6700\u4f73\u5b9e\u8df5\uff0c\u672c\u7ae0\u8282\u8bf4\u660e\u4e86\u4f7f\u7528 kubeadm \u6765\u90e8\u7f72 K8S \u96c6\u7fa4\u7684\u8fc7\u7a0b\u3002",source:"@site/docs/CloudNative/k8s/Quicklystart/\u4e09 \u96c6\u7fa4\u90e8\u7f72.md",sourceDirName:"CloudNative/k8s/Quicklystart",slug:"/CloudNative/k8s/Quicklystart/\u4e09 \u96c6\u7fa4\u90e8\u7f72",permalink:"/docs/CloudNative/k8s/Quicklystart/\u4e09 \u96c6\u7fa4\u90e8\u7f72",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/CloudNative/k8s/Quicklystart/\u4e09 \u96c6\u7fa4\u90e8\u7f72.md",tags:[],version:"current",frontMatter:{},sidebar:"cloudNative",previous:{title:"\u4e03 \u63a7\u5236\u5668\u914d\u7f6e\u6e05\u5355",permalink:"/docs/CloudNative/k8s/Quicklystart/\u4e03 \u63a7\u5236\u5668\u914d\u7f6e\u6e05\u5355"},next:{title:"\u4e5d ingress \u63a7\u5236\u5668",permalink:"/docs/CloudNative/k8s/Quicklystart/\u4e5d ingress \u63a7\u5236\u5668"}},i={},p=[{value:"3.1 \u4e00\u822c\u90e8\u7f72",id:"31-\u4e00\u822c\u90e8\u7f72",level:2},{value:"3.1.1 \u5173\u95ed firewalld \u548c selinux",id:"311-\u5173\u95ed-firewalld-\u548c-selinux",level:3},{value:"3.1.2 \u52a0\u8f7d ipvs \u5185\u6838\u6a21\u5757",id:"312-\u52a0\u8f7d-ipvs-\u5185\u6838\u6a21\u5757",level:3},{value:"3.1.3 \u4e0b\u8f7d Docker \u548c K8S",id:"313-\u4e0b\u8f7d-docker-\u548c-k8s",level:3},{value:"3.1.4 \u8bbe\u7f6e\u5185\u6838\u53ca K8S \u53c2\u6570",id:"314-\u8bbe\u7f6e\u5185\u6838\u53ca-k8s-\u53c2\u6570",level:3},{value:"3.2 \u90e8\u7f72 Master",id:"32-\u90e8\u7f72-master",level:2},{value:"3.2.1 \u63d0\u524d\u62c9\u53d6\u955c\u50cf",id:"321-\u63d0\u524d\u62c9\u53d6\u955c\u50cf",level:3},{value:"3.2.2 \u521d\u59cb\u5316Master",id:"322-\u521d\u59cb\u5316master",level:3},{value:"3.3 \u90e8\u7f72 Node",id:"33-\u90e8\u7f72-node",level:2},{value:"3.3.1 \u52a0\u5165\u96c6\u7fa4",id:"331-\u52a0\u5165\u96c6\u7fa4",level:3},{value:"3.3.2 \u67e5\u770b\u8fdb\u5ea6",id:"332-\u67e5\u770b\u8fdb\u5ea6",level:3},{value:"3.3.3 \u955c\u50cf\u4e0b\u8f7d\u592a\u6162",id:"333-\u955c\u50cf\u4e0b\u8f7d\u592a\u6162",level:3},{value:"3.4 jio\u672c\u90e8\u7f72",id:"34-jio\u672c\u90e8\u7f72",level:2},{value:"3.4.1 \u9884\u5148\u51c6\u5907",id:"341-\u9884\u5148\u51c6\u5907",level:3},{value:"3.4.2 \u521d\u59cb\u5316 master \u8282\u70b9",id:"342-\u521d\u59cb\u5316-master-\u8282\u70b9",level:3},{value:"3.4.3 \u521d\u59cb\u5316 node \u8282\u70b9",id:"343-\u521d\u59cb\u5316-node-\u8282\u70b9",level:3},{value:"3.4.3.1  \u83b7\u5f97 join\u547d\u4ee4\u53c2\u6570",id:"3431--\u83b7\u5f97-join\u547d\u4ee4\u53c2\u6570",level:4},{value:"3.4.3.2 \u521d\u59cb\u5316 node \u8282\u70b9",id:"3432-\u521d\u59cb\u5316-node-\u8282\u70b9",level:4},{value:"3.4.4 \u68c0\u67e5\u521d\u59cb\u5316\u7ed3\u679c",id:"344-\u68c0\u67e5\u521d\u59cb\u5316\u7ed3\u679c",level:3},{value:"3.5 \u4f7f\u7528 Kubespray \u90e8\u7f72",id:"35-\u4f7f\u7528-kubespray-\u90e8\u7f72",level:2},{value:"3.5.1 Kubespray \u7b80\u4ecb",id:"351-kubespray-\u7b80\u4ecb",level:3},{value:"3.5.2 \u521d\u59cb\u5316\u73af\u5883",id:"352-\u521d\u59cb\u5316\u73af\u5883",level:3},{value:"3.5.3 \u5b89\u88c5 Kubespray",id:"353-\u5b89\u88c5-kubespray",level:3},{value:"3.5.4 \u767b\u5f55 Dashboard",id:"354-\u767b\u5f55-dashboard",level:3},{value:"3.5.5 \u9a8c\u8bc1 K8s \u96c6\u7fa4",id:"355-\u9a8c\u8bc1-k8s-\u96c6\u7fa4",level:3},{value:"3.5.6 \u5176\u4ed6",id:"356-\u5176\u4ed6",level:3},{value:"\u53c2\u8003\u94fe\u63a5",id:"\u53c2\u8003\u94fe\u63a5",level:2}],u={toc:p};function c(e){let{components:n,...t}=e;return(0,l.kt)("wrapper",(0,a.Z)({},u,t,{components:n,mdxType:"MDXLayout"}),(0,l.kt)("h1",{id:"\u4e09-\u96c6\u7fa4\u90e8\u7f72"},"\u4e09 \u96c6\u7fa4\u90e8\u7f72"),(0,l.kt)("p",null,"\u4e3a\u7b80\u5355\u4e0a\u624b\u4f53\u9a8c\u529f\u80fd\uff0c\u53ef\u4ee5\u5148\u5229\u7528kubeadm\u5b89\u88c5\u6d4b\u8bd5\uff0c\u751f\u4ea7\u73af\u5883\u5efa\u8bae\u4e8c\u8fdb\u5236\u6216\u8005\u4e00\u4e9b\u6210\u719f\u7684\u96c6\u7fa4\u9ad8\u53ef\u7528\u5b89\u88c5\u65b9\u5f0f\uff0cKubeadm \u662f K8S \u5b98\u65b9\u63d0\u4f9b\u7684\u5feb\u901f\u90e8\u7f72\u5de5\u5177\uff0c\u5b83\u63d0\u4f9b\u4e86 kubeadm init \u4ee5\u53ca kubeadm join \u8fd9\u4e24\u4e2a\u547d\u4ee4\u4f5c\u4e3a\u5feb\u901f\u521b\u5efa kubernetes \u96c6\u7fa4\u7684\u6700\u4f73\u5b9e\u8df5\uff0c\u672c\u7ae0\u8282\u8bf4\u660e\u4e86\u4f7f\u7528 kubeadm \u6765\u90e8\u7f72 K8S \u96c6\u7fa4\u7684\u8fc7\u7a0b\u3002"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u96c6\u7fa4\u7ec4\u7ec7\u7ed3\u6784")),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"\u9879\u76ee"),(0,l.kt)("th",{parentName:"tr",align:null},"\u8bf4\u660e"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"\u96c6\u7fa4\u89c4\u6a21"),(0,l.kt)("td",{parentName:"tr",align:null},"Master\u3001node1\u3001node2")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"\u7cfb\u7edf"),(0,l.kt)("td",{parentName:"tr",align:null},"CentOS 7.3")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"\u7f51\u7edc\u89c4\u5212"),(0,l.kt)("td",{parentName:"tr",align:null},"POD\uff1a10.244.0.0/16\u3001Service\uff1a10.96.0.0/12")))),(0,l.kt)("h2",{id:"31-\u4e00\u822c\u90e8\u7f72"},"3.1 \u4e00\u822c\u90e8\u7f72"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"  \u672c\u5c0f\u8282\u7684\u6240\u6709\u7684\u64cd\u4f5c\uff0c\u5728\u6240\u6709\u7684\u8282\u70b9\u4e0a\u8fdb\u884c")),(0,l.kt)("h3",{id:"311-\u5173\u95ed-firewalld-\u548c-selinux"},"3.1.1 \u5173\u95ed firewalld \u548c selinux"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"setenforce 0\nsed -i '/^SELINUX=/cSELINUX=disabled' /etc/selinux/config\n\nsystemctl stop firewalld\nsystemctl disable firewalld\n")),(0,l.kt)("h3",{id:"312-\u52a0\u8f7d-ipvs-\u5185\u6838\u6a21\u5757"},"3.1.2 \u52a0\u8f7d ipvs \u5185\u6838\u6a21\u5757"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u5b89\u88c5 IPVS \u6a21\u5757")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"yum -y install ipvsadm ipset sysstat conntrack libseccomp\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u8bbe\u7f6e\u5f00\u673a\u52a0\u8f7d\u914d\u7f6e\u6587\u4ef6")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"cat >>/etc/modules-load.d/ipvs.conf<<EOF\nip_vs_dh\nip_vs_ftp\nip_vs\nip_vs_lblc\nip_vs_lblcr\nip_vs_lc\nip_vs_nq\nip_vs_pe_sip\nip_vs_rr\nip_vs_sed\nip_vs_sh\nip_vs_wlc\nip_vs_wrr\nnf_conntrack_ipv4\nEOF\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u8bbe\u7f6e\u5f00\u673a\u52a0\u8f7d IPVS \u6a21\u5757")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl enable systemd-modules-load.service   # \u8bbe\u7f6e\u5f00\u673a\u52a0\u8f7d\u5185\u6838\u6a21\u5757\nlsmod | grep -e ip_vs -e nf_conntrack_ipv4      # \u91cd\u542f\u540e\u68c0\u67e5 ipvs \u6a21\u5757\u662f\u5426\u52a0\u8f7d\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u5982\u679c\u96c6\u7fa4\u5df2\u7ecf\u90e8\u7f72\u5728\u4e86 iptables \u6a21\u5f0f\u4e0b\uff0c\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u547d\u4ee4\u4fee\u6539\uff0c\u4fee\u6539 mode \u4e3a ipvs \u91cd\u542f\u96c6\u7fa4\u5373\u53ef\u3002")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl edit -n kube-system configmap kube-proxy\n")),(0,l.kt)("h3",{id:"313-\u4e0b\u8f7d-docker-\u548c-k8s"},"3.1.3 \u4e0b\u8f7d Docker \u548c K8S"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u8bbe\u7f6e docker \u6e90")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"curl -o /etc/yum.repos.d/docker-ce.repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u8bbe\u7f6e k8s \u6e90")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"cat >>/etc/yum.repos.d/kuberetes.repo<<EOF\n[kuberneres]\nname=Kubernetes\nbaseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/\ngpgcheck=0\ngpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg\nenabled=1\nEOF\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u5b89\u88c5 docker-ce \u548c kubernetes")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"yum install docker-ce kubelet kubectl kubeadm -y\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl start docker\nsystemctl enable docker\nsystemctl enable kubelet\n")),(0,l.kt)("h3",{id:"314-\u8bbe\u7f6e\u5185\u6838\u53ca-k8s-\u53c2\u6570"},"3.1.4 \u8bbe\u7f6e\u5185\u6838\u53ca K8S \u53c2\u6570"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u8bbe\u7f6e\u5185\u6838\u53c2\u6570")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"cat >>/etc/sysctl.conf<<EOF\nnet.bridge.bridge-nf-call-ip6tables = 1\nnet.bridge.bridge-nf-call-iptables = 1\nnet.ipv4.ip_forward = 1\nEOF\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u8bbe\u7f6e kubelet \u5ffd\u7565 swap\uff0c\u4f7f\u7528 ipvs")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'cat >/etc/sysconfig/kubelet<<EOF\nKUBELET_EXTRA_ARGS="--fail-swap-on=false"\nKUBE_PROXY_MODE=ipvs\nEOF\n')),(0,l.kt)("h2",{id:"32-\u90e8\u7f72-master"},"3.2 \u90e8\u7f72 Master"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"  \u672c\u5c0f\u8282\u7684\u6240\u6709\u7684\u64cd\u4f5c\uff0c\u53ea\u5728 Master \u8282\u70b9\u4e0a\u8fdb\u884c")),(0,l.kt)("h3",{id:"321-\u63d0\u524d\u62c9\u53d6\u955c\u50cf"},"3.2.1 \u63d0\u524d\u62c9\u53d6\u955c\u50cf"),(0,l.kt)("p",null,"\u5bbf\u4e3b\u673a\u6700\u597d\u80fd\u8bbf\u95ee\u56fd\u5916\u8d44\u6e90\uff0c\u5728kubeadm init \u5728\u521d\u59cb\u5316\u7684\u65f6\u5019\u4f1a\u5230\u8c37\u6b4c\u7684 docker hub \u62c9\u53d6\u955c\u50cf\uff0c\u5982\u679c\u5bbf\u4e3b\u673a\u6d4b\u8bd5\u65e0\u6cd5\u8bbf\u95ee k8s.gcr.io \u53ef\u4ee5\u5728\u670d\u52a1\u5668\u6240\u4ee5\u6211\u4eec\u8981\u63d0\u524d\u90e8\u7f72\u597d\u4ee3\u7406\u8f6f\u4ef6\uff0c\u672c\u4f8b\u4e2d\u76d1\u542c\u4e2a\u672c\u673a 9666 \u8fdb\u884c\u90e8\u7f72\u3002"),(0,l.kt)("p",null,"\u5982\u679c\u6761\u4ef6\u4e0d\u5141\u8bb8\u53ef\u4ee5\u53c2\u8003: ",(0,l.kt)("a",{parentName:"p",href:"https://blog.csdn.net/jinguangliu/article/details/82792617"},"https://blog.csdn.net/jinguangliu/article/details/82792617")," \u6765\u89e3\u51b3\u955c\u50cf\u95ee\u9898\u3002"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u914d\u7f6e Docker \u62c9\u53d6\u955c\u50cf\u65f6\u5019\u7684\u4ee3\u7406\u5730\u5740\uff0cvim /usr/lib/systemd/system/docker.service\u3002")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'[Service]\nEnvironment="HTTPS_PROXY=127.0.0.1:9666"\nEnvironment="NO_PROXY=127.0.0.0/8,172.16.0.0/16"\n')),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u63d0\u524d\u62c9\u53d6\u521d\u59cb\u5316\u9700\u8981\u7684\u955c\u50cf")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"kubeadm config images pull\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u4f7f\u7528\u5176\u4ed6\u6e90\u955c\u50cf")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"docker pull mirrorgooglecontainers/kube-apiserver:v1.14.2\ndocker pull mirrorgooglecontainers/kube-controller-manager:v1.14.2\ndocker pull mirrorgooglecontainers/kube-scheduler:v1.14.2\ndocker pull mirrorgooglecontainers/kube-proxy:v1.14.2\ndocker pull mirrorgooglecontainers/pause:3.1\ndocker pull mirrorgooglecontainers/etcd:3.3.10\ndocker pull coredns/coredns:1.3.1\n\n\n\u5229\u7528`kubeadm config images list` \u67e5\u770b\u9700\u8981\u7684docker image name\n\nk8s.gcr.io/kube-apiserver:v1.14.2\nk8s.gcr.io/kube-controller-manager:v1.14.2\nk8s.gcr.io/kube-scheduler:v1.14.2\nk8s.gcr.io/kube-proxy:v1.14.2\nk8s.gcr.io/pause:3.1\nk8s.gcr.io/etcd:3.3.10\nk8s.gcr.io/coredns:1.3.1\n\n# \u4fee\u6539tag\n\ndocker tag docker.io/mirrorgooglecontainers/kube-apiserver:v1.14.2 k8s.gcr.io/kube-apiserver:v1.14.2\ndocker tag docker.io/mirrorgooglecontainers/kube-scheduler:v1.14.2 k8s.gcr.io/kube-scheduler:v1.14.2\ndocker tag docker.io/mirrorgooglecontainers/kube-proxy:v1.14.2 k8s.gcr.io/kube-proxy:v1.14.2\ndocker tag docker.io/mirrorgooglecontainers/kube-controller-manager:v1.14.2 k8s.gcr.io/kube-controller-manager:v1.14.2\ndocker tag docker.io/mirrorgooglecontainers/etcd:3.3.10  k8s.gcr.io/etcd:3.3.10\ndocker tag docker.io/mirrorgooglecontainers/pause:3.1  k8s.gcr.io/pause:3.1\ndocker tag docker.io/coredns/coredns:1.3.1  k8s.gcr.io/coredns:1.3.1\n\ndocker rmi `docker images |grep docker.io/ |awk '{print $1\":\"$2}'`\n")),(0,l.kt)("h3",{id:"322-\u521d\u59cb\u5316master"},"3.2.2 \u521d\u59cb\u5316Master"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u4f7f\u7528 kubeadm \u521d\u59cb\u5316 k8s \u96c6\u7fa4")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"kubeadm init --kubernetes-version=v1.14.0 --pod-network-cidr=10.244.0.0/16 --service-cidr=10.96.0.0/12 --ignore-preflight-errors=Swap\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u5982\u679c\u6709\u62a5\u9519\u4f7f\u7528\u4e0b\u9762\u547d\u4ee4\u67e5\u770b")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"journalctl -xeu kubelet\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u5982\u679c\u521d\u59cb\u5316\u8fc7\u7a0b\u88ab\u4e2d\u65ad\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u547d\u4ee4\u6765\u6062\u590d")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"kubeadm reset\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u4e0b\u9762\u662f\u6700\u540e\u6267\u884c\u6210\u529f\u663e\u793a\u7684\u7ed3\u679c\uff0c\u9700\u8981\u4fdd\u5b58\u8fd9\u4e2a\u6267\u884c\u7ed3\u679c\uff0c\u4ee5\u8ba9 node \u8282\u70b9\u52a0\u5165\u96c6\u7fa4")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'Your Kubernetes control-plane has initialized successfully!\n\nTo start using your cluster, you need to run the following as a regular user:\n\n  mkdir -p $HOME/.kube\n  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\n  sudo chown $(id -u):$(id -g) $HOME/.kube/config\n\nYou should now deploy a pod network to the cluster.\nRun "kubectl apply -f [podnetwork].yaml" with one of the options listed at:\n  https://kubernetes.io/docs/concepts/cluster-administration/addons/\n\nThen you can join any number of worker nodes by running the following on each as root:\n\nkubeadm join 172.16.100.9:6443 --token 2dyd69.hrfsjkkxs4stim7n \\\n    --discovery-token-ca-cert-hash sha256:4e30c1f41aefb177b708a404ccb7e818e31647c7dbdd2d42f6c5c9894b6f41e7\n')),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u6700\u597d\u4ee5\u666e\u901a\u7528\u6237\u7684\u8eab\u4efd\u8fd0\u884c\u4e0b\u9762\u7684\u547d\u4ee4")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"# \u5728\u5f53\u524d\u7528\u6237\u5bb6\u76ee\u5f55\u4e0b\u521b\u5efa.kube\u76ee\u5f55\u5e76\u914d\u7f6e\u8bbf\u95ee\u96c6\u7fa4\u7684config \u6587\u4ef6\nmkdir -p $HOME/.kube\nsudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\nsudo chown $(id -u):$(id -g) $HOME/.kube/config\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u90e8\u7f72 flannel \u7f51\u7edc\u63d2\u4ef6")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u67e5\u770b kube-system \u547d\u540d\u7a7a\u95f4\u4e2d\u8fd0\u884c\u7684 pods")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl get pods -n kube-system\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u67e5\u770b k8s \u96c6\u7fa4\u7ec4\u4ef6\u7684\u72b6\u6001")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl get ComponentStatus\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u914d\u7f6e\u547d\u4ee4\u8865\u5168")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'yum install -y bash-completion\nsource /usr/share/bash-completion/bash_completion\nsource <(kubectl completion bash)\necho "source <(kubectl completion bash)" >> ~/.bashrc\n')),(0,l.kt)("h2",{id:"33-\u90e8\u7f72-node"},"3.3 \u90e8\u7f72 Node"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"  \u672c\u5c0f\u8282\u7684\u6240\u6709\u7684\u64cd\u4f5c\uff0c\u53ea\u5728 Node \u8282\u70b9\u4e0a\u8fdb\u884c\u3002")),(0,l.kt)("h3",{id:"331-\u52a0\u5165\u96c6\u7fa4"},"3.3.1 \u52a0\u5165\u96c6\u7fa4"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u52a0\u5165\u96c6\u7fa4\uff0c\u6ce8\u610f\u5728\u547d\u4ee4\u5c3e\u90e8\u52a0\u4e0a --ignore-preflight-errors=Swap \uff0c\u4ee5\u5ffd\u7565 k8s \u5bf9\u4e3b\u673a swap \u7684\u68c0\u67e5\uff08k8s\u4e3a\u4e86\u6027\u80fd\u6240\u4ee5\u8981\u6c42\u8fdb\u5236 swap \uff09")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"kubeadm join 172.16.100.9:6443 --token 2dyd69.hrfsjkkxs4stim7n \\\n    --discovery-token-ca-cert-hash sha256:4e30c1f41aefb177b708a404ccb7e818e31647c7dbdd2d42f6c5c9894b6f41e7 --ignore-preflight-errors=Swap\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u8fd4\u56de\u7ed3\u679c\uff0c\u8868\u793a\u52a0\u5165\u96c6\u7fa4\u6210\u529f")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"This node has joined the cluster:\n* Certificate signing request was sent to apiserver and a response was received.\n* The Kubelet was informed of the new secure connection details.\n\nRun 'kubectl get nodes' on the control-plane to see this node join the cluster.\n")),(0,l.kt)("h3",{id:"332-\u67e5\u770b\u8fdb\u5ea6"},"3.3.2 \u67e5\u770b\u8fdb\u5ea6"),(0,l.kt)("p",null,"\u5f53 node \u8282\u70b9\u52a0\u5165 K8S \u96c6\u7fa4\u4e2d\u540e\uff0cMaster \u4f1a\u8c03\u5ea6\u5230 Node \u8282\u70b9\u4e0a\u4e00\u4e9b\u7ec4\u4ef6\uff0c\u7528\u4e8e\u5904\u7406\u96c6\u7fa4\u4e8b\u52a1\uff0c\u8fd9\u4e9b\u7ec4\u4ef6\u6ca1\u6709\u4e0b\u8f7d\u5b8c\u6210\u4e4b\u524d Node \u8282\u70b9\u5728\u96c6\u7fa4\u4e2d\u8fd8\u662f\u672a\u5c31\u7eea\u72b6\u6001"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u5728 node \u6267\u884c\u4e0b\u9762\u547d\u4ee4\uff0c\u53ef\u4ee5\u67e5\u770b\u955c\u50cf\u7684\u4e0b\u8f7d\u8fdb\u5ea6\uff0c\u4e0b\u9762\u662f\u6700\u7ec8\u7ed3\u679c\u663e\u793a")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"$ docker image ls\nREPOSITORY               TAG                 IMAGE ID            CREATED             SIZE\nk8s.gcr.io/kube-proxy    v1.14.0             5cd54e388aba        6 weeks ago         82.1MB\nquay.io/coreos/flannel   v0.11.0-amd64       ff281650a721        3 months ago        52.6MB\nk8s.gcr.io/pause         3.1                 da86e6ba6ca1        16 months ago       742kB\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u53ef\u4ee5\u5728 Master \u4e0a\u4f7f\u7528\u4e0b\u9762\u547d\u4ee4\u6765\u67e5\u770b\u65b0\u52a0\u5165\u7684\u8282\u70b9\u72b6\u6001")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"$ kubectl get nodes\nNAME     STATUS   ROLES    AGE     VERSION\nmaster   Ready    master   3d21h   v1.14.1\nnode1    Ready    <none>   3d21h   v1.14.1\nnode2    Ready    <none>   3d21h   v1.14.1\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u67e5\u770b\u96c6\u7fa4\u72b6\u6001")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'[root@master ~]\\# kubectl cluster-info \nKubernetes master is running at https://10.234.2.204:6443\nKubeDNS is running at https://10.234.2.204:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy\nMetrics-server is running at https://10.234.2.204:6443/api/v1/namespaces/kube-system/services/https:metrics-server:/proxy\n\nTo further debug and diagnose cluster problems, use \'kubectl cluster-info dump\'.\n[root@master ~]\\# kubectl get componentstatuses\nNAME                 STATUS    MESSAGE             ERROR\ncontroller-manager   Healthy   ok                  \nscheduler            Healthy   ok                  \netcd-0               Healthy   {"health":"true"}   \n')),(0,l.kt)("p",null,"\u5982\u679c\u5acc\u7f51\u7edcpull\u955c\u50cf\u6162\u53ef\u4ee5\u5728\u4e00\u53f0\u4e0a\u9762\u5c06\u955c\u50cf\u6253\u5305\u53d1\u9001\u81f3\u5176\u4ed6node\u8282\u70b9"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"\u62f7\u8d1d\u5230node\u8282\u70b9\nfor i in /tmp/*.tar; do scp -i $i root@172.16.0.15:/root/;done\n\n\nnode\u8282\u70b9\u8fd8\u539f\nfor i in *.tar ;do docker load -i $i;done\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u67e5\u770b kube-system \u8fd9\u4e2a k8s \u547d\u540d\u7a7a\u95f4\u4e2d\u6709\u54ea\u4e9b\u7ec4\u4ef6\uff0c\u5206\u522b\u8fd0\u884c\u5728\u54ea\u4e2a\u8282\u70b9\uff0c-o wide \u662f\u4ee5\u8be6\u7ec6\u65b9\u5f0f\u663e\u793a\u3002")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ kubectl get pods -n kube-system -o wide\n\nNAME                                 READY   STATUS    RESTARTS   AGE     IP              NODE         NOMINATED NODE   READINESS GATES\ncoredns-fb8b8dccf-cp24r              1/1     Running   0          26m     10.244.0.2      i-xeahpl98   <none>           <none>\ncoredns-fb8b8dccf-ljswp              1/1     Running   0          26m     10.244.0.3      i-xeahpl98   <none>           <none>\netcd-i-xeahpl98                      1/1     Running   0          25m     172.16.100.9    i-xeahpl98   <none>           <none>\nkube-apiserver-i-xeahpl98            1/1     Running   0          25m     172.16.100.9    i-xeahpl98   <none>           <none>\nkube-controller-manager-i-xeahpl98   1/1     Running   0          25m     172.16.100.9    i-xeahpl98   <none>           <none>\nkube-flannel-ds-amd64-crft8          1/1     Running   3          16m     172.16.100.6    i-me87b6gw   <none>           <none>\nkube-flannel-ds-amd64-nckw4          1/1     Running   0          6m41s   172.16.100.10   i-qhcc2owe   <none>           <none>\nkube-flannel-ds-amd64-zb7sg          1/1     Running   0          23m     172.16.100.9    i-xeahpl98   <none>           <none>\nkube-proxy-7kjkf                     1/1     Running   0          6m41s   172.16.100.10   i-qhcc2owe   <none>           <none>\nkube-proxy-c5xs2                     1/1     Running   2          16m     172.16.100.6    i-me87b6gw   <none>           <none>\nkube-proxy-rdzq2                     1/1     Running   0          26m     172.16.100.9    i-xeahpl98   <none>           <none>\nkube-scheduler-i-xeahpl98            1/1     Running   0          25m     172.16.100.9    i-xeahpl98   <none>           <none>\n")),(0,l.kt)("h3",{id:"333-\u955c\u50cf\u4e0b\u8f7d\u592a\u6162"},"3.3.3 \u955c\u50cf\u4e0b\u8f7d\u592a\u6162"),(0,l.kt)("p",null,"node \u8282\u70b9\u9700\u8981\u7ffb\u5899\u4e0b\u8f7d\u955c\u50cf\u592a\u6162\uff0c\u5efa\u8bae\u4f7f\u7528 docker \u955c\u50cf\u7684\u5bfc\u5165\u5bfc\u51fa\u529f\u80fd\n\u5148\u5c06master\u7684\u4e09\u4e2a\u955c\u50cf\u6253\u5305\u53d1\u9001\u5230node\u8282\u70b9\uff0cload\u540e\u518djion"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u5bfc\u51fa")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"docker image save -o /tmp/kube-proxy.tar k8s.gcr.io/kube-proxy\ndocker image save -o /tmp/flannel.tar quay.io/coreos/flannel\ndocker image save -o /tmp/pause.tar k8s.gcr.io/pause\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u5bfc\u5165")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"docker image load -i /tmp/kube-proxy.tar\ndocker image load -i /tmp/pause.tar\ndocker image load -i /tmp/flannel.tar\n")),(0,l.kt)("h2",{id:"34-jio\u672c\u90e8\u7f72"},"3.4 jio\u672c\u90e8\u7f72"),(0,l.kt)("h3",{id:"341-\u9884\u5148\u51c6\u5907"},"3.4.1 \u9884\u5148\u51c6\u5907"),(0,l.kt)("p",null,"\u73af\u5883\uff1a"),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"\u89d2\u8272"),(0,l.kt)("th",{parentName:"tr",align:null},"IP"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"master"),(0,l.kt)("td",{parentName:"tr",align:null},"172.16.1.129")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"node01"),(0,l.kt)("td",{parentName:"tr",align:null},"172.16.1.133")))),(0,l.kt)("p",null,"\u4fee\u6539\u5f53\u524d\u7684\u4e3b\u673a\u540d\uff0c\u786e\u4fdd\u4e0d\u662f ",(0,l.kt)("inlineCode",{parentName:"p"},"localhost"),"\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"hostnamectl set-hostname master\n")),(0,l.kt)("p",null,"\u4e3a\u5404\u8282\u70b9\u6dfb\u52a0\u4e3b\u673a\u540d\u89e3\u6790\uff0c \u7f16\u8f91",(0,l.kt)("inlineCode",{parentName:"p"},"/etc/hosts"),"\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"...\n172.16.1 master master.agou-ops.com\n172.16.1 node01 node01.aogu-ops.com\n")),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"\u786e\u4fdd\u4efb\u610f\u8282\u70b9\u4e0a ",(0,l.kt)("inlineCode",{parentName:"p"},"Kubelet"),"\u4f7f\u7528\u7684 IP \u5730\u5740\u53ef\u4e92\u901a\uff08\u65e0\u9700 NAT \u6620\u5c04\u5373\u53ef\u76f8\u4e92\u8bbf\u95ee\uff09\uff0c\u4e14\u6ca1\u6709\u9632\u706b\u5899\u3001\u5b89\u5168\u7ec4\u9694\u79bb")),(0,l.kt)("p",null,"\u5173\u95ed",(0,l.kt)("inlineCode",{parentName:"p"},"\u9632\u706b\u5899"),"\u548c",(0,l.kt)("inlineCode",{parentName:"p"},"SElinux"),"\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"sed -i 's/SELINUX=*/SELINUX=disabled/' /etc/selinux/config\n# getenforce \u786e\u5b9a\u5f53\u524dSElinux\u72b6\u6001\nsystemctl disable firewalld && systemctl stop firewalld\n")),(0,l.kt)("p",null,"\u5b89\u88c5 ",(0,l.kt)("inlineCode",{parentName:"p"},"docker")," \u4ee5\u53ca ",(0,l.kt)("inlineCode",{parentName:"p"},"kubelet")," \uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'# --------- \u5728 master \u548c node \u8282\u70b9\u6267\u884c -----------\n\n# \u4f7f\u7528\u963f\u91cc\u4e91 docker \u955c\u50cf\u52a0\u901f\uff0c\u53ef\u4ee5\u81ea\u884c\u53bb\u63a7\u5236\u53f0\u7533\u8bf7\uff0c\u5728\u8fd9\u91cc\u6211\u4f7f\u7528\u516c\u5171\u52a0\u901f\u955c\u50cf\nexport REGISTRY_MIRROR=https://registry.cn-hangzhou.aliyuncs.com\n\n# \u7f16\u8f91\u811a\u672c\u5feb\u901f\u5b89\u88c5\uff0c\u5185\u5bb9\u5982\u4e0b\uff1a\n\n#!/bin/bash\n\n# \u5728 master \u8282\u70b9\u548c worker \u8282\u70b9\u90fd\u8981\u6267\u884c\n\n# \u5b89\u88c5 docker\n# \u53c2\u8003\u6587\u6863\u5982\u4e0b\n# https://docs.docker.com/install/linux/docker-ce/centos/ \n# https://docs.docker.com/install/linux/linux-postinstall/\n\n# \u5378\u8f7d\u65e7\u7248\u672c\nyum remove -y docker \\\ndocker-client \\\ndocker-client-latest \\\ndocker-common \\\ndocker-latest \\\ndocker-latest-logrotate \\\ndocker-logrotate \\\ndocker-selinux \\\ndocker-engine-selinux \\\ndocker-engine\n\n# \u8bbe\u7f6e yum repository\nyum install -y yum-utils \\\ndevice-mapper-persistent-data \\\nlvm2\nyum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo\n\n# \u5b89\u88c5\u5e76\u542f\u52a8 docker\nyum install -y docker-ce-19.03.8 docker-ce-cli-19.03.8 containerd.io\nsystemctl enable docker\nsystemctl start docker\n\n# \u5b89\u88c5 nfs-utils\n# \u5fc5\u987b\u5148\u5b89\u88c5 nfs-utils \u624d\u80fd\u6302\u8f7d nfs \u7f51\u7edc\u5b58\u50a8\nyum install -y nfs-utils\nyum install -y wget\n\n# \u5173\u95ed swap \xd7\xd7\u91cd\u8981\xd7\xd7\nswapoff -a && echo "vm.swappiness=0" >> /etc/sysctl.conf && sysctl -p && free \u2013h\n\n# \u4fee\u6539 /etc/sysctl.conf\n# \u5982\u679c\u6709\u914d\u7f6e\uff0c\u5219\u4fee\u6539\nsed -i "s#^net.ipv4.ip_forward.*#net.ipv4.ip_forward=1#g"  /etc/sysctl.conf\nsed -i "s#^net.bridge.bridge-nf-call-ip6tables.*#net.bridge.bridge-nf-call-ip6tables=1#g"  /etc/sysctl.conf\nsed -i "s#^net.bridge.bridge-nf-call-iptables.*#net.bridge.bridge-nf-call-iptables=1#g"  /etc/sysctl.conf\nsed -i "s#^net.ipv6.conf.all.disable_ipv6.*#net.ipv6.conf.all.disable_ipv6=1#g"  /etc/sysctl.conf\nsed -i "s#^net.ipv6.conf.default.disable_ipv6.*#net.ipv6.conf.default.disable_ipv6=1#g"  /etc/sysctl.conf\nsed -i "s#^net.ipv6.conf.lo.disable_ipv6.*#net.ipv6.conf.lo.disable_ipv6=1#g"  /etc/sysctl.conf\nsed -i "s#^net.ipv6.conf.all.forwarding.*#net.ipv6.conf.all.forwarding=1#g"  /etc/sysctl.conf\n# \u53ef\u80fd\u6ca1\u6709\uff0c\u8ffd\u52a0\necho "net.ipv4.ip_forward = 1" >> /etc/sysctl.conf\necho "net.bridge.bridge-nf-call-ip6tables = 1" >> /etc/sysctl.conf\necho "net.bridge.bridge-nf-call-iptables = 1" >> /etc/sysctl.conf\necho "net.ipv6.conf.all.disable_ipv6 = 1" >> /etc/sysctl.conf\necho "net.ipv6.conf.default.disable_ipv6 = 1" >> /etc/sysctl.conf\necho "net.ipv6.conf.lo.disable_ipv6 = 1" >> /etc/sysctl.conf\necho "net.ipv6.conf.all.forwarding = 1"  >> /etc/sysctl.conf\n# \u6267\u884c\u547d\u4ee4\u4ee5\u5e94\u7528\nsysctl -p\n\n# \u914d\u7f6eK8S\u7684yum\u6e90\ncat <<EOF > /etc/yum.repos.d/kubernetes.repo\n[kubernetes]\nname=Kubernetes\nbaseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64\nenabled=1\ngpgcheck=0\nrepo_gpgcheck=0\ngpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg\n       http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg\nEOF\n\n# \u5378\u8f7d\u65e7\u7248\u672c\nyum remove -y kubelet kubeadm kubectl\n\n# \u5b89\u88c5kubelet\u3001kubeadm\u3001kubectl\n# \u5c06 ${1} \u66ff\u6362\u4e3a kubernetes \u7248\u672c\u53f7\uff0c\u4f8b\u5982 1.17.2\nyum install -y kubelet-${1} kubeadm-${1} kubectl-${1}\n\n# \u4fee\u6539docker Cgroup Driver\u4e3asystemd\n# # \u5c06/usr/lib/systemd/system/docker.service\u6587\u4ef6\u4e2d\u7684\u8fd9\u4e00\u884c ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock\n# # \u4fee\u6539\u4e3a ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --exec-opt native.cgroupdriver=systemd\n# \u5982\u679c\u4e0d\u4fee\u6539\uff0c\u5728\u6dfb\u52a0 worker \u8282\u70b9\u65f6\u53ef\u80fd\u4f1a\u78b0\u5230\u5982\u4e0b\u9519\u8bef\n# [WARNING IsDockerSystemdCheck]: detected "cgroupfs" as the Docker cgroup driver. The recommended driver is "systemd". \n# Please follow the guide at https://kubernetes.io/docs/setup/cri/\nsed -i "s#^ExecStart=/usr/bin/dockerd.*#ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --exec-opt native.cgroupdriver=systemd#g" /usr/lib/systemd/system/docker.service\n\n# \u8bbe\u7f6e docker \u955c\u50cf\uff0c\u63d0\u9ad8 docker \u955c\u50cf\u4e0b\u8f7d\u901f\u5ea6\u548c\u7a33\u5b9a\u6027\n# \u5982\u679c\u60a8\u8bbf\u95ee https://hub.docker.io \u901f\u5ea6\u975e\u5e38\u7a33\u5b9a\uff0c\u4ea6\u53ef\u4ee5\u8df3\u8fc7\u8fd9\u4e2a\u6b65\u9aa4\ncurl -sSL https://kuboard.cn/install-script/set_mirror.sh | sh -s ${REGISTRY_MIRROR}\n\n# \u91cd\u542f docker\uff0c\u5e76\u542f\u52a8 kubelet\nsystemctl daemon-reload\nsystemctl restart docker\nsystemctl enable kubelet && systemctl start kubelet\n\ndocker version\n')),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"\u26a0\ufe0f ",(0,l.kt)("strong",{parentName:"p"},"WARNING")),(0,l.kt)("p",{parentName:"blockquote"},"\u5982\u679c\u6b64\u65f6\u6267\u884c ",(0,l.kt)("inlineCode",{parentName:"p"},"service status kubelet")," \u547d\u4ee4\uff0c\u5c06\u5f97\u5230 kubelet \u542f\u52a8\u5931\u8d25\u7684\u9519\u8bef\u63d0\u793a\uff0c\u8bf7\u5ffd\u7565\u6b64\u9519\u8bef\uff0c\u56e0\u4e3a\u5fc5\u987b\u5b8c\u6210\u540e\u7eed\u6b65\u9aa4\u4e2d ",(0,l.kt)("inlineCode",{parentName:"p"},"kubeadm init")," \u7684\u64cd\u4f5c\uff0ckubelet \u624d\u80fd\u6b63\u5e38\u542f\u52a8")),(0,l.kt)("p",null,"\u8d4b\u4e88\u6743\u9650\u53ca\u8fd0\u884c\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"chmod +x preinstall.sh\n./preinstall.sh 1.18.2\n")),(0,l.kt)("h3",{id:"342-\u521d\u59cb\u5316-master-\u8282\u70b9"},"3.4.2 \u521d\u59cb\u5316 master \u8282\u70b9"),(0,l.kt)("p",null,"\u5173\u4e8e\u521d\u59cb\u5316\u65f6\u7528\u5230\u7684\u73af\u5883\u53d8\u91cf"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("strong",{parentName:"li"},(0,l.kt)("inlineCode",{parentName:"strong"},"APISERVER_NAME"))," \u4e0d\u80fd\u662f master \u7684 hostname"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("strong",{parentName:"li"},(0,l.kt)("inlineCode",{parentName:"strong"},"APISERVER_NAME"))," \u5fc5\u987b\u5168\u4e3a\u5c0f\u5199\u5b57\u6bcd\u3001\u6570\u5b57\u3001\u5c0f\u6570\u70b9\uff0c",(0,l.kt)("strong",{parentName:"li"},"\u4e0d\u80fd\u5305\u542b\u51cf\u53f7")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("strong",{parentName:"li"},(0,l.kt)("inlineCode",{parentName:"strong"},"POD_SUBNET"))," \u6240\u4f7f\u7528\u7684\u7f51\u6bb5\u4e0d\u80fd\u4e0e ",(0,l.kt)("strong",{parentName:"li"},(0,l.kt)("em",{parentName:"strong"},"master\u8282\u70b9/worker\u8282\u70b9"))," \u6240\u5728\u7684\u7f51\u6bb5\u91cd\u53e0\u3002\u8be5\u5b57\u6bb5\u7684\u53d6\u503c\u4e3a\u4e00\u4e2a ",(0,l.kt)("a",{parentName:"li",href:"https://kuboard.cn/glossary/cidr.html"},"CIDR")," \u503c\uff0c\u5982\u679c\u60a8\u5bf9 CIDR \u8fd9\u4e2a\u6982\u5ff5\u8fd8\u4e0d\u719f\u6089\uff0c\u8bf7\u4ecd\u7136\u6267\u884c ",(0,l.kt)("inlineCode",{parentName:"li"},"export POD_SUBNET=10.100.0.1/16 "),"\u547d\u4ee4\uff0c\u4e0d\u505a\u4fee\u6539")),(0,l.kt)("p",null,"\u5728 ",(0,l.kt)("inlineCode",{parentName:"p"},"master")," \u8282\u70b9\u4e0a\u8fd0\u884c\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'# \u66ff\u6362 x.x.x.x \u4e3a master \u8282\u70b9\u7684\u5185\u7f51IP\n# export \u547d\u4ee4\u53ea\u5728\u5f53\u524d shell \u4f1a\u8bdd\u4e2d\u6709\u6548\uff0c\u5f00\u542f\u65b0\u7684 shell \u7a97\u53e3\u540e\uff0c\u5982\u679c\u8981\u7ee7\u7eed\u5b89\u88c5\u8fc7\u7a0b\uff0c\u8bf7\u91cd\u65b0\u6267\u884c\u6b64\u5904\u7684 export \u547d\u4ee4\nexport MASTER_IP=172.16.1.129\n# \u66ff\u6362 apiserver.demo \u4e3a \u60a8\u60f3\u8981\u7684 dnsName\nexport APISERVER_NAME=apiserver.agou.com\n# Kubernetes \u5bb9\u5668\u7ec4\u6240\u5728\u7684\u7f51\u6bb5\uff0c\u8be5\u7f51\u6bb5\u5b89\u88c5\u5b8c\u6210\u540e\uff0c\u7531 kubernetes \u521b\u5efa\uff0c\u4e8b\u5148\u5e76\u4e0d\u5b58\u5728\u4e8e\u60a8\u7684\u7269\u7406\u7f51\u7edc\u4e2d\nexport POD_SUBNET=10.100.0.1/16\necho "${MASTER_IP}    ${APISERVER_NAME}" >> /etc/hosts\n')),(0,l.kt)("p",null,"\u5728",(0,l.kt)("inlineCode",{parentName:"p"},"master"),"\u8282\u70b9\u4e0a\u6dfb\u52a0\u4ee5\u4e0b\u811a\u672c\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},'#!/bin/bash\n\n# \u53ea\u5728 master \u8282\u70b9\u6267\u884c\n\n# \u811a\u672c\u51fa\u9519\u65f6\u7ec8\u6b62\u6267\u884c\nset -e\n\nif [ ${#POD_SUBNET} -eq 0 ] || [ ${#APISERVER_NAME} -eq 0 ]; then\n  echo -e "\\033[31;1m\u8bf7\u786e\u4fdd\u60a8\u5df2\u7ecf\u8bbe\u7f6e\u4e86\u73af\u5883\u53d8\u91cf POD_SUBNET \u548c APISERVER_NAME \\033[0m"\n  echo \u5f53\u524dPOD_SUBNET=$POD_SUBNET\n  echo \u5f53\u524dAPISERVER_NAME=$APISERVER_NAME\n  exit 1\nfi\n\n\n# \u67e5\u770b\u5b8c\u6574\u914d\u7f6e\u9009\u9879 https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta2\nrm -f ./kubeadm-config.yaml\ncat <<EOF > ./kubeadm-config.yaml\napiVersion: kubeadm.k8s.io/v1beta2\nkind: ClusterConfiguration\nkubernetesVersion: v${1}\nimageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers\ncontrolPlaneEndpoint: "${APISERVER_NAME}:6443"\nnetworking:\n  serviceSubnet: "10.96.0.0/16"\n  podSubnet: "${POD_SUBNET}"\n  dnsDomain: "cluster.local"\nEOF\n\n# kubeadm init\n# \u6839\u636e\u60a8\u670d\u52a1\u5668\u7f51\u901f\u7684\u60c5\u51b5\uff0c\u60a8\u9700\u8981\u7b49\u5019 3 - 10 \u5206\u949f\nkubeadm init --config=kubeadm-config.yaml --upload-certs\n\n# \u914d\u7f6e kubectl\nrm -rf /root/.kube/\nmkdir /root/.kube/\ncp -i /etc/kubernetes/admin.conf /root/.kube/config\n\n# \u5b89\u88c5 calico \u7f51\u7edc\u63d2\u4ef6\n# \u53c2\u8003\u6587\u6863 https://docs.projectcalico.org/v3.13/getting-started/kubernetes/self-managed-onprem/onpremises\necho "\u5b89\u88c5calico-3.13.1"\nrm -f calico-3.13.1.yaml\nwget https://kuboard.cn/install-script/calico/calico-3.13.1.yaml\nkubectl apply -f calico-3.13.1.yaml\n')),(0,l.kt)("p",null,"\u6267\u884c\u8be5\u811a\u672c\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"bash master_init.sh 1.18.2\n")),(0,l.kt)("p",null,"\u68c0\u67e5",(0,l.kt)("inlineCode",{parentName:"p"},"master"),"\u521d\u59cb\u5316\u7ed3\u679c\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"# \u6267\u884c\u5982\u4e0b\u547d\u4ee4\uff0c\u7b49\u5f85 3-10 \u5206\u949f\uff0c\u76f4\u5230\u6240\u6709\u7684\u5bb9\u5668\u7ec4\u5904\u4e8e Running \u72b6\u6001\nwatch kubectl get pod -n kube-system -o wide\n\n# \u67e5\u770b master \u8282\u70b9\u521d\u59cb\u5316\u7ed3\u679c\nkubectl get nodes -o wide\n")),(0,l.kt)("h3",{id:"343-\u521d\u59cb\u5316-node-\u8282\u70b9"},"3.4.3 \u521d\u59cb\u5316 node \u8282\u70b9"),(0,l.kt)("h4",{id:"3431--\u83b7\u5f97-join\u547d\u4ee4\u53c2\u6570"},"3.4.3.1  \u83b7\u5f97 join\u547d\u4ee4\u53c2\u6570"),(0,l.kt)("p",null,"\u5728",(0,l.kt)("inlineCode",{parentName:"p"},"master")," \u8282\u70b9\u4e0a\u83b7\u53d6",(0,l.kt)("inlineCode",{parentName:"p"},"join"),"\u547d\u4ee4\u884c\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"kubeadm token create --print-join-command\n")),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"\u2139\ufe0f ",(0,l.kt)("strong",{parentName:"p"},"\u6709\u6548\u65f6\u95f4")),(0,l.kt)("p",{parentName:"blockquote"},"\u8be5",(0,l.kt)("inlineCode",{parentName:"p"}," token")," \u7684\u6709\u6548\u65f6\u95f4\u4e3a 2 \u4e2a\u5c0f\u65f6\uff0c2\u5c0f\u65f6\u5185\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u6b64 token \u521d\u59cb\u5316\u4efb\u610f\u6570\u91cf\u7684 worker \u8282\u70b9\u3002")),(0,l.kt)("h4",{id:"3432-\u521d\u59cb\u5316-node-\u8282\u70b9"},"3.4.3.2 \u521d\u59cb\u5316 node \u8282\u70b9"),(0,l.kt)("p",null,"\u7f16\u8f91\u672c\u5730\u4e3b\u673a\u89e3\u6790\u6587\u4ef6",(0,l.kt)("inlineCode",{parentName:"p"},"/etc/hosts"),"\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"# \u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9\n172.16.1.129    apiserver.agou.com\n")),(0,l.kt)("p",null,"\u6267\u884c\u4ece",(0,l.kt)("inlineCode",{parentName:"p"},"master"),"\u8282\u70b9\u4e0a\u83b7\u53d6\u7684",(0,l.kt)("inlineCode",{parentName:"p"},"join"),"\u547d\u4ee4\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"kubeadm join apiserver.agou.com:6443 --token 7t8xh1.2y6pzjpgl9eai0kd     --discovery-token-ca-cert-hash sha256:a57479ae585f0c0a617d890c62c15c71023d85d4d55f4dd8fffeb56d9a467ef7 \n")),(0,l.kt)("h3",{id:"344-\u68c0\u67e5\u521d\u59cb\u5316\u7ed3\u679c"},"3.4.4 \u68c0\u67e5\u521d\u59cb\u5316\u7ed3\u679c"),(0,l.kt)("p",null,"\u5728",(0,l.kt)("inlineCode",{parentName:"p"},"master"),"\u8282\u70b9\u4e0a\u6267\u884c\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl get nodes -o wide\n")),(0,l.kt)("h2",{id:"35-\u4f7f\u7528-kubespray-\u90e8\u7f72"},"3.5 \u4f7f\u7528 Kubespray \u90e8\u7f72"),(0,l.kt)("h3",{id:"351-kubespray-\u7b80\u4ecb"},"3.5.1 Kubespray \u7b80\u4ecb"),(0,l.kt)("p",null,(0,l.kt)("a",{parentName:"p",href:"https://github.com/kubernetes-incubator/kubespray"},"Kubespray")," \u662f Kubernetes incubator \u4e2d\u7684\u9879\u76ee\uff0c\u76ee\u6807\u662f\u63d0\u4f9b Production Ready Kubernetes \u90e8\u7f72\u65b9\u6848\uff0c\u8be5\u9879\u76ee\u57fa\u7840\u662f\u901a\u8fc7 Ansible Playbook \u6765\u5b9a\u4e49\u7cfb\u7edf\u4e0e Kubernetes \u96c6\u7fa4\u90e8\u7f72\u7684\u4efb\u52a1\uff0c\u5177\u6709\u4ee5\u4e0b\u51e0\u4e2a\u7279\u70b9\uff1a"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u53ef\u4ee5\u90e8\u7f72\u5728 AWS, GCE, Azure, OpenStack \u4ee5\u53ca\u88f8\u673a\u4e0a."),(0,l.kt)("li",{parentName:"ul"},"\u90e8\u7f72 High Available Kubernetes \u96c6\u7fa4."),(0,l.kt)("li",{parentName:"ul"},"\u53ef\u7ec4\u5408\u6027 (Composable)\uff0c\u53ef\u81ea\u884c\u9009\u62e9 Network Plugin (flannel, calico, canal, weave) \u6765\u90e8\u7f72."),(0,l.kt)("li",{parentName:"ul"},"\u652f\u6301\u591a\u79cd Linux distributions(CoreOS, Debian Jessie, Ubuntu 16.04, CentOS/RHEL7).")),(0,l.kt)("p",null,"Kubespray \u7531\u4e00\u7cfb\u5217\u7684 ",(0,l.kt)("a",{parentName:"p",href:"http://docs.ansible.com/"},"Ansible")," playbook\u3001\u751f\u6210 ",(0,l.kt)("a",{parentName:"p",href:"https://github.com/kubernetes-incubator/kubespray/blob/master/docs/ansible.md"},"inventory")," \u7684\u547d\u4ee4\u884c\u5de5\u5177\u4ee5\u53ca\u751f\u6210 OS/Kubernetes \u96c6\u7fa4\u914d\u7f6e\u7ba1\u7406\u4efb\u52a1\u7684\u4e13\u4e1a\u77e5\u8bc6\u6784\u6210\u3002"),(0,l.kt)("h3",{id:"352-\u521d\u59cb\u5316\u73af\u5883"},"3.5.2 \u521d\u59cb\u5316\u73af\u5883"),(0,l.kt)("p",null,"\u4e3b\u673a\u73af\u5883\uff1a"),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"\u89d2\u8272"),(0,l.kt)("th",{parentName:"tr",align:null},"IP"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"master"),(0,l.kt)("td",{parentName:"tr",align:null},"172.16.1.128")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"node01"),(0,l.kt)("td",{parentName:"tr",align:null},"172.16.1.129")))),(0,l.kt)("p",null,"\u7f16\u8f91",(0,l.kt)("inlineCode",{parentName:"p"},"/etc/hosts"),"\u6587\u4ef6\uff0c\u4f7f\u5404\u4e3b\u673a\u4e4b\u95f4\u53ef\u4ee5\u901a\u8fc7\u4e3b\u673a\u540d\u4e92\u76f8\u901a\u4fe1\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"# \u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9\n172.16.1.128 master master.agou-ops.com\n172.16.1.129 node01 node01.agou-ops.com\n")),(0,l.kt)("p",null,"\u5173\u95ed SELinux \u548c\u9632\u706b\u5899\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"sed -i 's/SELINUX=*/SELINUX=disabled/' /etc/selinux/config\nsystemctl disable firewalld && systemctl stop firewalld\n")),(0,l.kt)("p",null,"Kubernetes 1.8 \u5f00\u59cb\u8981\u6c42\u5173\u95ed\u7cfb\u7edf\u7684 Swap \u4ea4\u6362\u5206\u533a\uff0c\u65b9\u6cd5\u5982\u4e0b\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'swapoff -a && echo "vm.swappiness=0" >> /etc/sysctl.conf && sysctl -p && free \u2013h\n')),(0,l.kt)("p",null,"Docker \u4ece 1.13 \u7248\u672c\u5f00\u59cb\u8c03\u6574\u4e86\u9ed8\u8ba4\u7684\u9632\u706b\u5899\u89c4\u5219\uff0c\u7981\u7528\u4e86 ",(0,l.kt)("inlineCode",{parentName:"p"},"iptables filter "),"\u8868\u4e2d",(0,l.kt)("inlineCode",{parentName:"p"},"FOWARD"),"\u94fe\uff0c\u8fd9\u6837\u4f1a\u5f15\u8d77 Kubernetes \u96c6\u7fa4\u4e2d\u8de8 Node \u7684 Pod \u65e0\u6cd5\u901a\u4fe1\uff0c\u5728\u5404\u4e2a Docker \u8282\u70b9\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"iptables -P FORWARD ACCEPT\n")),(0,l.kt)("p",null,"\u914d\u7f6e SSH Key \u8ba4\u8bc1\u3002\u786e\u4fdd\u672c\u673a\u4e5f\u53ef\u4ee5 SSH \u8fde\u63a5\uff0c\u5426\u5219\u4e0b\u9762\u90e8\u7f72\u5931\u8d25\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'ssh-keygen -t rsa -N ""\ncat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys\n')),(0,l.kt)("p",null,"\u66f4\u65b0\u7cfb\u7edf\u5185\u6838\u4e3a 4.4.x , CentOS \u9ed8\u8ba4\u4e3a 3.10.x \u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org\nrpm -Uvh http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm\nyum --enablerepo=elrepo-kernel install -y kernel-lt kernel-lt-devel \ngrub2-set-default 0\n")),(0,l.kt)("p",null,"\u91cd\u542f\u7cfb\u7edf\uff1a",(0,l.kt)("inlineCode",{parentName:"p"},"reboot")),(0,l.kt)("p",null,"\u589e\u52a0\u5185\u6838\u914d\u7f6e\uff0c\u7f16\u8f91",(0,l.kt)("inlineCode",{parentName:"p"},"/etc/sysctl.conf"),"\u6587\u4ef6\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"# \u589e\u52a0\u4ee5\u4e0b\u5185\u5bb9\nnet.bridge.bridge-nf-call-iptables = 1\nnet.bridge.bridge-nf-call-ip6tables = 1\n")),(0,l.kt)("p",null,"\u4f7f\u5176\u5185\u6838\u914d\u7f6e\u751f\u6548\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"sysctl -p\n")),(0,l.kt)("h3",{id:"353-\u5b89\u88c5-kubespray"},"3.5.3 \u5b89\u88c5 Kubespray"),(0,l.kt)("p",null,"\u5b89\u88c5 Centos \u7684 EPEL \u6e90\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"}," yum -y install epel-release\n")),(0,l.kt)("p",null,"\u66f4\u65b0\u7f13\u5b58\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"}," yum clean all && yum makecache\n")),(0,l.kt)("p",null,"\u5b89\u88c5\u76f8\u5173\u8f6f\u4ef6\uff08Ansible \u7248\u672c\u5fc5\u987b >= 2.7\uff09\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"}," yum install -y python-pip python3 python-netaddr python3-pip ansible git\n")),(0,l.kt)("p",null,"\u4e0b\u8f7d\u6e90\u7801\uff0c\u5f53\u524d Kubespray \u9879\u76ee\u7684 Master \u5206\u652f\u9ed8\u8ba4\u5b89\u88c5 K8s 1.13.1 \u7248\u672c\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"git clone https://github.com/kubernetes-sigs/kubespray.git\n")),(0,l.kt)("p",null,"\u5b89\u88c5 Kubespray \u4f9d\u8d56\uff0c\u82e5\u65e0\u7279\u6b8a\u8bf4\u660e\uff0c\u540e\u7eed\u64cd\u4f5c\u5747\u5728 ~/kubespray `\u76ee\u5f55\u4e0b\u6267\u884c\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"}," cd kubespray \n pip3 install -r requirements.txt\n")),(0,l.kt)("p",null,"\u914d\u7f6e Kubespray\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"}," cp -rfp inventory/sample inventory/mycluster\n \n # Update Ansible inventory file with inventory builder\ndeclare -a IPS=(10.10.1.3 10.10.1.4 10.10.1.5)\nCONFIG_FILE=inventory/mycluster/hosts.yaml python3 contrib/inventory_builder/inventory.py ${IPS[@]}\n")),(0,l.kt)("p",null,"\u4fee\u6539\u914d\u7f6e\u6587\u4ef6 ",(0,l.kt)("inlineCode",{parentName:"p"},"inventory/mycluster/hosts.ini "),"\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ini"},"[all]\nmaster ansible_host=master ip=172.16.1.128\n\n[kube-master]\nmaster\n\n[etcd]\nmaster\n\n[kube-node]\nnode01\n\n[k8s-cluster:children]\nkube-master\nkube-node\n\n[calico-rr]\n")),(0,l.kt)("p",null,"\u2139\ufe0f\u6b64\u5904\u4e5f\u53ef\u4ee5\u7528\uff1a",(0,l.kt)("inlineCode",{parentName:"p"},"kubespray prepare --masters master1 --etcds master1 --nodes node1 node2 node3"),"\u6765\u81ea\u52a8\u751f\u6210",(0,l.kt)("inlineCode",{parentName:"p"},"inventory"),"\u6587\u4ef6"),(0,l.kt)("p",null,"\u4fee\u6539\u914d\u7f6e\u6587\u4ef6",(0,l.kt)("inlineCode",{parentName:"p"}," inventory/mycluster/group_vars/all/all.yml"),"\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"# \u4fee\u6539\u5982\u4e0b\u914d\u7f6e:\nloadbalancer_apiserver_localhost: true \n# \u52a0\u8f7d\u5185\u6838\u6a21\u5757\uff0c\u5426\u5219 ceph, gfs \u7b49\u65e0\u6cd5\u6302\u8f7d\u5ba2\u6237\u7aef\nkubelet_load_modules: true\n")),(0,l.kt)("p",null,"\u4fee\u6539\u955c\u50cf\u9ed8\u8ba4\u7684 Repo \u5730\u5740\uff0c\u4f7f\u7528 Calico \u4e09\u5c42\u7f51\u7edc\uff0c\u540c\u65f6\u53ef\u4ee5\u6307\u5b9a\u5b89\u88c5\u7684 K8s\u7248\u672c\uff0c\u53c2\u6570\u4e3a",(0,l.kt)("inlineCode",{parentName:"p"}," kube_version"),"\u3002\u7f16\u8f91\u6587\u4ef6",(0,l.kt)("inlineCode",{parentName:"p"},"inventory/mycluster/group_vars/k8s-cluster/k8s-cluster.yml"),"(\u5728\u8fd9\u91cc\u6211\u80fd\u591f\u79d1\u5b66\u4e0a\u7f51\u5c31\u4e0d\u505a\u4fee\u6539\u4e86)\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},'kube_image_repo: "gcr.io/google-containers"\n')),(0,l.kt)("p",null,"\u5982\u9700\u8bbe\u7f6e\u4ee3\u7406\uff0c\u5728",(0,l.kt)("inlineCode",{parentName:"p"}," cluster.yml"),"\u4e2d\u7f16\u8f91 default \u503c\u5373\u53ef\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"...\nproxy_env:\n          http_proxy: \"\u3010\u3010 http_proxy | default ('192.168.43.37:8888') \u3011\u3011\"\n          HTTP_PROXY: \"\u3010\u3010 http_proxy | default ('192.168.43.37:8888') \u3011\u3011\"\n          https_proxy: \"\u3010\u3010 https_proxy | default ('192.168.43.37:8888') \u3011\u3011\"\n          HTTPS_PROXY: \"\u3010\u3010 https_proxy | default ('192.168.43.37:8888') \u3011\u3011\"\n          no_proxy: \"\u3010\u3010 no_proxy | default ('') \u3011\u3011\"\n          NO_PROXY: \"\u3010\u3010 no_proxy | default ('') \u3011\u3011\"\n      no_log: true\n...\n")),(0,l.kt)("p",null,"\u5982\u9700\u8bbe\u7f6e",(0,l.kt)("inlineCode",{parentName:"p"},"docker pull")," \u4ee3\u7406\uff0c\u65b0\u5efa",(0,l.kt)("inlineCode",{parentName:"p"},"/etc/systemd/system/docker.service.d/http-proxy.conf"),"\u6587\u4ef6\uff0c\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'[Service]\nEnvironment="http_proxy=192.168.43.37:8888"\nEnvironment="https_proxy=192.168.43.37:8888"\nEnvironment="NO_PROXY= hostname.example.com,172.10.10.10"\n# \u6700\u540e\u91cd\u542fdocker\nsystemctl daemon-reload\nsystemctl restart docker\n')),(0,l.kt)("p",null,"\u4fee\u6539",(0,l.kt)("inlineCode",{parentName:"p"},"./roles/kubernetes-apps/ansible/templates/dashboard.yml.j2"),"\u6587\u4ef6\uff0c\u4f7f\u7528 ",(0,l.kt)("inlineCode",{parentName:"p"},"NodePort")," \u65b9\u5f0f\u8bbf\u95ee Dashboard\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"# ------------------- Dashboard Service ------------------- #\u2026\u2026\u2026\u2026      \ntargetPort: 8443  \ntype: NodePort    //\u6dfb\u52a0\u8fd9\u4e00\u884c      \nselector:\nk8s-app: kubernetes-dashboard\n")),(0,l.kt)("p",null,"\u26a0\ufe0f \u6ce8\u610f\uff1a\u5982\u679c\u662f\u5355\u8282\u70b9\u90e8\u7f72 K8s\uff0cKubespray \u9ed8\u8ba4\u4f1a\u521b\u5efa 2 \u4e2a coredns Pod\uff0c\u4f46 Deployment \u4e2d\u53c8\u7528\u5230\u4e86 podAntiAffinity\uff0c\u56e0\u6b64\u4f1a\u5bfc\u81f4\u5176\u4e2d\u4e00\u4e2a coredns pod pending\uff0c\u6240\u4ee5\u9700\u8981\u4fee\u6539",(0,l.kt)("inlineCode",{parentName:"p"},"./roles/kubernetes-apps/ansible/templates/coredns-deployment.yml.j2"),"\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"# \u6ce8\u91ca\u6389\u4ee5\u4e0b\u51e0\u884c\u4ee3\u7801\n      affinity:\n        #podAntiAffinity:\n        #  requiredDuringSchedulingIgnoredDuringExecution:\n        #  - topologyKey: \"kubernetes.io/hostname\"\n        #    labelSelector:\n        #      matchLabels:\n        #        k8s-app: coredns\u3010\u3010 coredns_ordinal_suffix | default('') \u3011\u3011\n\n# \u6216\u8005\u5728spec\u4e00\u884c\u6dfb\u52a0\u4ee3\u7801\uff1a\nspec:\n  replicas: 1   //\u6307\u5b9apod\u4e3a1\u4e2a\u526f\u672c\n")),(0,l.kt)("p",null,"\u6700\u540e\u6267\u884c\u90e8\u7f72\u547d\u4ee4\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"ansible-playbook -i inventory/mycluster/hosts.ini  --become --become-user=root cluster.yml -b -v\n")),(0,l.kt)("h3",{id:"354-\u767b\u5f55-dashboard"},"3.5.4 \u767b\u5f55 Dashboard"),(0,l.kt)("p",null,"\u767b\u9646 Dashboard \u652f\u6301 kubeconfig \u548c token \u4e24\u79cd\u8ba4\u8bc1\u65b9\u5f0f\uff0ckubeconfig \u4e5f\u4f9d\u8d56 token \u5b57\u6bb5\uff0c\u6240\u4ee5\u751f\u6210 token \u8fd9\u4e00\u6b65\u662f\u5fc5\u4e0d\u53ef\u5c11\u7684\u3002\u6b64\u5904\uff0c\u6211\u4eec\u83b7\u53d6\u96c6\u7fa4\u7ba1\u7406\u5458\uff08\u62e5\u6709\u6240\u6709\u547d\u540d\u7a7a\u95f4\u7684 admin \u6743\u9650\uff09\u7684 token\u3002"),(0,l.kt)("p",null,"\u67e5\u770b kubernetes-dashboard \u66b4\u9732\u7684\u7aef\u53e3\uff0c\u5982\u4e0b\u6240\u793a\uff0c\u8fd9\u91cc\u662f31777\u7aef\u53e3\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"[root@master kubespray]\\#  kubectl get svc --all-namespaces | grep kubernetes-dashboard\nkube-system   kubernetes-dashboard        NodePort    10.233.41.202   <none>        443:30548/TCP            8m16s\n")),(0,l.kt)("p",null,"\u83b7\u53d6 admin \u7684 token"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"[root@master kubespray]\\#  kubectl -n kube-system describe $(kubectl -n kube-system get secret -n kube-system -o name | grep namespace) | grep token\nName:         namespace-controller-token-ksdvp\nType:  kubernetes.io/service-account-token\ntoken:      eyJhbGciOiJSUzI1NiIsImtpZCI6IkV0N0pLMXVqMzNxS2xCNXRlTkxpRTlOYnNMVzRiajNrLU9kdi1qRW5jTDQifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJuYW1lc3BhY2UtY29udHJvbGxlci10b2tlbi1rc2R2cCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJuYW1lc3BhY2UtY29udHJvbGxlciIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImZiM2NkMDBhLTE4ZjAtNGI4OC1hZGNiLWYwNGVjZWNlZTUzNiIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTpuYW1lc3BhY2UtY29udHJvbGxlciJ9.bYWcoopcYFC6EYNMNPkoiZeUQqfidC9NwlrMzzkZD3T9e-PbDd37pmTeWAcU_E4DCDzeVc9CXfWPhWCfr3syZKWiIXPNtDrNrIgnGs34Id2evsh7evVTgOjQtWkRoqX9UFdjWZdQPxvJChLZacRqbUp718umCzhR9evuE0zq8JeruBCTrcilQDDYobavfYs72HrwZ5xlIj2GMb66FeS7mYZacP-2-M3oVsziIWLs_kfBIaN_OkpImUPpvJxF-8xMmVP2BCKWyHWaLPIUdVsF8FkiLWH7bIS8f0cm8D4wEcMZ4IYkVe2FMcmMaiFJx5HEXrwA4YT7bMVy4PJhR71Thg\n")),(0,l.kt)("p",null,"\u5728 dashboard \u767b\u5f55\u9875\u9762\u4e0a\u4f7f\u7528\u4e0a\u9762\u8f93\u51fa\u4e2d\u7684\u90a3\u4e2a\u975e\u5e38\u957f\u7684\u5b57\u7b26\u4e32\u4f5c\u4e3a token \u767b\u5f55\uff0c\u5373\u53ef\u4ee5\u62e5\u6709\u7ba1\u7406\u5458\u6743\u9650\u64cd\u4f5c\u6574\u4e2a kubernetes \u96c6\u7fa4\u4e2d\u7684\u5bf9\u8c61\u3002\u5f53\u7136\u60a8\u4e5f\u53ef\u4ee5\u5c06\u8fd9\u4e32 token \u52a0\u5230 admin \u7528\u6237\u7684 kubeconfig \u6587\u4ef6\u4e2d\uff0c\u7ee7\u7eed\u4f7f\u7528 kubeconfig \u767b\u5f55\uff0c\u4e24\u79cd\u8ba4\u8bc1\u65b9\u5f0f\u4efb\u60a8\u9009\u62e9\u3002"),(0,l.kt)("p",null,"\u767b\u5f55 dashboard\uff1a",(0,l.kt)("a",{parentName:"p",href:"https://172.16.1.128:30548"},"https://172.16.1.128:30548")),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"\u6ce8\u610f\uff1a\u7531\u4e8e\u8fd9\u91cc\u4f7f\u7528\u7684 HTTPS\uff0c\u5e76\u672a\u4f7f\u7528\u8bc1\u4e66\uff0c\u56e0\u6b64\u4f7f\u7528 Google \u7b49\u6d4f\u89c8\u5668\u4f1a\u7ec8\u6b62\u8bbf\u95ee\u3002")),(0,l.kt)("h3",{id:"355-\u9a8c\u8bc1-k8s-\u96c6\u7fa4"},"3.5.5 \u9a8c\u8bc1 K8s \u96c6\u7fa4"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u67e5\u770b\u96c6\u7fa4\u7248\u672c")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"[root@master ~]\\# kubelet --version\nKubernetes v1.18.2\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u67e5\u770b\u96c6\u7fa4\u72b6\u6001")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"}," kubectl get nodes\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u67e5\u770b\u96c6\u7fa4 Pod ")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"}," kubectl get pods --all-namespaces\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u67e5\u770b IPVS")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"}," ipvsadm -L -n\n")),(0,l.kt)("h3",{id:"356-\u5176\u4ed6"},"3.5.6 \u5176\u4ed6"),(0,l.kt)("p",null,"\u589e\u52a0 node \u8282\u70b9\uff08\u63d0\u524d\u5728",(0,l.kt)("inlineCode",{parentName:"p"},"hosts.ini"),"\u6587\u4ef6\u4e2d\u589e\u52a0\u4e3b\u673a\u8282\u70b9\uff09\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"ansible-playbook -i inventory/mycluster/hosts.ini scale.yml -b -v -k\n")),(0,l.kt)("p",null,"\u5c06",(0,l.kt)("inlineCode",{parentName:"p"}," hosts.ini")," \u6587\u4ef6\u4e2d\u7684 master \u548c etcd \u7684\u673a\u5668\u589e\u52a0\u5230\u591a\u53f0\uff0c\u6267\u884c\u90e8\u7f72\u547d\u4ee4\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"ansible-playbook -i inventory/mycluster/hosts.ini cluster.yml -b -vvv\n")),(0,l.kt)("p",null,"\u522a\u9664\u8282\u70b9\uff0c\u5982\u679c\u4e0d\u6307\u5b9a\u8282\u70b9\u5c31\u662f\u522a\u9664\u6574\u4e2a\u96c6\u7fa4\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"ansible-playbook -i inventory/mycluster/hosts.ini remove-node.yml -b -v\n")),(0,l.kt)("p",null,"\u5982\u679c\u9700\u8981\u5378\u8f7d\uff0c\u53ef\u4ee5\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"ansible-playbook -i inventory/mycluster/hosts.ini reset.yml -b \u2013vvv\n")),(0,l.kt)("p",null,"\u5347\u7ea7 K8s \u96c6\u7fa4\uff0c\u9009\u62e9\u5bf9\u5e94\u7684 K8s \u7248\u672c\u4fe1\u606f\uff0c\u6267\u884c\u5347\u7ea7\u547d\u4ee4\u3002\u6d89\u53ca\u6587\u4ef6\u4e3a ",(0,l.kt)("inlineCode",{parentName:"p"},"upgrade-cluster.yml"),"\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"ansible-playbook upgrade-cluster.yml -b -i inventory/mycluster/hosts.ini -e kube_version=vX.XX.XX -vvv\n")),(0,l.kt)("h2",{id:"\u53c2\u8003\u94fe\u63a5"},"\u53c2\u8003\u94fe\u63a5"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"kubespray GetStarted\uff1a",(0,l.kt)("a",{parentName:"p",href:"https://github.com/kubernetes-sigs/kubespray/blob/master/docs/getting-started.md"},"https://github.com/kubernetes-sigs/kubespray/blob/master/docs/getting-started.md"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"\u4f7f\u7528 Kubespray \u5728\u57fa\u7840\u8bbe\u65bd\u6216\u4e91\u5e73\u53f0\u4e0a\u5b89\u88c5 Kubernetes\uff1a",(0,l.kt)("a",{parentName:"p",href:"https://k8smeetup.github.io/docs/getting-started-guides/kubespray/"},"https://k8smeetup.github.io/docs/getting-started-guides/kubespray/")))))}c.isMDXComponent=!0}}]);