"use strict";(self.webpackChunkmy_docsv_4=self.webpackChunkmy_docsv_4||[]).push([[7095],{3905:(e,n,t)=>{t.d(n,{Zo:()=>c,kt:()=>m});var a=t(67294);function s(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function l(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function r(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?l(Object(t),!0).forEach((function(n){s(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):l(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function i(e,n){if(null==e)return{};var t,a,s=function(e,n){if(null==e)return{};var t,a,s={},l=Object.keys(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||(s[t]=e[t]);return s}(e,n);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(s[t]=e[t])}return s}var o=a.createContext({}),p=function(e){var n=a.useContext(o),t=n;return e&&(t="function"==typeof e?e(n):r(r({},n),e)),t},c=function(e){var n=p(e.components);return a.createElement(o.Provider,{value:n},e.children)},k={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},g=a.forwardRef((function(e,n){var t=e.components,s=e.mdxType,l=e.originalType,o=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),g=p(t),m=s,d=g["".concat(o,".").concat(m)]||g[m]||k[m]||l;return t?a.createElement(d,r(r({ref:n},c),{},{components:t})):a.createElement(d,r({ref:n},c))}));function m(e,n){var t=arguments,s=n&&n.mdxType;if("string"==typeof e||s){var l=t.length,r=new Array(l);r[0]=g;var i={};for(var o in n)hasOwnProperty.call(n,o)&&(i[o]=n[o]);i.originalType=e,i.mdxType="string"==typeof e?e:s,r[1]=i;for(var p=2;p<l;p++)r[p]=t[p];return a.createElement.apply(null,r)}return a.createElement.apply(null,t)}g.displayName="MDXCreateElement"},83222:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>r,default:()=>k,frontMatter:()=>l,metadata:()=>i,toc:()=>p});var a=t(87462),s=(t(67294),t(3905));const l={},r="\u57fa\u4e8ekubernetes\u5e73\u53f0\u7684CICD\u6301\u7eed\u96c6\u6210",i={unversionedId:"CloudNative/k8s/Kubernetes with Jenkins CICD",id:"CloudNative/k8s/Kubernetes with Jenkins CICD",title:"\u57fa\u4e8ekubernetes\u5e73\u53f0\u7684CICD\u6301\u7eed\u96c6\u6210",description:"\u6587\u7ae0\u76ee\u5f55",source:"@site/docs/CloudNative/k8s/Kubernetes with Jenkins CICD.md",sourceDirName:"CloudNative/k8s",slug:"/CloudNative/k8s/Kubernetes with Jenkins CICD",permalink:"/docs/CloudNative/k8s/Kubernetes with Jenkins CICD",draft:!1,editUrl:"https://github.com/AGou-ops/myDocsv4/edit/main/docs/CloudNative/k8s/Kubernetes with Jenkins CICD.md",tags:[],version:"current",frontMatter:{},sidebar:"cloudNative",previous:{title:"Kubernetes YAML file quicklystart",permalink:"/docs/CloudNative/k8s/Kubernetes Yaml quicklystart"},next:{title:"Minikube Basic",permalink:"/docs/CloudNative/k8s/Minikube Basic"}},o={},p=[{value:"\u6587\u7ae0\u76ee\u5f55",id:"\u6587\u7ae0\u76ee\u5f55",level:3},{value:"1.\u57fa\u4e8ek8s\u96c6\u7fa4\u7684Jenkins\u6301\u7eed\u96c6\u6210",id:"1\u57fa\u4e8ek8s\u96c6\u7fa4\u7684jenkins\u6301\u7eed\u96c6\u6210",level:2},{value:"2.\u5c06Jenkins\u90e8\u7f72\u5728k8s\u96c6\u7fa4",id:"2\u5c06jenkins\u90e8\u7f72\u5728k8s\u96c6\u7fa4",level:2},{value:"2.1.\u7f16\u5199Jenkins namespace\u6587\u4ef6",id:"21\u7f16\u5199jenkins-namespace\u6587\u4ef6",level:3},{value:"2.2.\u7f16\u5199Jenkins rbac\u6388\u6743\u6587\u4ef6",id:"22\u7f16\u5199jenkins-rbac\u6388\u6743\u6587\u4ef6",level:3},{value:"2.3.\u7f16\u5199Jenkins statefulset\u8d44\u6e90\u6587\u4ef6",id:"23\u7f16\u5199jenkins-statefulset\u8d44\u6e90\u6587\u4ef6",level:3},{value:"2.4.\u7f16\u5199Jenkins StorageClass\u8d44\u6e90\u6587\u4ef6",id:"24\u7f16\u5199jenkins-storageclass\u8d44\u6e90\u6587\u4ef6",level:3},{value:"2.5.\u7f16\u5199Jenkins svc\u8d44\u6e90\u6587\u4ef6",id:"25\u7f16\u5199jenkins-svc\u8d44\u6e90\u6587\u4ef6",level:3},{value:"2.6.\u51c6\u5907Jenkins\u955c\u50cf\u5e76\u63a8\u9001\u81f3harbor",id:"26\u51c6\u5907jenkins\u955c\u50cf\u5e76\u63a8\u9001\u81f3harbor",level:3},{value:"2.7.\u521b\u5efa\u6240\u6709\u8d44\u6e90\u5e76\u67e5\u770b\u8d44\u6e90\u7684\u72b6\u6001",id:"27\u521b\u5efa\u6240\u6709\u8d44\u6e90\u5e76\u67e5\u770b\u8d44\u6e90\u7684\u72b6\u6001",level:3},{value:"2.8.\u9875\u9762\u5b89\u88c5Jenkins",id:"28\u9875\u9762\u5b89\u88c5jenkins",level:3},{value:"2.9.\u767b\u9646Jenkins",id:"29\u767b\u9646jenkins",level:3},{value:"3.\u4f7f\u7528docker\u90e8\u7f72gitlab",id:"3\u4f7f\u7528docker\u90e8\u7f72gitlab",level:2},{value:"3.1.\u90e8\u7f72gitlab",id:"31\u90e8\u7f72gitlab",level:3},{value:"3.2.\u8bbf\u95eegitlab",id:"32\u8bbf\u95eegitlab",level:3},{value:"4.\u5c06gitlab\u90e8\u7f72\u5728k8s\u96c6\u7fa4",id:"4\u5c06gitlab\u90e8\u7f72\u5728k8s\u96c6\u7fa4",level:2},{value:"4.1.\u5c06gitlab\u955c\u50cf\u63a8\u9001\u81f3harbor\u4ed3\u5e93",id:"41\u5c06gitlab\u955c\u50cf\u63a8\u9001\u81f3harbor\u4ed3\u5e93",level:3},{value:"4.2.\u4f7f\u7528docker\u8fd0\u884cgitlab\u67e5\u8be2\u7528\u6237\u7684id\u53f7",id:"42\u4f7f\u7528docker\u8fd0\u884cgitlab\u67e5\u8be2\u7528\u6237\u7684id\u53f7",level:3},{value:"4.3.\u7f16\u5199gitlab StorageClass \u8d44\u6e90\u6587\u4ef6",id:"43\u7f16\u5199gitlab-storageclass-\u8d44\u6e90\u6587\u4ef6",level:3},{value:"4.4.\u7f16\u5199gitlab statefulset \u8d44\u6e90\u6587\u4ef6",id:"44\u7f16\u5199gitlab-statefulset-\u8d44\u6e90\u6587\u4ef6",level:3},{value:"4.5.\u7f16\u5199gitlab service \u8d44\u6e90\u6587\u4ef6",id:"45\u7f16\u5199gitlab-service-\u8d44\u6e90\u6587\u4ef6",level:3},{value:"4.6.\u521b\u5efa\u6240\u6709\u8d44\u6e90\u5e76\u67e5\u770b\u72b6\u6001",id:"46\u521b\u5efa\u6240\u6709\u8d44\u6e90\u5e76\u67e5\u770b\u72b6\u6001",level:3},{value:"4.7.\u4fee\u6539gitlab\u914d\u7f6e",id:"47\u4fee\u6539gitlab\u914d\u7f6e",level:3},{value:"4.8.\u8bbf\u95eegitlab",id:"48\u8bbf\u95eegitlab",level:3},{value:"5.\u63d0\u4ea4\u7a0b\u5e8f\u4ee3\u7801\u5230gitlab\u4e0a",id:"5\u63d0\u4ea4\u7a0b\u5e8f\u4ee3\u7801\u5230gitlab\u4e0a",level:2},{value:"5.1.\u65b0\u5efa\u4e00\u4e2a\u9879\u76ee",id:"51\u65b0\u5efa\u4e00\u4e2a\u9879\u76ee",level:3},{value:"5.2.\u5c06\u7a0b\u5e8f\u4ee3\u7801\u63d0\u4ea4\u5230gitlab",id:"52\u5c06\u7a0b\u5e8f\u4ee3\u7801\u63d0\u4ea4\u5230gitlab",level:3},{value:"6.Jenkins\u96c6\u6210gitlab",id:"6jenkins\u96c6\u6210gitlab",level:2},{value:"6.1.\u5728Jenkins\u4e0a\u5b89\u88c5gitlab\u63d2\u4ef6",id:"61\u5728jenkins\u4e0a\u5b89\u88c5gitlab\u63d2\u4ef6",level:3},{value:"6.2.\u5728gitlab\u4e0a\u751f\u6210token",id:"62\u5728gitlab\u4e0a\u751f\u6210token",level:3},{value:"6.3.\u5728Jenkins\u6dfb\u52a0gitlab api token",id:"63\u5728jenkins\u6dfb\u52a0gitlab-api-token",level:3},{value:"7.Jenkins\u5206\u5e03\u5f0fmaster-slave\u6a21\u5f0f",id:"7jenkins\u5206\u5e03\u5f0fmaster-slave\u6a21\u5f0f",level:2},{value:"7.1.\u65b0\u589eJenkins\u8282\u70b9",id:"71\u65b0\u589ejenkins\u8282\u70b9",level:3},{value:"7.2.\u65b0\u5efa\u4e00\u4e2a\u4efb\u52a1\u8fd0\u884c\u5728slave1\u8282\u70b9\u4e0a",id:"72\u65b0\u5efa\u4e00\u4e2a\u4efb\u52a1\u8fd0\u884c\u5728slave1\u8282\u70b9\u4e0a",level:3},{value:"7.3.\u89c2\u5bdf\u8282\u70b9\u5173\u8054\u7684\u6267\u884c\u4efb\u52a1",id:"73\u89c2\u5bdf\u8282\u70b9\u5173\u8054\u7684\u6267\u884c\u4efb\u52a1",level:3},{value:"8.\u4f7f\u7528pipeline\u6d41\u6c34\u7ebf\u5c06know-system\u9879\u76ee\u66f4\u65b0\u5230kubernetes\u73af\u5883",id:"8\u4f7f\u7528pipeline\u6d41\u6c34\u7ebf\u5c06know-system\u9879\u76ee\u66f4\u65b0\u5230kubernetes\u73af\u5883",level:2},{value:"8.1.\u5b9e\u73b0\u601d\u8def",id:"81\u5b9e\u73b0\u601d\u8def",level:3},{value:"8.2.\u5c06know-system\u90e8\u7f72\u5728k8s\u4e2d",id:"82\u5c06know-system\u90e8\u7f72\u5728k8s\u4e2d",level:3},{value:"8.3.\u5c06k8s\u8d44\u6e90\u6587\u4ef6\u63d0\u4ea4\u81f3gitlab",id:"83\u5c06k8s\u8d44\u6e90\u6587\u4ef6\u63d0\u4ea4\u81f3gitlab",level:3},{value:"8.4.\u7f16\u5199Jenkins pipeline\u5c06\u9879\u76ee\u66f4\u65b0\u5230k8s",id:"84\u7f16\u5199jenkins-pipeline\u5c06\u9879\u76ee\u66f4\u65b0\u5230k8s",level:3},{value:"8.5.\u5c06pipeline\u7c98\u8d34\u5230\u6d41\u6c34\u7ebf\u4efb\u52a1\u4e2d",id:"85\u5c06pipeline\u7c98\u8d34\u5230\u6d41\u6c34\u7ebf\u4efb\u52a1\u4e2d",level:3},{value:"8.6.\u6784\u5efamaster\u5206\u652f\u5b8c\u6210\u9879\u76ee\u66f4\u65b0",id:"86\u6784\u5efamaster\u5206\u652f\u5b8c\u6210\u9879\u76ee\u66f4\u65b0",level:3}],c={toc:p};function k(e){let{components:n,...t}=e;return(0,s.kt)("wrapper",(0,a.Z)({},c,t,{components:n,mdxType:"MDXLayout"}),(0,s.kt)("h1",{id:"\u57fa\u4e8ekubernetes\u5e73\u53f0\u7684cicd\u6301\u7eed\u96c6\u6210"},"\u57fa\u4e8ekubernetes\u5e73\u53f0\u7684CICD\u6301\u7eed\u96c6\u6210"),(0,s.kt)("h3",{id:"\u6587\u7ae0\u76ee\u5f55"},"\u6587\u7ae0\u76ee\u5f55"),(0,s.kt)("p",null,"[toc]"),(0,s.kt)("h2",{id:"1\u57fa\u4e8ek8s\u96c6\u7fa4\u7684jenkins\u6301\u7eed\u96c6\u6210"},"1.\u57fa\u4e8ek8s\u96c6\u7fa4\u7684Jenkins\u6301\u7eed\u96c6\u6210"),(0,s.kt)("p",null,"Jenkins\u66f4\u65b0\u4f20\u7edfLNMT\u9879\u76ee\u6d41\u7a0b\u5f88\u7b80\u5355\uff0cJenkins\u4e5f\u53ea\u9700\u8981\u90e8\u7f72\u5728\u7269\u7406\u670d\u52a1\u5668\u5373\u53ef\u5b9e\u73b0\u9879\u76ee\u7248\u672c\u7684\u6301\u7eed\u66f4\u65b0\u8fed\u4ee3"),(0,s.kt)("p",null,"\u5982\u679c\u9879\u76ee\u662f\u90e8\u7f72\u5728k8s\u96c6\u7fa4\uff0cJenkins\u8fd8\u5728\u7269\u7406\u673a\u4e0a\u90e8\u7f72\u7684\u8bdd\uff0c\u9879\u76ee\u66f4\u65b0\u6d41\u7a0b\u5c06\u4f1a\u53d8\u5f97\u7e41\u7410\uff0c\u5927\u81f4\u6d41\u7a0b\uff1a\u9996\u5148Jenkins\u5c06\u9879\u76ee\u7f16\u8bd1\u6210war\u5305\uff0c\u7136\u540e\u5c06war\u5728\u4e00\u53f0\u7269\u7406\u673a\u4e0a\u8fd0\u884c\uff0c\u5982\u679c\u8fd0\u884c\u6210\u529f\uff0c\u518d\u8c03\u7528\u53e6\u4e00\u4e2aJenkins\u4efb\u52a1\uff0c\u8fd9\u4e2aJenkins\u4efb\u52a1\u4e3b\u8981\u7684\u4f5c\u7528\u5c31\u662f\u5c06war\u5305\u548cROOT\u76ee\u5f55copy\u5230\u521d\u59cb\u955c\u50cf\u4e2d\uff0c\u5f53\u955c\u50cf\u6784\u5efa\u5b8c\u6bd5\u540e\uff0c\u5c06\u955c\u50cf\u63a8\u9001\u81f3harbor\u5e73\u53f0\uff0c\u518d\u7531\u8fd0\u7ef4\u62ff\u7740\u955c\u50cf\u7248\u672c\u653e\u5728k8s\u91cc\u53bb\u5347\u7ea7\u3002"),(0,s.kt)("p",null,"\u5982\u679cJenkins\u53ea\u662f\u5355\u5355\u90e8\u7f72\u5728\u4e00\u53f0\u7269\u7406\u673a\u4e0a\uff0c\u67d0\u53f0Jenkins\u6302\u6389\u540e\uff0c\u6574\u4e2aCI/CD\u5e73\u53f0\u5c06\u65e0\u6cd5\u66f4\u65b0\u8fed\u4ee3\uff0c\u8fd9\u662f\u4e00\u4e2a\u5f88\u4e25\u91cd\u7684\u540e\u679c\uff0c\u5982\u679c\u5c06Jenkins\u90e8\u7f72\u5728k8s\u5e73\u53f0\uff0c\u501f\u52a9k8s pod\u81ea\u6108\u529f\u80fd\uff0cJenkins\u6302\u6389\u7684\u60c5\u51b5\u51e0\u4e4e\u4e0d\u4f1a\u53d1\u751f\u3002"),(0,s.kt)("p",null,"Jenkins\u90e8\u7f72\u5728k8s\u73af\u5883\u4e4b\u540e\uff0c\u901a\u8fc7\u5efa\u7acbRBAC\u6388\u6743\u673a\u5236\uff0c\u53ef\u4ee5\u5b9e\u73b0Jenkins\u4e00\u952e\u66f4\u65b0\u8fed\u4ee3\u5230k8s\u73af\u5883\uff0c\u65e0\u9700\u5728\u4f7f\u7528\u7269\u7406\u673a\u73af\u5883\u90a3\u4e48\u7e41\u7410\u7684\u6b65\u9aa4"),(0,s.kt)("blockquote",null,(0,s.kt)("p",{parentName:"blockquote"},"\u5f53Jenkins\u4e0ekubernetes\u96c6\u6210\u540e\u7684\u66f4\u65b0\u6d41\u7a0b\uff1a"),(0,s.kt)("p",{parentName:"blockquote"},"1\uff09Jenkins\u4ecegitlab\u4e0a\u62c9\u53d6\u5f00\u53d1\u63d0\u4ea4\u7684\u4ee3\u7801"),(0,s.kt)("p",{parentName:"blockquote"},"2\uff09Jenkins\u8c03\u7528maven\u8fdb\u884c\u7f16\u8bd1\u9879\u76ee"),(0,s.kt)("p",{parentName:"blockquote"},"3\uff09Jenkins\u8c03\u7528docker\u5c06\u5199\u597ddockerfile\u6784\u5efa\u6210\u955c\u50cf"),(0,s.kt)("p",{parentName:"blockquote"},"4\uff09\u5c06\u955c\u50cf\u63a8\u9001\u81f3harbor\u4ed3\u5e93"),(0,s.kt)("p",{parentName:"blockquote"},"5\uff09Jenkins\u8c03\u7528k8s\u5c06\u955c\u50cf\u90e8\u7f72\u5728k8s\u73af\u5883")),(0,s.kt)("p",null,(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/fcebc6a2b3f3211c4481fe783597dce6.png",alt:"img"})),(0,s.kt)("h2",{id:"2\u5c06jenkins\u90e8\u7f72\u5728k8s\u96c6\u7fa4"},"2.\u5c06Jenkins\u90e8\u7f72\u5728k8s\u96c6\u7fa4"),(0,s.kt)("blockquote",null,(0,s.kt)("p",{parentName:"blockquote"},(0,s.kt)("strong",{parentName:"p"},"\u90e8\u7f72\u601d\u8def\uff1a")),(0,s.kt)("p",{parentName:"blockquote"},"1.\u7531\u4e8eJenkins\u8981\u66f4\u65b0\u9879\u76ee\u5230\u5404\u4e2anamespace\uff0c\u56e0\u6b64\u9700\u8981\u505aRBAC\u6388\u6743\uff0c\u51c6\u5907\u4e00\u4e2aServiceAccount\uff0c\u76f4\u63a5\u5c06ServiceAccount\u7ed1\u5b9a\u5230cluster-admin\u96c6\u7fa4\u89d2\u8272\u4e0a\uff0c\u4f7fJenkins\u62e5\u6709\u5bf9\u6240\u6709namespace\u4e0b\u7684\u9879\u76ee\u6709\u64cd\u4f5c\u6743\u9650\u3002"),(0,s.kt)("p",{parentName:"blockquote"},"2.Jenkins\u90e8\u7f72\u91c7\u7528statefulset\u63a7\u5236\u5668\uff0c\u5e76\u914d\u5408StorageClass\u52a8\u6001\u5c06Jenkins\u6570\u636e\u8fdb\u884c\u6301\u4e45\u5316\u3002"),(0,s.kt)("p",{parentName:"blockquote"},"3.\u51c6\u5907svc\u8d44\u6e90\uff0c\u5c06Jenkins\u76848080/50000\u7aef\u53e3\u8fdb\u884c\u66b4\u9732\u3002")),(0,s.kt)("h3",{id:"21\u7f16\u5199jenkins-namespace\u6587\u4ef6"},"2.1.\u7f16\u5199Jenkins namespace\u6587\u4ef6"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-yaml"},"[root@k8s-master1 jenkins]\\# cat jenkins-namespace.yaml \napiVersion: v1 \nkind: Namespace \nmetadata: \n    name: jenkins \n")),(0,s.kt)("h3",{id:"22\u7f16\u5199jenkins-rbac\u6388\u6743\u6587\u4ef6"},"2.2.\u7f16\u5199Jenkins rbac\u6388\u6743\u6587\u4ef6"),(0,s.kt)("p",null,"\u521b\u5efa\u4e00\u4e2aserviceaccount\u8d26\u53f7Jenkins\uff0c\u76f4\u63a5\u5c06sa\u8d26\u53f7\u4e0ecluster-admin\u96c6\u7fa4\u89d2\u8272\u8fdb\u884c\u7ed1\u5b9a"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-yaml"},"[root@k8s-master1 jenkins]\\# cat jenkins-rbac.yaml \napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: jenkins\n  namespace: jenkins\n\n---\n\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: ClusterRoleBinding\nmetadata:\n  name: jenkins-crb\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: cluster-admin\nsubjects:\n- kind: ServiceAccount\n  name: jenkins\n  namespace: jenkins\n\n")),(0,s.kt)("h3",{id:"23\u7f16\u5199jenkins-statefulset\u8d44\u6e90\u6587\u4ef6"},"2.3.\u7f16\u5199Jenkins statefulset\u8d44\u6e90\u6587\u4ef6"),(0,s.kt)("p",null,"Jenkins\u4e5f\u4f1a\u4ea7\u751f\u6570\u636e\uff0c\u56e0\u6b64\u91c7\u7528statefulset\u90e8\u7f72\u6709\u72b6\u6001\u7684\u670d\u52a1\uff0c\u5e76\u914d\u5408StorageClass\u52a8\u6001\u521b\u5efa\u5b58\u50a8\u7cfb\u7edf"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-yaml"},'[root@k8s-master1 jenkins]\\# cat jenkins-statefulset.yaml \napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: jenkins-master\n  namespace: jenkins\nspec:\n  replicas: 1\n  serviceName: jenkins\n  selector:\n    matchLabels:\n      app: jenkins-master\n  template:\n    metadata:\n      labels:\n        app: jenkins-master\n    spec:\n      serviceAccount: jenkins\n      initContainers:\n      - name: jenkins-chown\n        image: harbor.jiangxl.com/jenkins/busybox:1.30\n        command: ["sh","-c","chown -R 1000:1000 /var/jenkins_home"]\n        securityContext:\n          privileged: true\n        volumeMounts:\n        - name: jenkins-data\n          mountPath: /var/jenkins_home\n      containers:\n      - name: jenkins-master\n        image: harbor.jiangxl.com/jenkins/jenkinsci-blueocean:1.24.6\n        env:\n        - name: JAVA_OPTS\n          value: "-Xms4096m -Xmx5120m -Duser.timezone=Asia/Shanghai -Dhudson.model.DirectoryBrowserSupport.CSP="\n        ports:\n        - name: http\n          containerPort: 8080\n        - name: slave\n          containerPort: 50000\n        volumeMounts:\n        - name: jenkins-data\n          mountPath: /var/jenkins_home\n  volumeClaimTemplates:\n    - metadata:\n        name: jenkins-data\n      spec:\n        storageClassName: jenkins-storageclass\n        accessModes:\n        - ReadWriteMany\n        resources:\n          requests:\n            storage: 10Gi\n')),(0,s.kt)("h3",{id:"24\u7f16\u5199jenkins-storageclass\u8d44\u6e90\u6587\u4ef6"},"2.4.\u7f16\u5199Jenkins StorageClass\u8d44\u6e90\u6587\u4ef6"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-yaml"},"[root@k8s-master1 jenkins]\\# cat jenkins-storageclass.yaml \napiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\n  name: jenkins-storageclass\nprovisioner: nfs-storage-01\nreclaimPolicy: Retain\n")),(0,s.kt)("h3",{id:"25\u7f16\u5199jenkins-svc\u8d44\u6e90\u6587\u4ef6"},"2.5.\u7f16\u5199Jenkins svc\u8d44\u6e90\u6587\u4ef6"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-yaml"},"[root@k8s-master1 jenkins]\\# cat jenkins-svc.yaml \napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    app: jenkins-master\n  name: jenkins-svc\n  namespace: jenkins\nspec:\n  ports:\n  - name: http\n    port: 8080\n    targetPort: 8080\n    nodePort: 38080\n  - name: slave\n    port: 50000\n    targetPort: 50000\n    nodePort: 50000\n  selector: \n    app: jenkins-master\n  type: NodePort\n")),(0,s.kt)("h3",{id:"26\u51c6\u5907jenkins\u955c\u50cf\u5e76\u63a8\u9001\u81f3harbor"},"2.6.\u51c6\u5907Jenkins\u955c\u50cf\u5e76\u63a8\u9001\u81f3harbor"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-sh"},"[root@k8s-master1 jenkins]\\# docker pull jenkinsci/blueocean:1.24.6\n[root@k8s-master1 jenkins]\\# docker tag jenkinsci/blueocean:1.24.6 harbor.jiangxl.com/jenkins/jenkinsci-blueocean:1.24.6\n[root@k8s-master1 jenkins]\\# docker push harbor.jiangxl.com/jenkins/jenkinsci-blueocean:1.24.6\n")),(0,s.kt)("h3",{id:"27\u521b\u5efa\u6240\u6709\u8d44\u6e90\u5e76\u67e5\u770b\u8d44\u6e90\u7684\u72b6\u6001"},"2.7.\u521b\u5efa\u6240\u6709\u8d44\u6e90\u5e76\u67e5\u770b\u8d44\u6e90\u7684\u72b6\u6001"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-sh"},"1.\u521b\u5efa\u6240\u6709\u8d44\u6e90\n[root@k8s-master1 jenkins]\\# kubectl apply -f ./\nnamespace/jenkins created\nserviceaccount/jenkins created\nclusterrolebinding.rbac.authorization.k8s.io/jenkins-crb created\nstatefulset.apps/jenkins-master created\nstorageclass.storage.k8s.io/jenkins-storageclass created\nservice/jenkins-svc created\n\n2.\u67e5\u770b\u8d44\u6e90\u72b6\u6001\n[root@k8s-master1 jenkins]\\# kubectl get pod,statefulset,svc,storageclass,sa -n jenkins\nNAME                   READY   STATUS    RESTARTS   AGE\npod/jenkins-master-0   1/1     Running   0          31m\n\nNAME                              READY   AGE\nstatefulset.apps/jenkins-master   1/1     31m\n\nNAME                  TYPE       CLUSTER-IP   EXTERNAL-IP   PORT(S)                         AGE\nservice/jenkins-svc   NodePort   10.101.2.5   <none>        8080:38080/TCP,50000:50000/TCP   31m\n\nNAME                                               PROVISIONER      RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE\nstorageclass.storage.k8s.io/jenkins-storageclass   nfs-storage-01   Retain          Immediate           false                  31m\n\nNAME                     SECRETS   AGE\nserviceaccount/jenkins   1         31m\n\n3.\u67e5\u770bpvc\uff0c\u5df2\u7ecf\u52a8\u6001\u521b\u5efa\n[root@k8s-master1 jenkins]\\# kubectl get pvc -n jenkins\nNAME                            STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS           AGE\njenkins-data-jenkins-master-0   Bound    pvc-3f49831b-7faa-456e-9a2f-65b6085933de   10Gi       RWX            jenkins-storageclass   32m\n")),(0,s.kt)("h3",{id:"28\u9875\u9762\u5b89\u88c5jenkins"},"2.8.\u9875\u9762\u5b89\u88c5Jenkins"),(0,s.kt)("blockquote",null,(0,s.kt)("p",{parentName:"blockquote"},"\u8bbf\u95ee\u96c6\u7fa4\u8282\u70b9\u4efb\u610fip+38080\u7aef\u53e3"),(0,s.kt)("p",{parentName:"blockquote"},"\u8bbf\u95ee\u770b\u5230\u5982\u4e0b\u9875\u9762\u8bf4\u660eJenkins\u8fd8\u5728\u542f\u52a8\u4e2d\uff0c\u5f53\u65e5\u5fd7\u8f93\u51fa\u5230\u4e0b\u56fe\u6837\u5b50\u65f6\uff0c\u5237\u65b0Jenkins\u5373\u53ef\u8fdb\u5165\u7cfb\u7edf\uff0c\u590d\u5236\u65e5\u5fd7\u4e2dpassword\u89e3\u9501Jenkins"),(0,s.kt)("p",{parentName:"blockquote"},(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/5072a83139484c61860f966035834408.png",alt:"\u8bf7\u6dfb\u52a0\u56fe\u7247\u63cf\u8ff0"}))),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"1\uff09\u89e3\u9501Jenkins")),(0,s.kt)("p",null,"\u53ef\u4ee5\u5728\u65e5\u5fd7\u4e2d\u590d\u5236password\uff0c\u4e5f\u53ef\u4ee5\u67e5\u770b/var/jenkins_home/secrets/initialAdminPassword\u8fd9\u4e2a\u6587\u4ef6"),(0,s.kt)("p",null,(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/fd63e40a9e9f4cc8b62736a8f95e13fd.png",alt:"\u8bf7\u6dfb\u52a0\u56fe\u7247\u63cf\u8ff0"})),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"2\uff09\u9009\u62e9\u63d2\u4ef6\u6765\u5b89\u88c5")),(0,s.kt)("p",null,"\u628a\u6240\u6709\u7684\u63d2\u4ef6\u90fd\u52fe\u9009\u4e0a\uff0c\u907f\u514d\u540e\u671f\u51fa\u73b0\u8f6f\u4ef6\u4f9d\u8d56"),(0,s.kt)("p",null,(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/a5dc04c56dc34f3098980e8a45329ad3.png",alt:null})),(0,s.kt)("p",null,"\u70b9\u51fb\u5168\u90e8\u5373\u53ef\u5168\u90e8\u52fe\u9009\n",(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/20a43cdcdaf04446a9e34d3910cf3720.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"3\uff09\u7b49\u5f85\u63d2\u4ef6\u5b89\u88c5\u5b8c")),(0,s.kt)("p",null,(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/a192f76b08cf490d924b8c07e2fca199.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"4\uff09\u521b\u5efaJenkins\u8d26\u53f7"),"\n",(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/6da90fc978394f78a6973653aa2d9b40.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"5\uff09\u8bbe\u7f6e\u5b9e\u4f8b\u5730\u5740"),"\n",(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/b7698c5a282d4fd7805a01ea7e0d7785.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"6\uff09\u91cd\u542fJenkins")),(0,s.kt)("p",null,(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/0147db61d00345bb9bb5c89f20fb3f91.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,s.kt)("h3",{id:"29\u767b\u9646jenkins"},"2.9.\u767b\u9646Jenkins"),(0,s.kt)("p",null,"\u8d26\u53f7admin\u5bc6\u7801admin\n",(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/ad1325a8e3a347d3bc795029cb401a12.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,s.kt)("h2",{id:"3\u4f7f\u7528docker\u90e8\u7f72gitlab"},"3.\u4f7f\u7528docker\u90e8\u7f72gitlab"),(0,s.kt)("blockquote",null,(0,s.kt)("p",{parentName:"blockquote"},"\u8fd9\u91cc\u53ea\u662f\u6269\u5c55\u4e00\u4e0b\u5982\u4f55\u7528docker\u90e8\u7f72gitlab\uff0c\u5efa\u8bae\u91c7\u75284\u4e2d\u7684k8s\u90e8\u7f72gitlab")),(0,s.kt)("h3",{id:"31\u90e8\u7f72gitlab"},"3.1.\u90e8\u7f72gitlab"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-sh"},'[root@k8s-master2 ~]\\# docker run -d --hostname 192.168.16.105 -p 8443:443 -p 8080:80 -p 8022:22 --name gitlab --restart always -v /data2/k8s/gitlab-data/config/:/etc/gitlab -v /data2/k8s/gitlab-data/logs/:/var/log/gitlab -v /data2/k8s/gitlab-data/data/:/var/opt/gitlab gitlab/gitlab-ce:13.11.4-ce.0\n\n[root@k8s-master2 ~]\\# docker ps\nCONTAINER ID        IMAGE                           COMMAND                  CREATED             STATUS                   PORTS                                                               NAMES\n33d868fe0369        gitlab/gitlab-ce:13.11.4-ce.0   "/assets/wrapper"        14 minutes ago      Up 4 minutes (healthy)   0.0.0.0:8022->22/tcp, 0.0.0.0:8080->80/tcp, 0.0.0.0:8443->443/tcp   gitlab\n')),(0,s.kt)("p",null,"\u5f53\u51fa\u73b0\u4ee5\u4e0b\u9875\u9762\u8868\u793agitlab\u542f\u52a8\u5b8c\u6210\n",(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/8aecebfb08ed4dce8db08a824c33bdb1.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,s.kt)("h3",{id:"32\u8bbf\u95eegitlab"},"3.2.\u8bbf\u95eegitlab"),(0,s.kt)("p",null,"\u8bbf\u95ee",(0,s.kt)("a",{parentName:"p",href:"http://192.168.16.105:8080/"},"http://192.168.16.105:8080/")),(0,s.kt)("p",null,"\u7b2c\u4e00\u6b21\u767b\u9646\u9700\u8981\u8bbe\u7f6eroot\u5bc6\u7801\n",(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/31be9f25fca64dd699b78ef9bbeaf6c4.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"}),"\n\u8bbe\u7f6e\u5b8c\u5bc6\u7801\u5373\u53ef\u767b\u9646\u7cfb\u7edf\n",(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/cb47d2b998d940dd897ce6c253a29f20.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,s.kt)("h2",{id:"4\u5c06gitlab\u90e8\u7f72\u5728k8s\u96c6\u7fa4"},"4.\u5c06gitlab\u90e8\u7f72\u5728k8s\u96c6\u7fa4"),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"\u90e8\u7f72\u5206\u6790\uff1a")),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"gitlab\u91c7\u7528statefulset\u63a7\u5236\u5668\u90e8\u7f72\uff0c\u901a\u8fc7StorageClass\u5c06gitlab\u7684\u914d\u7f6e\u6587\u4ef6\u3001gitlab\u7684\u6570\u636e\u6587\u4ef6\u8fdb\u884c\u6301\u4e45\u5316\u5b58\u50a8"),(0,s.kt)("li",{parentName:"ul"},"\u7531\u4e8egitlab\u955c\u50cf\u96c6\u6210\u4e86\u5f88\u591a\u7ec4\u4ef6\uff0c\u6bcf\u4e2a\u7ec4\u4ef6\u5728gitlab\u6570\u636e\u76ee\u5f55\u6240\u4f7f\u7528\u7684\u7528\u6237\u5c5e\u7ec4\u4e0d\u540c\uff0c\u56e0\u6b64\u90fd\u9700\u8981\u9488\u5bf9\u6bcf\u4e2a\u7ec4\u4ef6\u53bb\u4fee\u6539\u5bf9\u5e94\u7684\u6240\u5c5e\u7528\u6237\uff0c\u5426\u5219\u65e0\u6743\u9650\u542f\u52a8\u76f8\u5173\u7ec4\u4ef6\uff0c\u9996\u5148\u7528docker\u8fd0\u884cgitlab\u955c\u50cf\uff0c\u67e5\u8be2\u51fagitlab\u6570\u636e\u76ee\u5f55\u4e2d\u4e0d\u540c\u7ec4\u4ef6\u5bf9\u5e94\u7684\u4e0d\u7528\u6240\u5c5e\u7528\u6237\uff0c\u7136\u540e\u5728\u521d\u59cb\u5316\u5bb9\u5668\u4e2d\u8fdb\u884c\u8d4b\u6743"),(0,s.kt)("li",{parentName:"ul"},"\u4fee\u6539gitlab\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u786e\u5b9a\u5bf9\u5916\u63d0\u4f9b\u8bbf\u95ee\u7684url"),(0,s.kt)("li",{parentName:"ul"},"gitlab\u768480\u7aef\u53e3\u901a\u8fc7svc\u8d44\u6e90\u8fdb\u884c\u66b4\u9732")),(0,s.kt)("h3",{id:"41\u5c06gitlab\u955c\u50cf\u63a8\u9001\u81f3harbor\u4ed3\u5e93"},"4.1.\u5c06gitlab\u955c\u50cf\u63a8\u9001\u81f3harbor\u4ed3\u5e93"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-sh"},"[root@k8s-master1 ~]\\# docker tag gitlab/gitlab-ce:13.11.4-ce.0 harbor.jiangxl.com/jenkins/gitlab-ce:13.11.4-ce.0 \n[root@k8s-master1 ~]\\# docker push  harbor.jiangxl.com/jenkins/gitlab-ce:13.11.4-ce.0 \n")),(0,s.kt)("h3",{id:"42\u4f7f\u7528docker\u8fd0\u884cgitlab\u67e5\u8be2\u7528\u6237\u7684id\u53f7"},"4.2.\u4f7f\u7528docker\u8fd0\u884cgitlab\u67e5\u8be2\u7528\u6237\u7684id\u53f7"),(0,s.kt)("p",null,"gitlab\u6bcf\u4e2a\u7ec4\u4ef6\u90fd\u662f\u4e0d\u540c\u7684\u6240\u5c5e\u7528\u6237\u6765\u7ba1\u7406\uff0c\u6211\u4eec\u4e0d\u660e\u786e\u6bcf\u4e2a\u7528\u6237\u7684uid\u3001gid\u662f\u591a\u5c11\uff0c\u56e0\u6b64\u9700\u8981\u5148\u7528docker\u542f\u52a8\u67e5\u8be2\u4e00\u4e0b"),(0,s.kt)("p",null,"\u9700\u8981\u8bb0\u597d\u8fd9\u4e9b\u7ec4\u4ef6\u7684\u7528\u6237uid\u3001gid\uff0c\u4e00\u4f1a\u5728statfulset\u8d44\u6e90\u4e2d\u5b9a\u4e49\u521d\u59cb\u5316\u5bb9\u5668\u65f6\u4f1a\u7528\u5230"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-sh"},"1.\u4f7f\u7528docker\u8fd0\u884cgitlab\u5bb9\u5668\n[root@k8s-master1 ~]\\# docker run -d harbor.jiangxl.com/jenkins/gitlab-ce:13.11.4-ce.0\n\n2.\u8fdb\u5165\u5bb9\u5668\n[root@k8s-master1 ~]\\# docker exec -it 33d868fe0369 bash\n\n3.\u67e5\u770bgitlab\u6570\u636e\u8def\u5f84\u4e0b\u5404\u7ec4\u4ef6\u4f7f\u7528\u7684\u6240\u5c5e\u7528\u6237\nroot@192:/# ll /var/opt/gitlab/\ntotal 20\ndrwxr-xr-x 20 root              root       4096 May 20 09:12 ./\ndrwxr-xr-x  1 root              root         20 May 14 15:17 ../\ndrwxr-xr-x  2 git               git           6 May 20 09:01 .bundle/\n-rw-r--r--  1 git               git         363 May 20 09:01 .gitconfig\ndrwx---\x3e---\x3e  2 git               git          29 May 20 09:01 .ssh/\ndrwxr-x---\x3e  3 gitlab-prometheus root         42 May 20 09:11 alertmanager/\ndrwx---\x3e---\x3e  2 git               root          6 May 20 09:01 backups/\n-rw---\x3e---\x3e-  1 root              root         38 May 20 09:06 bootstrapped\ndrwx---\x3e---\x3e  3 git               git          26 May 20 09:01 git-data/\ndrwx---\x3e---\x3e  3 git               root        123 May 20 09:11 gitaly/\ndrwxr-xr-x  3 git               root         20 May 20 09:01 gitlab-ci/\ndrwxr-xr-x  2 git               root         53 May 20 09:11 gitlab-exporter/\ndrwxr-xr-x  9 git               root        160 May 20 09:11 gitlab-rails/\ndrwx---\x3e---\x3e  2 git               root         24 May 20 09:10 gitlab-shell/\ndrwxr-x---\x3e  3 git               gitlab-www   55 May 20 09:11 gitlab-workhorse/\ndrwx---\x3e---\x3e  4 gitlab-prometheus root         83 May 20 09:12 grafana/\ndrwx---\x3e---\x3e  3 root              root         71 May 21 02:21 logrotate/\ndrwxr-x---\x3e  9 root              gitlab-www  163 May 20 09:05 nginx/\ndrwx---\x3e---\x3e  2 gitlab-psql       root         26 May 20 09:11 postgres-exporter/\ndrwxr-xr-x  3 gitlab-psql       root         81 May 20 09:11 postgresql/\ndrwxr-x---\x3e  4 gitlab-prometheus root         53 May 20 09:11 prometheus/\n-rw-r--r--  1 root              root        226 May 20 09:12 public_attributes.json\ndrwxr-x---\x3e  2 gitlab-redis      git          60 May 21 02:29 redis/\n-rw-r--r--  1 root              root         40 May 20 09:01 trusted-certs-directory-hash\n\n4.\u53ea\u9700\u8981\u770bpostgresql\u3001reids\u3001gitlab-data\u3001prometheus\u76ee\u5f55\u7684\u7528\u6237\u5373\u53ef\uff0c\u4e3b\u8981\u8fd9\u56db\u4e2a\n#\u53ef\u4ee5\u770b\u5230gitlab-data\u7684\u7528\u6237\u662fgit\u3001postgresql\u7684\u7528\u6237\u662fgitlab-psql\u3001redis\u7684\u662fgitlab-redis\nroot@192:/# id git\nuid=998(git) gid=998(git) groups=998(git)\nroot@192:/# \nroot@192:/# id gitlab-psql\nuid=996(gitlab-psql) gid=996(gitlab-psql) groups=996(gitlab-psql)\nroot@192:/# \nroot@192:/# id gitlab-redis\nuid=997(gitlab-redis) gid=997(gitlab-redis) groups=997(gitlab-redis)\nroot@192:/# \nroot@192:/# id gitlab-prometheus\nuid=992(gitlab-prometheus) gid=992(gitlab-prometheus) groups=992(gitlab-prometheus)\n")),(0,s.kt)("h3",{id:"43\u7f16\u5199gitlab-storageclass-\u8d44\u6e90\u6587\u4ef6"},"4.3.\u7f16\u5199gitlab StorageClass \u8d44\u6e90\u6587\u4ef6"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-yaml"},"[root@k8s-master1 gitlab]\\# vim gitlab-storageclass.yaml \napiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\n  name: gitlab-storageclass\nprovisioner: nfs-storage-01\nreclaimPolicy: Retain\n")),(0,s.kt)("h3",{id:"44\u7f16\u5199gitlab-statefulset-\u8d44\u6e90\u6587\u4ef6"},"4.4.\u7f16\u5199gitlab statefulset \u8d44\u6e90\u6587\u4ef6"),(0,s.kt)("p",null,"StorageClass pvc\u6a21\u677f\u5b9a\u4e49\u4e24\u4e2a\uff0c\u4e00\u4e2a\u5b58\u50a8gitlab\u6570\u636e\uff0c\u4e00\u4e2a\u5b58\u50a8gitlab\u914d\u7f6e\u6587\u4ef6"),(0,s.kt)("p",null,"\u5c06\u521a\u521a\u67e5\u5230\u7684\u7528\u6237uid\u3001gid\uff0c\u901a\u8fc7\u521d\u59cb\u5316\u5bb9\u5668\u5206\u522b\u8d4b\u6743\u9650\u7ed9\u6bcf\u4e2a\u7ec4\u4ef6\u76ee\u5f55"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-yaml"},'[root@k8s-master1 gitlab]\\# vim gitlab-statefulset.yaml \napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: gitlab\n  namespace: jenkins\nspec:\n  replicas: 1\n  serviceName: gitlab\n  selector:\n    matchLabels:\n      app: gitlab\n  template:\n    metadata:\n      labels:\n        app: gitlab\n    spec:\n      initContainers:             #\u5b9a\u4e49\u521d\u59cb\u5316\u5bb9\u5668\uff0c\u5c06\u6bcf\u4e2a\u7ec4\u4ef6\u8def\u5f84\u8d4b\u4e88\u5bf9\u5e94\u7684\u7528\u6237\u6743\u9650\n      - name: gitlab-data-git\n        image: harbor.jiangxl.com/jenkins/busybox:1.30\n        command: ["sh","-c","chown -R 998:998 /var/opt/gitlab"]     #git\u7528\u6237\u6388\u6743\u6574\u4e2agitlab\u6570\u636e\u76ee\u5f55\n        securityContext:      #\u5f00\u542f\u7279\u6743\u6a21\u5f0f\n          privileged: true  \n        volumeMounts:       #\u5c06\u6570\u636e\u6301\u4e45\u5316\u7684pvc\u8fdb\u884c\u6302\u8f7d\n        - name: gitlab-data\n          mountPath: /var/opt/gitlab\n      - name: gitlab-data-psql\n        image: harbor.jiangxl.com/jenkins/busybox:1.30\n        command: ["sh","-c","chown -R 996:996 /var/opt/gitlab/postgresql*"]     #gitlab-psql\u6388\u6743postgresql\u76ee\u5f55\n        securityContext:\n          privileged: true\n        volumeMounts:\n        - name: gitlab-data\n          mountPath: /var/opt/gitlab\n      - name: gitlab-data-redis\n        image: harbor.jiangxl.com/jenkins/busybox:1.30\n        command: ["sh","-c","chown -R 997:997 /var/opt/gitlab/redis"]   #gitlab-redis\u6388\u6743redis\u76ee\u5f55\n        securityContext:\n          privileged: true\n        volumeMounts:\n        - name: gitlab-data\n          mountPath: /var/opt/gitlab\n      - name: gitlab-data-prome                 #gitlab-prometheus\u7528\u6237\u6388\u6743prometheus\u76ee\u5f55\n        image: harbor.jiangxl.com/jenkins/busybox:1.30\n        command: ["sh","-c","chown -R 992:992 /var/opt/gitlab/alertmanager /var/opt/gitlab/grafana /var/opt/gitlab/prometheus"]\n        securityContext:\n          privileged: true\n        volumeMounts:\n        - name: gitlab-data\n          mountPath: /var/opt/gitlab\n\n      - name: gitlab-config-chown         #\u8fd9\u4e2a\u521d\u59cb\u5316\u5bb9\u5668\u4e3b\u8981\u5c31\u662f\u628a\u914d\u7f6e\u76ee\u5f55\u8fdb\u884c\u6388\u6743\uff0c\u53ef\u505a\u53ef\u4e0d\u505a\uff0c\u56e0\u4e3a\u8fd9\u4e2a\u76ee\u5f55\u7684\u6240\u5c5e\u7528\u6237\u5c31\u662froot\uff0c\u800cnfs\u521b\u5efa\u7684\u5b58\u50a8\u8def\u5f84\u9ed8\u8ba4\u4e5f\u662froot\u7684\u6240\u5c5e\n        image: harbor.jiangxl.com/jenkins/busybox:1.30\n        command: ["sh","-c","chown -R 998:998 /etc/gitlab"]     #\u6388\u6743\u7ed9gitlab\u7528\u6237\n        securityContext:  \n          privileged: true\n        volumeMounts:\n        - name: gitlab-config\n          mountPath: /etc/gitlab\n      containers:                   #\u5b9a\u4e49\u4e3b\u5bb9\u5668\n      - name: gitlab\n        image: harbor.jiangxl.com/jenkins/gitlab-ce:13.11.4-ce.0\n        ports:\n        - name: http\n          containerPort: 80\n        volumeMounts:             #\u6302\u8f7d\u6301\u4e45\u5316\u6570\u636e\u5377\u5230\u5bb9\u5668\u7684\u8def\u5f84\n        - name: gitlab-data\n          mountPath: /var/opt/gitlab\n        - name: gitlab-config\n          mountPath: /etc/gitlab\n  volumeClaimTemplates:           #\u5b9a\u4e49pvc\u6a21\u677f\n    - metadata:               #metadata\u662f\u6570\u7ec4\u5f62\u5f0f\uff0c\u56e0\u6b64\u53ef\u4ee5\u5b9a\u4e49\u591a\u4e2a\uff0c\u4e00\u4e2ametadata\u5c31\u662f\u4e00\u4e2apvc\u6a21\u677f\n        name: gitlab-data         #pvc\u540d\u79f0\n      spec:\n        storageClassName: gitlab-storageclass     #\u4f7f\u7528\u7684StorageClass\u540d\u79f0\n        accessModes:\n        - ReadWriteMany           #\u8bbf\u95ee\u6a21\u5f0f\u4e3a\u591a\u4e3b\u673a\u53ef\u8bfb\u5199\n        resources:\n          requests:\n            storage: 10Gi\n    - metadata:\n        name: gitlab-config\n      spec:\n        storageClassName: gitlab-storageclass\n        accessModes:\n        - ReadWriteMany\n        resources:\n          requests:\n            storage: 1Gi\n')),(0,s.kt)("h3",{id:"45\u7f16\u5199gitlab-service-\u8d44\u6e90\u6587\u4ef6"},"4.5.\u7f16\u5199gitlab service \u8d44\u6e90\u6587\u4ef6"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-yaml"},"[root@k8s-master1 gitlab]\\# vim gitlab-svc.yaml \napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    app: gitlab\n  name: gitlab-svc\n  namespace: jenkins\nspec:\n  ports:\n  - name: http\n    port: 80 \n    targetPort: 80\n    nodePort: 30080\n  selector: \n    app: gitlab\n  type: NodePort\n")),(0,s.kt)("h3",{id:"46\u521b\u5efa\u6240\u6709\u8d44\u6e90\u5e76\u67e5\u770b\u72b6\u6001"},"4.6.\u521b\u5efa\u6240\u6709\u8d44\u6e90\u5e76\u67e5\u770b\u72b6\u6001"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-sh"},"1.\u521b\u5efa\u6240\u6709\u8d44\u6e90\n[root@k8s-master1 gitlab]\\# kubectl apply -f ./\nstatefulset.apps/gitlab created\nstorageclass.storage.k8s.io/gitlab-storageclass created\nservice/gitlab-svc created\n\n2.\u67e5\u770b\u8d44\u6e90\u7684\u72b6\u6001\n[root@k8s-master1 gitlab]\\# kubectl get all -n jenkins\nNAME                   READY   STATUS    RESTARTS   AGE\npod/gitlab-0           1/1     Running   0          4m21s\npod/jenkins-master-0   1/1     Running   0          18h\n\nNAME                  TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)                          AGE\nservice/gitlab-svc    NodePort   10.101.97.95    <none>        80:30080/TCP                     57m\nservice/jenkins-svc   NodePort   10.99.113.179   <none>        8080:38080/TCP,50000:50000/TCP   23h\n\nNAME                              READY   AGE\nstatefulset.apps/gitlab           1/1     57m\nstatefulset.apps/jenkins-master   1/1     23h\n\n3.\u67e5\u770bpvc\u8d44\u6e90\u7684\u72b6\u6001\n[root@k8s-master1 gitlab]\\# kubectl get pvc -n jenkins\nNAME                            STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS           AGE\ngitlab-config-gitlab-0          Bound    pvc-91e63538-e07d-4196-82e8-4195b29d9352   1Gi        RWX            gitlab-storageclass    64m\ngitlab-data-gitlab-0            Bound    pvc-2a300c8d-49e6-4035-99f1-81c3e190fe3e   10Gi       RWX            gitlab-storageclass    57m\njenkins-data-jenkins-master-0   Bound    pvc-9efb572b-d566-418d-bb6e-b225b43de4a5   10Gi       RWX            jenkins-storageclass   23h\n")),(0,s.kt)("h3",{id:"47\u4fee\u6539gitlab\u914d\u7f6e"},"4.7.\u4fee\u6539gitlab\u914d\u7f6e"),(0,s.kt)("p",null,"\u5f53gitlab\u670d\u52a1\u542f\u52a8\u4e4b\u540e\uff0c\u914d\u7f6e\u6587\u4ef6\u548c\u6570\u636e\u76ee\u5f55\u5c31\u4f1a\u5b58\u50a8\u5728pvc\u4e0a\uff0c\u6211\u4eec\u9700\u8981\u4fee\u6539gitlab\u7684\u914d\u7f6e\u6587\u4ef6\u660e\u786e\u8bbf\u95ee\u5730\u5740"),(0,s.kt)("p",null,"\u4e3b\u8981\uff1a\u8fd9\u91cc\u53ea\u5199\u5730\u5740\uff0c\u4e0d\u8981\u52a0\u7aef\u53e3\uff0c\u5982\u679c\u52a0\u4e86\u966480\u4ee5\u5916\u7684\u7aef\u53e3\uff0c\u90a3\u4e48\u5bb9\u5668\u91ccgitlab\u768480\u5c31\u4f1a\u6539\u6210\u4f60\u6307\u5b9a\u7684\u7aef\u53e3\uff0c\u90a3\u4e48\u505a\u5f97svc\u5c06\u4f1a\u5931\u6548\uff0c\u65e0\u6cd5\u66b4\u9732gitlab"),(0,s.kt)("p",null,"\u8fd9\u4e00\u6b65\u4e5f\u53ef\u4ee5\u4e0d\u505a\uff0c\u56e0\u4e3a\u5bf9\u4e8ek8s\u800c\u8a00\u90fd\u662f\u901a\u8fc7\u96c6\u7fa4\u4efb\u610f\u8282\u70b9ip\u53bb\u6620\u5c04\u7684"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-sh"},"[root@k8s-master2 ~]\\# vim /data2/k8s/storageclass/jenkins-gitlab-config-gitlab-0-pvc-91e63538-e07d-4196-82e8-4195b29d9352/gitlab.rb \nexternal_url 'http://192.168.16.106'\n")),(0,s.kt)("p",null,"\u4fee\u6539\u5b8c\u91cd\u65b0\u90e8\u7f72\u4e00\u4e0bgitlab\u5373\u53ef"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-sh"},"[root@k8s-master1 gitlab]\\# kubectl replace -f gitlab-statefulset.yaml \nstatefulset.apps/gitlab replaced\n\n")),(0,s.kt)("h3",{id:"48\u8bbf\u95eegitlab"},"4.8.\u8bbf\u95eegitlab"),(0,s.kt)("p",null,"\u8bbf\u95eehttp://\u96c6\u7fa4\u4efb\u610f\u8282\u70b9ip:30080\u7aef\u53e3"),(0,s.kt)("blockquote",null,(0,s.kt)("p",{parentName:"blockquote"},"gitlab\u542f\u52a8\u7f13\u6162\uff0c\u8fdb\u5165\u5bb9\u5668\u67e5\u770bgitlab\u72b6\u6001\uff0c\u90fd\u662frun\u540e\u5373\u53ef\u8bbf\u95ee"),(0,s.kt)("p",{parentName:"blockquote"},(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/3cb3db85c0a44853bb427cc3f739f8ef.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"}))),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"1\uff09\u8bbe\u7f6e\u7528\u6237\u5bc6\u7801")),(0,s.kt)("p",null,"\u6700\u5c118\u4f4d\uff0c\u8fd9\u91cc\u8bbe\u7f6eadmin123\n",(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/f272c0ffc079443199a81e55f95fba69.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"2\uff09\u8fdb\u5165gitlab")),(0,s.kt)("p",null,(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/207da6d0e57b43008394ab964311a6f2.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"3\uff09\u8bbe\u7f6e\u8bed\u8a00\u4e3a\u4e2d\u6587")),(0,s.kt)("p",null,(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/b1c0dfdc00c24d8588f29c1ef4664fae.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,s.kt)("h2",{id:"5\u63d0\u4ea4\u7a0b\u5e8f\u4ee3\u7801\u5230gitlab\u4e0a"},"5.\u63d0\u4ea4\u7a0b\u5e8f\u4ee3\u7801\u5230gitlab\u4e0a"),(0,s.kt)("h3",{id:"51\u65b0\u5efa\u4e00\u4e2a\u9879\u76ee"},"5.1.\u65b0\u5efa\u4e00\u4e2a\u9879\u76ee"),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"1\uff09\u70b9\u51fb\u65b0\u5efa\u9879\u76ee"),"\n",(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/77ce6e59d41d4ec1b016f50bd766ef68.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"2\uff09\u521b\u5efa\u7a7a\u767d\u9879\u76ee")),(0,s.kt)("p",null,(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/bf036a4f46f84a9e94d1d137ee7d310f.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"3\uff09\u586b\u5199\u9879\u76ee\u4fe1\u606f")),(0,s.kt)("p",null,"\u53ef\u89c1\u7ea7\u522b\u8bbe\u7f6e\u4e3a\u516c\u5f00\n",(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/101cb12d291e489abf69647313fecc9d.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"4\uff09\u521b\u5efa\u5b8c\u6210")),(0,s.kt)("p",null,(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/c1de124f7b624b2b95efcf335767eecb.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,s.kt)("h3",{id:"52\u5c06\u7a0b\u5e8f\u4ee3\u7801\u63d0\u4ea4\u5230gitlab"},"5.2.\u5c06\u7a0b\u5e8f\u4ee3\u7801\u63d0\u4ea4\u5230gitlab"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-sh"},"[root@k8s-master1 python-demo]\\# git init\n\u521d\u59cb\u5316\u7a7a\u7684 Git \u7248\u672c\u5e93\u4e8e /root/gitlab_project/python-demo/.git/\n[root@k8s-master1 python-demo]\\# git remote add origin http://192.168.16.106:30080/root/blog_project.git\n[root@k8s-master1 python-demo]\\# git add .\n[root@k8s-master1 python-demo]\\# git commit -m \"Initial commit\"\n[root@k8s-master1 python-demo]\\# git push -u origin master\nUsername for 'http://192.168.16.106:30080': root        #\u8f93\u5165\u7528\u6237\u540d\nPassword for 'http://root@192.168.16.106:30080':        #\u8f93\u5165\u5bc6\u7801\nCounting objects: 48, done.\nDelta compression using up to 4 threads.\nCompressing objects: 100% (44/44), done.\nWriting objects: 100% (48/48), 978.49 KiB | 0 bytes/s, done.\nTotal 48 (delta 4), reused 0 (delta 0)\nTo http://192.168.16.106:30080/root/blog_project.git\n * [new branch]      master -> master\n\u5206\u652f master \u8bbe\u7f6e\u4e3a\u8ddf\u8e2a\u6765\u81ea origin \u7684\u8fdc\u7a0b\u5206\u652f master\u3002\n")),(0,s.kt)("p",null,(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/d4306e08735645e5ae24a93123b7a064.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,s.kt)("h2",{id:"6jenkins\u96c6\u6210gitlab"},"6.Jenkins\u96c6\u6210gitlab"),(0,s.kt)("p",null,"\u5fc5\u987b\u5728jenkins\u914d\u7f6egitlab\u5730\u5740\uff0c\u5426\u5219pipeline\u627e\u4e0d\u5230git\u5730\u5740"),(0,s.kt)("h3",{id:"61\u5728jenkins\u4e0a\u5b89\u88c5gitlab\u63d2\u4ef6"},"6.1.\u5728Jenkins\u4e0a\u5b89\u88c5gitlab\u63d2\u4ef6"),(0,s.kt)("p",null,"\u4fee\u6539Jenkins\u9ed8\u8ba4\u6e90\u4e3a\u6e05\u534e\u6e90"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-sh"},"1.\u4fee\u6539\u6e90\ncd /data2/k8s/storageclassjenkins-jenkins-data-jenkins-master-0-pvc-9efb572b-d566-418d-bb6e-b225b43de4a5/updates\nsed -i 's/http:\\/\\/updates.jenkins- ci.org\\/download/https:\\/\\/mirrors.tuna.tsinghua.edu.cn\\/jenkins/g' default.json\nsed -i 's/http:\\/\\/www.google.com/https:\\/\\/www.baidu.com/g' default.json\n\n2.\u91cd\u542fJenkins\n[root@k8s-master1 ~]\\# kubectl replace -f /root/k8s1.19/jenkins/jenkins-statefulset.yaml \nstatefulset.apps/jenkins-master replaced\n")),(0,s.kt)("p",null,"\u7cfb\u7edf\u7ba1\u7406\u2014>\u63d2\u4ef6\u7ba1\u7406\u2014>\u53ef\u9009\u63d2\u4ef6\u2014>\u641c\u7d22gitlab\u2014>\u5b89\u88c5\n",(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/07defd42b2a5485ba30659d6d4d775af.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,s.kt)("h3",{id:"62\u5728gitlab\u4e0a\u751f\u6210token"},"6.2.\u5728gitlab\u4e0a\u751f\u6210token"),(0,s.kt)("p",null,"edit profile\u2014>>\u8bbf\u95ee\u4ee4\u724c\u2014>>\u586b\u5199token\u540d\u79f0\u2014>>\u52fe\u9009\u6743\u9650\u8303\u56f4\n",(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/63547133425548b5a3e5e3a902cf90b3.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,s.kt)("p",null,"token\u53ea\u663e\u793a\u4e00\u6b21\uff0c\u59a5\u5584\u4fdd\u7ba1\uff1aF4N8_LrfC7BdNWXXyJA2"),(0,s.kt)("p",null,(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/41554f761e5742c9af47c519ceedaf51.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,s.kt)("h3",{id:"63\u5728jenkins\u6dfb\u52a0gitlab-api-token"},"6.3.\u5728Jenkins\u6dfb\u52a0gitlab api token"),(0,s.kt)("p",null,"\u7cfb\u7edf\u7ba1\u7406\u2014>\u627e\u5230gitlab\u2014>\u8fdb\u884c\u914d\u7f6e\u5373\u53ef"),(0,s.kt)("p",null,"Connection name\uff1agitlab-token"),(0,s.kt)("p",null,"Gitlab host URL\uff1a",(0,s.kt)("a",{parentName:"p",href:"http://192.168.16.104:30080/"},"http://192.168.16.104:30080/")),(0,s.kt)("p",null,(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/04b27f6631e648c0a81627335fdab789.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,s.kt)("p",null,"\u586b\u5199\u5b8c\u57fa\u672c\u4fe1\u606f\u540e\u70b9\u51fb\u6dfb\u52a0gitlab token\uff0c\u7c7b\u578b\u53ea\u80fd\u9009\u62e9gitlab api token\uff0c\u5c06token\u7c98\u8fdb\u53bb\u5373\u53ef"),(0,s.kt)("p",null,(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/3a3cf1606a7b45c6b02a3132aab80ac0.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,s.kt)("p",null,"\u6dfb\u52a0\u5b8ctoken\u4e4b\u540e\uff0c\u4e0b\u62c9\u9009\u62e9\u521a\u521a\u6dfb\u52a0\u7684token\uff0c\u4e0d\u518d\u53d8\u7ea2\u8bf4\u660e\u8fde\u63a5gitlab\u6210\u529f"),(0,s.kt)("p",null,(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/6af8522a35b843e7a3da53e2a3179bd4.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,s.kt)("h2",{id:"7jenkins\u5206\u5e03\u5f0fmaster-slave\u6a21\u5f0f"},"7.Jenkins\u5206\u5e03\u5f0fmaster-slave\u6a21\u5f0f"),(0,s.kt)("p",null,"jenkins\u5206\u5e03\u5f0f\u5c31\u662f\u6709\u591a\u4e2aslave\u8282\u70b9\uff0c\u5f53\u9700\u8981\u6784\u5efa\u7684\u9879\u76ee\u975e\u5e38\u591a\u65f6\uff0cmaster\u7684\u6027\u80fd\u4f1a\u6709\u5f71\u54cd\uff0cslave\u4f1a\u627f\u62c5master\u7684\u5de5\u4f5c\u91cf\uff0c\u5728slave\u5728\u4e0a\u521b\u5efa\u9879\u76ee\u3002slave\u8282\u70b9\u4e0emaster\u7684\u533a\u522b\u5c31\u5728\u4e8eslave\u4e0d\u9700\u8981\u5b89\u88c5Jenkins"),(0,s.kt)("p",null,"slave\u8282\u70b9\u6709\u5f88\u591a\u65b9\u5f0f\u90e8\u7f72\uff0c\u6211\u4eec\u91c7\u7528"),(0,s.kt)("h3",{id:"71\u65b0\u589ejenkins\u8282\u70b9"},"7.1.\u65b0\u589eJenkins\u8282\u70b9"),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"1\uff09\u7cfb\u7edf\u7ba1\u7406\u2014>\u8282\u70b9\u7ba1\u7406\u2014>\u65b0\u5efa\u8282\u70b9\u2014>\u586b\u5199\u8282\u70b9\u540d\u79f0\u2014>\u56fa\u5b9a\u8282\u70b9\u2014>\u786e\u5b9a"),"\n",(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/95f634c391aa41359aba7c928eb3e693.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"2\uff09\u6dfb\u52a0\u8282\u70b9\u8be6\u7ec6\u4fe1\u606f")),(0,s.kt)("p",null,"\u540d\u5b57\uff1aJenkins-slave1-107"),(0,s.kt)("p",null,"\u6267\u884c\u5668\u6570\u91cf\uff1a3"),(0,s.kt)("p",null,"\u8fdc\u7a0b\u5de5\u4f5c\u76ee\u5f55\uff1a/data/jenkins_jobs"),(0,s.kt)("p",null,"\u6807\u7b7e\uff1aJenkins-slave1-107 #\u7528\u4e8e\u8ba9Jenkins\u67d0\u4e2a\u4efb\u52a1\u8fd0\u884c\u5728\u67d0\u4e2a\u8282\u70b9\u4e0a"),(0,s.kt)("p",null,"\u7528\u6cd5\uff1a\u5c3d\u53ef\u80fd\u7684\u4f7f\u7528\u8fd9\u4e2a\u8282\u70b9"),(0,s.kt)("p",null,"\u542f\u52a8\u65b9\u5f0f\uff1a\u901a\u8fc7java web\u542f\u52a8\u4ee3\u7406"),(0,s.kt)("p",null,"\u81ea\u5b9a\u4e49\u5de5\u4f5c\u76ee\u5f55\uff1a/data/jenkins_jobs\n",(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/24e8095eed63443f90c3b86db984ec93.jpg",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"3\uff09\u6dfb\u52a0\u5b8c\u8282\u70b9\u53d1\u73b0\u8282\u70b9\u662f\u7ea2\u7684\uff0c\u8fd9\u8bf4\u660e\u4ee3\u7406\u7a0b\u5e8f\u8fd8\u6ca1\u6709\u542f\u52a8\uff0cJenkins\u4e0d\u77e5\u9053\u8282\u70b9\u662f\u8c01")),(0,s.kt)("p",null,(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/3dccdb73b2834db791fb00270d95d0e5.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,s.kt)("p",null,"\u70b9\u51fb\u8282\u70b9\uff0c\u8fdb\u53bb\u540e\u4f1a\u770b\u5230\u5982\u4f55\u542f\u52a8agent\uff0c\u53f3\u952e\u590d\u5236agent.jar\u62ff\u5230\u94fe\u63a5\u5730\u5740\uff0c\u53bb\u5bf9\u5e94\u7684\u670d\u52a1\u5668\u4e0a\u4e0b\u8f7djar\u5305\uff0c\u7136\u540e\u542f\u52a8\u5373\u53ef\u6210\u529f\u6dfb\u52a0\u8282\u70b9\n",(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/747440af22584bf5867db7b32b7fa9dc.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-sh"},'1.\u521b\u5efa\u8282\u70b9\u5de5\u4f5c\u76ee\u5f55\n[root@k8s-node2 ~]\\# mkdir /data/jenkins_jobs\n[root@k8s-node2 ~]\\# cd /data/jenkins_jobs\n\n2.\u4e0b\u8f7dagent\u7a0b\u5e8f\n[root@k8s-node2 /data/jenkins_jobs]\\# wget http://192.168.16.104:38080/jnlpJars/agent.jar\n\n3.\u542f\u52a8agent\n[root@k8s-node2 /data/jenkins_jobs]\\# nohup java -jar agent.jar -jnlpUrl http://192.168.16.104:38080/computer/Jenkins-slave1-107/jenkins-agent.jnlp -secret efbde6c51590ca2c9097e6866de9f2d18520bfc05440a1872135e78b47283721 -workDir "/data/jenkins_jobs" &\n\n\n\u547d\u4ee4\u89e3\u91ca\uff1a\n java -jar agent.jar \\      #\u542f\u52a8jar\u5305\n -jnlpUrl http://192.168.16.104:38080/computer/Jenkins-slave1-107/jenkins-agent.jnlp \\  #\u8fd9\u4e2a\u8def\u5f84\u5c31\u662f\u6211\u4eec\u5728Jenkins\u4e0a\u65b0\u5efa\u8282\u70b9\u4e4b\u540e\u7684\u8282\u70b9\u6240\u5728\u8def\u5f84\uff0c\u5982\u679c\u4e0d\u6307\u5b9a\uff0cJenkins\u6839\u672c\u4e0d\u77e5\u9053\u8fd9\u4e2a\u8282\u70b9\u5bf9\u5e94\u54ea\u53f0\u670d\u52a1\u5668\n -secret efbde6c51590ca2c9097e6866de9f2d18520bfc05440a1872135e78b47283721 \\   #\u8ba4\u8bc1\n -workDir "/data/jenkins_obs" &     #\u5de5\u4f5c\u76ee\u5f55\n')),(0,s.kt)("p",null,"agent\u542f\u52a8\u540e\u5728Jenkins\u9875\u9762\u4e0a\u89c2\u5bdf\u8282\u70b9\uff0c\u53d1\u73b0\u5df2\u7ecf\u662f\u53ef\u7528\u72b6\u6001\n",(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/5199668c5f564bb78b30223cc63d465d.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,s.kt)("h3",{id:"72\u65b0\u5efa\u4e00\u4e2a\u4efb\u52a1\u8fd0\u884c\u5728slave1\u8282\u70b9\u4e0a"},"7.2.\u65b0\u5efa\u4e00\u4e2a\u4efb\u52a1\u8fd0\u884c\u5728slave1\u8282\u70b9\u4e0a"),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"1\uff09\u914d\u7f6e\u4efb\u52a1\u2014>general\u2014>\u9650\u5236\u9879\u76ee\u7684\u8fd0\u884c\u8282\u70b9\u2014>\u586b\u5199\u8282\u70b9\u8bbe\u7f6e\u7684\u6807\u7b7e\u5373\u53ef"),"\n",(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/385087446afa435da77418de3cebfdf5.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"2\uff09\u8fd0\u884c\u4efb\u52a1\u89c2\u5bdf\u8fd0\u884c\u5728\u54ea\u4e2a\u8282\u70b9")),(0,s.kt)("p",null,"\u9009\u62e9master\u5206\u652f\uff0c\u5f00\u59cb\u6784\u5efa\n",(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/11026daa09754df8892cc7c42d434b32.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,s.kt)("p",null,"\u4efb\u52a1\u5df2\u7ecf\u8fd0\u884c\u5230\u4e86Jenkins-slave1-107\u8282\u70b9\u4e0a"),(0,s.kt)("p",null,(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/f4003605156e44fc994c7a9da3f63b69.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,s.kt)("p",null,"\u9489\u9489\u5df2\u7ecf\u6536\u5230\u4fe1\u606f\u5e76\u4e14\u5728\u8282\u70b9\u5de5\u4f5c\u76ee\u5f55\u5df2\u7ecf\u4ea7\u751f\u6570\u636e"),(0,s.kt)("p",null,(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/2b0b214b6069439c837821a44b043a74.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,s.kt)("h3",{id:"73\u89c2\u5bdf\u8282\u70b9\u5173\u8054\u7684\u6267\u884c\u4efb\u52a1"},"7.3.\u89c2\u5bdf\u8282\u70b9\u5173\u8054\u7684\u6267\u884c\u4efb\u52a1"),(0,s.kt)("blockquote",null,(0,s.kt)("p",{parentName:"blockquote"},"\u5230\u8fd9\u4e00\u6b65CI/CD\u5e73\u53f0\u5df2\u7ecf\u90e8\u7f72\u5b8c\u6210\uff0c\u6211\u4eec\u53ef\u4ee5\u65b0\u5efa\u4e00\u4e2a\u6d41\u7a0b\uff0c\u66f4\u65b0\u7a0b\u5e8f\u5230kubernetes\u5e73\u53f0\n",(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/37216cf5a5824c899d172e8f4137e2c0.png",alt:null}))),(0,s.kt)("h2",{id:"8\u4f7f\u7528pipeline\u6d41\u6c34\u7ebf\u5c06know-system\u9879\u76ee\u66f4\u65b0\u5230kubernetes\u73af\u5883"},"8.\u4f7f\u7528pipeline\u6d41\u6c34\u7ebf\u5c06know-system\u9879\u76ee\u66f4\u65b0\u5230kubernetes\u73af\u5883"),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"k8s\u66f4\u65b0\u53ef\u4ee5\u91c7\u7528\u4e24\u79cd\u65b9\u5f0f")),(0,s.kt)("p",null," 1.\u5c06\u8d44\u6e90yaml\u6587\u4ef6\u4e5f\u4e0a\u4f20\u5230\u4ee3\u7801\u4ed3\u5e93\uff0c\u9879\u76ee\u6253\u5b8c\u955c\u50cf\u540e\uff0c\u53ef\u4ee5\u901a\u8fc7\u66ff\u6362deployment\u8d44\u6e90\u6211\u4eec\u6307\u5b9aimage\u7684\u5b57\u7b26\u4e32\uff0c\u628a\u6700\u65b0\u7248\u672c\u7684\u955c \u50cf\u66ff\u6362\u5230deployment\u8d44\u6e90\u4e2d\uff0c\u6700\u540e\u6267\u884ckubectl apply ./\u5b8c\u6210\u66f4\u65b0"),(0,s.kt)("p",null," 2.\u6267\u884ckubectl \u547d\u4ee4\u66f4\u65b0deployment\u8d44\u6e90\u7684\u955c\u50cf"),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"\u7531\u4e8e\u6211\u4eec\u6784\u5efa\u4efb\u52a1\u90fd\u662f\u901a\u8fc7agent\u53bb\u8fd0\u884c\u7684\uff0cagent\u90e8\u7f72\u5728k8s node\u8282\u70b9\uff0c\u7ee7\u627f\u4e86docker\u3001kubectl\u547d\u4ee4\uff0c\u56e0\u6b64\u4e0d\u5fc5\u62c5\u5fc3kubectl\u547d\u4ee4\u4e0d\u80fd\u7528")),(0,s.kt)("h3",{id:"81\u5b9e\u73b0\u601d\u8def"},"8.1.\u5b9e\u73b0\u601d\u8def"),(0,s.kt)("p",null,"1.\u9996\u5148\u5c06know-system\u5728k8s\u4e2d\u8fdb\u884c\u90e8\u7f72\uff0c\u5b9e\u73b0\u53ef\u4ee5\u8bbf\u95ee\u7684\u72b6\u6001"),(0,s.kt)("p",null,"2.\u5c06\u90e8\u7f72know-system\u7684yaml\u6587\u4ef6\u590d\u5236\u5230\u4ee3\u7801\u76ee\u5f55\u4e2d\uff0c\u5e76\u5c06deployment\u8d44\u6e90\u4e2d\u5bb9\u5668image\u5bf9\u5e94\u7684\u955c\u50cf\u6539\u6210\u4e00\u4e2a\u5b57\u7b26\u4e32\uff0c\u8fd9\u6837pipeline\u66f4\u65b0\u65f6\u53ef\u4ee5\u901a\u8fc7\u66f4\u6362\u8fd9\u4e2a\u5b57\u7b26\u4e32\uff0c\u628a\u6700\u65b0\u7684\u955c\u50cf\u7248\u672c\u66ff\u6362\u5230deployment\u8d44\u6e90\u4e2d\u5b8c\u6210\u66f4\u65b0\uff0c\u6700\u540e\u5c06\u4ee3\u7801\u53ca\u90e8\u7f72\u6587\u4ef6\u63a8\u9001\u5230gitlab"),(0,s.kt)("p",null,"3.\u4f18\u5316pipeline\u811a\u672c\uff0c\u589e\u52a0k8s\u90e8\u7f72\u6b65\u9aa4"),(0,s.kt)("p",null,"4.\u66f4\u65b0\u4ee3\u7801\uff0c\u4f7f\u7528\u6d41\u6c34\u7ebf\u66f4\u65b0\u9879\u76ee\u5230k8s"),(0,s.kt)("h3",{id:"82\u5c06know-system\u90e8\u7f72\u5728k8s\u4e2d"},"8.2.\u5c06know-system\u90e8\u7f72\u5728k8s\u4e2d"),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"1\uff09\u51c6\u5907\u9879\u76eeyaml\u6587\u4ef6")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-yaml"},"1.\u51c6\u5907deployment\u8d44\u6e90\n[root@k8s-master1 know-system]\\# cat nginx-depoly.yaml \napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: know-system\n  namespace: know-system\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: know-system\n  template:\n    metadata:\n      labels:\n        app: know-system\n    spec:\n      containers:\n      - name: nginx\n        image: harbor.jiangxl.com/project/nginx-project:v1-code\n        ports:\n        - containerPort: 80\n        volumeMounts:\n        - name: nginx-data\n          mountPath: /data/code\n        - name: nginx-config\n          mountPath: /data/nginx/conf/conf.d/\n      volumes:\n        - name: nginx-config\n          configMap:\n            name: nginx-configmap\n        - name : nginx-data\n          persistentVolumeClaim:\n            claimName: pvc-know\n            readOnly: false\n\n2.\u51c6\u5907configmap\u8d44\u6e90\n[root@k8s-master1 know-system]\\# cat nginx-configmap.yaml \napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: nginx-configmap\n  namespace: know-system\ndata:\n  know.jiangxl.com.conf: |\n    server {\n      listen 80;\n      server_name know.jiangxl.com;\n      location / {\n        root /data/code/know_system;\n        index index.html;\n      }\n    }\n\n3.\u51c6\u5907svc\u8d44\u6e90\n[root@k8s-master1 know-system]\\# cat nginx-svc.yaml \napiVersion: v1\nkind: Service\nmetadata:\n  name: nginx-service\n  namespace: know-system\nspec:\n  selector:\n    app: know-system\n  type: NodePort\n  ports:\n  - port: 80    \n    targetPort: 80\n")),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"2\uff09\u521b\u5efa\u6240\u6709\u8d44\u6e90")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-sh"},"[root@k8s-master1 know-system]\\# kubectl apply -f ./\nconfigmap/nginx-configmap unchanged\ndeployment.apps/know-system configured\nservice/nginx-service configured\n")),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"3\uff09\u67e5\u770b\u9879\u76ee\u9996\u9875")),(0,s.kt)("p",null,(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/5c579af45d324e1c857e235d62ca72f1.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,s.kt)("h3",{id:"83\u5c06k8s\u8d44\u6e90\u6587\u4ef6\u63d0\u4ea4\u81f3gitlab"},"8.3.\u5c06k8s\u8d44\u6e90\u6587\u4ef6\u63d0\u4ea4\u81f3gitlab"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-sh"},'1.\u5c06\u90e8\u7f72\u6587\u4ef6\u590d\u5236\u5230\u4ee3\u7801\u76ee\u5f55\n[root@k8s-master1 know_system]\\# mkdir deploy\n[root@k8s-master1 know_system]\\# cp /root/k8s1.19/know-system/* deploy/\n\n2.\u4fee\u6539deployment\u8d44\u6e90\u4e2d\u7684image\n#\u5c06image\u5bf9\u5e94\u7684\u955c\u50cf\u6539\u6210\u4e00\u4e2a\u5b57\u7b26\u4e32\uff0cpipeline\u66f4\u65b0\u65f6\u53ef\u4ee5\u901a\u8fc7\u66f4\u6362\u8fd9\u4e2a\u5b57\u7b26\u4e32\u628a\u6700\u65b0\u7684\u955c\u50cf\u66ff\u6362\u5230deployment\u8d44\u6e90\u4e2d\n[root@k8s-master1 know_system]\\# vim deploy/nginx-depoly.yaml \n        image: {{updateimage}}\n\n2.\u63d0\u4ea4\u81f3gitlab\n[root@k8s-master1 know_system]\\# git add .\n[root@k8s-master1 know_system]\\# git commit -m "deploy"\n[root@k8s-master1 know_system]\\# git push origin master\n')),(0,s.kt)("h3",{id:"84\u7f16\u5199jenkins-pipeline\u5c06\u9879\u76ee\u66f4\u65b0\u5230k8s"},"8.4.\u7f16\u5199Jenkins pipeline\u5c06\u9879\u76ee\u66f4\u65b0\u5230k8s"),(0,s.kt)("blockquote",null,(0,s.kt)("p",{parentName:"blockquote"},"\u5f53\u524dpipeline\u811a\u672c\u4e3b\u8981\u662f\u66f4\u65b0\u7528yaml\u6587\u4ef6\u521b\u5efa\u7684\u9879\u76eepod\u73b0")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-shell"},'pipeline {\n    agent { label \'Jenkins-slave1-107\' }                //\u8ba9\u8be5pipeline\u59cb\u7ec8\u8fd0\u884c\u5728Jenkins-slave1-107 Jenkins agent\u8282\u70b9\u4e0a\uff0c\u56e0\u4e3a\u8fd9\u4e2a\u8282\u70b9\u6240\u5728\u7684\u670d\u52a1\u5668\u53ef\u4ee5\u8fd0\u884ck8s\u96c6\u7fa4\u7684docker\u3001kubelet\u547d\u4ee4\n\n    environment {                                   //environment\u4e3b\u8981\u7528\u4e8e\u5b9a\u4e49\u73af\u5883\u53d8\u91cf\uff0c\u53ef\u4ee5\u628a\u4e00\u4e9b\u5e38\u7528\u5230\u7684\u503c\u505a\u6210\u73af\u5883\u53d8\u91cf\n        IMAGE_REPO="harbor.jiangxl.com/project"\n    }\n\n  parameters {                               //\u5b9a\u4e49\u53c2\u6570\u5316\u6784\u5efa\u6d41\u7a0b\n    gitParameter(name: \'VERSION\',defaultValue: \'master\',type: \'BRANCH\',description: \'\u9009\u62e9\u8981\u66f4\u65b0\u7684\u5206\u652f\')             //\u5b9a\u4e49\u4e00\u4e2agitparamters\u53c2\u6570\u5316\u6784\u5efa\u8fc7\u7a0b\uff0c\u7528\u4e8e\u9009\u62e9\u66f4\u65b0\u7684\u4ee3\u7801\n    string(name: \'project\',defaultValue: \'know-system\',description: \'\u9879\u76ee\u540d\u79f0\',trim: true)                  //\u5b9a\u4e49\u4e00\u4e2a\u7a7a\u767d\u5b57\u7b26\u4e32\uff0c\u58f0\u660e\u9879\u76ee\u540d\u79f0\n  } \n    stages {                        //\u5b9a\u4e49pipeline\u6267\u884c\u9636\u6bb5\n        stage(\'\u8fd0\u7ef4\u786e\u8ba4\u4fe1\u606f\') {                                 //\u9636\u6bb51\uff0c\u4f7f\u7528\u4e00\u4e2a\u4ea4\u4e92\u5f0f\uff0c\u8ba9\u8fd0\u884c\u786e\u8ba4\u66f4\u65b0\u4fe1\u606f\uff0c\u5982\u679c\u6709\u8bef\u53ef\u76f4\u63a5\u9000\u51fa\u66f4\u65b0\uff0c\u907f\u514d\u66f4\u65b0\u9519\u8bef\n            steps {\n                input message: """                          \n                jobname: ${project}\n                branch: ${VERSION}""", ok: "\u66f4\u65b0"                       //\u4ea4\u4e92\u5f0f\u8f93\u51fa\u4e00\u4e2a\u66f4\u65b0\u7684\u9879\u76ee\u548c\u5206\u652f\u53f7\n            }\n        }\n        stage(\'\u62c9\u53d6\u9879\u76ee\u4ee3\u7801\') {                                  //\u9636\u6bb52\uff0c\u7528\u4e8e\u62c9\u53d6git\u4e0a\u5bf9\u5e94\u7684\u9879\u76ee\u4ee3\u7801\n            steps {\n        checkout([$class: \'GitSCM\', branches: [[name: \'$VERSION\']], extensions: [], userRemoteConfigs: [[credentialsId: \'gitlab-root\', url: \'http://192.168.16.106:30080/root/know_system.git\']]])\n            }\n        }  \n        stage(\'\u6784\u5efa\u9879\u76ee\u955c\u50cf\') {                             //\u9636\u6bb53.\u7528\u4e8e\u5c06\u9879\u76ee\u4ee3\u7801\u66f4\u65b0\u5230docker\u521d\u59cb\u955c\u50cf\u4e2d\uff0c\u4e3b\u8981\u6b65\u9aa4\u5c31\u662f\u751f\u4ea7\u4e00\u4e2adockerfile\uff0c\u5c06\u4ee3\u7801\u590d\u5236\u5230\u955c\u50cf\u4e2d\uff0c\u6700\u540e\u6839\u636eDockerfile\u6784\u5efa\u51fa\u955c\u50cf\n            steps {\n        sh """              \n                pwd\n        echo "\nFROM harbor.jiangxl.com/project/nginx-project:v1-code\n\nRUN mkdir /data/code/know_system\nCOPY  ./* /data/code/know_system/\nEXPOSE 80\n        " >Dockerfile\n        """                             //\u7f16\u5199\u4e00\u4e2aDockerfile\uff0c\u5b9a\u4e49\u521d\u59cb\u955c\u50cf\uff0c\u5e76\u5c06\u66f4\u65b0\u7684\u4ee3\u7801\u590d\u5236\u5230\u5bb9\u5668\u7684\u6307\u5b9a\u8def\u5f84\n\n        sh \'docker build -t ${IMAGE_REPO}/${project}:master-v${BUILD_ID} .\'   //\u6700\u7ec8\u955c\u50cf\u7684\u540d\u79f0\u5c31\u662fharbor.jiangxl.com/project/know-system:master-v1                \n            }\n        }   \n\n        stage(\'\u63a8\u9001\u955c\u50cf\u5230harbor\u4ed3\u5e93\') {             //\u9636\u6bb54\uff0c\u5c06\u6784\u5efa\u597d\u7684\u955c\u50cf\u63a8\u9001\u81f3harbor\u4ed3\u5e93\u4e2d\uff0c\u4fbf\u4e8ek8s\u62c9\u53d6\u66f4\u65b0\u7a0b\u5e8f\n            steps {\n        sh \'docker push ${IMAGE_REPO}/${project}:master-v${BUILD_ID}\'   //\u63a8\u9001\u955c\u50cf\u5230harbor\u4ed3\u5e93\n            }\n        }           \n        stage(\'\u5c06\u9879\u76ee\u66f4\u65b0\u5230k8s\') {                     //\u9636\u6bb55\uff0c\u4e3b\u8981\u662f\u66f4\u65b0k8s\u4e2d\u9879\u76ee\u4f7f\u7528\u7684\u5bb9\u5668\uff0c\u5c06\u6700\u65b0\u6784\u5efa\u7684\u955c\u50cf\u66ff\u6362\u5230\u9879\u76eepod\u4e2d\uff0c\u7136\u540e\u66f4\u65b0pod\n            steps {                                     //\u4f7f\u7528kubectl\u547d\u4ee4\u66f4\u65b0\u9879\u76ee\n        sh "sed -i \'s#{{updateimage}}#${IMAGE_REPO}/${project}:master-v${BUILD_ID}#g\' deploy/*"       //\u5c06deployment\u8d44\u6e90\u4e2d\u6211\u4eec\u5199\u6b7b\u7684\u955c\u50cf\u7248\u672c\u5b57\u7b26\u4e32\uff0c\u66ff\u6362\u6210\u521a\u521a\u63a8\u9001\u81f3harbor\u4ed3\u5e93\u7684\u955c\u50cf\u7248\u672c\n                sh \'kubectl apply -f deploy/\'                   //\u5f53\u955c\u50cf\u7248\u672c\u66ff\u6362\u540e\uff0c\u66f4\u65b0\u8d44\u6e90\u7684yaml\u6587\u4ef6\u5373\u53ef\u5b8c\u6210\u9879\u76ee\u66f4\u65b0\n            }\n        }                  \n    }\n    post {\n      success {       //\u6784\u5efa\u6210\u529f\u4e86\u53d1\u9001\u4e00\u4e2a\u6784\u6210\u6210\u529f\u7684\u6d88\u606f\u5230\u9489\u9489\n          echo "\u6784\u5efa\u6210\u529f\uff0c\u53d1\u9001\u6d88\u606f\u5230\u9489\u9489"\n          sh """\n          curl \'https://oapi.dingtalk.com/robot/send?access_token=6719ac958daf4f31114cb0c1289837c9aca45d111d8653b04c3d6ae164f25146\' \\\n -H \'Content-Type: application/json\' \\\n -d \'{"msgtype": "text","text": {"content":"\ud83d\ude04\ud83d\udc4d\u6784\u5efa\u6210\u529f\ud83d\udc4d\ud83d\ude04\\n \u5173\u952e\u5b57\uff1ajenkins\\n \u9879\u76ee \u540d\u79f0: ${JOB_BASE_NAME}\\n \u66f4\u65b0\u7684\u5206\u652f\u53f7: ${VERSION}\\n \u672c\u6b21\u6784\u5efa\u7684\u955c\u50cf\u7248\u672c\uff1a${IMAGE_REPO}/${project}:master-v${BUILD_ID}\\n \u6784\u5efa\u5730\u5740\uff1a${RUN_DISPLAY_URL} "}}\'\n          """\n      }\n      failure {       //\u6784\u5efa\u5931\u8d25\u4e86\u53d1\u9001\u4e00\u4e2a\u6784\u6210\u6210\u529f\u7684\u6d88\u606f\u5230\u9489\u9489\n          echo "\u6784\u5efa\u5931\u8d25\uff0c\u53d1\u9001\u6d88\u606f\u5230\u9489\u9489"\n          sh """\n          curl \'https://oapi.dingtalk.com/robot/send?access_token=6719ac958daf4f31114cb0c1289837c9aca45d111d8653b04c3d6ae164f25146\' \\\n -H \'Content-Type: application/json\' \\\n -d \'{"msgtype": "text","text": {"content":"\ud83d\ude16\u274c\u6784\u5efa\u5931\u8d25\u274c\ud83d\ude16\\n \u5173\u952e\u5b57\uff1ajenkins\\n \u9879\u76ee \u540d\u79f0: ${JOB_BASE_NAME}\\n \u66f4\u65b0\u7684\u5206\u652f\u53f7: ${VERSION}\\n \u672c\u6b21\u6784\u5efa\u7684\u955c\u50cf\u7248\u672c\uff1a${IMAGE_REPO}/${project}:master-v${BUILD_ID}\\n \u6784\u5efa\u5730\u5740\uff1a${RUN_DISPLAY_URL} "}}\'\n        """\n      }\n      always {          //\u65e0\u8bba\u6210\u529f\u8fd8\u662f\u5931\u8d25\u90fd\u6267\u884c\u6b64\u6b65\u9aa4\n        echo "\u6784\u5efa\u6d41\u7a0b\u7ed3\u675f"\n      }\n    }\n}\n')),(0,s.kt)("h3",{id:"85\u5c06pipeline\u7c98\u8d34\u5230\u6d41\u6c34\u7ebf\u4efb\u52a1\u4e2d"},"8.5.\u5c06pipeline\u7c98\u8d34\u5230\u6d41\u6c34\u7ebf\u4efb\u52a1\u4e2d"),(0,s.kt)("p",null,(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/6b567d43deb0474e8b57f717070c1e95.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,s.kt)("h3",{id:"86\u6784\u5efamaster\u5206\u652f\u5b8c\u6210\u9879\u76ee\u66f4\u65b0"},"8.6.\u6784\u5efamaster\u5206\u652f\u5b8c\u6210\u9879\u76ee\u66f4\u65b0"),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"1\uff09\u9009\u62e9\u66f4\u65b0\u4fe1\u606f")),(0,s.kt)("p",null,(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/cebe0301954b46e0a696ebe6e2d05e93.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"2\uff09\u8fd0\u7ef4\u786e\u8ba4\u4fe1\u606f"),"\n",(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/e14279c1a0824528a12931943441b2ab.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"3\uff09pipeline\u4efb\u52a1\u66f4\u65b0\u6210\u529f")),(0,s.kt)("p",null,(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/b322ccd2bf6e48f5a5609660bc537d55.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"4\uff09\u5728blue ocean\u67e5\u770b\u6b64\u6b21\u66f4\u65b0\u7684\u955c\u50cf\u7248\u672c"),"\n",(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/0e471501cd6c4617b630b6bebb53f41c.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"5\uff09\u5728rancher\u4e0a\u89c2\u5bdf\u9879\u76ee\u662f\u5426\u66f4\u65b0\u6210\u6700\u65b0\u7684\u955c\u50cf\u7248\u672c")),(0,s.kt)("p",null,"\u66f4\u65b0\u6d41\u7a0b\u987a\u5229\u5b8c\u6210\uff01\n",(0,s.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/b261c18ee6c646a2848342ae64dda144.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,s.kt)("blockquote",null,(0,s.kt)("p",{parentName:"blockquote"},"\u8be5\u6587\u7ae0\u4e3a\u8f6c\u8f7d\u5185\u5bb9\uff0c\u4ec5\u505a\u5907\u4efd\u79c1\u4eba\u5b66\u4e60\u4f7f\u7528\uff0c\u539f\u6587\uff1a",(0,s.kt)("a",{parentName:"p",href:"https://jiangxl.blog.csdn.net/article/details/119828244"},"https://jiangxl.blog.csdn.net/article/details/119828244"))))}k.isMDXComponent=!0}}]);