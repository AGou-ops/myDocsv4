"use strict";(self.webpackChunkmy_docsv_4=self.webpackChunkmy_docsv_4||[]).push([[3067],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>k});var r=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=r.createContext({}),p=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},c=function(e){var t=p(e.components);return r.createElement(l.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},u=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,l=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),u=p(n),k=a,d=u["".concat(l,".").concat(k)]||u[k]||m[k]||o;return n?r.createElement(d,s(s({ref:t},c),{},{components:n})):r.createElement(d,s({ref:t},c))}));function k(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,s=new Array(o);s[0]=u;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i.mdxType="string"==typeof e?e:a,s[1]=i;for(var p=2;p<o;p++)s[p]=n[p];return r.createElement.apply(null,s)}return r.createElement.apply(null,n)}u.displayName="MDXCreateElement"},82557:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>m,frontMatter:()=>o,metadata:()=>i,toc:()=>p});var r=n(87462),a=(n(67294),n(3905));const o={},s=void 0,i={unversionedId:"LinuxBasics/PVE/PVE issues",id:"LinuxBasics/PVE/PVE issues",title:"PVE issues",description:"1. pve\u6dfb\u52a0NFS\u62a5\u9519\uff1acreate storage failed Permission denied at /usr/share/perl5/PVE/Storage/Plugin.pm line 1374. (500)",source:"@site/docs/LinuxBasics/PVE/PVE issues.md",sourceDirName:"LinuxBasics/PVE",slug:"/LinuxBasics/PVE/PVE issues",permalink:"/docs/LinuxBasics/PVE/PVE issues",draft:!1,editUrl:"https://github.com/AGou-ops/myDocsv4/edit/main/docs/LinuxBasics/PVE/PVE issues.md",tags:[],version:"current",frontMatter:{},sidebar:"linuxBasics",previous:{title:"PVE Tips",permalink:"/docs/LinuxBasics/PVE/PVE Tips"},next:{title:"PVE \u521d\u59cb\u5316\u76f8\u5173",permalink:"/docs/LinuxBasics/PVE/PVE \u521d\u59cb\u5316\u76f8\u5173"}},l={},p=[],c={toc:p};function m(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,r.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"pve\u6dfb\u52a0",(0,a.kt)("inlineCode",{parentName:"li"},"NFS"),"\u62a5\u9519\uff1a",(0,a.kt)("inlineCode",{parentName:"li"},"create storage failed: mkdir /mnt/pve/NAS_share/snippets: Permission denied at /usr/share/perl5/PVE/Storage/Plugin.pm line 1374. (500)"))),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"\u89e3\u51b3\u65b9\u6cd5\uff1a"),(0,a.kt)("p",{parentName:"blockquote"},"I've self-resolved! In FreeNAS, under the share settings, I experimentally set the mapall users setting to root, which makes anyone using that directory access it with root permissions. The issue then went away, giving me full access to the share. To further lock down the security, I created a \"Proxmox\" user with write permissions, and mapall-users'd that user to the share. Issue resolved!"),(0,a.kt)("p",{parentName:"blockquote"},"\u6765\u81ea\uff1a",(0,a.kt)("a",{parentName:"p",href:"https://forum.proxmox.com/threads/cant-use-nfs-share.53463/"},"https://forum.proxmox.com/threads/cant-use-nfs-share.53463/"))),(0,a.kt)("p",null,"\u7b80\u5355\u6765\u8bf4\u5c31\u662f",(0,a.kt)("inlineCode",{parentName:"p"},"TrueNAS"),"\u91cc\u9762\u7684\u5171\u4eab\u8bbe\u7f6e\u4e0d\u5bf9\uff0c\u5177\u4f53\u6307\u5b9a\u6b65\u9aa4\u4e3a\uff1a"),(0,a.kt)("p",null,"\u7f16\u8f91NFS\u5171\u4eab\uff0c",(0,a.kt)("strong",{parentName:"p"},"\u6253\u5f00\u9ad8\u7ea7\u9009\u9879")),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/image-20230425100107366.png",alt:"image-20230425100107366"})),(0,a.kt)("p",null,"\u4e0d\u8981\u8bbe\u7f6e\u4e3aroot\u7528\u6237\u6216\u8005root\u7528\u6237\u7ec4\u3002"),(0,a.kt)("ol",{start:2},(0,a.kt)("li",{parentName:"ol"},"\u5b89\u88c5rockylinux\u62a5\u5185\u6838\u9519\u8bef\uff0c\u5982\u4e0b\u56fe\u6240\u793a\uff1a")),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/image-20230425110415762.png",alt:"image-20230425110415762"})),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"\u89e3\u51b3\u65b9\u6cd5\uff1a"),(0,a.kt)("p",{parentName:"blockquote"},"Try with CPU-type: ",(0,a.kt)("inlineCode",{parentName:"p"},"host"),":\n",(0,a.kt)("a",{parentName:"p",href:"https://forum.proxmox.com/threads/kernel-panic-when-creating-vms-centos-9-stream-iso.104656/page-2#post-485684"},"https://forum.proxmox.com/threads/k...centos-9-stream-iso.104656/page-2#post-485684"))),(0,a.kt)("ol",{start:3},(0,a.kt)("li",{parentName:"ol"},"\u4fee\u6539vmid\uff0c\u4f7f\u7528\u4ee5\u4e0b\u811a\u672c\uff1a")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\n\necho Put the VMID to change\nread oldVMID\ncase $oldVMID in\n    ''|*[!0-9]*)\n        echo bad input. Exiting\n        exit;;\n    *)\n        echo Old VMID - $oldVMID ;;\nesac\necho\necho Put the new VMID\nread newVMID\ncase $newVMID in\n    ''|*[!0-9]*)\n        echo bad input. Exiting\n        exit;;\n    *)\n        echo New VMID - $newVMID ;;\nesac\necho\n\nvgNAME=\"$(lvs --noheadings -o lv_name,vg_name | grep $oldVMID | awk -F ' ' '{print $2}' | uniq -d)\"\n\ncase $vgNAME in\n    \"\")\n        echo Machine not in Volume Group. Exiting\n        exit;;\n    *)\n        echo Volume Group - $vgNAME ;;\nesac\n\nfor i in $(lvs -a|grep $vgNAME | awk '{print $1}' | grep $oldVMID);\ndo lvrename $vgNAME/vm-$oldVMID-disk-$(echo $i | awk '{print substr($0,length,1)}') vm-$newVMID-disk-$(echo $i | awk '{print substr($0,length,1)}');\ndone;\nsed -i \"s/$oldVMID/$newVMID/g\" /etc/pve/qemu-server/$oldVMID.conf;\nmv /etc/pve/qemu-server/$oldVMID.conf /etc/pve/qemu-server/$newVMID.conf;\n\necho Ta-Da!\n")),(0,a.kt)("p",null,"\u6216\u8005\u624b\u52a8\uff1a"),(0,a.kt)("blockquote",null,(0,a.kt)("ol",{parentName:"blockquote"},(0,a.kt)("li",{parentName:"ol"},"First, we have to take a backup of the virtual machine and its configuration.")),(0,a.kt)("ol",{parentName:"blockquote",start:2},(0,a.kt)("li",{parentName:"ol"},"Next, run the command below to access information about the logical volumes:")),(0,a.kt)("pre",{parentName:"blockquote"},(0,a.kt)("code",{parentName:"pre"},"`lvs -a`\n")),(0,a.kt)("ol",{parentName:"blockquote",start:3},(0,a.kt)("li",{parentName:"ol"},"Now, from the output from the above step, select the VMID that we want to change.")),(0,a.kt)("ol",{parentName:"blockquote",start:4},(0,a.kt)("li",{parentName:"ol"},"Then, shut down the VM.")),(0,a.kt)("ol",{parentName:"blockquote",start:5},(0,a.kt)("li",{parentName:"ol"},"After that, run the following command to update the name of the volumes:")),(0,a.kt)("pre",{parentName:"blockquote"},(0,a.kt)("code",{parentName:"pre"},"lvrename data/current_vmid new_vmid`\n\n\n\nRemember to replace current_vmid and new_vmid with the current VMID and the new VMID we want to change it to respectively.\n")),(0,a.kt)("ol",{parentName:"blockquote",start:6},(0,a.kt)("li",{parentName:"ol"},"Next, we have to update the ID in the VMs configuration file as seen below:")),(0,a.kt)("pre",{parentName:"blockquote"},(0,a.kt)("code",{parentName:"pre"},'`sed -i "s/ current_vmid/new_vmid/g" /etc/pve/bob-server/ current_vmid.conf`\n')),(0,a.kt)("ol",{parentName:"blockquote",start:7},(0,a.kt)("li",{parentName:"ol"},"Then, we will rename the VM configuration file as seen here:")),(0,a.kt)("pre",{parentName:"blockquote"},(0,a.kt)("code",{parentName:"pre"},"`mv /etc/pve/bob-server/ current_vmid.conf /etc/pve/bob-server/new_vmid .conf`\n")),(0,a.kt)("ol",{parentName:"blockquote",start:8},(0,a.kt)("li",{parentName:"ol"},"Finally, it is time to start the VM again."))),(0,a.kt)("ol",{start:4},(0,a.kt)("li",{parentName:"ol"},"pve\u514b\u9686\u5b8c\u4e4b\u540e\u83ab\u540d\u5947\u5999\u6240\u6709\u4e3b\u673a\u548c\u5b58\u50a8\u56fe\u6807\u5168\u90e8\u53d8\u6210\u95ee\u53f7\u4e86\uff1f")),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"\u89e3\u51b3\u65b9\u6848\uff1a"),(0,a.kt)("pre",{parentName:"blockquote"},(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"service pve-cluster stop\nservice corosync stop\nservice pvestatd stop\nservice pveproxy stop\nservice pvedaemon stop\n\nservice pve-cluster start\nservice corosync start\nservice pvestatd start\nservice pveproxy start\nservice pvedaemon start\n")),(0,a.kt)("p",{parentName:"blockquote"},"Tried this before, but now it actually worked. Got one node up and working, testing it on 2nd node now...")),(0,a.kt)("ol",{start:5},(0,a.kt)("li",{parentName:"ol"},"\u547d\u4ee4\u884c\u7ec8\u7aef\u79fb\u9664\u9875\u9762\u65e0\u6cd5\u5220\u9664\u7684\u5377\u7ec4")),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/image-20230427111513547.png",alt:"image-20230427111513547"})),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"\u26a0\ufe0f\u6ce8\u610f\u5982\u679c\u662f\u91cd\u8981\u6570\u636e\uff0c\u9700\u8981\u5907\u4efd\u3002"),(0,a.kt)("ol",{parentName:"blockquote"},(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"run"),(0,a.kt)("p",{parentName:"li"},"Code:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre"},"lvdisplay\n")),(0,a.kt)("ol",{parentName:"li"},(0,a.kt)("li",{parentName:"ol"},"Check to see if you have nay volume's still in that group"))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"If you do run"),(0,a.kt)("p",{parentName:"li"},"Code:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre"},"lvremove /dev/pve/vm-104-cloudinit\n")),(0,a.kt)("p",{parentName:"li"},"-"," This will remove that volume")))))}m.isMDXComponent=!0}}]);