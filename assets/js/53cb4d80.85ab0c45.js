"use strict";(self.webpackChunkmy_docsv_4=self.webpackChunkmy_docsv_4||[]).push([[6080],{3905:(e,t,n)=>{n.d(t,{Zo:()=>k,kt:()=>b});var r=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},s=Object.keys(e);for(r=0;r<s.length;r++)n=s[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(r=0;r<s.length;r++)n=s[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var i=r.createContext({}),c=function(e){var t=r.useContext(i),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},k=function(e){var t=c(e.components);return r.createElement(i.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,s=e.originalType,i=e.parentName,k=l(e,["components","mdxType","originalType","parentName"]),d=c(n),b=a,p=d["".concat(i,".").concat(b)]||d[b]||u[b]||s;return n?r.createElement(p,o(o({ref:t},k),{},{components:n})):r.createElement(p,o({ref:t},k))}));function b(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var s=n.length,o=new Array(s);o[0]=d;var l={};for(var i in t)hasOwnProperty.call(t,i)&&(l[i]=t[i]);l.originalType=e,l.mdxType="string"==typeof e?e:a,o[1]=l;for(var c=2;c<s;c++)o[c]=n[c];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},97397:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>i,contentTitle:()=>o,default:()=>u,frontMatter:()=>s,metadata:()=>l,toc:()=>c});var r=n(87462),a=(n(67294),n(3905));const s={},o=void 0,l={unversionedId:"CloudNative/k8s/Installation/Kubernetes \u4e8c\u8fdb\u5236\u5b89\u88c5",id:"CloudNative/k8s/Installation/Kubernetes \u4e8c\u8fdb\u5236\u5b89\u88c5",title:"Kubernetes \u4e8c\u8fdb\u5236\u5b89\u88c5",description:"[[toc]]",source:"@site/docs/CloudNative/k8s/Installation/Kubernetes \u4e8c\u8fdb\u5236\u5b89\u88c5.md",sourceDirName:"CloudNative/k8s/Installation",slug:"/CloudNative/k8s/Installation/Kubernetes \u4e8c\u8fdb\u5236\u5b89\u88c5",permalink:"/docs/CloudNative/k8s/Installation/Kubernetes \u4e8c\u8fdb\u5236\u5b89\u88c5",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/CloudNative/k8s/Installation/Kubernetes \u4e8c\u8fdb\u5236\u5b89\u88c5.md",tags:[],version:"current",frontMatter:{},sidebar:"cloudNative",previous:{title:"Installation",permalink:"/docs/category/installation"},next:{title:"\u4f7f\u7528 Kubeadm \u90e8\u7f72(\u5355master)",permalink:"/docs/CloudNative/k8s/Installation/\u4f7f\u7528 Kubeadm \u90e8\u7f72\uff08\u5355master\uff09"}},i={},c=[{value:"1.\u73af\u5883\u51c6\u5907",id:"1\u73af\u5883\u51c6\u5907",level:2},{value:"1.1.Kubernetes\u9ad8\u53ef\u7528\u96c6\u7fa4\u90e8\u7f72\u65b9\u5f0f",id:"11kubernetes\u9ad8\u53ef\u7528\u96c6\u7fa4\u90e8\u7f72\u65b9\u5f0f",level:3},{value:"1.2.Kubernetes\u96c6\u7fa4\u5f03\u7528docker\u5bb9\u5668",id:"12kubernetes\u96c6\u7fa4\u5f03\u7528docker\u5bb9\u5668",level:3},{value:"1.3.Kubernetes\u96c6\u7fa4\u6240\u9700\u7684\u8bc1\u4e66",id:"13kubernetes\u96c6\u7fa4\u6240\u9700\u7684\u8bc1\u4e66",level:3},{value:"1.4.\u73af\u5883\u51c6\u5907",id:"14\u73af\u5883\u51c6\u5907",level:3},{value:"1.5.\u5b89\u88c5cfssl\u8bc1\u4e66\u751f\u6210\u5de5\u5177",id:"15\u5b89\u88c5cfssl\u8bc1\u4e66\u751f\u6210\u5de5\u5177",level:3},{value:"2.\u64cd\u4f5c\u7cfb\u7edf\u521d\u59cb\u5316\u914d\u7f6e",id:"2\u64cd\u4f5c\u7cfb\u7edf\u521d\u59cb\u5316\u914d\u7f6e",level:2},{value:"3.\u90e8\u7f72Etcd\u96c6\u7fa4",id:"3\u90e8\u7f72etcd\u96c6\u7fa4",level:2},{value:"3.1.\u4f7f\u7528cfssl\u8bc1\u4e66\u5de5\u5177\u751f\u6210etcd\u8bc1\u4e66",id:"31\u4f7f\u7528cfssl\u8bc1\u4e66\u5de5\u5177\u751f\u6210etcd\u8bc1\u4e66",level:3},{value:"3.2.\u90e8\u7f72etcd\u96c6\u7fa4",id:"32\u90e8\u7f72etcd\u96c6\u7fa4",level:3},{value:"4.\u90e8\u7f72Docker\u670d\u52a1",id:"4\u90e8\u7f72docker\u670d\u52a1",level:2},{value:"4.1.\u5b89\u88c5docker",id:"41\u5b89\u88c5docker",level:3},{value:"4.2.\u4e3adocker\u521b\u5efasystemctl\u542f\u52a8\u811a\u672c",id:"42\u4e3adocker\u521b\u5efasystemctl\u542f\u52a8\u811a\u672c",level:3},{value:"5.\u90e8\u7f72kubernetes master\u8282\u70b9",id:"5\u90e8\u7f72kubernetes-master\u8282\u70b9",level:2},{value:"5.1.\u4f7f\u7528cfssl\u751f\u6210apiserver\u7684\u8bc1\u4e66\u6587\u4ef6",id:"51\u4f7f\u7528cfssl\u751f\u6210apiserver\u7684\u8bc1\u4e66\u6587\u4ef6",level:3},{value:"5.2.\u89e3\u538b\u4e8c\u8fdb\u5236\u6587\u4ef6\u590d\u5236\u76f8\u5173\u7ec4\u4ef6\u7a0b\u5e8f",id:"52\u89e3\u538b\u4e8c\u8fdb\u5236\u6587\u4ef6\u590d\u5236\u76f8\u5173\u7ec4\u4ef6\u7a0b\u5e8f",level:3},{value:"5.3.\u90e8\u7f72kube-apiserver\u7ec4\u4ef6",id:"53\u90e8\u7f72kube-apiserver\u7ec4\u4ef6",level:3},{value:"5.3.1.\u521b\u5efakube-apiserver\u914d\u7f6e\u6587\u4ef6",id:"531\u521b\u5efakube-apiserver\u914d\u7f6e\u6587\u4ef6",level:4},{value:"5.3.2.\u521b\u5efaTLS Bootstrapping\u6587\u4ef6",id:"532\u521b\u5efatls-bootstrapping\u6587\u4ef6",level:4},{value:"5.3.4.\u521b\u5efasystemctl\u811a\u672c\u7ba1\u7406apiserver",id:"534\u521b\u5efasystemctl\u811a\u672c\u7ba1\u7406apiserver",level:4},{value:"5.3.5.\u542f\u52a8kube-apiserver\u7ec4\u4ef6",id:"535\u542f\u52a8kube-apiserver\u7ec4\u4ef6",level:4},{value:"5.4.\u90e8\u7f72kube-controller-manage\u7ec4\u4ef6",id:"54\u90e8\u7f72kube-controller-manage\u7ec4\u4ef6",level:3},{value:"5.4.1.\u521b\u5efakube-controller-manage\u914d\u7f6e\u6587\u4ef6",id:"541\u521b\u5efakube-controller-manage\u914d\u7f6e\u6587\u4ef6",level:4},{value:"5.4.2.\u751f\u6210kubeconfig\u6587\u4ef6",id:"542\u751f\u6210kubeconfig\u6587\u4ef6",level:4},{value:"5.4.3.\u521b\u5efasystemctl\u811a\u672c\u7ba1\u7406\u670d\u52a1",id:"543\u521b\u5efasystemctl\u811a\u672c\u7ba1\u7406\u670d\u52a1",level:4},{value:"5.4.4.\u542f\u52a8kube-controller-manage\u7ec4\u4ef6",id:"544\u542f\u52a8kube-controller-manage\u7ec4\u4ef6",level:4},{value:"5.5.\u90e8\u7f72kube-scheduler\u7ec4\u4ef6",id:"55\u90e8\u7f72kube-scheduler\u7ec4\u4ef6",level:3},{value:"5.5.1.\u521b\u5efakube-scheduler\u914d\u7f6e\u6587\u4ef6",id:"551\u521b\u5efakube-scheduler\u914d\u7f6e\u6587\u4ef6",level:4},{value:"5.5.2.\u751f\u6210kubeconfig\u6587\u4ef6",id:"552\u751f\u6210kubeconfig\u6587\u4ef6",level:4},{value:"5.5.3.\u521b\u5efasystemctl\u811a\u672c\u7ba1\u7406\u670d\u52a1",id:"553\u521b\u5efasystemctl\u811a\u672c\u7ba1\u7406\u670d\u52a1",level:4},{value:"5.5.4.\u542f\u52a8kube-scheduler\u7ec4\u4ef6",id:"554\u542f\u52a8kube-scheduler\u7ec4\u4ef6",level:4},{value:"5.6.\u51c6\u5907kubectl\u6240\u9700\u7684kubeconfig\u6587\u4ef6\u8fde\u63a5\u96c6\u7fa4",id:"56\u51c6\u5907kubectl\u6240\u9700\u7684kubeconfig\u6587\u4ef6\u8fde\u63a5\u96c6\u7fa4",level:3},{value:"5.6.1.\u751f\u6210\u8bc1\u4e66\u6587\u4ef6",id:"561\u751f\u6210\u8bc1\u4e66\u6587\u4ef6",level:4},{value:"5.6.2.\u751f\u6210kubeconfig\u6587\u4ef6",id:"562\u751f\u6210kubeconfig\u6587\u4ef6",level:4},{value:"5.6.3.\u4f7f\u7528kubectl\u67e5\u770b\u96c6\u7fa4\u8fde\u63a5\u4fe1\u606f",id:"563\u4f7f\u7528kubectl\u67e5\u770b\u96c6\u7fa4\u8fde\u63a5\u4fe1\u606f",level:4},{value:"6.\u5728master\u8282\u70b9\u90e8\u7f72node\u8282\u70b9\u76f8\u5173\u7ec4\u4ef6",id:"6\u5728master\u8282\u70b9\u90e8\u7f72node\u8282\u70b9\u76f8\u5173\u7ec4\u4ef6",level:2},{value:"6.1.\u5728\u96c6\u7fa4\u6388\u6743kubelet-bootstrap\u7528\u6237\u5141\u8bb8\u8bf7\u6c42\u8bc1\u4e66",id:"61\u5728\u96c6\u7fa4\u6388\u6743kubelet-bootstrap\u7528\u6237\u5141\u8bb8\u8bf7\u6c42\u8bc1\u4e66",level:3},{value:"6.2.\u5728master\u8282\u70b9\u90e8\u7f72kubelet\u7ec4\u4ef6",id:"62\u5728master\u8282\u70b9\u90e8\u7f72kubelet\u7ec4\u4ef6",level:3},{value:"6.2.1.\u5c06kubelet\u548ckube-proxy\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u62f7\u8d1d\u81f3\u5bf9\u5e94\u76ee\u5f55",id:"621\u5c06kubelet\u548ckube-proxy\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u62f7\u8d1d\u81f3\u5bf9\u5e94\u76ee\u5f55",level:4},{value:"6.2.2.\u521b\u5efakubelet\u914d\u7f6e\u6587\u4ef6",id:"622\u521b\u5efakubelet\u914d\u7f6e\u6587\u4ef6",level:4},{value:"6.2.3.\u521b\u5efakubelet-config.yaml\u53c2\u6570\u914d\u7f6e\u6587\u4ef6",id:"623\u521b\u5efakubelet-configyaml\u53c2\u6570\u914d\u7f6e\u6587\u4ef6",level:4},{value:"6.2.4.\u521b\u5efabootstrap-kubeconfig\u6587\u4ef6",id:"624\u521b\u5efabootstrap-kubeconfig\u6587\u4ef6",level:4},{value:"6.2.5.\u521b\u5efasystemctl\u811a\u672c\u5e76\u542f\u52a8\u670d\u52a1",id:"625\u521b\u5efasystemctl\u811a\u672c\u5e76\u542f\u52a8\u670d\u52a1",level:4},{value:"6.2.6.\u5c06master\u8282\u70b9\u4f5c\u4e3anode\u52a0\u5165\u96c6\u7fa4\u5185\u90e8",id:"626\u5c06master\u8282\u70b9\u4f5c\u4e3anode\u52a0\u5165\u96c6\u7fa4\u5185\u90e8",level:4},{value:"6.3.\u5728master\u8282\u70b9\u90e8\u7f72kube-proxy",id:"63\u5728master\u8282\u70b9\u90e8\u7f72kube-proxy",level:3},{value:"6.3.1.\u521b\u5efakube-proxy\u914d\u7f6e\u6587\u4ef6",id:"631\u521b\u5efakube-proxy\u914d\u7f6e\u6587\u4ef6",level:4},{value:"6.3.2.\u521b\u5efakube-proxy\u53c2\u6570\u914d\u7f6e\u6587\u4ef6",id:"632\u521b\u5efakube-proxy\u53c2\u6570\u914d\u7f6e\u6587\u4ef6",level:4},{value:"6.3.3.\u751f\u6210kubeconfig\u6587\u4ef6",id:"633\u751f\u6210kubeconfig\u6587\u4ef6",level:4},{value:"6.3.4.\u521b\u5efasystemctl\u811a\u672c\u7ba1\u7406\u670d\u52a1",id:"634\u521b\u5efasystemctl\u811a\u672c\u7ba1\u7406\u670d\u52a1",level:4},{value:"6.3.4.\u542f\u52a8kube-proxy\u7ec4\u4ef6",id:"634\u542f\u52a8kube-proxy\u7ec4\u4ef6",level:4},{value:"6.4.\u6388\u6743apiserver\u8bbf\u95eekubelet",id:"64\u6388\u6743apiserver\u8bbf\u95eekubelet",level:3},{value:"7.\u90e8\u7f72kubernetes calico\u7f51\u7edc\u7ec4\u4ef6",id:"7\u90e8\u7f72kubernetes-calico\u7f51\u7edc\u7ec4\u4ef6",level:2},{value:"8.\u90e8\u7f72kubernetes node\u8282\u70b9",id:"8\u90e8\u7f72kubernetes-node\u8282\u70b9",level:2},{value:"8.1.\u89e3\u538b\u4e8c\u8fdb\u5236\u6587\u4ef6\u590d\u5236\u76f8\u5173\u7ec4\u4ef6\u7a0b\u5e8f",id:"81\u89e3\u538b\u4e8c\u8fdb\u5236\u6587\u4ef6\u590d\u5236\u76f8\u5173\u7ec4\u4ef6\u7a0b\u5e8f",level:3},{value:"8.2.\u90e8\u7f72kubelet\u7ec4\u4ef6",id:"82\u90e8\u7f72kubelet\u7ec4\u4ef6",level:3},{value:"8.2.1.\u521b\u5efakubelet\u914d\u7f6e\u6587\u4ef6",id:"821\u521b\u5efakubelet\u914d\u7f6e\u6587\u4ef6",level:4},{value:"8.2.2.\u521b\u5efakubelet\u53c2\u6570\u914d\u7f6e\u6587\u4ef6",id:"822\u521b\u5efakubelet\u53c2\u6570\u914d\u7f6e\u6587\u4ef6",level:4},{value:"8.2.3.\u521b\u5efabootstrap-kubeconfig\u6587\u4ef6",id:"823\u521b\u5efabootstrap-kubeconfig\u6587\u4ef6",level:4},{value:"8.2.4.\u521b\u5efasystemctl\u811a\u672c\u5e76\u542f\u52a8\u670d\u52a1",id:"824\u521b\u5efasystemctl\u811a\u672c\u5e76\u542f\u52a8\u670d\u52a1",level:4},{value:"8.2.5.master\u8282\u70b9\u6388\u6743\u540c\u610fnode\u8282\u70b9\u52a0\u5165\u96c6\u7fa4",id:"825master\u8282\u70b9\u6388\u6743\u540c\u610fnode\u8282\u70b9\u52a0\u5165\u96c6\u7fa4",level:4},{value:"8.3.\u90e8\u7f72kube-proxy\u7ec4\u4ef6",id:"83\u90e8\u7f72kube-proxy\u7ec4\u4ef6",level:3},{value:"8.3.1.\u521b\u5efakube-proxy\u914d\u7f6e\u6587\u4ef6",id:"831\u521b\u5efakube-proxy\u914d\u7f6e\u6587\u4ef6",level:4},{value:"8.3.2.\u521b\u5efakube-proxy\u53c2\u6570\u914d\u7f6e\u6587\u4ef6",id:"832\u521b\u5efakube-proxy\u53c2\u6570\u914d\u7f6e\u6587\u4ef6",level:4},{value:"8.3.3.\u751f\u6210kube-config\u6587\u4ef6",id:"833\u751f\u6210kube-config\u6587\u4ef6",level:4},{value:"8.3.4.\u521b\u5efasystemctl\u811a\u672c\u7ba1\u7406\u670d\u52a1",id:"834\u521b\u5efasystemctl\u811a\u672c\u7ba1\u7406\u670d\u52a1",level:4},{value:"8.3.5.\u542f\u52a8kube-proxy\u7ec4\u4ef6",id:"835\u542f\u52a8kube-proxy\u7ec4\u4ef6",level:4},{value:"8.4.\u5feb\u901f\u589e\u52a0\u65b0\u7684node\u8282\u70b9",id:"84\u5feb\u901f\u589e\u52a0\u65b0\u7684node\u8282\u70b9",level:3},{value:"8.4.1.\u5c06kubelet\u548ckube-proxy\u76ee\u5f55\u62f7\u8d1d\u81f3\u65b0\u7684node\u8282\u70b9",id:"841\u5c06kubelet\u548ckube-proxy\u76ee\u5f55\u62f7\u8d1d\u81f3\u65b0\u7684node\u8282\u70b9",level:4},{value:"8.4.2.\u914d\u7f6e\u5e76\u542f\u52a8kubelet\u7ec4\u4ef6",id:"842\u914d\u7f6e\u5e76\u542f\u52a8kubelet\u7ec4\u4ef6",level:4},{value:"8.4.3.master\u8282\u70b9\u6388\u6743\u65b0node\u8282\u70b9\u7684\u8bf7\u6c42",id:"843master\u8282\u70b9\u6388\u6743\u65b0node\u8282\u70b9\u7684\u8bf7\u6c42",level:4},{value:"8.4.4.\u914d\u7f6e\u5e76\u542f\u52a8kube-proxy\u7ec4\u4ef6",id:"844\u914d\u7f6e\u5e76\u542f\u52a8kube-proxy\u7ec4\u4ef6",level:4},{value:"9.\u4e3a\u96c6\u7fa4\u90e8\u7f72coredns\u7ec4\u4ef6",id:"9\u4e3a\u96c6\u7fa4\u90e8\u7f72coredns\u7ec4\u4ef6",level:2},{value:"9.1.\u90e8\u7f72coredns\u7ec4\u4ef6",id:"91\u90e8\u7f72coredns\u7ec4\u4ef6",level:3},{value:"9.2.\u8fd0\u884c\u4e00\u4e2abusybox\u5bb9\u5668\u6d4b\u8bd5dns",id:"92\u8fd0\u884c\u4e00\u4e2abusybox\u5bb9\u5668\u6d4b\u8bd5dns",level:3},{value:"10.\u6269\u5bb9master\u8282\u70b9\u7ec4\u5efakubernetes\u9ad8\u53ef\u7528\u96c6\u7fa4",id:"10\u6269\u5bb9master\u8282\u70b9\u7ec4\u5efakubernetes\u9ad8\u53ef\u7528\u96c6\u7fa4",level:2},{value:"10.1.kubernetes\u9ad8\u53ef\u7528\u67b6\u6784\u6982\u5ff5",id:"101kubernetes\u9ad8\u53ef\u7528\u67b6\u6784\u6982\u5ff5",level:3},{value:"10.2.\u5728\u96c6\u7fa4\u4e2d\u65b0\u589e\u4e00\u4e2aetcd\u8282\u70b9",id:"102\u5728\u96c6\u7fa4\u4e2d\u65b0\u589e\u4e00\u4e2aetcd\u8282\u70b9",level:3},{value:"10.2.1.\u9996\u5148\u65b0\u589e\u52a0\u4e00\u53f0\u5355\u70b9\u7684etcd",id:"1021\u9996\u5148\u65b0\u589e\u52a0\u4e00\u53f0\u5355\u70b9\u7684etcd",level:4},{value:"10.2.2.\u5728\u73b0\u6709etcd\u96c6\u7fa4\u4efb\u610f\u4e00\u4e2a\u8282\u70b9\u4e0a\u589e\u52a0\u65b0etcd\u8282\u70b9",id:"1022\u5728\u73b0\u6709etcd\u96c6\u7fa4\u4efb\u610f\u4e00\u4e2a\u8282\u70b9\u4e0a\u589e\u52a0\u65b0etcd\u8282\u70b9",level:4},{value:"10.2.3.\u914d\u7f6e\u65b0\u589e\u7684etcd\u8282\u70b9\u52a0\u5165\u96c6\u7fa4",id:"1023\u914d\u7f6e\u65b0\u589e\u7684etcd\u8282\u70b9\u52a0\u5165\u96c6\u7fa4",level:4},{value:"10.2.4.\u914d\u7f6ekube-apiserver\u589e\u52a0\u65b0\u7684etcd\u8282\u70b9",id:"1024\u914d\u7f6ekube-apiserver\u589e\u52a0\u65b0\u7684etcd\u8282\u70b9",level:4},{value:"10.3.\u90e8\u7f72master-2\u8282\u70b9",id:"103\u90e8\u7f72master-2\u8282\u70b9",level:3},{value:"10.3.1.\u90e8\u7f72docker",id:"1031\u90e8\u7f72docker",level:4},{value:"10.3.2.\u90e8\u7f72kubernetes\u5404\u4e2a\u7ec4\u4ef6",id:"1032\u90e8\u7f72kubernetes\u5404\u4e2a\u7ec4\u4ef6",level:4},{value:"10.3.3.\u6388\u6743master2\u8282\u70b9\u52a0\u5165\u96c6\u7fa4",id:"1033\u6388\u6743master2\u8282\u70b9\u52a0\u5165\u96c6\u7fa4",level:4},{value:"10.4.\u90e8\u7f72Nginx+Keepalived\u5b9e\u73b0kubernetes\u9ad8\u53ef\u7528\u96c6\u7fa4",id:"104\u90e8\u7f72nginxkeepalived\u5b9e\u73b0kubernetes\u9ad8\u53ef\u7528\u96c6\u7fa4",level:3},{value:"10.4.1.\u90e8\u7f72Nginx\u8d1f\u8f7d\u5747\u8861",id:"1041\u90e8\u7f72nginx\u8d1f\u8f7d\u5747\u8861",level:4},{value:"10.4.2.\u90e8\u7f72keepalived\u53cc\u673a\u70ed\u5907",id:"1042\u90e8\u7f72keepalived\u53cc\u673a\u70ed\u5907",level:4},{value:"10.4.3.\u4f7f\u7528VIP\u8bbf\u95eekubernetes\u670d\u52a1",id:"1043\u4f7f\u7528vip\u8bbf\u95eekubernetes\u670d\u52a1",level:4},{value:"10.4.4.\u6d4b\u8bd5keepalived\u9ad8\u53ef\u7528",id:"1044\u6d4b\u8bd5keepalived\u9ad8\u53ef\u7528",level:4},{value:"10.5.\u5207\u6362kubernetes\u96c6\u7fa4\u4e3a\u9ad8\u53ef\u7528\u6a21\u5f0f",id:"105\u5207\u6362kubernetes\u96c6\u7fa4\u4e3a\u9ad8\u53ef\u7528\u6a21\u5f0f",level:3},{value:"11.\u6d4b\u8bd5kubernetes\u9ad8\u53ef\u7528\u96c6\u7fa4",id:"11\u6d4b\u8bd5kubernetes\u9ad8\u53ef\u7528\u96c6\u7fa4",level:2},{value:"12.\u5728kubernetes\u96c6\u7fa4\u8fd0\u884c\u4e00\u5957\u670d\u52a1\u9a8c\u8bc1\u96c6\u7fa4\u7684\u53ef\u7528\u6027",id:"12\u5728kubernetes\u96c6\u7fa4\u8fd0\u884c\u4e00\u5957\u670d\u52a1\u9a8c\u8bc1\u96c6\u7fa4\u7684\u53ef\u7528\u6027",level:2},{value:"12.1.\u521b\u5efa\u8d44\u6e90yaml\u6587\u4ef6",id:"121\u521b\u5efa\u8d44\u6e90yaml\u6587\u4ef6",level:3},{value:"12.2.\u521b\u5efa\u8d44\u6e90\u5e76\u8fdb\u884c\u6d4b\u8bd5",id:"122\u521b\u5efa\u8d44\u6e90\u5e76\u8fdb\u884c\u6d4b\u8bd5",level:3},{value:"13.\u90e8\u7f72kubernetes dashboard",id:"13\u90e8\u7f72kubernetes-dashboard",level:2},{value:"13.1.\u90e8\u7f72dashboard",id:"131\u90e8\u7f72dashboard",level:3},{value:"13.2.\u8bbf\u95eedashboard",id:"132\u8bbf\u95eedashboard",level:3}],k={toc:c};function u(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,r.Z)({},k,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"[","[toc]","]"),(0,a.kt)("h2",{id:"1\u73af\u5883\u51c6\u5907"},"1.\u73af\u5883\u51c6\u5907"),(0,a.kt)("h3",{id:"11kubernetes\u9ad8\u53ef\u7528\u96c6\u7fa4\u90e8\u7f72\u65b9\u5f0f"},"1.1.Kubernetes\u9ad8\u53ef\u7528\u96c6\u7fa4\u90e8\u7f72\u65b9\u5f0f"),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"\u76ee\u524d\u751f\u4ea7\u73af\u5883\u90e8\u7f72Kubernetes\u5efa\u4e3b\u8981\u6709\u4e24\u79cd\u65b9\u5f0f\uff1a"),(0,a.kt)("p",{parentName:"blockquote"},"kubeadm\uff1a\u63d0\u4f9bkubeadm init\u548ckubeadm join\uff0c\u7528\u4e8e\u5feb\u901f\u90e8\u7f72Kubernetes\u96c6\u7fa4\uff0ckubeadm\u5b89\u88c5\u7684k8s\u96c6\u7fa4\uff0c\u6240\u6709\u7684k8s\u7ec4\u4ef6\u90fd\u662f\u4ee5pod\u5f62\u5f0f\u8fd0\u884c\u3002"),(0,a.kt)("p",{parentName:"blockquote"},"\u4e8c\u8fdb\u5236\u5305\uff1a\u4ecegithub\u4e0a\u4e0b\u8f7d\u53d1\u884c\u7248\u7684\u4e8c\u8fdb\u5236\u5305\uff0c\u624b\u52a8\u90e8\u7f72\u6bcf\u4e2a\u7ec4\u4ef6\uff0c\u7ec4\u6210kubernetes\u96c6\u7fa4\u3002"),(0,a.kt)("p",{parentName:"blockquote"},"Kubeadm\u964d\u4f4e\u90e8\u7f72\u6210\u672c\uff0c\u4ece\u800c\u5c4f\u853d\u4e86\u5f88\u591a\u7ec6\u8282\uff0c\u9047\u5230\u95ee\u9898\u5f88\u96be\u6392\u67e5\uff0c\u5982\u679c\u60f3\u66f4\u5bb9\u6613\u53ef\u63a7\uff0c\u63a8\u8350\u4f7f\u7528\u4e8c\u8fdb\u5236\u5305\u90e8\u7f72Kubernetes\u96c6\u7fa4\uff0c\u867d\u7136\u624b\u52a8\u90e8\u7f72\u9ebb\u70e6\u70b9\uff0c\u671f\u95f4\u53ef\u4ee5\u5b66\u4e60\u5f88\u591a\u5de5\u4f5c\u539f\u7406\uff0c\u4e5f\u5229\u4e8e\u540e\u671f\u7ef4\u62a4\u3002")),(0,a.kt)("h3",{id:"12kubernetes\u96c6\u7fa4\u5f03\u7528docker\u5bb9\u5668"},"1.2.Kubernetes\u96c6\u7fa4\u5f03\u7528docker\u5bb9\u5668"),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"\u5728k8s\u5e73\u53f0\u4e2d\uff0c\u4e3a\u4e86\u89e3\u51b3\u4e0e\u5bb9\u5668\u8fd0\u884c\u65f6\uff0c\u6bd4\u5982docker\u7684\u96c6\u6210\u95ee\u9898\uff0c\u5728\u65e9\u671f\u793e\u533a\u63a8\u51faCRI\u63a5\u53e3\uff0c\u4ee5\u652f\u6301\u66f4\u591a\u7684\u5bb9\u5668\uff0c\u5f53\u6211\u4eec\u4f7f\u7528Docker\u4f5c\u4e3a\u5bb9\u5668\u8fd0\u884c\u65f6\uff0c\u9996\u5148kubelet\u8c03\u7528dockershim\u7684CRI\u5bb9\u5668\u63a5\u53e3\u8fde\u63a5docker\u8fdb\u7a0b\uff0c\u6700\u540e\u7531docker\u542f\u52a8\u5bb9\u5668\u3002"),(0,a.kt)("p",{parentName:"blockquote"},"\u5728k8s1.23\u7248\u672c\u4e2d\uff0ck8s\u8ba1\u5212\u5f03\u7528kubelet\u4e2d\u7684dockershim\u63a5\u53e3\uff0cdockershim\u63a5\u53e3\u4e00\u65e6\u5f03\u7528\uff0ckubelet\u53bb\u8c03\u7528CRL\u65f6\u5c31\u6ca1\u6709\u53ef\u4ee5\u4e0edocker\u5efa\u7acb\u8fde\u63a5\u7684\u4e00\u4e2a\u63a5\u53e3\uff0c\u4ece\u800c\u5bfc\u81f4k8s\u5f03\u7528docker\u5bb9\u5668\u3002")),(0,a.kt)("h3",{id:"13kubernetes\u96c6\u7fa4\u6240\u9700\u7684\u8bc1\u4e66"},"1.3.Kubernetes\u96c6\u7fa4\u6240\u9700\u7684\u8bc1\u4e66"),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"k8s\u6240\u6709\u7ec4\u4ef6\u5747\u91c7\u7528https\u52a0\u5bc6\u901a\u4fe1\uff0c\u8fd9\u4e9b\u7ec4\u4ef6\u4e00\u822c\u7531\u4e24\u5957\u6839\u8bc1\u4e66\u751f\u6210\uff1a\u4e00\u4e2a\u7528\u4e8ek8s apiserver\u4e00\u4e2a\u7528\u4e8eetcd\u6570\u636e\u5e93\u3002"),(0,a.kt)("p",{parentName:"blockquote"},"\u6309\u7167\u89d2\u8272\u6765\u5206\uff0c\u8bc1\u4e66\u5206\u4e3a\u7ba1\u7406\u8282\u70b9\u548c\u5de5\u4f5c\u8282\u70b9\u3002"),(0,a.kt)("ul",{parentName:"blockquote"},(0,a.kt)("li",{parentName:"ul"},"\u7ba1\u7406\u8282\u70b9\uff1a\u6307controller-manager\u548cscheduler\u8fde\u63a5apiserver\u6240\u9700\u7684\u5ba2\u6237\u7aef\u8bc1\u4e66\u3002"),(0,a.kt)("li",{parentName:"ul"},"\u5de5\u4f5c\u8282\u70b9\uff1a\u6307kubelet\u548ckube-proxy\u8fde\u63a5apiserver\u6240\u9700\u8981\u7684\u5ba2\u6237\u7aef\u8bc1\u4e66\uff0c\u800c\u4e00\u822c\u90fd\u4f1a\u542f\u7528Bootstrap TLS\u673a\u5236\uff0c\u6240\u4ee5kubelet\u7684\u8bc1\u4e66\u521d\u6b21\u542f\u52a8\u4f1a\u5411apiserver\u7533\u8bf7\u9881\u53d1\u8bc1\u4e66\uff0c\u7531controller-manager\u7ec4\u4ef6\u81ea\u52a8\u9881\u53d1\u3002"),(0,a.kt)("li",{parentName:"ul"},"\u56fe\u4e2d\u7ea2\u7ebf\u662fk8s\u5404\u4e2a\u7ec4\u4ef6\u901a\u8fc7\u643a\u5e26k8s\u81ea\u5efa\u8bc1\u4e66\u9881\u53d1\u673a\u6784\u751f\u6210\u7684\u5ba2\u6237\u7aef\u8bc1\u4e66\u8bbf\u95eeapiserver\uff0c\u56fe\u4e2d\u84dd\u7ebf\u662fk8sapiserver\u7ec4\u4ef6\u901a\u8fc7etcd\u9881\u53d1\u7684\u5ba2\u6237\u7aef\u8bc1\u4e66\u4e0eetcd\u5efa\u7acb\u8fde\u63a5\u3002")),(0,a.kt)("p",{parentName:"blockquote"},(0,a.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/3b600f8680a443168cb556a183c19b3f.png",alt:"\u8bf7\u6dfb\u52a0\u56fe\u7247\u63cf\u8ff0"}))),(0,a.kt)("h3",{id:"14\u73af\u5883\u51c6\u5907"},"1.4.\u73af\u5883\u51c6\u5907"),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:null},"\u89d2\u8272"),(0,a.kt)("th",{parentName:"tr",align:null},"IP"),(0,a.kt)("th",{parentName:"tr",align:null},"\u7ec4\u4ef6"))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"binary-k8s-master1"),(0,a.kt)("td",{parentName:"tr",align:null},"192.168.20.10"),(0,a.kt)("td",{parentName:"tr",align:null},"kube-apiserver\u3001kube-controller-manage\u3001kube-scheduler\u3001kubelet\u3001kube-proxy\u3001docker\u3001etcd\u3001nginx\u3001keepalived")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"binary-k8s-master2"),(0,a.kt)("td",{parentName:"tr",align:null},"192.168.20.11"),(0,a.kt)("td",{parentName:"tr",align:null},"kube-apiserver\u3001kube-controller-manage\u3001kube-scheduler\u3001kubelet\u3001kube-proxy\u3001docker\u3001nginx\u3001keepalived\u3001etcd\uff08\u6269\u5bb9\u8282\u70b9\uff09")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"binary-k8s-node1"),(0,a.kt)("td",{parentName:"tr",align:null},"192.168.20.12"),(0,a.kt)("td",{parentName:"tr",align:null},"kubelet\u3001kube-proxy\u3001docker\u3001etcd")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"binary-k8s-node2"),(0,a.kt)("td",{parentName:"tr",align:null},"192.168.20.13"),(0,a.kt)("td",{parentName:"tr",align:null},"kubelet\u3001kube-proxy\u3001docker\u3001etcd")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"\u8d1f\u8f7d\u5747\u8861\u5668IP"),(0,a.kt)("td",{parentName:"tr",align:null},"192.168.20.9"),(0,a.kt)("td",{parentName:"tr",align:null},"\uff08\u4f5c\u7528\u4e8ekube-apiserver\u7684\u5730\u5740\uff09")))),(0,a.kt)("p",null,"\u9996\u5148\u90e8\u7f72\u4e00\u5957\u5355master\u8282\u70b9\u7684kubernetes\u96c6\u7fa4\uff0c\u7136\u540e\u5728\u589e\u52a0\u4e00\u53f0master\u8282\u70b9\uff0c\u5f62\u6210\u9ad8\u53ef\u7528\u96c6\u7fa4\u3002"),(0,a.kt)("p",null,"\u5355master\u8282\u70b9\u7684kubernetes\u96c6\u7fa4\u670d\u52a1\u5668\u89c4\u5212\u3002"),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:null},"\u89d2\u8272"),(0,a.kt)("th",{parentName:"tr",align:null},"IP"),(0,a.kt)("th",{parentName:"tr",align:null},"\u7ec4\u4ef6"))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"binary-k8s-master1"),(0,a.kt)("td",{parentName:"tr",align:null},"192.168.20.10"),(0,a.kt)("td",{parentName:"tr",align:null},"kube-apiserver\u3001kube-controller-manage\u3001kube-schedule\u3001etcd")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"binary-k8s-node1"),(0,a.kt)("td",{parentName:"tr",align:null},"192.168.20.12"),(0,a.kt)("td",{parentName:"tr",align:null},"kubelet\u3001kube-proxy\u3001docker\u3001etcd")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"binary-k8s-node2"),(0,a.kt)("td",{parentName:"tr",align:null},"192.168.20.13"),(0,a.kt)("td",{parentName:"tr",align:null},"kubelet\u3001kube-proxy\u3001docker\u3001etcd")))),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/ea0354a4d3cc4b6397ee9397f42e35dc.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,a.kt)("h3",{id:"15\u5b89\u88c5cfssl\u8bc1\u4e66\u751f\u6210\u5de5\u5177"},"1.5.\u5b89\u88c5cfssl\u8bc1\u4e66\u751f\u6210\u5de5\u5177"),(0,a.kt)("p",null,"cfssl\u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u8bc1\u4e66\u7ba1\u7406\u5de5\u5177\uff0c\u4f7f\u7528json\u6587\u4ef6\u751f\u6210\u8bc1\u4e66\uff0c\u76f8\u6bd4openssl\u66f4\u65b9\u4fbf\u4f7f\u7528\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"[root@binary-k8s-master1 ~]\\# wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64\n[root@binary-k8s-master1 ~]\\# wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64\n[root@binary-k8s-master1 ~]\\# wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64\n\n[root@binary-k8s-master1 ~]\\# chmod +x cfssl_linux-amd64 cfssljson_linux-amd64 cfssl-certinfo_linux-amd64\n\n[root@binary-k8s-master1 ~]\\# mv cfssl_linux-amd64 /usr/local/bin/cfssl\n[root@binary-k8s-master1 ~]\\# mv cfssljson_linux-amd64 /usr/local/bin/cfssljson\n[root@binary-k8s-master1 ~]\\# mv cfssl-certinfo_linux-amd64 /usr/bin/cfssl-certinfo\n")),(0,a.kt)("h2",{id:"2\u64cd\u4f5c\u7cfb\u7edf\u521d\u59cb\u5316\u914d\u7f6e"},"2.\u64cd\u4f5c\u7cfb\u7edf\u521d\u59cb\u5316\u914d\u7f6e"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"1.\u5173\u95ed\u9632\u706b\u5899\nsystemctl stop firewalld \nsystemctl disable firewalld\n\n2.\u5173\u95edselinux\nsed -i 's/enforcing/disabled/' /etc/selinux/config \nsetenforce 0 \n\n3.\u5173\u95ed\u4ea4\u6362\u5206\u533a\nswapoff -a\nsed -ri 's/.*swap.*/#&/' /etc/fstab\n\n4.\u914d\u7f6ehosts\ncat >> /etc/hosts << EOF \n192.168.20.10 binary-k8s-master1\n192.168.20.12 binary-k8s-node1\n192.168.20.13 binary-k8s-node2\nEOF\n\n5.\u4f18\u5316\u5185\u6838\u53c2\u6570\ncat > /etc/sysctl.d/k8s.conf << EOF \nnet.bridge.bridge-nf-call-ip6tables = 1 \nnet.bridge.bridge-nf-call-iptables = 1 \nEOF\nsysctl --system\n")),(0,a.kt)("h2",{id:"3\u90e8\u7f72etcd\u96c6\u7fa4"},"3.\u90e8\u7f72Etcd\u96c6\u7fa4"),(0,a.kt)("p",null,"etcd\u662f\u4e00\u4e2a\u5206\u5e03\u5f0f\u952e\u503c\u5b58\u50a8\u7cfb\u7edf\uff0ckubernetes\u4f7f\u7528etcd\u8fdb\u884c\u6570\u636e\u5b58\u50a8\uff0c\u4e3a\u89e3\u51b3etcd\u5355\u70b9\u6545\u969c\uff0c\u91c7\u7528\u96c6\u7fa4\u65b9\u5f0f\u90e8\u7f72\uff0c3\u53f0\u7ec4\u7ec4\u5efa\u96c6\u7fa4\uff0c\u53ef\u4ee5\u574f1\u53f0\uff0c\u5982\u679c\u67095\u53f0\u53ef\u4ee5\u574f2\u53f0\u3002"),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:null},"\u8282\u70b9\u540d\u79f0"),(0,a.kt)("th",{parentName:"tr",align:null},"IP"))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"etcd-1"),(0,a.kt)("td",{parentName:"tr",align:null},"192.168.20.10")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"etcd-2"),(0,a.kt)("td",{parentName:"tr",align:null},"192.168.20.12")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"etcd-3"),(0,a.kt)("td",{parentName:"tr",align:null},"192.168.20.13")))),(0,a.kt)("h3",{id:"31\u4f7f\u7528cfssl\u8bc1\u4e66\u5de5\u5177\u751f\u6210etcd\u8bc1\u4e66"},"3.1.\u4f7f\u7528cfssl\u8bc1\u4e66\u5de5\u5177\u751f\u6210etcd\u8bc1\u4e66"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"1.\u751f\u6210CA\u81ea\u7b7e\u9881\u53d1\u673a\u6784\u8bc1\u4e66")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'[root@binary-k8s-master1 ~/TLS/etcd]\\# vim ca-config.json\n{\n  "signing": {\n    "default": {\n      "expiry": "87600h"\n    },\n    "profiles": {\n      "www": {\n         "expiry": "87600h",\n         "usages": [\n            "signing",\n            "key encipherment",\n            "server auth",\n            "client auth"\n        ]\n      }\n    }\n  }\n}\n\n[root@binary-k8s-master1 ~/TLS/etcd]\\# vim ca-csr.json\n{\n    "CN": "etcd CA",\n    "key": {\n        "algo": "rsa",\n        "size": 2048\n    },\n    "names": [\n        {\n            "C": "CN",\n            "L": "Beijing",\n            "ST": "Beijing"\n        }\n    ]\n}\n\n\n[root@binary-k8s-master1 ~/TLS/etcd]\\# cfssl gencert -initca ca-csr.json | cfssljson -bare ca -\n2021/08/27 17:16:49 [INFO] generating a new CA key and certificate from CSR\n2021/08/27 17:16:49 [INFO] generate received request\n2021/08/27 17:16:49 [INFO] received CSR\n2021/08/27 17:16:49 [INFO] generating key: rsa-2048\n2021/08/27 17:16:49 [INFO] encoded CSR\n2021/08/27 17:16:49 [INFO] signed certificate with serial number 595276170535764345591605360849177409156623041535\n\n')),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"2.\u4f7f\u7528\u81ea\u7b7eCA\u7b7e\u53d1Etcd HTTPS\u8bc1\u4e66")),(0,a.kt)("p",null,"\u7533\u8bf7\u8bc1\u4e66\u7684json\u6587\u4ef6\u4e2d\u6709\u4e00\u4e2ahosts\u5b57\u6bb5\uff0c\u8fd9\u4e2a\u5b57\u6bb5\u7684\u503c\u5c31\u662fetcd\u96c6\u7fa4\u7684IP\u5730\u5740\uff0c\u53ef\u4ee5\u591a\u5199\u51e0\u4e2aIP\uff0c\u4f5c\u4e3a\u9884\u7559IP\uff0c\u65b9\u4fbf\u6269\u5bb9etcd\u96c6\u7fa4\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'1.\u521b\u5efa\u8bc1\u4e66\u7533\u8bf7\u6587\u4ef6\n[root@binary-k8s-master1 ~/TLS/etcd]\\# vim server-csr.json\n{\n    "CN": "etcd",\n    "hosts": [\n    "192.168.20.10",\n    "192.168.20.11",            #\u9884\u7559ip\n    "192.168.20.12",\n    "192.168.20.13"\n    ],\n    "key": {\n        "algo": "rsa",\n        "size": 2048\n    },\n    "names": [\n        {\n            "C": "CN",\n            "L": "BeiJing",\n            "ST": "BeiJing"\n        }\n    ]\n}\n\n2.\u751f\u6210\u8bc1\u4e66\n[root@binary-k8s-master1 ~/TLS/etcd]\\# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=www server-csr.json | cfssljson -bare server\n2021/08/27 17:17:08 [INFO] generate received request\n2021/08/27 17:17:08 [INFO] received CSR\n2021/08/27 17:17:08 [INFO] generating key: rsa-2048\n2021/08/27 17:17:08 [INFO] encoded CSR\n2021/08/27 17:17:08 [INFO] signed certificate with serial number 390637014214409356442509482537912246480465374076\n2021/08/27 17:17:08 [WARNING] This certificate lacks a "hosts" field. This makes it unsuitable for\nwebsites. For more information see the Baseline Requirements for the Issuance and Management\nof Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);\nspecifically, section 10.2.3 ("Information Requirements").\n')),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"3.\u67e5\u770b\u751f\u4ea7\u7684\u8bc1\u4e66\u6587\u4ef6")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"[root@binary-k8s-master1 ~/TLS/etcd]\\# ll\n\u603b\u7528\u91cf 36\n-rw-r--r--. 1 root root  288 8\u6708  27 17:16 ca-config.json\n-rw-r--r--. 1 root root  956 8\u6708  27 17:16 ca.csr\n-rw-r--r--. 1 root root  210 8\u6708  27 17:16 ca-csr.json\n-rw-------. 1 root root 1675 8\u6708  27 17:16 ca-key.pem\n-rw-r--r--. 1 root root 1265 8\u6708  27 17:16 ca.pem\n-rw-r--r--. 1 root root 1021 8\u6708  27 17:17 server.csr\n-rw-r--r--. 1 root root  311 8\u6708  27 17:17 server-csr.json\n-rw-------. 1 root root 1679 8\u6708  27 17:17 server-key.pem\n-rw-r--r--. 1 root root 1346 8\u6708  27 17:17 server.pem\n")),(0,a.kt)("h3",{id:"32\u90e8\u7f72etcd\u96c6\u7fa4"},"3.2.\u90e8\u7f72etcd\u96c6\u7fa4"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"1.\u4e0b\u8f7detcd\u4e8c\u8fdb\u5236\u6587\u4ef6")),(0,a.kt)("p",null,"\u4e0b\u8f7d\u5730\u5740\uff1a",(0,a.kt)("a",{parentName:"p",href:"https://github.com/etcd-io/etcd/releases/download/v3.4.9/etcd-v3.4.9-linux-amd64.tar.gz"},"https://github.com/etcd-io/etcd/releases/download/v3.4.9/etcd-v3.4.9-linux-amd64.tar.gz")),(0,a.kt)("p",null,"\u90e8\u7f72\u4e8c\u8fdb\u5236\u7684\u7a0b\u5e8f\u96c6\u7fa4\u6700\u7b80\u5355\u7684\u65b9\u5f0f\u5c31\u662f\u5728\u5176\u4e2d\u4e00\u53f0\u4e0a\u9762\u90e8\u7f72\uff0c\u7136\u540e\u5c06\u6240\u6709\u7684\u6587\u4ef6scp\u5230\u5176\u4ed6\u673a\u5668\u4e0a\u4fee\u6539\u914d\u7f6e\uff0c\u4e00\u5957\u96c6\u7fa4\u4e5f\u5c31\u5b8c\u6210\u4e86\u3002"),(0,a.kt)("p",null,"\u5c06\u4e0b\u8f7d\u597d\u7684\u6587\u4ef6\u4e0a\u4f20\u81f3\u6240\u6709etcd\u8282\u70b9\u3002"),(0,a.kt)("p",null,"etcd\u914d\u7f6e\u6587\u4ef6\u89e3\u91ca"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'#[Member]\nETCD_NAME="etcd-1"                          #\u8282\u70b9\u540d\u79f0\nETCD_DATA_DIR="/data/etcd/data"                 #\u6570\u636e\u76ee\u5f55\nETCD_LISTEN_PEER_URLS="https://192.168.20.10:2380"          #\u96c6\u7fa4\u901a\u4fe1\u5730\u5740\nETCD_LISTEN_CLIENT_URLS="https://192.168.20.10:2379,http://127.0.0.1:2379"      #\u5ba2\u6237\u7aef\u8bbf\u95ee\u7684\u76d1\u542c\u5730\u5740\uff0c\u5728\u8fd9\u91cc\u52a0\u4e00\u4e2ahttp://127.0.0.1:2379\uff0c\u5728\u5f53\u524d\u8282\u70b9\u67e5\u96c6\u7fa4\u4fe1\u606f\u65f6\u5c31\u4e0d\u9700\u8981\u6307\u5b9a\u8bc1\u4e66\u53bb\u67e5\u8be2\u4e86\n    \n#[Clustering]\nETCD_INITIAL_ADVERTISE_PEER_URLS="https://192.168.20.10:2380"           #\u96c6\u7fa4\u901a\u544a\u5730\u5740\nETCD_ADVERTISE_CLIENT_URLS="https://192.168.20.10:2379,http://127.0.0.1:2379"                   #\u5ba2\u6237\u7aef\u901a\u544a\u5730\u5740\uff0c\uff0c\u5728\u8fd9\u91cc\u52a0\u4e00\u4e2ahttp://127.0.0.1:2379\uff0c\u5728\u5f53\u524d\u8282\u70b9\u67e5\u96c6\u7fa4\u4fe1\u606f\u65f6\u5c31\u4e0d\u9700\u8981\u6307\u5b9a\u8bc1\u4e66\u53bb\u67e5\u8be2\u4e86\nETCD_INITIAL_CLUSTER="etcd-1=https://192.168.20.10:2380,etcd-2=https://192.168.20.12:2380,etcd-3=https://192.168.20.13:2380"                        #\u96c6\u7fa4\u8282\u70b9\u5730\u5740\nETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster"               #\u96c6\u7fa4\u7684\u552f\u4e00\u6807\u8bc6\nETCD_INITIAL_CLUSTER_STATE="new"                        #\u52a0\u5165\u96c6\u7fa4\u7684\u72b6\u6001\uff0cnew\u4e3a\u65b0\u96c6\u7fa4\uff0cexisting\u8868\u793a\u52a0\u5165\u73b0\u6709\u96c6\u7fa4\n\n')),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"2.\u90e8\u7f72etcd-1\u8282\u70b9")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'1.\u521b\u5efa\u7a0b\u5e8f\u76ee\u5f55\n[root@binary-k8s-master1 ~]\\# mkdir /data/etcd/{bin,conf,ssl,data} -p\n\n2.\u89e3\u538b\u4e8c\u8fdb\u5236\u6587\u4ef6\n[root@binary-k8s-master1 ~]\\# tar xf etcd-v3.4.9-linux-amd64.tar.gz\n\n3.\u5c06\u4e8c\u8fdb\u5236\u547d\u4ee4\u79fb\u52a8\u5230\u5236\u5b9a\u51fa\u7a0b\u5e8f\u76ee\u5f55\n[root@binary-k8s-master1 ~]\\# mv etcd-v3.4.9-linux-amd64/etcd* /data/etcd/bin/\n\n4.\u7f16\u8f91\u914d\u7f6e\u6587\u4ef6\n[root@binary-k8s-master1 ~]\\# vim /data/etcd/conf/etcd.conf \n#[Member]\nETCD_NAME="etcd-1"\nETCD_DATA_DIR="/data/etcd/data"\nETCD_LISTEN_PEER_URLS="https://192.168.20.10:2380"\nETCD_LISTEN_CLIENT_URLS="https://192.168.20.10:2379,http://127.0.0.1:2379"\n\n#[Clustering]\nETCD_INITIAL_ADVERTISE_PEER_URLS="https://192.168.20.10:2380"\nETCD_ADVERTISE_CLIENT_URLS="https://192.168.20.10:2379,http://127.0.0.1:2379"\nETCD_INITIAL_CLUSTER="etcd-1=https://192.168.20.10:2380,etcd-2=https://192.168.20.12:2380,etcd-3=https://192.168.20.13:2380"\nETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster"\nETCD_INITIAL_CLUSTER_STATE="new"\n\n5.\u7f16\u5199systemctl\u63a7\u5236\u811a\u672c\n[root@binary-k8s-master1 ~]\\# vim /usr/lib/systemd/system/etcd.service\n[Unit]\nDescription=Etcd Server\nAfter=network.target\nAfter=network-online.target\nWants=network-online.target\n\n[Service]\nType=notify\nEnvironmentFile=/data/etcd/conf/etcd.conf\nExecStart=/data/etcd/bin/etcd \\\n--cert-file=/data/etcd/ssl/server.pem \\\n--key-file=/data/etcd/ssl/server-key.pem \\\n--peer-cert-file=/data/etcd/ssl/server.pem \\\n--peer-key-file=/data/etcd/ssl/server-key.pem \\\n--trusted-ca-file=/data/etcd/ssl/ca.pem \\\n--peer-trusted-ca-file=/data/etcd/ssl/ca.pem \\\n--logger=zap\nRestart=on-failure\nLimitNOFILE=65536\n\n[Install]\nWantedBy=multi-user.target\n\n6.\u590d\u5236\u8bc1\u4e66\u6587\u4ef6\n[root@binary-k8s-master1 ~]\\# cp TLS/etcd/*.pem /data/etcd/ssl/\n\n7.\u542f\u52a8etcd-1\u8282\u70b9\n[root@binary-k8s-master1 ~]\\# systemctl daemon-reload\n[root@binary-k8s-master1 ~]\\# systemctl start etcd\n[root@binary-k8s-master1 ~]\\# systemctl enable etcd\n\n#\u7b2c\u4e00\u4e2a\u8282\u70b9\u542f\u52a8\u4f1a\u4e00\u76f4\u5904\u4e8e\u5176\u4e2d\u4e2d\u7684\u72b6\u6001\uff0c\u53ea\u6709\u5f53\u7b2c\u4e8c\u4e2a\u8282\u70b9\u4e5f\u542f\u52a8\u4e86\uff0c\u7b2c\u4e00\u4e2a\u8282\u70b9\u624d\u80fd\u542f\u52a8\u6210\u529f\uff0c\u56e0\u4e3a\u96c6\u7fa4\u7248\u7684etcd\u81f3\u5c11\u9700\u89812\u4e2a\u8282\u70b9\u624d\u80fd\u6210\u529f\u8fd0\u884c\n')),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"3.\u914d\u7f6eetcd-2\u8282\u70b9\u548cetcd-3\u8282\u70b9")),(0,a.kt)("p",null,"\u90e8\u7f72\u5b8c\u4e00\u4e2a\u8282\u70b9\uff0c\u53ef\u4ee5\u76f4\u63a5\u5c06\u76ee\u5f55\u62f7\u8d1d\u81f3\u5176\u4ed6\u8282\u70b9\uff0c\u7701\u53bb\u5b89\u88c5\u7684\u4e00\u4e9b\u6b65\u9aa4\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'1.\u63a8\u9001etcd\u76ee\u5f55\n[root@binary-k8s-master1 ~]\\# scp -rp /data/etcd root@192.168.20.12:/data\n[root@binary-k8s-master1 ~]\\# scp -rp /data/etcd root@192.168.20.13:/data\n\n2.\u63a8\u9001systemctl\u542f\u52a8\u6587\u4ef6\n[root@binary-k8s-master1 ~]\\# scp -rp /usr/lib/systemd/system/etcd.service root@192.168.20.12:/usr/lib/systemd/system/\n[root@binary-k8s-master1 ~]\\# scp -rp /usr/lib/systemd/system/etcd.service root@192.168.20.13:/usr/lib/systemd/system/\n\n3.\u4fee\u6539etcd-2\u914d\u7f6e\u6587\u4ef6\n[root@binary-k8s-node1 ~]\\# vim /data/etcd/conf/etcd.conf \n#[Member]\nETCD_NAME="etcd-2"\nETCD_DATA_DIR="/data/etcd/data"\nETCD_LISTEN_PEER_URLS="https://192.168.20.12:2380"\nETCD_LISTEN_CLIENT_URLS="https://192.168.20.12:2379,http://127.0.0.1:2379"\n\n#[Clustering]\nETCD_INITIAL_ADVERTISE_PEER_URLS="https://192.168.20.12:2380"\nETCD_ADVERTISE_CLIENT_URLS="https://192.168.20.12:2379,http://127.0.0.1:2379"\nETCD_INITIAL_CLUSTER="etcd-1=https://192.168.20.10:2380,etcd-2=https://192.168.20.12:2380,etcd-3=https://192.168.20.13:2380"\nETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster"\nETCD_INITIAL_CLUSTER_STATE="new"\n\n4.\u4fee\u6539etcd-3\u914d\u7f6e\u6587\u4ef6\n[root@binary-k8s-node2 ~]\\# vim /data/etcd/conf/etcd.conf \n#[Member]\nETCD_NAME="etcd-3"\nETCD_DATA_DIR="/data/etcd/data"\nETCD_LISTEN_PEER_URLS="https://192.168.20.13:2380"\nETCD_LISTEN_CLIENT_URLS="https://192.168.20.13:2379,http://127.0.0.1:2379"\n\n#[Clustering]\nETCD_INITIAL_ADVERTISE_PEER_URLS="https://192.168.20.13:2380"\nETCD_ADVERTISE_CLIENT_URLS="https://192.168.20.13:2379,http://127.0.0.1:2379"\nETCD_INITIAL_CLUSTER="etcd-1=https://192.168.20.10:2380,etcd-2=https://192.168.20.12:2380,etcd-3=https://192.168.20.13:2380"\nETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster"\nETCD_INITIAL_CLUSTER_STATE="new"\n\n5.\u542f\u52a8etcd-1\u548cetcd-2\n[root@binary-k8s-node1 ~]\\# systemctl daemon-reload\n[root@binary-k8s-node1 ~]\\# systemctl start etcd\n[root@binary-k8s-node1 ~]\\# systemctl enable etcd\n------------\n[root@binary-k8s-node2 ~]\\# systemctl daemon-reload\n[root@binary-k8s-node2 ~]\\# systemctl start etcd\n[root@binary-k8s-node2 ~]\\# systemctl enable etcd\n')),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"4.\u67e5\u770b\u96c6\u7fa4\u72b6\u6001"),(0,a.kt)("br",{parentName:"p"}),"\n","etcd-1\u542f\u52a8\u65f6\u4f1a\u4e00\u76f4\u5904\u4e8e\u7b49\u5f85\u72b6\u6001\uff0c\u5f53etcd-2\u6267\u884c\u542f\u52a8\u547d\u4ee4\u65f6\u4f1a\u7acb\u5373\u542f\u52a8\u6210\u529f\uff0c\u5e76\u4e14etcd-1\u4e5f\u4f1a\u7acb\u523b\u542f\u52a8\u6210\u529f\u3002"),(0,a.kt)("p",null,"\u67e5\u770betcd\u7684\u65e5\u5fd7\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e2a\u547d\u4ee4\uff1a",(0,a.kt)("inlineCode",{parentName:"p"},"[root@binary-k8s-master1 ~]\\# journalctl -u etcd -f")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'1.\u67e5\u770b\u670d\u52a1\u7aef\u53e3\n[root@binary-k8s-master1 ~]\\# netstat -lnpt | grep etcd\ntcp        0      0 192.168.20.10:2379      0.0.0.0:*               LISTEN      9625/etcd           \ntcp        0      0 192.168.20.10:2380      0.0.0.0:*               LISTEN      9625/etcd\n\n2.\u67e5\u770b\u96c6\u7fa4\u72b6\u6001\n#\u5982\u679c\u914d\u7f6e\u6587\u4ef6\u4e2d2379\u7aef\u53e3\u6ca1\u6709\u52a0\u4e00\u4e2a127.0.0.1\u5219\u8fd9\u6837\u67e5\u770b\u96c6\u7fa4\u72b6\u6001\n[root@binary-k8s-master1 ~]\\# ETCDCTL_API=3 /data/etcd/bin/etcdctl --cacert=/data/etcd/ssl/ca.pem --cert=/data/etcd/ssl/server.pem --key=/data/etcd/ssl/server-key.pem --endpoints="https://192.168.20.10:2379,https://192.168.20.12:2379,https://192.168.20.13:2379" endpoint health --write-out=table\n+----------------------------+--------+-------------+-------+\n|          ENDPOINT          | HEALTH |    TOOK     | ERROR |\n+----------------------------+--------+-------------+-------+\n| https://192.168.20.10:2379 |   true | 32.322714ms |       |\n| https://192.168.20.12:2379 |   true | 31.524079ms |       |\n| https://192.168.20.13:2379 |   true | 38.985949ms |       |\n+----------------------------+--------+-------------+-------+\n#\u5982\u679c\u914d\u7f6e\u6587\u4ef6\u6c47\u603b2379\u7aef\u53e3\u52a0\u4e86\u4e00\u4e2a127.0.0.1\u5219\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u65b9\u5f0f\u67e5\u770b\u96c6\u7fa4\u4fe1\u606f\u65e0\u9700\u6307\u5b9a\u8bc1\u4e66\n[root@binary-k8s-master1 /data/etcd/conf]\\#  /data/etcd/bin/etcdctl member list --write-out=table\n+------------------+---------+--------+----------------------------+---------------------------------------------------+------------+\n|        ID        | STATUS  |  NAME  |         PEER ADDRS         |                   CLIENT ADDRS                    | IS LEARNER |\n+------------------+---------+--------+----------------------------+---------------------------------------------------+------------+\n| 12446003b2a53d43 | started | etcd-2 | https://192.168.20.12:2380 | https://127.0.0.1:2379,https://192.168.20.12:2379 |      false |\n| 51ae3f86f3783687 | started | etcd-1 | https://192.168.20.10:2380 |  http://127.0.0.1:2379,https://192.168.20.10:2379 |      false |\n| 667c9c7ba890c3f7 | started | etcd-3 | https://192.168.20.13:2380 |  http://127.0.0.1:2379,https://192.168.20.13:2379 |      false |\n+------------------+---------+--------+----------------------------+---------------------------------------------------+------------+\n')),(0,a.kt)("p",null,"\u914d\u7f6e\u6587\u4ef6\u72b6\u6001",(0,a.kt)("br",{parentName:"p"}),"\n",(0,a.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/da2f8ef902c04e77a4e555d67cc32273.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,a.kt)("p",null,"etcd\u542f\u52a8\u6210\u529f\u7684\u65e5\u5fd7"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/25e40829361b4c78b782ae1b180a90b7.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,a.kt)("h2",{id:"4\u90e8\u7f72docker\u670d\u52a1"},"4.\u90e8\u7f72Docker\u670d\u52a1"),(0,a.kt)("p",null,"\u6240\u6709kubernetes\u8282\u70b9\u90fd\u9700\u8981\u5b89\u88c5docker\u670d\u52a1\uff0c\u5305\u62ecmaster\u548cnode\u8282\u70b9\u3002"),(0,a.kt)("p",null,"docker\u4e8c\u8fdb\u5236\u6587\u4ef6\u4e0b\u8f7d\u5730\u5740\uff1a",(0,a.kt)("a",{parentName:"p",href:"https://download.docker.com/linux/static/stable/x86%5C_64/docker-19.03.9.tgz"},"https://download.docker.com/linux/static/stable/x86\\_64/docker-19.03.9.tgz")),(0,a.kt)("h3",{id:"41\u5b89\u88c5docker"},"4.1.\u5b89\u88c5docker"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'1.\u89e3\u538b\u4e8c\u8fdb\u5236\u5305\ntar zxf docker-19.03.9.tgz\n\n2.\u5c06\u53ef\u6267\u884c\u547d\u4ee4\u79fb\u52a8\u5230\u7cfb\u7edf\u8def\u5f84\nmv docker/* /usr/bin\n\n3.\u521b\u5efa\u914d\u7f6e\u6587\u4ef6\nmkdir /etc/docker\nvim /etc/docker/daemon.json\n{\n  "registry-mirrors": ["https://9wn5tbfh.mirror.aliyuncs.com"]\n}\n')),(0,a.kt)("h3",{id:"42\u4e3adocker\u521b\u5efasystemctl\u542f\u52a8\u811a\u672c"},"4.2.\u4e3adocker\u521b\u5efasystemctl\u542f\u52a8\u811a\u672c"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"1.\u7f16\u5199\u542f\u52a8\u811a\u672c\nvim /usr/lib/systemd/system/docker.service\n[Unit]\nDescription=Docker Application Container Engine\nDocumentation=https://docs.docker.com\nAfter=network-online.target firewalld.service\nWants=network-online.target\n\n[Service]\nType=notify\nExecStart=/usr/bin/dockerd\nExecReload=/bin/kill -s HUP \nLimitNOFILE=infinity\nLimitNPROC=infinity\nLimitCORE=infinity\nTimeoutStartSec=0\nDelegate=yes\nKillMode=process\nRestart=on-failure\nStartLimitBurst=3\nStartLimitInterval=60s\n\n[Install]\nWantedBy=multi-user.target\n\n2.\u542f\u52a8docker\nsystemctl daemon-reload \nsystemctl start docker\nsystemctl enable docker\n")),(0,a.kt)("h2",{id:"5\u90e8\u7f72kubernetes-master\u8282\u70b9"},"5.\u90e8\u7f72kubernetes master\u8282\u70b9"),(0,a.kt)("p",null,"\u90e8\u7f72\u4e8c\u8fdb\u5236\u7684kubernetes\u7ec4\u4ef6\u5927\u81f4\u53ef\u5206\u4e3a\u5982\u4e0b\u51e0\u4e2a\u6b65\u9aa4\uff1a"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"1.\u89e3\u538b\u4e8c\u8fdb\u5236\u6587\u4ef6"),(0,a.kt)("li",{parentName:"ul"},"2.\u590d\u5236\u4e8c\u8fdb\u5236\u7a0b\u5e8f\u5230\u6307\u5b9a\u76ee\u5f55"),(0,a.kt)("li",{parentName:"ul"},"3.\u521b\u5efa\u7ec4\u4ef6\u914d\u7f6e\u6587\u4ef6"),(0,a.kt)("li",{parentName:"ul"},"4.\u751f\u6210\u7ec4\u4ef6\u7684kubeconfig\u6587\u4ef6"),(0,a.kt)("li",{parentName:"ul"},"5.\u521b\u5efasystemctl\u811a\u672c\u7ba1\u7406\u670d\u52a1"),(0,a.kt)("li",{parentName:"ul"},"6.\u542f\u52a8\u7ec4\u4ef6")),(0,a.kt)("p",null,"kubernetes\u96c6\u7fa4\u7684master\u8282\u70b9\u548cnode\u8282\u70b9\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u90fd\u4ecegithub\u4e0a\u4e0b\u8f7d\uff0cmaster\u548cnode\u76f8\u5173\u7684\u6240\u6709\u7ec4\u4ef6\u90fd\u5728\u4e00\u4e2a\u7a0b\u5e8f\u5305\u4e2d\u3002"),(0,a.kt)("p",null,"\u4e0b\u8f7d\u5730\u5740\uff1a ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.20.md"},"https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.20.md")),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/36b71f10da9442808c7a950d2dedd254.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,a.kt)("h3",{id:"51\u4f7f\u7528cfssl\u751f\u6210apiserver\u7684\u8bc1\u4e66\u6587\u4ef6"},"5.1.\u4f7f\u7528cfssl\u751f\u6210apiserver\u7684\u8bc1\u4e66\u6587\u4ef6"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"1.\u751f\u6210CA\u81ea\u7b7e\u9881\u53d1\u673a\u6784\u8bc1\u4e66")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'1.\u51c6\u5907CA\u914d\u7f6e\u6587\u4ef6\n[root@binary-k8s-master1 ~/TLS/k8s]\\# vim ca-config.json\n{\n  "signing": {\n    "default": {\n      "expiry": "87600h"\n    },\n    "profiles": {\n      "kubernetes": {\n         "expiry": "87600h",\n         "usages": [\n            "signing",\n            "key encipherment",\n            "server auth",\n            "client auth"\n        ]\n      }\n    }\n  }\n}\n[root@binary-k8s-master1 ~/TLS/k8s]\\# vim ca-csr.json\n{\n    "CN": "kubernetes",\n    "key": {\n        "algo": "rsa",\n        "size": 2048\n    },\n    "names": [\n        {\n            "C": "CN",\n            "L": "Beijing",\n            "ST": "Beijing",\n            "O": "k8s",\n            "OU": "System"\n        }\n    ]\n}\n\n2.\u751f\u6210\u8bc1\u4e66\u6587\u4ef6\n[root@binary-k8s-master1 ~/TLS/k8s]\\# cfssl gencert -initca ca-csr.json | cfssljson -bare ca -\n2021/09/01 16:20:42 [INFO] generating a new CA key and certificate from CSR\n2021/09/01 16:20:42 [INFO] generate received request\n2021/09/01 16:20:42 [INFO] received CSR\n2021/09/01 16:20:42 [INFO] generating key: rsa-2048\n2021/09/01 16:20:43 [INFO] encoded CSR\n2021/09/01 16:20:43 [INFO] signed certificate with serial number 90951268335404710707183639990677546638148434604\n')),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"2.\u4f7f\u7528\u81ea\u7b7eCA\u7b7e\u53d1apiserver HTTPS\u8bc1\u4e66")),(0,a.kt)("p",null,"\u7b7e\u53d1\u7684\u5ba2\u6237\u7aef\u8bc1\u4e66\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684hosts\u5b57\u6bb5\u8981\u5305\u542b\u6240\u6709Master/LB/VIP\u7684IP\u5730\u5740\uff0cNode\u8282\u70b9\u7684\u5730\u5740\u53ef\u5199\u53ef\u4e0d\u5199\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'1.\u51c6\u5907\u5ba2\u6237\u7aef\u914d\u7f6e\u6587\u4ef6\n[root@binary-k8s-master1 ~/TLS/k8s]\\# vim kube-apiserver-csr.json\n{\n    "CN": "kubernetes",\n    "hosts": [\n      "10.0.0.1",\n      "127.0.0.1",\n      "192.168.20.10",\n      "192.168.20.11",\n      "192.168.20.12",\n      "192.168.20.13",\n      "192.168.20.9",\n      "kubernetes",\n      "kubernetes.default",\n      "kubernetes.default.svc",\n      "kubernetes.default.svc.cluster",\n      "kubernetes.default.svc.cluster.local"\n    ],\n    "key": {\n        "algo": "rsa",\n        "size": 2048\n    },\n    "names": [\n        {\n            "C": "CN",\n            "L": "BeiJing",\n            "ST": "BeiJing",\n            "O": "k8s",\n            "OU": "System"\n        }\n    ]\n}\n\n2.\u751f\u6210\u8bc1\u4e66\u6587\u4ef6\n[root@binary-k8s-master1 ~/TLS/k8s]\\# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-apiserver-csr.json | cfssljson -bare kube-apiserver\n2021/09/01 16:30:24 [INFO] generate received request\n2021/09/01 16:30:24 [INFO] received CSR\n2021/09/01 16:30:24 [INFO] generating key: rsa-2048\n2021/09/01 16:30:25 [INFO] encoded CSR\n2021/09/01 16:30:25 [INFO] signed certificate with serial number 714472722509814799589567099679496298525490716083\n2021/09/01 16:30:25 [WARNING] This certificate lacks a "hosts" field. This makes it unsuitable for\nwebsites. For more information see the Baseline Requirements for the Issuance and Management\nof Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);\nspecifically, section 10.2.3 ("Information Requirements").\n')),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"3.\u67e5\u770b\u751f\u4ea7\u7684\u8bc1\u4e66\u6587\u4ef6")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"[root@binary-k8s-master1 ~/TLS/k8s]\\# ll\n\u603b\u7528\u91cf 36\n-rw-r--r--. 1 root root  294 9\u6708   1 16:20 ca-config.json\n-rw-r--r--. 1 root root 1001 9\u6708   1 16:20 ca.csr\n-rw-r--r--. 1 root root  264 9\u6708   1 16:20 ca-csr.json\n-rw-------. 1 root root 1679 9\u6708   1 16:20 ca-key.pem\n-rw-r--r--. 1 root root 1359 9\u6708   1 16:20 ca.pem\n-rw-r--r--. 1 root root 1277 9\u6708   1 16:30 kube-apiserver.csr\n-rw-r--r--. 1 root root  602 9\u6708   1 16:30 kube-apiserver-csr.json\n-rw-------. 1 root root 1679 9\u6708   1 16:30 kube-apiserver-key.pem\n-rw-r--r--. 1 root root 1643 9\u6708   1 16:30 kube-apiserver.pem\n")),(0,a.kt)("h3",{id:"52\u89e3\u538b\u4e8c\u8fdb\u5236\u6587\u4ef6\u590d\u5236\u76f8\u5173\u7ec4\u4ef6\u7a0b\u5e8f"},"5.2.\u89e3\u538b\u4e8c\u8fdb\u5236\u6587\u4ef6\u590d\u5236\u76f8\u5173\u7ec4\u4ef6\u7a0b\u5e8f"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"[root@binary-k8s-master1 ~]\\# mkdir /data/kubernetes/{bin,config,ssl,logs} -p\n[root@binary-k8s-master1 ~]\\# tar xf kubernetes-server-linux-amd64.tar.gz \n[root@binary-k8s-master1 ~]\\# cd kubernetes/server/bin/\n[root@binary-k8s-master1 ~/kubernetes/server/bin]\\# cp kube-apiserver kube-scheduler kube-controller-manager /data/kubernetes/bin/\n[root@binary-k8s-master1 ~/kubernetes/server/bin]\\# cp kubectl /usr/bin/\n")),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/e7c7eb9ad3ae4b0a8800c575d4e86023.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,a.kt)("h3",{id:"53\u90e8\u7f72kube-apiserver\u7ec4\u4ef6"},"5.3.\u90e8\u7f72kube-apiserver\u7ec4\u4ef6"),(0,a.kt)("h4",{id:"531\u521b\u5efakube-apiserver\u914d\u7f6e\u6587\u4ef6"},"5.3.1.\u521b\u5efakube-apiserver\u914d\u7f6e\u6587\u4ef6"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'[root@binary-k8s-master1 ~]\\# vim /data/kubernetes/config/kube-apiserver.conf\nKUBE_APISERVER_OPTS="--logtostderr=false \\\n--v=2 \\\n--log-dir=/data/kubernetes/logs \\\n--etcd-servers=https://192.168.20.10:2379,https://192.168.20.12:2379,https://192.168.20.13:2379 \\\n--bind-address=192.168.20.10 \\\n--secure-port=6443 \\\n--advertise-address=192.168.20.10 \\\n--allow-privileged=true \\\n--service-cluster-ip-range=10.0.0.0/24 \\\n--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,NodeRestriction \\\n--authorization-mode=RBAC,Node \\\n--enable-bootstrap-token-auth=true \\\n--token-auth-file=/data/kubernetes/config/token.csv \\\n--service-node-port-range=30000-32767 \\\n--kubelet-client-certificate=/data/kubernetes/ssl/kube-apiserver.pem \\\n--kubelet-client-key=/data/kubernetes/ssl/kube-apiserver-key.pem \\\n--tls-cert-file=/data/kubernetes/ssl/kube-apiserver.pem  \\\n--tls-private-key-file=/data/kubernetes/ssl/kube-apiserver-key.pem \\\n--client-ca-file=/data/kubernetes/ssl/ca.pem \\\n--service-account-key-file=/data/kubernetes/ssl/ca-key.pem \\\n--service-account-issuer=api \\\n--service-account-signing-key-file=/data/kubernetes/ssl/kube-apiserver-key.pem \\\n--etcd-cafile=/data/etcd/ssl/ca.pem \\\n--etcd-certfile=/data/etcd/ssl/server.pem \\\n--etcd-keyfile=/data/etcd/ssl/server-key.pem \\\n--requestheader-client-ca-file=/data/kubernetes/ssl/ca.pem \\\n--proxy-client-cert-file=/data/kubernetes/ssl/kube-apiserver.pem \\\n--proxy-client-key-file=/data/kubernetes/ssl/kube-apiserver-key.pem \\\n--requestheader-allowed-names=kubernetes \\\n--requestheader-extra-headers-prefix=X-Remote-Extra- \\\n--requestheader-group-headers=X-Remote-Group \\\n--requestheader-username-headers=X-Remote-User \\\n--enable-aggregator-routing=true \\\n--audit-log-maxage=30 \\\n--audit-log-maxbackup=3 \\\n--audit-log-maxsize=100 \\\n--audit-log-path=/data/kubernetes/logs/k8s-audit.log"\n')),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"\u914d\u7f6e\u6587\u4ef6\u5404\u53c2\u6570\u542b\u4e49")),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:null},"\u914d\u7f6e\u53c2\u6570"),(0,a.kt)("th",{parentName:"tr",align:null},"\u542b\u4e49"))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"\u2013logtostderr"),(0,a.kt)("td",{parentName:"tr",align:null},"\u662f\u5426\u5f00\u542f\u65e5\u5fd7")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"\u2013v"),(0,a.kt)("td",{parentName:"tr",align:null},"\u65e5\u5fd7\u7684\u7b49\u7ea7\uff0c\u7b49\u7ea7\u8d8a\u9ad8\u5185\u5bb9\u8d8a\u8be6\u7ec6")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"\u2013log-dir"),(0,a.kt)("td",{parentName:"tr",align:null},"\u65e5\u5fd7\u5b58\u653e\u8def\u5f84")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"\u2013etcd-servers"),(0,a.kt)("td",{parentName:"tr",align:null},"etcd\u96c6\u7fa4\u5730\u5740")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"\u2013bind-address"),(0,a.kt)("td",{parentName:"tr",align:null},"\u76d1\u542c\u5730\u5740\uff0c\u4e5f\u5c31\u662f\u672c\u673a")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"\u2013secure-port"),(0,a.kt)("td",{parentName:"tr",align:null},"https\u5b89\u5168\u7aef\u53e3")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"\u2013advertise-address"),(0,a.kt)("td",{parentName:"tr",align:null},"\u96c6\u7fa4\u901a\u544a\u5730\u5740")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"\u2013allow-privileged"),(0,a.kt)("td",{parentName:"tr",align:null},"\u4f01\u4e1a\u6388\u6743")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"\u2013service-cluster-ip-range"),(0,a.kt)("td",{parentName:"tr",align:null},"service\u8d44\u6e90IP\u5730\u5740\u6bb5")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"\u2013enable-admission-plugins"),(0,a.kt)("td",{parentName:"tr",align:null},"\u51c6\u5165\u63a7\u5236\u6a21\u5757")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"\u2013authorization-mode"),(0,a.kt)("td",{parentName:"tr",align:null},"\u8ba4\u8bc1\u6388\u6743\uff0c\u542f\u7528RBAC\u6388\u6743\u548c\u8282\u70b9\u81ea\u7ba1\u7406")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"\u2013enable-bootstrap-token-auth"),(0,a.kt)("td",{parentName:"tr",align:null},"\u542f\u7528TLS bootstrap\u673a\u5236\uff0c\u542f\u7528\u4e4b\u540ekubelet\u53ef\u4ee5\u81ea\u52a8\u7ed9node\u8282\u9881\u53d1\u8bc1\u4e66")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"\u2013token-auth-file"),(0,a.kt)("td",{parentName:"tr",align:null},"bootstrap token\u6587\u4ef6\u8def\u5f84")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"\u2013service-node-port-range"),(0,a.kt)("td",{parentName:"tr",align:null},"Service nodeport\u7c7b\u578b\u9ed8\u8ba4\u5206\u914d\u7aef\u53e3\u8303\u56f4")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"\u2013kubelet-client-certificate"),(0,a.kt)("td",{parentName:"tr",align:null},"apiserver\u8bbf\u95eekubelet\u7684\u5ba2\u6237\u7aef\u8bc1\u4e66\u6587\u4ef6")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"\u2013kubelet-client-key"),(0,a.kt)("td",{parentName:"tr",align:null},"apiserver\u8bbf\u95eekubelet\u7684\u5ba2\u6237\u7aef\u79c1\u94a5\u6587\u4ef6")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"\u2013tls-cert-file"),(0,a.kt)("td",{parentName:"tr",align:null},"apiserver https\u8bc1\u4e66")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"\u2013tls-private-key-file"),(0,a.kt)("td",{parentName:"tr",align:null},"apiserver https\u8bc1\u4e66")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"\u2013client-ca-file"),(0,a.kt)("td",{parentName:"tr",align:null},"ca\u8bc1\u4e66\u8def\u5f84")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"\u2013service-account-key-file"),(0,a.kt)("td",{parentName:"tr",align:null},"ca\u79c1\u94a5\u8def\u5f84")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"\u2013service-account-issuer"),(0,a.kt)("td",{parentName:"tr",align:null},"sa\u8d26\u53f7\u6388\u6743\u8fc7\u671f\u65f6\u95f4\u7684\u4e00\u4e2a\u914d\u7f6e\uff0c1.20\u4ee5\u540e\u624d\u6709\u7684\u7279\u6027")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"\u2013service-account-signing-key-file"),(0,a.kt)("td",{parentName:"tr",align:null},"\u8bc1\u4e66\u6587\u4ef6\u8def\u5f84")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"\u2013etcd-cafile"),(0,a.kt)("td",{parentName:"tr",align:null},"etcd ca\u8bc1\u4e66\u6587\u4ef6\u8def\u5f84")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"\u2013etcd-certfile"),(0,a.kt)("td",{parentName:"tr",align:null},"etcd \u5ba2\u6237\u7aef\u8bc1\u4e66\u6587\u4ef6\u8def\u5f84")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"\u2013etcd-keyfile"),(0,a.kt)("td",{parentName:"tr",align:null},"etcd \u5ba2\u6237\u7aef\u79c1\u94a5\u6587\u4ef6\u8def\u5f84")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"\u2013requestheader-client-ca-file"),(0,a.kt)("td",{parentName:"tr",align:null},"\u805a\u5408\u5c42\u76f8\u5173\u914d\u7f6e")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"\u2013proxy-client-cert-file"),(0,a.kt)("td",{parentName:"tr",align:null},"\u805a\u5408\u5c42\u76f8\u5173\u914d\u7f6e")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"\u2013proxy-client-key-file"),(0,a.kt)("td",{parentName:"tr",align:null},"\u805a\u5408\u5c42\u76f8\u5173\u914d\u7f6e")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"\u2013requestheader-allowed-names"),(0,a.kt)("td",{parentName:"tr",align:null},"\u805a\u5408\u5c42\u76f8\u5173\u914d\u7f6e")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"\u2013requestheader-extra-headers-prefix"),(0,a.kt)("td",{parentName:"tr",align:null},"\u805a\u5408\u5c42\u76f8\u5173\u914d\u7f6e")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"\u2013enable-aggregator-routing"),(0,a.kt)("td",{parentName:"tr",align:null},"\u805a\u5408\u5c42\u76f8\u5173\u914d\u7f6e")))),(0,a.kt)("h4",{id:"532\u521b\u5efatls-bootstrapping\u6587\u4ef6"},"5.3.2.\u521b\u5efaTLS Bootstrapping\u6587\u4ef6"),(0,a.kt)("p",null,"TLS Bootstraping\uff1aMaster apiserver\u542f\u7528TLS\u8ba4\u8bc1\u540e\uff0cNode\u8282\u70b9kubelet\u548ckube-proxy\u8981\u4e0ekube-apiserver\u8fdb\u884c\u901a\u4fe1\uff0c\u5fc5\u987b\u4f7f\u7528CA\u7b7e\u53d1\u7684\u6709\u6548\u8bc1\u4e66\u624d\u53ef\u4ee5\uff0c\u5f53Node\u8282\u70b9\u5f88\u591a\u65f6\uff0c\u8fd9\u79cd\u5ba2\u6237\u7aef\u8bc1\u4e66\u9881\u53d1\u9700\u8981\u5927\u91cf\u5de5\u4f5c\uff0c\u540c\u6837\u4e5f\u4f1a\u589e\u52a0\u96c6\u7fa4\u6269\u5c55\u590d\u6742\u5ea6\u3002\u4e3a\u4e86\u7b80\u5316\u6d41\u7a0b\uff0cKubernetes\u5f15\u5165\u4e86TLS bootstraping\u673a\u5236\u6765\u81ea\u52a8\u9881\u53d1\u5ba2\u6237\u7aef\u8bc1\u4e66\uff0ckubelet\u4f1a\u4ee5\u4e00\u4e2a\u4f4e\u6743\u9650\u7528\u6237\u81ea\u52a8\u5411apiserver\u7533\u8bf7\u8bc1\u4e66\uff0ckubelet\u7684\u8bc1\u4e66\u7531apiserver\u52a8\u6001\u7b7e\u7f72\u3002\u6240\u4ee5\u5f3a\u70c8\u5efa\u8bae\u5728Node\u4e0a\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f\uff0c\u76ee\u524d\u4e3b\u8981\u7528\u4e8ekubelet\uff0ckube-proxy\u8fd8\u662f\u7531\u6211\u4eec\u7edf\u4e00\u9881\u53d1\u4e00\u4e2a\u8bc1\u4e66\u3002"),(0,a.kt)("p",null,"TLS bootstraping \u5de5\u4f5c\u6d41\u7a0b\uff1a"),(0,a.kt)("p",null,"kubelet\u9996\u5148\u53d6\u67e5\u627ebootstraping\u914d\u7f6e\u6587\u4ef6\uff0c\u7136\u540e\u53bb\u8fde\u63a5apiserver\uff0c\u5f00\u59cb\u9a8c\u8bc1bootstrap token\u6587\u4ef6\uff0c\u518d\u9a8c\u8bc1\u8bc1\u4e66\u6587\u4ef6\uff0c\u6700\u540e\u9881\u53d1\u8bc1\u4e66\u542f\u52a8\u6210\u529f\uff0c\u5426\u5219\u5c31\u4f1a\u542f\u52a8\u5931\u8d25\u3002",(0,a.kt)("br",{parentName:"p"}),"\n",(0,a.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/17a18dfd43ae4604863e590283b63ebd.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"1.\u751f\u6210\u4e00\u4e2atoken\u503c\n[root@binary-k8s-master1 ~]\\# head -c 16 /dev/urandom | od -An -t x | tr -d ' '\nd7f96b0d86c574d0f64a713608db092\n\n2.\u521b\u5efatoken\u6587\u4ef6\n[root@binary-k8s-master1 ~]\\# vim /data/kubernetes/config/token.csv\nd7f96b0d86c574d0f64a713608db0922,kubelet-bootstrap,10001,\"system:node-bootstrapper\"\n\n#\u683c\u5f0f\uff1atoken\uff0c\u7528\u6237\u540d\uff0cUID\uff0c\u7528\u6237\u7ec4\n")),(0,a.kt)("h4",{id:"534\u521b\u5efasystemctl\u811a\u672c\u7ba1\u7406apiserver"},"5.3.4.\u521b\u5efasystemctl\u811a\u672c\u7ba1\u7406apiserver"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"[root@binary-k8s-master1 ~]\\# vim /usr/lib/systemd/system/kube-apiserver.service \n[Unit]\nDescription=Kubernetes API Server\nDocumentation=https://github.com/kubernetes/kubernetes\n\n[Service]\nEnvironmentFile=/data/kubernetes/config/kube-apiserver.conf\nExecStart=/data/kubernetes/bin/kube-apiserver $KUBE_APISERVER_OPTS\nRestart=on-failure\n\n[Install]\nWantedBy=multi-user.target\n")),(0,a.kt)("h4",{id:"535\u542f\u52a8kube-apiserver\u7ec4\u4ef6"},"5.3.5.\u542f\u52a8kube-apiserver\u7ec4\u4ef6"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"1.\u62f7\u8d1d\u6211\u4eec\u9700\u8981\u7684\u8bc1\u4e66\u6587\u4ef6\n[root@binary-k8s-master1 ~]\\# cp TLS/k8s/*.pem /data/kubernetes/ssl/\n\n2.\u542f\u52a8kube-apiserver\n[root@binary-k8s-master1 ~]\\# systemctl daemon-reload\n[root@binary-k8s-master1 ~]\\# systemctl start kube-apiserver \n[root@binary-k8s-master1 ~]\\# systemctl enable kube-apiserver\n\n3.\u67e5\u770b\u7aef\u53e3\n[root@binary-k8s-master1 ~]\\# netstat -lnpt | grep kube\ntcp        0      0 192.168.20.10:6443      0.0.0.0:*               LISTEN      28546/kube-apiserve \n")),(0,a.kt)("h3",{id:"54\u90e8\u7f72kube-controller-manage\u7ec4\u4ef6"},"5.4.\u90e8\u7f72kube-controller-manage\u7ec4\u4ef6"),(0,a.kt)("h4",{id:"541\u521b\u5efakube-controller-manage\u914d\u7f6e\u6587\u4ef6"},"5.4.1.\u521b\u5efakube-controller-manage\u914d\u7f6e\u6587\u4ef6"),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},(0,a.kt)("strong",{parentName:"p"},"\u914d\u7f6e\u6587\u4ef6\u542b\u4e49")),(0,a.kt)("p",{parentName:"blockquote"},"\u2013kubeconfig\uff1a\u6307\u5b9a\u7528\u4e8e\u8fde\u63a5apiserver\u7684kubeconfig\u914d\u7f6e\u6587\u4ef6"),(0,a.kt)("p",{parentName:"blockquote"},"\u2013leader-elect\uff1a\u7528\u4e8e\u9ad8\u53ef\u7528\u96c6\u7fa4\uff0c\u81ea\u52a8\u9009\u4e3e"),(0,a.kt)("p",{parentName:"blockquote"},"\u2013cluster-signing-cert-file\uff1a\u6307\u5b9aCA\u8bc1\u4e66\u6587\u4ef6\uff0c\u4e3akubelet\u81ea\u52a8\u9881\u53d1\u8bc1\u4e66"),(0,a.kt)("p",{parentName:"blockquote"},"\u2013cluster-signing-key-file\uff1a\u6307\u5b9aCA\u79c1\u94a5\u6587\u4ef6\uff0c\u4e3akubelet\u81ea\u52a8\u9881\u53d1\u8bc1\u4e66"),(0,a.kt)("p",{parentName:"blockquote"},"\u2013cluster-signing-duration\uff1a\u8bc1\u4e66\u8fc7\u671f\u65f6\u95f4")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'[root@binary-k8s-master1 ~]\\# vim /data/kubernetes/config/kube-controller-manager.conf \nKUBE_CONTROLLER_MANAGER_OPTS="--logtostderr=false \\\n--v=2 \\\n--log-dir=/data/kubernetes/logs \\\n--leader-elect=true \\\n--kubeconfig=/data/kubernetes/config/kube-controller-manager.kubeconfig \\\n--bind-address=192.168.20.10 \\\n--allocate-node-cidrs=true \\\n--cluster-cidr=10.244.0.0/16 \\\n--service-cluster-ip-range=10.0.0.0/24 \\\n--cluster-signing-cert-file=/data/kubernetes/ssl/ca.pem \\\n--cluster-signing-key-file=/data/kubernetes/ssl/ca-key.pem  \\\n--root-ca-file=/data/kubernetes/ssl/ca.pem \\\n--service-account-private-key-file=/data/kubernetes/ssl/ca-key.pem \\\n--cluster-signing-duration=87600h0m0s"\n')),(0,a.kt)("h4",{id:"542\u751f\u6210kubeconfig\u6587\u4ef6"},"5.4.2.\u751f\u6210kubeconfig\u6587\u4ef6"),(0,a.kt)("p",null,"kube-controller-manage\u5229\u7528kubeconfig\u914d\u7f6e\u6587\u4ef6\u8fde\u63a5apiserver\u3002"),(0,a.kt)("p",null,"kubeconfig\u6587\u4ef6\u4e2d\u5305\u62ec\u96c6\u7fa4apiserver\u5730\u5740\u3001\u8bc1\u4e66\u6587\u4ef6\u3001\u7528\u6237\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'1.\u7531\u4e8ekubeconfig\u9700\u8981\u8bc1\u4e66\u6587\u4ef6\u7684\u652f\u6301\uff0c\u56e0\u6b64\u8981\u751f\u6210\u4e00\u4e2a\u8bc1\u4e66\n[root@binary-k8s-master1 ~/TLS/k8s]\\# vim kube-controller-manager-csr.json \n{\n  "CN": "system:kube-controller-manager",\n  "hosts": [],\n  "key": {\n    "algo": "rsa",\n    "size": 2048\n  },\n  "names": [\n    {\n      "C": "CN",\n      "L": "BeiJing",\n      "ST": "BeiJing",\n      "O": "system:masters",\n      "OU": "System"\n    }\n  ]\n}\n\n[root@binary-k8s-master1 ~/TLS/k8s]\\# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager\n2021/09/01 16:36:18 [INFO] generate received request\n2021/09/01 16:36:18 [INFO] received CSR\n2021/09/01 16:36:18 [INFO] generating key: rsa-2048\nl2021/09/01 16:36:19 [INFO] encoded CSR\n2021/09/01 16:36:19 [INFO] signed certificate with serial number 719101376219834763931271155238486242405063666906\n2021/09/01 16:36:19 [WARNING] This certificate lacks a "hosts" field. This makes it unsuitable for\nwebsites. For more information see the Baseline Requirements for the Issuance and Management\nof Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);\nspecifically, section 10.2.3 ("Information Requirements").\n\n[root@binary-k8s-master1 ~/TLS/k8s]\\# cp kube-controller-manager*pem /data/kubernetes/ssl/\n\n\n2.\u751f\u6210kubeconfig\u6587\u4ef6\n#\u5728kubeconfig\u6587\u4ef6\u4e2d\u589e\u52a0\u96c6\u7fa4apiserver\u4fe1\u606f\n[root@binary-k8s-master1 ~]\\# kubectl config set-cluster kubernetes \\\n--certificate-authority=/data/kubernetes/ssl/ca.pem \\\n--embed-certs=true \\\n--server="https://192.168.20.10:6443" \\\n--kubeconfig=/data/kubernetes/config/kube-controller-manager.kubeconfig\n#\u5728kubeconfig\u6587\u4ef6\u4e2d\u589e\u52a0\u8bc1\u4e66\u6587\u4ef6\u4fe1\u606f  \n[root@binary-k8s-master1 ~]\\# kubectl config set-credentials kube-controller-manager \\\n--client-certificate=/data/kubernetes/ssl/kube-controller-manager.pem \\\n--client-key=/data/kubernetes/ssl/kube-controller-manager-key.pem \\\n--embed-certs=true \\\n--kubeconfig=/data/kubernetes/config/kube-controller-manager.kubeconfig\n#\u5728kubeconfig\u6587\u4ef6\u4e2d\u589e\u52a0\u7528\u6237\u4fe1\u606f  \n[root@binary-k8s-master1 ~]\\# kubectl config set-context default \\\n--cluster=kubernetes \\\n--user=kube-controller-manager \\\n--kubeconfig=/data/kubernetes/config/kube-controller-manager.kubeconfig\n\n3.\u6307\u5b9a\u751f\u6210\u7684kubeconfig\u6587\u4ef6\u4e3a\u96c6\u7fa4\u4f7f\u7528\n[root@binary-k8s-master1 ~]\\# kubectl config use-context default --kubeconfig=/data/kubernetes/config/kube-controller-manager.kubeconfig  \n')),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/877a98a70b2f47919bcaae2d9d02a4d1.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,a.kt)("h4",{id:"543\u521b\u5efasystemctl\u811a\u672c\u7ba1\u7406\u670d\u52a1"},"5.4.3.\u521b\u5efasystemctl\u811a\u672c\u7ba1\u7406\u670d\u52a1"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"[root@binary-k8s-master1 ~]\\# vim /usr/lib/systemd/system/kube-controller-manager.service\n[Unit]\nDescription=Kubernetes Controller Manager\nDocumentation=https://github.com/kubernetes/kubernetes\n\n[Service]\nEnvironmentFile=/data/kubernetes/config/kube-controller-manager.conf\nExecStart=/data/kubernetes/bin/kube-controller-manager $KUBE_CONTROLLER_MANAGER_OPTS\nRestart=on-failure\n\n[Install]\nWantedBy=multi-user.target\n")),(0,a.kt)("h4",{id:"544\u542f\u52a8kube-controller-manage\u7ec4\u4ef6"},"5.4.4.\u542f\u52a8kube-controller-manage\u7ec4\u4ef6"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"1.\u542f\u52a8\u670d\u52a1\n[root@binary-k8s-master1 ~]\\# systemctl daemon-reload \n[root@binary-k8s-master1 ~]\\# systemctl start kube-controller-manager\n[root@binary-k8s-master1 ~]\\# systemctl enable kube-controller-manager\n\n2.\u67e5\u770b\u7aef\u53e3\n[root@binary-k8s-master1 ~]\\# netstat -lnpt | grep kube\ntcp        0      0 192.168.20.10:6443      0.0.0.0:*               LISTEN      28546/kube-apiserve \ntcp        0      0 192.168.20.10:10257     0.0.0.0:*               LISTEN      28941/kube-controll \ntcp6       0      0 :::10252                :::*                    LISTEN      28941/kube-controll \n")),(0,a.kt)("h3",{id:"55\u90e8\u7f72kube-scheduler\u7ec4\u4ef6"},"5.5.\u90e8\u7f72kube-scheduler\u7ec4\u4ef6"),(0,a.kt)("h4",{id:"551\u521b\u5efakube-scheduler\u914d\u7f6e\u6587\u4ef6"},"5.5.1.\u521b\u5efakube-scheduler\u914d\u7f6e\u6587\u4ef6"),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"\u914d\u7f6e\u6587\u4ef6\u89e3\u91ca"),(0,a.kt)("p",{parentName:"blockquote"},"\u2013kubeconfig\uff1a\u6307\u5b9akubeconfig\u6587\u4ef6"),(0,a.kt)("p",{parentName:"blockquote"},"\u2013leader-elect\uff1a\u9009\u4e3e")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'[root@binary-k8s-master1 ~]\\# vim /data/kubernetes/config/kube-scheduler.conf \nKUBE_SCHEDULER_OPTS="--logtostderr=false \\\n--v=2 \\\n--log-dir=/data/kubernetes/logs \\\n--leader-elect \\\n--kubeconfig=/data/kubernetes/config/kube-scheduler.kubeconfig \\\n--bind-address=192.168.20.10"\n')),(0,a.kt)("h4",{id:"552\u751f\u6210kubeconfig\u6587\u4ef6"},"5.5.2.\u751f\u6210kubeconfig\u6587\u4ef6"),(0,a.kt)("p",null,"\u751f\u6210kubeconfig\u8fde\u63a5\u96c6\u7fa4apiserver\u3002"),(0,a.kt)("p",null,"kube-schedule\u5229\u7528kubeconfig\u914d\u7f6e\u6587\u4ef6\u8fde\u63a5apiserver\u3002"),(0,a.kt)("p",null,"kubeconfig\u6587\u4ef6\u4e2d\u5305\u62ec\u96c6\u7fa4apiserver\u5730\u5740\u3001\u8bc1\u4e66\u6587\u4ef6\u3001\u7528\u6237\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'1.\u521b\u5efa\u8bc1\u4e66\u914d\u7f6e\u6587\u4ef6\n[root@binary-k8s-master1 ~/TLS/k8s]\\# vim kube-scheduler-csr.json\n{\n  "CN": "system:kube-scheduler",\n  "hosts": [],\n  "key": {\n    "algo": "rsa",\n    "size": 2048\n  },\n  "names": [\n    {\n      "C": "CN",\n      "L": "BeiJing",\n      "ST": "BeiJing",\n      "O": "system:masters",\n      "OU": "System"\n    }\n  ]\n}\n\n2.\u751f\u6210\u8bc1\u4e66\n[root@binary-k8s-master1 ~/TLS/k8s]\\# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-scheduler-csr.json | cfssljson -bare kube-scheduler\n2021/09/02 14:50:40 [INFO] generate received request\n2021/09/02 14:50:40 [INFO] received CSR\n2021/09/02 14:50:40 [INFO] generating key: rsa-2048\n2021/09/02 14:50:42 [INFO] encoded CSR\n2021/09/02 14:50:42 [INFO] signed certificate with serial number 91388852050290848663498441480862532526947759393\n2021/09/02 14:50:42 [WARNING] This certificate lacks a "hosts" field. This makes it unsuitable for\nwebsites. For more information see the Baseline Requirements for the Issuance and Management\nof Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);\nspecifically, section 10.2.3 ("Information Requirements").\n\n3.\u67e5\u770b\u8bc1\u4e66\u6587\u4ef6\n[root@binary-k8s-master1 ~/TLS/k8s]\\# ll\n\u603b\u7528\u91cf 68\n-rw-r--r--. 1 root root  294 9\u6708   1 16:20 ca-config.json\n-rw-r--r--. 1 root root 1001 9\u6708   1 16:20 ca.csr\n-rw-r--r--. 1 root root  264 9\u6708   1 16:20 ca-csr.json\n-rw-------. 1 root root 1679 9\u6708   1 16:20 ca-key.pem\n-rw-r--r--. 1 root root 1359 9\u6708   1 16:20 ca.pem\n-rw-r--r--. 1 root root 1277 9\u6708   1 16:30 kube-apiserver.csr\n-rw-r--r--. 1 root root  602 9\u6708   1 16:30 kube-apiserver-csr.json\n-rw-------. 1 root root 1679 9\u6708   1 16:30 kube-apiserver-key.pem\n-rw-r--r--. 1 root root 1643 9\u6708   1 16:30 kube-apiserver.pem\n-rw-r--r--. 1 root root 1045 9\u6708   1 16:36 kube-controller-manager.csr\n-rw-r--r--. 1 root root  255 9\u6708   1 16:46 kube-controller-manager-csr.json\n-rw-------. 1 root root 1675 9\u6708   1 16:36 kube-controller-manager-key.pem\n-rw-r--r--. 1 root root 1436 9\u6708   1 16:36 kube-controller-manager.pem\n-rw-r--r--. 1 root root 1029 9\u6708   2 14:50 kube-scheduler.csr\n-rw-r--r--. 1 root root  245 9\u6708   2 14:50 kube-scheduler-csr.json\n-rw-------. 1 root root 1675 9\u6708   2 14:50 kube-scheduler-key.pem\n-rw-r--r--. 1 root root 1424 9\u6708   2 14:50 kube-scheduler.pem\n\n4.\u62f7\u8d1d\u8bc1\u4e66\u6587\u4ef6\u81f3\u6307\u5b9a\u8def\u5f84\n[root@binary-k8s-master1 ~/TLS/k8s]\\# cp kube-scheduler*.pem /data/kubernetes/ssl/\n\n5.\u751f\u6210kubeconfig\u6587\u4ef6\n#\u5728kubeconfig\u6587\u4ef6\u4e2d\u589e\u52a0\u96c6\u7fa4apiserver\u4fe1\u606f\n[root@binary-k8s-master1 ~]\\# kubectl config set-cluster kubernetes \\\n--certificate-authority=/data/kubernetes/ssl/ca.pem \\\n--embed-certs=true \\\n--server="https://192.168.20.10:6443" \\\n--kubeconfig=/data/kubernetes/config/kube-scheduler.kubeconfig\n#\u5728kubeconfig\u6587\u4ef6\u4e2d\u589e\u52a0\u8bc1\u4e66\u6587\u4ef6\u4fe1\u606f \n[root@binary-k8s-master1 ~]\\# kubectl config set-credentials kube-scheduler \\\n--client-certificate=/data/kubernetes/ssl/kube-scheduler.pem \\\n--client-key=/data/kubernetes/ssl/kube-scheduler-key.pem \\\n--embed-certs=true \\\n--kubeconfig=/data/kubernetes/config/kube-scheduler.kubeconfig\n#\u5728kubeconfig\u6587\u4ef6\u4e2d\u589e\u52a0\u7528\u6237\u4fe1\u606f \n[root@binary-k8s-master1 ~]\\# kubectl config set-context default \\\n--cluster=kubernetes \\\n--user=kube-scheduler \\\n--kubeconfig=/data/kubernetes/config/kube-scheduler.kubeconfig\n\n6.\u6307\u5b9a\u751f\u6210\u7684kubeconfig\u6587\u4ef6\u4e3a\u96c6\u7fa4\u4f7f\u7528\n[root@binary-k8s-master1 ~]\\# kubectl config use-context default --kubeconfig=/data/kubernetes/config/kube-scheduler.kubeconfig\n')),(0,a.kt)("h4",{id:"553\u521b\u5efasystemctl\u811a\u672c\u7ba1\u7406\u670d\u52a1"},"5.5.3.\u521b\u5efasystemctl\u811a\u672c\u7ba1\u7406\u670d\u52a1"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"[root@binary-k8s-master1 ~]\\# vim /usr/lib/systemd/system/kube-scheduler.service\n[Unit]\nDescription=Kubernetes Scheduler\nDocumentation=https://github.com/kubernetes/kubernetes\n\n[Service]\nEnvironmentFile=/data/kubernetes/config/kube-scheduler.conf\nExecStart=/data/kubernetes/bin/kube-scheduler $KUBE_SCHEDULER_OPTS\nRestart=on-failure\n\n[Install]\nWantedBy=multi-user.target\n")),(0,a.kt)("h4",{id:"554\u542f\u52a8kube-scheduler\u7ec4\u4ef6"},"5.5.4.\u542f\u52a8kube-scheduler\u7ec4\u4ef6"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"1.\u542f\u52a8\u670d\u52a1\n[root@binary-k8s-master1 ~]\\# systemctl daemon-reload\n[root@binary-k8s-master1 ~]\\# systemctl start kube-scheduler\n[root@binary-k8s-master1 ~]\\# systemctl enable kube-scheduler\n\n2.\u67e5\u770b\u7aef\u53e3\n[root@binary-k8s-master1 ~]\\# netstat -lnpt | grep kube\ntcp        0      0 192.168.20.10:6443      0.0.0.0:*               LISTEN      28546/kube-apiserve \ntcp        0      0 192.168.20.10:10257     0.0.0.0:*               LISTEN      28941/kube-controll \ntcp        0      0 192.168.20.10:10259     0.0.0.0:*               LISTEN      6127/kube-scheduler \ntcp6       0      0 :::10251                :::*                    LISTEN      6127/kube-scheduler \ntcp6       0      0 :::10252                :::*                    LISTEN      28941/kube-controll \n")),(0,a.kt)("h3",{id:"56\u51c6\u5907kubectl\u6240\u9700\u7684kubeconfig\u6587\u4ef6\u8fde\u63a5\u96c6\u7fa4"},"5.6.\u51c6\u5907kubectl\u6240\u9700\u7684kubeconfig\u6587\u4ef6\u8fde\u63a5\u96c6\u7fa4"),(0,a.kt)("p",null,"kubectl\u60f3\u8981\u8fde\u63a5\u96c6\u7fa4\u5bf9\u5404\u79cd\u8d44\u6e90\u8fdb\u884c\u64cd\u4f5c\uff0c\u9700\u8981\u6709\u4e00\u4e2akubeconfig\u6587\u4ef6\u8fde\u63a5apiserver\u624d\u53ef\u4ee5\u5bf9\u96c6\u7fa4\u8fdb\u884c\u64cd\u4f5c\uff0c\u4e5f\u5c31\u662fkubeadm\u5b89\u88c5k8s\u96c6\u7fa4\u540e\u5728master\u8282\u70b9\u751f\u6210\u7684/root/.kube\u76ee\u5f55\uff0c\u8fd9\u4e2a\u76ee\u5f55\u4e2d\u7684config\u6587\u4ef6\u5c31\u662fkubectl\u7528\u4e8e\u8fde\u63a5apiserver\u7684kubeconfig\u6587\u4ef6\u3002"),(0,a.kt)("h4",{id:"561\u751f\u6210\u8bc1\u4e66\u6587\u4ef6"},"5.6.1.\u751f\u6210\u8bc1\u4e66\u6587\u4ef6"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'1.\u521b\u5efa\u8bc1\u4e66\u914d\u7f6e\u6587\u4ef6\n[root@binary-k8s-master1 ~/TLS/k8s]\\# vim kubectl-csr.json \n{\n  "CN": "kubectl",\n  "hosts": [],\n  "key": {\n    "algo": "rsa",\n    "size": 2048\n  },\n  "names": [\n    {\n      "C": "CN",\n      "L": "BeiJing",\n      "ST": "BeiJing",\n      "O": "system:masters",\n      "OU": "System"\n    }\n  ]\n}\n\n2.\u751f\u6210\u8bc1\u4e66\n[root@binary-k8s-master1 ~/TLS/k8s]\\# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kubectl-csr.json | cfssljson -bare kubectl\n2021/09/02 17:20:44 [INFO] generate received request\n2021/09/02 17:20:44 [INFO] received CSR\n2021/09/02 17:20:44 [INFO] generating key: rsa-2048\n2021/09/02 17:20:45 [INFO] encoded CSR\n2021/09/02 17:20:45 [INFO] signed certificate with serial number 398472525484598388169457456772550114435870340604\n2021/09/02 17:20:45 [WARNING] This certificate lacks a "hosts" field. This makes it unsuitable for\nwebsites. For more information see the Baseline Requirements for the Issuance and Management\nof Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);\nspecifically, section 10.2.3 ("Information Requirements").\n\n3.\u67e5\u770b\u751f\u6210\u7684\u8bc1\u4e66\u6587\u4ef6\n[root@binary-k8s-master1 ~/TLS/k8s]\\# ll\n\u603b\u7528\u91cf 84\n-rw-r--r--. 1 root root  294 9\u6708   1 16:20 ca-config.json\n-rw-r--r--. 1 root root 1001 9\u6708   1 16:20 ca.csr\n-rw-r--r--. 1 root root  264 9\u6708   1 16:20 ca-csr.json\n-rw-------. 1 root root 1679 9\u6708   1 16:20 ca-key.pem\n-rw-r--r--. 1 root root 1359 9\u6708   1 16:20 ca.pem\n-rw-r--r--. 1 root root 1277 9\u6708   1 16:30 kube-apiserver.csr\n-rw-r--r--. 1 root root  602 9\u6708   1 16:30 kube-apiserver-csr.json\n-rw-------. 1 root root 1679 9\u6708   1 16:30 kube-apiserver-key.pem\n-rw-r--r--. 1 root root 1643 9\u6708   1 16:30 kube-apiserver.pem\n-rw-r--r--. 1 root root 1045 9\u6708   1 16:36 kube-controller-manager.csr\n-rw-r--r--. 1 root root  255 9\u6708   1 16:46 kube-controller-manager-csr.json\n-rw-------. 1 root root 1675 9\u6708   1 16:36 kube-controller-manager-key.pem\n-rw-r--r--. 1 root root 1436 9\u6708   1 16:36 kube-controller-manager.pem\n-rw-r--r--. 1 root root 1013 9\u6708   2 17:20 kubectl.csr\n-rw-r--r--. 1 root root  231 9\u6708   2 17:20 kubectl-csr.json\n-rw-------. 1 root root 1679 9\u6708   2 17:20 kubectl-key.pem\n-rw-r--r--. 1 root root 1403 9\u6708   2 17:20 kubectl.pem\n-rw-r--r--. 1 root root 1029 9\u6708   2 14:50 kube-scheduler.csr\n-rw-r--r--. 1 root root  245 9\u6708   2 14:50 kube-scheduler-csr.json\n-rw-------. 1 root root 1675 9\u6708   2 14:50 kube-scheduler-key.pem\n-rw-r--r--. 1 root root 1424 9\u6708   2 14:50 kube-scheduler.pem\n\n4.\u62f7\u8d1d\u8bc1\u4e66\u6587\u4ef6\u5230\u6307\u5b9a\u76ee\u5f55\n[root@binary-k8s-master1 ~/TLS/k8s]\\# \\cp kubectl*.pem /data/kubernetes/ssl/\n')),(0,a.kt)("h4",{id:"562\u751f\u6210kubeconfig\u6587\u4ef6"},"5.6.2.\u751f\u6210kubeconfig\u6587\u4ef6"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'1.\u5728kubeconfig\u6587\u4ef6\u4e2d\u589e\u52a0\u96c6\u7fa4apiserver\u4fe1\u606f\n[root@binary-k8s-master1 ~]\\# kubectl config set-cluster kubernetes \\\n--certificate-authority=/data/kubernetes/ssl/ca.pem \\\n--embed-certs=true \\\n--server="https://192.168.20.10:6443" \\\n--kubeconfig=/root/.kube/config\n\n2.\u5728kubeconfig\u6587\u4ef6\u4e2d\u589e\u52a0\u8bc1\u4e66\u6587\u4ef6\u4fe1\u606f\n[root@binary-k8s-master1 ~]\\# kubectl config set-credentials cluster-admin \\\n--client-certificate=/data/kubernetes/ssl/kubectl.pem \\\n--client-key=/data/kubernetes/ssl/kubectl-key.pem  \\\n--embed-certs=true \\\n--kubeconfig=/root/.kube/config\n\n3.\u5728kubeconfig\u6587\u4ef6\u4e2d\u589e\u52a0\u7528\u6237\u4fe1\u606f \n[root@binary-k8s-master1 ~]\\# kubectl config set-context default \\\n--cluster=kubernetes \\\n--user=cluster-admin \\\n--kubeconfig=/root/.kube/config\n  \n4.\u6307\u5b9a\u751f\u6210\u7684kubeconfig\u6587\u4ef6\u4e3a\u96c6\u7fa4\u4f7f\u7528\n[root@binary-k8s-master1 ~]\\# kubectl config use-context default --kubeconfig=/root/.kube/config\n')),(0,a.kt)("h4",{id:"563\u4f7f\u7528kubectl\u67e5\u770b\u96c6\u7fa4\u8fde\u63a5\u4fe1\u606f"},"5.6.3.\u4f7f\u7528kubectl\u67e5\u770b\u96c6\u7fa4\u8fde\u63a5\u4fe1\u606f"),(0,a.kt)("p",null,"\u81f3\u6b64master\u8282\u70b9\u76f8\u5173\u7ec4\u4ef6\u90e8\u7f72\u5b8c\u6210\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'[root@binary-k8s-master1 ~]\\# kubectl get node\nNo resources found\n\n[root@binary-k8s-master1 ~]\\# kubectl get cs\nWarning: v1 ComponentStatus is deprecated in v1.19+\nNAME                 STATUS    MESSAGE             ERROR\nscheduler            Healthy   ok                  \ncontroller-manager   Healthy   ok                  \netcd-1               Healthy   {"health":"true"}   \netcd-0               Healthy   {"health":"true"}   \netcd-2               Healthy   {"health":"true"}  \n')),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/8ea5953c67f6460facc684905acb502c.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,a.kt)("h2",{id:"6\u5728master\u8282\u70b9\u90e8\u7f72node\u8282\u70b9\u76f8\u5173\u7ec4\u4ef6"},"6.\u5728master\u8282\u70b9\u90e8\u7f72node\u8282\u70b9\u76f8\u5173\u7ec4\u4ef6"),(0,a.kt)("h3",{id:"61\u5728\u96c6\u7fa4\u6388\u6743kubelet-bootstrap\u7528\u6237\u5141\u8bb8\u8bf7\u6c42\u8bc1\u4e66"},"6.1.\u5728\u96c6\u7fa4\u6388\u6743kubelet-bootstrap\u7528\u6237\u5141\u8bb8\u8bf7\u6c42\u8bc1\u4e66"),(0,a.kt)("p",null,"\u5728\u6b64\u5904\u505a\u4e86\u8fd9\u4e00\u6b65\u4e4b\u540e\uff0cnode\u8282\u70b9\u52a0\u5165\u96c6\u7fa4\u65f6\u5c31\u4e0d\u9700\u8981\u505a\u4e86\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"[root@binary-k8s-master1 ~]\\# kubectl create clusterrolebinding kubelet-bootstrap \\\n--clusterrole=system:node-bootstrapper \\\n--user=kubelet-bootstrap\n")),(0,a.kt)("h3",{id:"62\u5728master\u8282\u70b9\u90e8\u7f72kubelet\u7ec4\u4ef6"},"6.2.\u5728master\u8282\u70b9\u90e8\u7f72kubelet\u7ec4\u4ef6"),(0,a.kt)("p",null,"\u7531\u4e8emaster\u4e5f\u9700\u8981\u542f\u52a8\u67d0\u4e9bpod\uff0c\u6bd4\u5982calico\u7ec4\u4ef6\u90fd\u662f\u4ee5pod\u65b9\u5f0f\u8fd0\u884c\u7684\uff0c\u56e0\u6b64\u5728master\u8282\u70b9\u4e5f\u9700\u8981kubelet\u548ckube-proxy\u7ec4\u4ef6\u3002"),(0,a.kt)("h4",{id:"621\u5c06kubelet\u548ckube-proxy\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u62f7\u8d1d\u81f3\u5bf9\u5e94\u76ee\u5f55"},"6.2.1.\u5c06kubelet\u548ckube-proxy\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u62f7\u8d1d\u81f3\u5bf9\u5e94\u76ee\u5f55"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"[root@binary-k8s-master1 ~]\\# cp kubernetes/server/bin/{kubelet,kube-proxy} /data/kubernetes/bin/\n")),(0,a.kt)("h4",{id:"622\u521b\u5efakubelet\u914d\u7f6e\u6587\u4ef6"},"6.2.2.\u521b\u5efakubelet\u914d\u7f6e\u6587\u4ef6"),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"\u914d\u7f6e\u6587\u4ef6\u542b\u4e49\uff1a"),(0,a.kt)("p",{parentName:"blockquote"},"\u2013hostname-override\uff1a\u8282\u70b9\u540d\u79f0\uff0c\u96c6\u7fa4\u4e2d\u552f\u4e00"),(0,a.kt)("p",{parentName:"blockquote"},"\u2013network-plugin\uff1a\u542f\u7528CNI\u7f51\u7edc"),(0,a.kt)("p",{parentName:"blockquote"},"\u2013kubeconfig\uff1a\u6307\u5b9a\u81ea\u52a8\u751f\u6210\u7684kubeconfig\u6587\u4ef6\u8def\u5f84\uff0c\u7528\u4e8e\u8fde\u63a5apiserver"),(0,a.kt)("p",{parentName:"blockquote"},"\u2013bootstrap-kubeconfig\uff1a\u6307\u5b9a\u9996\u6b21\u542f\u52a8\u5411apiserver\u7533\u8bf7\u8bc1\u4e66\u7684kubeconfig\u6587\u4ef6\u8def\u5f84"),(0,a.kt)("p",{parentName:"blockquote"},"\u2013config\uff1a\u914d\u7f6e\u53c2\u6570\u6587\u4ef6\u8def\u5f84"),(0,a.kt)("p",{parentName:"blockquote"},"\u2013cert-dir\uff1akubelet\u8bc1\u4e66\u751f\u6210\u76ee\u5f55\u8def\u5f84"),(0,a.kt)("p",{parentName:"blockquote"},"\u2013pod-infra-container-image\uff1apod\u5bb9\u5668\u7684\u6839\u5bb9\u5668")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'[root@binary-k8s-master1 ~]\\# vim /data/kubernetes/config/kubelet.conf\nKUBELET_OPTS="--logtostderr=false \\\n--v=2 \\\n--log-dir=/data/kubernetes/logs \\\n--hostname-override=binary-k8s-master1 \\\n--network-plugin=cni \\\n--kubeconfig=/data/kubernetes/config/kubelet.kubeconfig \\\n--bootstrap-kubeconfig=/data/kubernetes/config/bootstrap.kubeconfig \\\n--config=/data/kubernetes/config/kubelet-config.yml \\\n--cert-dir=/data/kubernetes/ssl \\\n--pod-infra-container-image=pause-amd64:3.0"\n')),(0,a.kt)("h4",{id:"623\u521b\u5efakubelet-configyaml\u53c2\u6570\u914d\u7f6e\u6587\u4ef6"},"6.2.3.\u521b\u5efakubelet-config.yaml\u53c2\u6570\u914d\u7f6e\u6587\u4ef6"),(0,a.kt)("p",null,"kubelet\u548ckube-proxy\u670d\u52a1\u7684\u53c2\u6570\u914d\u7f6e\u662f\u4ee5yaml\u5f62\u5f0f\u6765\u914d\u7f6e\u7684"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"[root@binary-k8s-master1 ~]\\# vim /data/kubernetes/config/kubelet-config.yml\nkind: KubeletConfiguration\napiVersion: kubelet.config.k8s.io/v1beta1\naddress: 0.0.0.0                #\u76d1\u542c\u5730\u5740\nport: 10250                     #\u76d1\u542c\u7aef\u53e3\nreadOnlyPort: 10255\ncgroupDriver: cgroupfs          #\u9a71\u52a8\u5f15\u64ce\nclusterDNS:\n- 10.0.0.2\nclusterDomain: cluster.local\nfailSwapOn: false\nauthentication:\n  anonymous:\n    enabled: false\n  webhook:\n    cacheTTL: 2m0s\n    enabled: true\n  x509:\n    clientCAFile: /data/kubernetes/ssl/ca.pem       #ca\u8bc1\u4e66\u6587\u4ef6\u8def\u5f84\nauthorization:\n  mode: Webhook\n  webhook:\n    cacheAuthorizedTTL: 5m0s\n    cacheUnauthorizedTTL: 30s\nevictionHard:\n  imagefs.available: 15%\n  memory.available: 100Mi\n  nodefs.available: 10%\n  nodefs.inodesFree: 5%\nmaxOpenFiles: 1000000\nmaxPods: 110                #\u53ef\u8fd0\u884c\u7684pod\u7684\u6570\u91cf\n")),(0,a.kt)("h4",{id:"624\u521b\u5efabootstrap-kubeconfig\u6587\u4ef6"},"6.2.4.\u521b\u5efabootstrap-kubeconfig\u6587\u4ef6"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'1.\u5728kubeconfig\u6587\u4ef6\u4e2d\u589e\u52a0\u96c6\u7fa4apiserver\u4fe1\u606f\n[root@binary-k8s-master1 ~]\\# kubectl config set-cluster kubernetes \\\n--certificate-authority=/data/kubernetes/ssl/ca.pem \\\n--embed-certs=true \\\n--server="https://192.168.20.10:6443" \\\n--kubeconfig=/data/kubernetes/config/bootstrap.kubeconfig\n  \n2.\u5728kubeconfig\u6587\u4ef6\u4e2d\u589e\u52a0token\u4fe1\u606f\n[root@binary-k8s-master1 ~]\\# kubectl config set-credentials "kubelet-bootstrap" \\\n--token=d7f96b0d86c574d0f64a713608db0922 \\\n--kubeconfig=/data/kubernetes/config/bootstrap.kubeconfig\n#\u8fd9\u4e2atoken\u5c31\u662f\u4e4b\u524d\u751f\u6210\u7684/data/kubernetes/config/token.csv\u4e2d\u7684token\n  \n3.\u5728kubeconfig\u6587\u4ef6\u4e2d\u589e\u52a0\u7528\u6237\u4fe1\u606f \n[root@binary-k8s-master1 ~]\\# kubectl config set-context default \\\n--cluster=kubernetes \\\n--user="kubelet-bootstrap" \\\n--kubeconfig=/data/kubernetes/config/bootstrap.kubeconfig\n\n4.\u6307\u5b9a\u751f\u6210\u7684kubeconfig\u6587\u4ef6\u4e3a\u96c6\u7fa4\u4f7f\u7528\n[root@binary-k8s-master1 ~]\\# kubectl config use-context default --kubeconfig=/data/kubernetes/config/bootstrap.kubeconfig\n')),(0,a.kt)("h4",{id:"625\u521b\u5efasystemctl\u811a\u672c\u5e76\u542f\u52a8\u670d\u52a1"},"6.2.5.\u521b\u5efasystemctl\u811a\u672c\u5e76\u542f\u52a8\u670d\u52a1"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"1.\u521b\u5efasystemctl\u811a\u672c\n[root@binary-k8s-master1 ~]\\# vim /usr/lib/systemd/system/kubelet.service\n[Unit]\nDescription=Kubernetes Kubelet\nAfter=docker.service\n\n[Service]\nEnvironmentFile=/data/kubernetes/config/kubelet.conf\nExecStart=/data/kubernetes/bin/kubelet $KUBELET_OPTS\nRestart=on-failure\nLimitNOFILE=65536\n\n[Install]\nWantedBy=multi-user.target\n\n2.\u542f\u52a8kubelet\u670d\u52a1\n[root@binary-k8s-master1 ~]\\# systemctl daemon-reload\n[root@binary-k8s-master1 ~]\\# systemctl start kubelet\n[root@binary-k8s-master1 ~]\\# systemctl enable kubelet\n")),(0,a.kt)("h4",{id:"626\u5c06master\u8282\u70b9\u4f5c\u4e3anode\u52a0\u5165\u96c6\u7fa4\u5185\u90e8"},"6.2.6.\u5c06master\u8282\u70b9\u4f5c\u4e3anode\u52a0\u5165\u96c6\u7fa4\u5185\u90e8"),(0,a.kt)("p",null,"\u5f53kubelet\u7ec4\u4ef6\u542f\u52a8\u6210\u529f\u540e\uff0c\u5c31\u4f1a\u60f3apiserver\u53d1\u9001\u4e00\u4e2a\u8bf7\u6c42\u52a0\u5165\u96c6\u7fa4\u7684\u4fe1\u606f\uff0c\u53ea\u6709\u5f53master\u8282\u70b9\u6388\u6743\u540c\u610f\u540e\uff0c\u624d\u53ef\u4ee5\u6b63\u5e38\u52a0\u5165\uff0c\u867d\u7136\u662fmaster\u8282\u70b9\u90e8\u7f72\u7684node\u7ec4\u4ef6\uff0c\u4f46\u662f\u4e5f\u4f1a\u53d1\u751f\u4e00\u4e2a\u52a0\u5165\u96c6\u7fa4\u7684\u4fe1\u606f\uff0c\u9700\u8981master\u540c\u610f\u3002"),(0,a.kt)("p",null,"\u5f53kubelet\u542f\u52a8\u4e4b\u540e\uff0c\u9996\u5148\u4f1a\u5728\u8bc1\u4e66\u76ee\u5f55\u751f\u6210\u4e00\u4e2akubelet-client.key.tmp\u8fd9\u4e2a\u6587\u4ef6\uff0c\u5f53\u4f7f\u7528kubectl certificate approve\u547d\u4ee4\u6388\u6743\u6210\u529fnode\u7684\u8bf7\u6c42\u4e4b\u540e\uff0ckubelet-client.key.tmp\u5c0f\u65f6\uff0c\u968f\u4e4b\u4f1a\u751f\u6210\u4e00\u4e2akubelet-client-current.pem\u7684\u8bc1\u4e66\u6587\u4ef6\uff0c\u7528\u4e8e\u4e0eapiserver\u5efa\u7acb\u8fde\u63a5\uff0c\u6b64\u65f6\u518d\u4f7f\u7528kubectl get node\u5c31\u4f1a\u770b\u5230\u8282\u70b9\u4fe1\u606f\u4e86\u3002"),(0,a.kt)("p",null,"\u6269\u5c55\uff1a\u5982\u679c\u540e\u671f\u60f3\u8981\u4fee\u6539node\u7684\u540d\u79f0\uff0c\u90a3\u4e48\u5c31\u628a\u751f\u6210\u7684kubelet\u8bc1\u4e66\u6587\u4ef6\u5168\u90e8\u5220\u9664\uff0c\u7136\u540e\u4f7f\u7528kubectl delete node\u5220\u9664\u8be5\u8282\u70b9\uff0c\u5728\u4fee\u6539kubelet\u914d\u7f6e\u6587\u4ef6\u4e2d\u8be5\u8282\u70b9\u7684\u540d\u79f0\uff0c\u7136\u540e\u4f7f\u7528kubectl delete csr\u5220\u9664\u6388\u6743\u4fe1\u606f\uff0c\u518d\u91cd\u542fkubelet\u751f\u6210\u65b0\u7684\u6388\u6743\u4fe1\u606f\uff0c\u7136\u540e\u6388\u6743\u901a\u8fc7\u5373\u53ef\u770b\u5230\u65b0\u7684\u540d\u5b57\u7684node\u8282\u70b9\u3002"),(0,a.kt)("p",null,"\u53ea\u6709\u5f53\u6388\u6743\u901a\u8fc7\u540e\uff0ckubelet\u751f\u6210\u4e86\u8bc1\u4e66\u6587\u4ef6\uff0ckubelet\u7684\u7aef\u53e3\u624d\u4f1a\u88ab\u542f\u52a8"),(0,a.kt)("p",null,"\u6ce8\u610f\uff1a\u5f53kubelet\u7684\u6388\u6743\u88abmaster\u8bf7\u6c42\u901a\u540e\uff0ckube-proxy\u542f\u52a8\u6210\u529f\u540e\uff0c\u8282\u70b9\u624d\u4f1a\u6b63\u771f\u7684\u52a0\u5165\u96c6\u7fa4\uff0c\u5373\u4f7fkubectl get node\u770b\u5230\u7684\u8282\u70b9\u662fReady\uff0c\u8be5\u8282\u70b9\u4e5f\u662f\u4e0d\u53ef\u7528\u7684\uff0c\u5fc5\u987b\u5f53kube-proxy\u542f\u52a8\u5b8c\u6bd5\u540e\uff0c\u8fd9\u4e2a\u8282\u70b9\u624d\u7b97\u6b63\u771f\u7684\u542f\u52a8\u5b8c\u6bd5<"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"1.\u76f4\u63a5\u5728master\u8282\u70b9\u4e0a\u6267\u884c\u5982\u4e0b\u547d\u4ee4\u83b7\u53d6\u8bf7\u6c42\u5217\u8868\n[root@binary-k8s-master1 ~]\\# kubectl get csr\nNAME                                                   AGE   SIGNERNAME                                    REQUESTOR           CONDITION\nnode-csr-JN8q9WljA6oupdWZ2mVO-TOIq2sLodFdkyL5fu6Ius4   4s    kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending\n\n2.\u6388\u6743\u540c\u610f\u6b64\u8282\u70b9\u52a0\u5165\u96c6\u7fa4\n[root@binary-k8s-master1 ~]\\# kubectl certificate approve node-csr-JN8q9WljA6oupdWZ2mVO-TOIq2sLodFdkyL5fu6Ius4\ncertificatesigningrequest.certificates.k8s.io/node-csr-JN8q9WljA6oupdWZ2mVO-TOIq2sLodFdkyL5fu6Ius4 approved\n\n3.\u67e5\u770bnode\u8282\u70b9\n[root@binary-k8s-master1 ~]\\# kubectl get node\nNAME                 STATUS     ROLES    AGE   VERSION\nbinary-k8s-master1   NotReady   <none>   6s    v1.20.4\n#\u6b64\u65f6master\u8282\u70b9\u5df2\u7ecf\u51fa\u73b0\u5728\u96c6\u7fa4\u8282\u70b9\u5217\u8868\u4e2d\u4e86\n\n4.\u67e5\u770bkubelet\u7aef\u53e3\n[root@binary-k8s-master1 ~]\\# netstat -lnpt | grep kubelet\ntcp        0      0 127.0.0.1:10248         0.0.0.0:*               LISTEN      29092/kubelet       \ntcp        0      0 127.0.0.1:41132         0.0.0.0:*               LISTEN      29092/kubelet       \ntcp6       0      0 :::10250                :::*                    LISTEN      29092/kubelet       \ntcp6       0      0 :::10255                :::*                    LISTEN      29092/kubelet \n")),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/857b38edfb4c46e99ccd40e7fa296628.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,a.kt)("h3",{id:"63\u5728master\u8282\u70b9\u90e8\u7f72kube-proxy"},"6.3.\u5728master\u8282\u70b9\u90e8\u7f72kube-proxy"),(0,a.kt)("h4",{id:"631\u521b\u5efakube-proxy\u914d\u7f6e\u6587\u4ef6"},"6.3.1.\u521b\u5efakube-proxy\u914d\u7f6e\u6587\u4ef6"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'[root@binary-k8s-master1 ~]\\# vim /data/kubernetes/config/kube-proxy.conf\nKUBE_PROXY_OPTS="--logtostderr=false \\\n--v=2 \\\n--log-dir=/data/kubernetes/logs \\\n--config=/data/kubernetes/config/kube-proxy-config.yml"\n')),(0,a.kt)("h4",{id:"632\u521b\u5efakube-proxy\u53c2\u6570\u914d\u7f6e\u6587\u4ef6"},"6.3.2.\u521b\u5efakube-proxy\u53c2\u6570\u914d\u7f6e\u6587\u4ef6"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"[root@binary-k8s-master1 ~]\\# vim /data/kubernetes/config/kube-proxy-config.yml\nkind: KubeProxyConfiguration\napiVersion: kubeproxy.config.k8s.io/v1alpha1\nbindAddress: 0.0.0.0                                    #\u76d1\u542c\u5730\u5740\nmetricsBindAddress: 0.0.0.0:10249                           #\u76d1\u542c\u7aef\u53e3\nclientConnection:\n  kubeconfig: /data/kubernetes/config/kube-proxy.kubeconfig         #kubeconfig\u6587\u4ef6\u7528\u4e8e\u548capiserver\u901a\u4fe1\nhostnameOverride: binary-k8s-master1                #\u5f53\u524d\u8282\u70b9\u540d\u79f0\nclusterCIDR: 10.244.0.0/16\n")),(0,a.kt)("h4",{id:"633\u751f\u6210kubeconfig\u6587\u4ef6"},"6.3.3.\u751f\u6210kubeconfig\u6587\u4ef6"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'1.\u521b\u5efa\u8bc1\u4e66\u914d\u7f6e\u6587\u4ef6\n[root@binary-k8s-master1 ~/TLS/k8s]\\# vim kube-proxy-csr.json \n{\n  "CN": "system:kube-proxy",\n  "hosts": [],\n  "key": {\n    "algo": "rsa",\n    "size": 2048\n  },\n  "names": [\n    {\n      "C": "CN",\n      "L": "BeiJing",\n      "ST": "BeiJing",\n      "O": "k8s",\n      "OU": "System"\n    }\n  ]\n}\n\n\n2.\u751f\u6210\u8bc1\u4e66\n[root@binary-k8s-master1 ~/TLS/k8s]\\# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy\n2021/09/03 16:04:23 [INFO] generate received request\n2021/09/03 16:04:23 [INFO] received CSR\n2021/09/03 16:04:23 [INFO] generating key: rsa-2048\n2021/09/03 16:04:24 [INFO] encoded CSR\n2021/09/03 16:04:24 [INFO] signed certificate with serial number 677418055440191127932354470575565723194258386145\n2021/09/03 16:04:24 [WARNING] This certificate lacks a "hosts" field. This makes it unsuitable for\nwebsites. For more information see the Baseline Requirements for the Issuance and Management\nof Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);\nspecifically, section 10.2.3 ("Information Requirements").\n\n3.\u67e5\u770b\u8bc1\u4e66\u6587\u4ef6\n[root@binary-k8s-master1 ~/TLS/k8s]\\# ll *proxy*\n-rw-r--r--. 1 root root 1009 9\u6708   3 16:04 kube-proxy.csr\n-rw-r--r--. 1 root root  230 9\u6708   3 16:04 kube-proxy-csr.json\n-rw-------. 1 root root 1679 9\u6708   3 16:04 kube-proxy-key.pem\n-rw-r--r--. 1 root root 1403 9\u6708   3 16:04 kube-proxy.pem\n\n\n4.\u62f7\u8d1d\u8bc1\u4e66\u6587\u4ef6\u81f3\u6307\u5b9a\u8def\u5f84\n[root@binary-k8s-master1 ~/TLS/k8s]\\# cp kube-proxy*.pem /data/kubernetes/ssl/\n\n5.\u751f\u6210kubeconfig\u6587\u4ef6\n#\u5728kubeconfig\u6587\u4ef6\u4e2d\u589e\u52a0\u96c6\u7fa4apiserver\u4fe1\u606f\n[root@binary-k8s-master1 ~]\\# kubectl config set-cluster kubernetes \\\n--certificate-authority=/data/kubernetes/ssl/ca.pem \\\n--embed-certs=true \\\n--server="https://192.168.20.10:6443" \\\n--kubeconfig=/data/kubernetes/config/kube-proxy.kubeconfig\n#\u5728kubeconfig\u6587\u4ef6\u4e2d\u589e\u52a0\u8bc1\u4e66\u6587\u4ef6\u4fe1\u606f \n[root@binary-k8s-master1 ~]\\# kubectl config set-credentials kube-proxy \\\n--client-certificate=/data/kubernetes/ssl/kube-proxy.pem \\\n--client-key=/data/kubernetes/ssl/kube-proxy-key.pem \\\n--embed-certs=true \\\n--kubeconfig=/data/kubernetes/config/kube-proxy.kubeconfig\n#\u5728kubeconfig\u6587\u4ef6\u4e2d\u589e\u52a0\u7528\u6237\u4fe1\u606f \n[root@binary-k8s-master1 ~]\\# kubectl config set-context default \\\n--cluster=kubernetes \\\n--user=kube-proxy \\\n--kubeconfig=/data/kubernetes/config/kube-proxy.kubeconfig\n\n6.\u6307\u5b9a\u751f\u6210\u7684kubeconfig\u6587\u4ef6\u4e3a\u96c6\u7fa4\u4f7f\u7528\n[root@binary-k8s-master1 ~]\\# kubectl config use-context default --kubeconfig=/data/kubernetes/config/kube-proxy.kubeconfig\n')),(0,a.kt)("h4",{id:"634\u521b\u5efasystemctl\u811a\u672c\u7ba1\u7406\u670d\u52a1"},"6.3.4.\u521b\u5efasystemctl\u811a\u672c\u7ba1\u7406\u670d\u52a1"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"[root@binary-k8s-master1 ~]\\# vim /usr/lib/systemd/system/kube-proxy.service\n[Unit]\nDescription=Kubernetes Proxy\nAfter=network.target\n\n[Service]\nEnvironmentFile=/data/kubernetes/config/kube-proxy.conf\nExecStart=/data/kubernetes/bin/kube-proxy $KUBE_PROXY_OPTS\nRestart=on-failure\nLimitNOFILE=65536\n\n[Install]\nWantedBy=multi-user.target\n")),(0,a.kt)("h4",{id:"634\u542f\u52a8kube-proxy\u7ec4\u4ef6"},"6.3.4.\u542f\u52a8kube-proxy\u7ec4\u4ef6"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"1.\u542f\u52a8\u670d\u52a1\n[root@binary-k8s-master1 ~]\\# systemctl daemon-reload\n[root@binary-k8s-master1 ~]\\# systemctl start kube-proxy\n[root@binary-k8s-master1 ~]\\# systemctl enable kube-proxy\n\n2.\u67e5\u770b\u7aef\u53e3\n[root@binary-k8s-master1 ~]\\# netstat -lnpt | grep kube-proxy\ntcp6       0      0 :::10249                :::*                    LISTEN      29354/kube-proxy    \ntcp6       0      0 :::10256                :::*                    LISTEN      29354/kube-proxy \n")),(0,a.kt)("h3",{id:"64\u6388\u6743apiserver\u8bbf\u95eekubelet"},"6.4.\u6388\u6743apiserver\u8bbf\u95eekubelet"),(0,a.kt)("p",null,"\u5982\u679c\u4e0d\u6536\u53d6apiserver\u8bbf\u95eekubelet\uff0c\u90a3\u4e48\u5c06\u65e0\u6cd5\u4f7f\u7528kubectl\u67e5\u770b\u96c6\u7fa4\u7684\u4e00\u4e9b\u4fe1\u606f\uff0c\u6bd4\u5982kubectl logs\u5c31\u65e0\u6cd5\u4f7f\u7528\u3002"),(0,a.kt)("p",null,"\u5b9e\u9645\u4e0a\u5c31\u662f\u521b\u5efa\u4e00\u4e2arbac\u8d44\u6e90\u8ba9apiserver\u80fd\u5426\u8bbf\u95eekubelet\u7684\u8d44\u6e90\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'1.\u7f16\u5199\u8d44\u6e90yaml\u6587\u4ef6\n[root@binary-k8s-master1 ~]\\# vim apiserver-to-kubelet-rbac.yaml \napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  annotations:\n    rbac.authorization.kubernetes.io/autoupdate: "true"\n  labels:\n    kubernetes.io/bootstrapping: rbac-defaults\n  name: system:kube-apiserver-to-kubelet\nrules:\n  - apiGroups:\n      - ""\n    resources:\n      - nodes/proxy\n      - nodes/stats\n      - nodes/log\n      - nodes/spec\n      - nodes/metrics\n      - pods/log\n    verbs:\n      - "*"\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: system:kube-apiserver\n  namespace: ""\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: system:kube-apiserver-to-kubelet\nsubjects:\n  - apiGroup: rbac.authorization.k8s.io\n    kind: User\n    name: kubernetes\n\n2.\u521b\u5efa\u8d44\u6e90\n[root@binary-k8s-master1 ~]\\# kubectl apply -f apiserver-to-kubelet-rbac.yaml\nclusterrole.rbac.authorization.k8s.io/system:kube-apiserver-to-kubelet created\nclusterrolebinding.rbac.authorization.k8s.io/system:kube-apiserver created\n')),(0,a.kt)("h2",{id:"7\u90e8\u7f72kubernetes-calico\u7f51\u7edc\u7ec4\u4ef6"},"7.\u90e8\u7f72kubernetes calico\u7f51\u7edc\u7ec4\u4ef6"),(0,a.kt)("p",null,"\u57286\u4e2dmaster\u8282\u70b9\u5df2\u7ecf\u52a0\u5165\u96c6\u7fa4\uff0c\u4f46\u662f\u72b6\u6001\u4e00\u76f4\u5904\u4e8eNotReady\u72b6\u6001\uff0c\u5c31\u662f\u7531\u4e8e\u96c6\u7fa4\u6ca1\u6709\u7f51\u7edc\u7ec4\u4ef6\u5bfc\u81f4\u7684\uff0c\u90e8\u7f72\u597d\u7f51\u7edc\u7ec4\u4ef6\uff0cmaster\u8282\u70b9\u7acb\u9a6c\u4f1a\u6210\u4e3aReady\u72b6\u6001\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"1.\u90e8\u7f72calico\n[root@binary-k8s-master1 ~]\\# kubectl apply -f calico.yaml\nconfigmap/calico-config created\ncustomresourcedefinition.apiextensions.k8s.io/bgpconfigurations.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/bgppeers.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/blockaffinities.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/clusterinformations.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/felixconfigurations.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/globalnetworkpolicies.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/globalnetworksets.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/hostendpoints.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/ipamblocks.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/ipamconfigs.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/ipamhandles.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/ippools.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/kubecontrollersconfigurations.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/networkpolicies.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/networksets.crd.projectcalico.org created\nclusterrole.rbac.authorization.k8s.io/calico-kube-controllers created\nclusterrolebinding.rbac.authorization.k8s.io/calico-kube-controllers created\nclusterrole.rbac.authorization.k8s.io/calico-node created\nclusterrolebinding.rbac.authorization.k8s.io/calico-node created\ndaemonset.apps/calico-node created\nserviceaccount/calico-node created\ndeployment.apps/calico-kube-controllers created\nserviceaccount/calico-kube-controllers created\n\n2.\u67e5\u770b\u8d44\u6e90\u72b6\u6001\n[root@binary-k8s-master1 ~]\\# kubectl get pod -n kube-system\nNAME                                      READY   STATUS    RESTARTS   AGE\ncalico-kube-controllers-97769f7c7-bnwcl   1/1     Running   0          11m\ncalico-node-mghdj                         1/1     Running   0          11m\n\n3.\u67e5\u770bmaster\u8282\u70b9\u7684\u72b6\u6001\n[root@binary-k8s-master1 ~]\\# kubectl get node\nNAME          STATUS   ROLES    AGE   VERSION\nk8s-master1   Ready    <none>   99m   v1.20.4\n")),(0,a.kt)("h2",{id:"8\u90e8\u7f72kubernetes-node\u8282\u70b9"},"8.\u90e8\u7f72kubernetes node\u8282\u70b9"),(0,a.kt)("h3",{id:"81\u89e3\u538b\u4e8c\u8fdb\u5236\u6587\u4ef6\u590d\u5236\u76f8\u5173\u7ec4\u4ef6\u7a0b\u5e8f"},"8.1.\u89e3\u538b\u4e8c\u8fdb\u5236\u6587\u4ef6\u590d\u5236\u76f8\u5173\u7ec4\u4ef6\u7a0b\u5e8f"),(0,a.kt)("p",null,"\u4ee5\u4e0b\u64cd\u4f5c\u4ec5\u5728node1\u8282\u70b9\u64cd\u4f5c\u5373\u53ef\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"1.\u51c6\u5907\u4e8c\u8fdb\u5236\u7a0b\u5e8f\n[root@binary-k8s-node1 ~]\\# tar xf kubernetes-server-linux-amd64.tar.gz \n[root@binary-k8s-node1 ~]\\# mkdir -p /data/kubernetes/{bin,config,ssl,logs} \n[root@binary-k8s-node1 ~]\\# cp kubernetes/server/bin/{kubelet,kube-proxy} /data/kubernetes/bin/\n[root@binary-k8s-node1 ~]\\# cp kubernetes/server/bin/kubectl /usr/bin/\n\n2.\u5c06master\u8282\u70b9\u4e0a\u7684\u8bc1\u4e66\u6587\u4ef6\u62f7\u8d1d\u81f3node\u8282\u70b9\n[root@binary-k8s-master1 ~]\\# scp -rp /data/kubernetes/ssl/* binary-k8s-node1:/data/kubernetes/ssl/\n[root@binary-k8s-master1 ~]\\# scp -rp /data/kubernetes/config/token.csv root@binary-k8s-node1:/data/kubernetes/config\n\n3.\u5220\u9664\u4ecemaster\u8282\u70b9\u4e0a\u62f7\u8d1d\u8fc7\u6765\u7684kubelet\u8bc1\u4e66\n[root@binary-k8s-node1 ~]\\# rm -rf /data/kubernetes/ssl/kubelet-client-*\n#kubelet\u8bc1\u4e66\u9700\u8981\u5220\u9664\uff0c\u5f53node\u8282\u70b9\u7684kubelet\u542f\u52a8\u540e\u4f1a\u751f\u6210\u4e34\u65f6\u8bc1\u4e66\u6587\u4ef6\uff0c\u5f53master\u6388\u6743\u901a\u8fc7\u540e\uff0c\u8bc1\u4e66\u6587\u4ef6\u4ea7\u751f\n")),(0,a.kt)("h3",{id:"82\u90e8\u7f72kubelet\u7ec4\u4ef6"},"8.2.\u90e8\u7f72kubelet\u7ec4\u4ef6"),(0,a.kt)("h4",{id:"821\u521b\u5efakubelet\u914d\u7f6e\u6587\u4ef6"},"8.2.1.\u521b\u5efakubelet\u914d\u7f6e\u6587\u4ef6"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'[root@binary-k8s-node1 ~]\\# vim /data/kubernetes/config/kubelet.conf \nKUBELET_OPTS="--logtostderr=false \\\n--v=2 \\\n--log-dir=/data/kubernetes/logs \\\n--hostname-override=binary-k8s-node1        #\u6ce8\u610f\u4fee\u6539\u8282\u70b9\u540d\u79f0 \\\n--network-plugin=cni \\\n--kubeconfig=/data/kubernetes/config/kubelet.kubeconfig \\\n--bootstrap-kubeconfig=/data/kubernetes/config/bootstrap.kubeconfig \\\n--config=/data/kubernetes/config/kubelet-config.yml \\\n--cert-dir=/data/kubernetes/ssl \\\n--pod-infra-container-image=pause-amd64:3.0"\n')),(0,a.kt)("h4",{id:"822\u521b\u5efakubelet\u53c2\u6570\u914d\u7f6e\u6587\u4ef6"},"8.2.2.\u521b\u5efakubelet\u53c2\u6570\u914d\u7f6e\u6587\u4ef6"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"[root@binary-k8s-node1 ~]\\# vim /data/kubernetes/config/kubelet-config.yml\nkind: KubeletConfiguration\napiVersion: kubelet.config.k8s.io/v1beta1\naddress: 0.0.0.0\nport: 10250\nreadOnlyPort: 10255\ncgroupDriver: cgroupfs\nclusterDNS:\n- 10.0.0.2\nclusterDomain: cluster.local\nfailSwapOn: false\nauthentication:\n  anonymous:\n    enabled: false\n  webhook:\n    cacheTTL: 2m0s\n    enabled: true\n  x509:\n    clientCAFile: /data/kubernetes/ssl/ca.pem\nauthorization:\n  mode: Webhook\n  webhook:\n    cacheAuthorizedTTL: 5m0s\n    cacheUnauthorizedTTL: 30s\nevictionHard:\n  imagefs.available: 15%\n  memory.available: 100Mi\n  nodefs.available: 10%\n  nodefs.inodesFree: 5%\nmaxOpenFiles: 1000000\nmaxPods: 110\n")),(0,a.kt)("h4",{id:"823\u521b\u5efabootstrap-kubeconfig\u6587\u4ef6"},"8.2.3.\u521b\u5efabootstrap-kubeconfig\u6587\u4ef6"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'1.\u5728kubeconfig\u6587\u4ef6\u4e2d\u589e\u52a0\u96c6\u7fa4apiserver\u4fe1\u606f\n[root@binary-k8s-node1 ~]\\# kubectl config set-cluster kubernetes \\\n--certificate-authority=/data/kubernetes/ssl/ca.pem \\\n--embed-certs=true \\\n--server="https://192.168.20.10:6443" \\\n--kubeconfig=/data/kubernetes/config/bootstrap.kubeconfig\n  \n2.\u5728kubeconfig\u6587\u4ef6\u4e2d\u589e\u52a0token\u4fe1\u606f\n[root@binary-k8s-master1 ~]\\# kubectl config set-credentials "kubelet-bootstrap" \\\n--token=d7f96b0d86c574d0f64a713608db0922 \\\n--kubeconfig=/data/kubernetes/config/bootstrap.kubeconfig\n#\u8fd9\u4e2atoken\u5c31\u662f\u4e4b\u524d\u751f\u6210\u7684/data/kubernetes/config/token.csv\u4e2d\u7684token\n  \n3.\u5728kubeconfig\u6587\u4ef6\u4e2d\u589e\u52a0\u7528\u6237\u4fe1\u606f \n[root@binary-k8s-master1 ~]\\# kubectl config set-context default \\\n--cluster=kubernetes \\\n--user="kubelet-bootstrap" \\\n--kubeconfig=/data/kubernetes/config/bootstrap.kubeconfig\n\n4.\u6307\u5b9a\u751f\u6210\u7684kubeconfig\u6587\u4ef6\u4e3a\u96c6\u7fa4\u4f7f\u7528\n[root@binary-k8s-master1 ~]\\# kubectl config use-context default --kubeconfig=/data/kubernetes/config/bootstrap.kubeconfig\n')),(0,a.kt)("h4",{id:"824\u521b\u5efasystemctl\u811a\u672c\u5e76\u542f\u52a8\u670d\u52a1"},"8.2.4.\u521b\u5efasystemctl\u811a\u672c\u5e76\u542f\u52a8\u670d\u52a1"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"1.\u7f16\u5199systemctl\u670d\u52a1\u811a\u672c\n[root@binary-k8s-node1 ~]\\# vim /usr/lib/systemd/system/kubelet.service\n[Unit]\nDescription=Kubernetes Kubelet\nAfter=docker.service\n\n[Service]\nEnvironmentFile=/data/kubernetes/config/kubelet.conf\nExecStart=/data/kubernetes/bin/kubelet $KUBELET_OPTS\nRestart=on-failure\nLimitNOFILE=65536\n\n[Install]\nWantedBy=multi-user.target\n\n2.\u542f\u52a8kubelet\u670d\u52a1\n[root@binary-k8s-node1 ~]\\# systemctl daemon-reload\n[root@binary-k8s-node1 ~]\\# systemctl start kubelet\n[root@binary-k8s-node1 ~]\\# systemctl enable kubelet\n[root@binary-k8s-node1 ~]\\# systemctl status kubelet\n")),(0,a.kt)("h4",{id:"825master\u8282\u70b9\u6388\u6743\u540c\u610fnode\u8282\u70b9\u52a0\u5165\u96c6\u7fa4"},"8.2.5.master\u8282\u70b9\u6388\u6743\u540c\u610fnode\u8282\u70b9\u52a0\u5165\u96c6\u7fa4"),(0,a.kt)("p",null,"kubelet\u670d\u52a1\u542f\u52a8\u540e\uff0c\u4f1a\u751f\u6210\u4e00\u4e2a\u4e34\u65f6\u8bc1\u4e66\u6587\u4ef6\uff0c\u7136\u540e\u5411master\u8282\u70b9\u53d1\u9001\u4e00\u4e2acsr\u6388\u6743\u8bf7\u6c42\uff0c\u5f53master\u8282\u70b9\u6388\u6743\u540c\u610f\u540e\uff0ckubelet-clinet\u8bc1\u4e66\u6587\u4ef6\u751f\u6210\uff0c\u7aef\u53e3\u4e5f\u968f\u4e4b\u542f\u52a8\uff0c\u8282\u70b9\u6b63\u5e38\u52a0\u5165\u96c6\u7fa4\u3002"),(0,a.kt)("p",null,"csr\u5217\u8868\u7684\u6388\u6743\u4fe1\u606f\u4e5f\u4f1a\u81ea\u52a8\u6e05\u7a7a\uff0c\u5982\u679cmaster\u8282\u70b9\u7684\u6388\u6743\u4e0d\u53ca\u65f6\uff0c\u4e5f\u53ef\u4ee5\u91cd\u542f\u4e00\u4e0bkubelet\u91cd\u65b0\u53d1\u9001\u4e00\u4e2acsr\u8bf7\u6c42\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"1.\u5728node\u8282\u70b9\u67e5\u770b\u4e34\u65f6\u8bc1\u4e66\u6587\u4ef6\n[root@binary-k8s-node1 ~]\\# ll /data/kubernetes/ssl/*.tmp\n-rw-------. 1 root root  227 9\u6708   6 11:28 kubelet-client.key.tmp\n#\u53ea\u8981kubelet\u542f\u52a8\u5c31\u4f1a\u4ea7\u751f\u4e00\u4e2a\u4e34\u65f6\u8bc1\u4e66\u6587\u4ef6\n\n2.\u5728master\u8282\u70b9\u67e5\u770bcsr\u6388\u6743\u8bf7\u6c42\u5217\u8868\n[root@binary-k8s-master1 ~]\\# kubectl get csr\nNAME                                                   AGE    SIGNERNAME                                    REQUESTOR           CONDITION\nnode-csr-JmO7N8iDvyD0D-2Pu7_yHJ3ngZ5xXfA_TwRevqmHAXI   11s    kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending\n\n3.\u6388\u6743\u901a\u8fc7\n[root@binary-k8s-master1 ~]\\# kubectl certificate approve node-csr-JmO7N8iDvyD0D-2Pu7_yHJ3ngZ5xXfA_TwRevqmHAXI\ncertificatesigningrequest.certificates.k8s.io/node-csr-JmO7N8iDvyD0D-2Pu7_yHJ3ngZ5xXfA_TwRevqmHAXI approved\n\n4.\u6b64\u65f6\u4e34\u65f6\u6587\u4ef6\u5df2\u5220\u9664\uff0c\u5df2\u7ecf\u751f\u6210kubelet\u8bc1\u4e66\u6587\u4ef6\n[root@binary-k8s-node1 ~]\\# ll /data/kubernetes/ssl/kubelet-client*\n-rw-------. 1 root root 1236 9\u6708   6 11:28 kubelet-client-2021-09-06-11-28-54.pem\nlrwxrwxrwx. 1 root root   59 9\u6708   6 11:28 kubelet-client-current.pem -> /data/kubernetes/ssl/kubelet-client-2021-09-06-11-28-54.pem\n\n5.node1\u8282\u70b9\u6210\u529f\u52a0\u5165\u96c6\u7fa4\n[root@binary-k8s-master1 ~]\\# kubectl get node\nNAME                 STATUS   ROLES    AGE     VERSION\nbinary-k8s-master1   Ready    <none>   2d22h   v1.20.4\nbinary-k8s-node1     Ready    <none>   4h59m   v1.20.4\n\n6.\u5728node\u8282\u70b9\u67e5\u770bkubelet\u670d\u52a1\u7684\u7aef\u53e3\n[root@binary-k8s-node1 ~]\\# netstat -lnpt | grep kubelet\ntcp        0      0 127.0.0.1:10248         0.0.0.0:*               LISTEN      29220/kubelet       \ntcp        0      0 127.0.0.1:44151         0.0.0.0:*               LISTEN      29220/kubelet       \ntcp6       0      0 :::10250                :::*                    LISTEN      29220/kubelet       \ntcp6       0      0 :::10255                :::*                    LISTEN      29220/kubelet\n")),(0,a.kt)("h3",{id:"83\u90e8\u7f72kube-proxy\u7ec4\u4ef6"},"8.3.\u90e8\u7f72kube-proxy\u7ec4\u4ef6"),(0,a.kt)("h4",{id:"831\u521b\u5efakube-proxy\u914d\u7f6e\u6587\u4ef6"},"8.3.1.\u521b\u5efakube-proxy\u914d\u7f6e\u6587\u4ef6"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'[root@binary-k8s-node1 ~]\\# vim /data/kubernetes/config/kube-proxy.conf\nKUBE_PROXY_OPTS="--logtostderr=false \\\n--v=2 \\\n--log-dir=/data/kubernetes/logs \\\n--config=/data/kubernetes/config/kube-proxy-config.yml"\n')),(0,a.kt)("h4",{id:"832\u521b\u5efakube-proxy\u53c2\u6570\u914d\u7f6e\u6587\u4ef6"},"8.3.2.\u521b\u5efakube-proxy\u53c2\u6570\u914d\u7f6e\u6587\u4ef6"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"[root@binary-k8s-node1 ~]\\# vim /data/kubernetes/config/kube-proxy-config.yml\nkind: KubeProxyConfiguration\napiVersion: kubeproxy.config.k8s.io/v1alpha1\nbindAddress: 0.0.0.0                                    #\u76d1\u542c\u5730\u5740\nmetricsBindAddress: 0.0.0.0:10249                           #\u76d1\u542c\u7aef\u53e3\nclientConnection:\n  kubeconfig: /data/kubernetes/config/kube-proxy.kubeconfig         #kubeconfig\u6587\u4ef6\u7528\u4e8e\u548capiserver\u901a\u4fe1\nhostnameOverride: binary-k8s-node1              #\u5f53\u524d\u8282\u70b9\u540d\u79f0\nclusterCIDR: 10.244.0.0/16\n")),(0,a.kt)("h4",{id:"833\u751f\u6210kube-config\u6587\u4ef6"},"8.3.3.\u751f\u6210kube-config\u6587\u4ef6"),(0,a.kt)("p",null,"\u7531\u4e8ekube-proxy\u7684\u8bc1\u4e66\u6587\u4ef6\u57288.1\u4e2d\u5df2\u7ecf\u4ecemaster\u8282\u70b9\u62f7\u8d1d\u5230node\u8282\u70b9\u4e86\uff0c\u56e0\u6b64\u76f4\u63a5\u751f\u6210kubeconfig\u6587\u4ef6\u5373\u53ef\u3002"),(0,a.kt)("p",null,"\u96c6\u7fa4\u4e2d\u4e0d\u540c\u8282\u70b9\u7684\u7ec4\u4ef6\u90fd\u8981\u7528\u540c\u4e00\u4e2a\u8bc1\u4e66\u6587\u4ef6\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'1.\u751f\u6210kubeconfig\u6587\u4ef6\n#\u5728kubeconfig\u6587\u4ef6\u4e2d\u589e\u52a0\u96c6\u7fa4apiserver\u4fe1\u606f\n[root@binary-k8s-node1 ~]\\# kubectl config set-cluster kubernetes \\\n--certificate-authority=/data/kubernetes/ssl/ca.pem \\\n--embed-certs=true \\\n--server="https://192.168.20.10:6443" \\\n--kubeconfig=/data/kubernetes/config/kube-proxy.kubeconfig\n#\u5728kubeconfig\u6587\u4ef6\u4e2d\u589e\u52a0\u8bc1\u4e66\u6587\u4ef6\u4fe1\u606f \n[root@binary-k8s-node1 ~]\\# kubectl config set-credentials kube-proxy \\\n--client-certificate=/data/kubernetes/ssl/kube-proxy.pem \\\n--client-key=/data/kubernetes/ssl/kube-proxy-key.pem \\\n--embed-certs=true \\\n--kubeconfig=/data/kubernetes/config/kube-proxy.kubeconfig\n#\u5728kubeconfig\u6587\u4ef6\u4e2d\u589e\u52a0\u7528\u6237\u4fe1\u606f \n[root@binary-k8s-node1 ~]\\# kubectl config set-context default \\\n--cluster=kubernetes \\\n--user=kube-proxy \\\n--kubeconfig=/data/kubernetes/config/kube-proxy.kubeconfig\n\n2.\u6307\u5b9a\u751f\u6210\u7684kubeconfig\u6587\u4ef6\u4e3a\u96c6\u7fa4\u4f7f\u7528\n[root@binary-k8s-node1 ~]\\# kubectl config use-context default --kubeconfig=/data/kubernetes/config/kube-proxy.kubeconfig\n')),(0,a.kt)("h4",{id:"834\u521b\u5efasystemctl\u811a\u672c\u7ba1\u7406\u670d\u52a1"},"8.3.4.\u521b\u5efasystemctl\u811a\u672c\u7ba1\u7406\u670d\u52a1"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"[root@binary-k8s-node1 ~]\\# vim /usr/lib/systemd/system/kube-proxy.service\n[Unit]\nDescription=Kubernetes Proxy\nAfter=network.target\n\n[Service]\nEnvironmentFile=/data/kubernetes/config/kube-proxy.conf\nExecStart=/data/kubernetes/bin/kube-proxy $KUBE_PROXY_OPTS\nRestart=on-failure\nLimitNOFILE=65536\n\n[Install]\nWantedBy=multi-user.targ\n")),(0,a.kt)("h4",{id:"835\u542f\u52a8kube-proxy\u7ec4\u4ef6"},"8.3.5.\u542f\u52a8kube-proxy\u7ec4\u4ef6"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"1.\u542f\u52a8\u670d\u52a1\n[root@binary-k8s-node1 ~]\\# systemctl daemon-reload\n[root@binary-k8s-node1 ~]\\# systemctl start kube-proxy\n[root@binary-k8s-node1 ~]\\# systemctl enable kube-proxy\n\n2.\u67e5\u770b\u7aef\u53e3\n[root@binary-k8s-node1 ~]\\# netstat -lnpt | grep kube-proxy\ntcp6       0      0 :::10249                :::*                    LISTEN      26954/kube-proxy    \ntcp6       0      0 :::10256                :::*                    LISTEN      26954/kube-proxy  \n")),(0,a.kt)("h3",{id:"84\u5feb\u901f\u589e\u52a0\u65b0\u7684node\u8282\u70b9"},"8.4.\u5feb\u901f\u589e\u52a0\u65b0\u7684node\u8282\u70b9"),(0,a.kt)("p",null,"\u4e8c\u8fdb\u5236\u90e8\u7f72\u7684\u7a0b\u5e8f\u7279\u522b\u597d\u7684\u4e00\u4e2a\u5730\u65b9\u5c31\u5728\u4e8e\uff0c\u80fd\u591f\u5feb\u901f\u90e8\u7f72\u4e00\u4e2a\u65b0\u7684\u670d\u52a1\uff0c\u505a\u6cd5\u5c31\u662f\u76f4\u63a5\u62f7\u8d1d\u5df2\u7ecf\u90e8\u7f72\u597d\u7684\u76ee\u5f55\u5230\u4e00\u4e2a\u65b0\u7684\u4f4d\u7f6e\uff0c\u6539\u6539\u5176\u4e2d\u7684\u53c2\u6570\u5373\u53ef\u542f\u52a8\u4f7f\u7528\u4e86\u3002"),(0,a.kt)("h4",{id:"841\u5c06kubelet\u548ckube-proxy\u76ee\u5f55\u62f7\u8d1d\u81f3\u65b0\u7684node\u8282\u70b9"},"8.4.1.\u5c06kubelet\u548ckube-proxy\u76ee\u5f55\u62f7\u8d1d\u81f3\u65b0\u7684node\u8282\u70b9"),(0,a.kt)("p",null,"\u8981\u62f7\u8d1dkubelet\u548ckube-proxy\u90e8\u7f72\u76ee\u5f55\u4ee5\u53casystemctl\u542f\u52a8\u811a\u672c\u6587\u4ef6\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"[root@binary-k8s-node1 ~]\\# scp -rp /data/kubernetes root@binary-k8s-node2:/data\n[root@binary-k8s-node1 ~]\\# scp /usr/lib/systemd/system/kube* root@binary-k8s-node2:/usr/lib/systemd/system/\n")),(0,a.kt)("h4",{id:"842\u914d\u7f6e\u5e76\u542f\u52a8kubelet\u7ec4\u4ef6"},"8.4.2.\u914d\u7f6e\u5e76\u542f\u52a8kubelet\u7ec4\u4ef6"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'1.\u5220\u9664\u6ca1\u7528\u7684\u8bc1\u4e66\u6587\u4ef6\n[root@binary-k8s-node2 ~]\\# rm -rf /data/kubernetes/ssl/kubelet-client-*\n\n2.\u4fee\u6539kubelet\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u8282\u70b9\u540d\u79f0\n[root@binary-k8s-node2 ~]\\# vim /data/kubernetes/config/kubelet.conf \nKUBELET_OPTS="--logtostderr=false \\\n--v=2 \\\n--log-dir=/data/kubernetes/logs \\\n--hostname-override=binary-k8s-node2 \\\n--network-plugin=cni \\\n--kubeconfig=/data/kubernetes/config/kubelet.kubeconfig \\\n--bootstrap-kubeconfig=/data/kubernetes/config/bootstrap.kubeconfig \\\n--config=/data/kubernetes/config/kubelet-config.yml \\\n--cert-dir=/data/kubernetes/ssl \\\n--pod-infra-container-image=pause-amd64:3.0"\n#\u5c06--hostname-override\u503c\u4fee\u6539\u4e3a\u5f53\u524d\u8282\u70b9\u540d\u79f0\u5373\u53ef\n\n3.\u542f\u52a8kubelet\n[root@binary-k8s-node2 ~]\\# systemctl daemon-reload \n[root@binary-k8s-node2 ~]\\# systemctl start kubelet\n[root@binary-k8s-node2 ~]\\# systemctl enable kubelet\n')),(0,a.kt)("h4",{id:"843master\u8282\u70b9\u6388\u6743\u65b0node\u8282\u70b9\u7684\u8bf7\u6c42"},"8.4.3.master\u8282\u70b9\u6388\u6743\u65b0node\u8282\u70b9\u7684\u8bf7\u6c42"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"1.master\u8282\u70b9\u67e5\u770b\u6388\u6743\u4fe1\u606f\u5217\u8868\n[root@binary-k8s-master1 ~]\\# kubectl get csr\nNAME                                                   AGE   SIGNERNAME                                    REQUESTOR           CONDITION\nnode-csr-u_AHUS7T5rku-hnhnGsGi8uGBqlgMquOq_3oq6jrOyE   48s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending\n\n2.\u6388\u6743\u901a\u8fc7node\u8282\u70b9\u7684kubelet\n[root@binary-k8s-master1 ~]\\# kubectl certificate approve node-csr-u_AHUS7T5rku-hnhnGsGi8uGBqlgMquOq_3oq6jrOyE\ncertificatesigningrequest.certificates.k8s.io/node-csr-u_AHUS7T5rku-hnhnGsGi8uGBqlgMquOq_3oq6jrOyE approved\n\n3.\u6210\u529f\u52a0\u5165\u96c6\u7fa4\n[root@binary-k8s-master1 ~]\\# kubectl get node\nNAME                 STATUS   ROLES    AGE     VERSION\nbinary-k8s-master1   Ready    <none>   2d23h   v1.20.4\nbinary-k8s-node1     Ready    <none>   5h54m   v1.20.4\nbinary-k8s-node2     Ready    <none>   1s      v1.20.4\n\n4.\u67e5\u770bkubelet\u7684\u7aef\u53e3\n[root@binary-k8s-node2 ~]\\# netstat -lnpt | grep kube\ntcp        0      0 127.0.0.1:41121         0.0.0.0:*               LISTEN      16694/kubelet       \ntcp        0      0 127.0.0.1:10248         0.0.0.0:*               LISTEN      16694/kubelet       \ntcp6       0      0 :::10250                :::*                    LISTEN      16694/kubelet       \ntcp6       0      0 :::10255                :::*                    LISTEN      16694/kubelet\n")),(0,a.kt)("h4",{id:"844\u914d\u7f6e\u5e76\u542f\u52a8kube-proxy\u7ec4\u4ef6"},"8.4.4.\u914d\u7f6e\u5e76\u542f\u52a8kube-proxy\u7ec4\u4ef6"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"1.\u4fee\u6539kube-proxy\u53c2\u6570\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u4e3b\u673a\u540d\n[root@binary-k8s-node2 ~]\\# vim /data/kubernetes/config/kube-proxy-config.yml \nkind: KubeProxyConfiguration\napiVersion: kubeproxy.config.k8s.io/v1alpha1\nbindAddress: 0.0.0.0\nmetricsBindAddress: 0.0.0.0:10249\nclientConnection:\n  kubeconfig: /data/kubernetes/config/kube-proxy.kubeconfig\nhostnameOverride: binary-k8s-node2\nclusterCIDR: 10.244.0.0/16\n\n2.\u542f\u52a8kubelet\n[root@binary-k8s-node2 ~]\\# systemctl daemon-reload \n[root@binary-k8s-node2 ~]\\# systemctl start kube-proxy\n[root@binary-k8s-node2 ~]\\# systemctl enable kube-proxy\n\n3\u67e5\u770bkube-proxy\u7aef\u53e3\n[root@binary-k8s-node2 ~]\\# netstat -lnpt | grep kube\ntcp        0      0 127.0.0.1:41121         0.0.0.0:*               LISTEN      16694/kubelet       \ntcp        0      0 127.0.0.1:10248         0.0.0.0:*               LISTEN      16694/kubelet       \ntcp6       0      0 :::10249                :::*                    LISTEN      20410/kube-proxy    \ntcp6       0      0 :::10250                :::*                    LISTEN      16694/kubelet       \ntcp6       0      0 :::10255                :::*                    LISTEN      16694/kubelet       \ntcp6       0      0 :::10256                :::*                    LISTEN      20410/kube-proxy\n")),(0,a.kt)("h2",{id:"9\u4e3a\u96c6\u7fa4\u90e8\u7f72coredns\u7ec4\u4ef6"},"9.\u4e3a\u96c6\u7fa4\u90e8\u7f72coredns\u7ec4\u4ef6"),(0,a.kt)("h3",{id:"91\u90e8\u7f72coredns\u7ec4\u4ef6"},"9.1.\u90e8\u7f72coredns\u7ec4\u4ef6"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'1.coredns.yaml\u6587\u4ef6\u5185\u5bb9\n[root@binary-k8s-master1 ~]\\# cat coredns.yaml \n# Warning: This is a file generated from the base underscore template file: coredns.yaml.base\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: coredns\n  namespace: kube-system\n  labels:\n      kubernetes.io/cluster-service: "true"\n      addonmanager.kubernetes.io/mode: Reconcile\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  labels:\n    kubernetes.io/bootstrapping: rbac-defaults\n    addonmanager.kubernetes.io/mode: Reconcile\n  name: system:coredns\nrules:\n- apiGroups:\n  - ""\n  resources:\n  - endpoints\n  - services\n  - pods\n  - namespaces\n  verbs:\n  - list\n  - watch\n- apiGroups:\n  - ""\n  resources:\n  - nodes\n  verbs:\n  - get\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  annotations:\n    rbac.authorization.kubernetes.io/autoupdate: "true"\n  labels:\n    kubernetes.io/bootstrapping: rbac-defaults\n    addonmanager.kubernetes.io/mode: EnsureExists\n  name: system:coredns\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: system:coredns\nsubjects:\n- kind: ServiceAccount\n  name: coredns\n  namespace: kube-system\n---\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: coredns\n  namespace: kube-system\n  labels:\n      addonmanager.kubernetes.io/mode: EnsureExists\ndata:\n  Corefile: |\n    .:53 {\n        log\n        errors\n        health {\n            lameduck 5s\n        }\n        ready\n        kubernetes cluster.local in-addr.arpa ip6.arpa {\n            pods insecure\n            fallthrough in-addr.arpa ip6.arpa\n            ttl 30\n        }\n        prometheus :9153\n        forward . /etc/resolv.conf\n        cache 30\n        loop\n        reload\n        loadbalance\n    }\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: coredns\n  namespace: kube-system\n  labels:\n    k8s-app: kube-dns\n    kubernetes.io/cluster-service: "true"\n    addonmanager.kubernetes.io/mode: Reconcile\n    kubernetes.io/name: "CoreDNS"\nspec:\n  # replicas: not specified here:\n  # 1. In order to make Addon Manager do not reconcile this replicas parameter.\n  # 2. Default is 1.\n  # 3. Will be tuned in real time if DNS horizontal auto-scaling is turned on.\n  strategy:\n    type: RollingUpdate\n    rollingUpdate:\n      maxUnavailable: 1\n  selector:\n    matchLabels:\n      k8s-app: kube-dns\n  template:\n    metadata:\n      labels:\n        k8s-app: kube-dns\n      annotations:\n        seccomp.security.alpha.kubernetes.io/pod: \'runtime/default\'\n    spec:\n      priorityClassName: system-cluster-critical\n      serviceAccountName: coredns\n      tolerations:\n        - key: "CriticalAddonsOnly"\n          operator: "Exists"\n      nodeSelector:\n        kubernetes.io/os: linux\n      containers:\n      - name: coredns\n        image: coredns:1.6.7\n        imagePullPolicy: IfNotPresent\n        resources:\n          limits:\n            memory: 512Mi \n          requests:\n            cpu: 100m\n            memory: 70Mi\n        args: [ "-conf", "/etc/coredns/Corefile" ]\n        volumeMounts:\n        - name: config-volume\n          mountPath: /etc/coredns\n          readOnly: true\n        ports:\n        - containerPort: 53\n          name: dns\n          protocol: UDP\n        - containerPort: 53\n          name: dns-tcp\n          protocol: TCP\n        - containerPort: 9153\n          name: metrics\n          protocol: TCP\n        livenessProbe:\n          httpGet:\n            path: /health\n            port: 8080\n            scheme: HTTP\n          initialDelaySeconds: 60\n          timeoutSeconds: 5\n          successThreshold: 1\n          failureThreshold: 5\n        readinessProbe:\n          httpGet:\n            path: /ready\n            port: 8181\n            scheme: HTTP\n        securityContext:\n          allowPrivilegeEscalation: false\n          capabilities:\n            add:\n            - NET_BIND_SERVICE\n            drop:\n            - all\n          readOnlyRootFilesystem: true\n      dnsPolicy: Default\n      volumes:\n        - name: config-volume\n          configMap:\n            name: coredns\n            items:\n            - key: Corefile\n              path: Corefile\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: kube-dns\n  namespace: kube-system\n  annotations:\n    prometheus.io/port: "9153"\n    prometheus.io/scrape: "true"\n  labels:\n    k8s-app: kube-dns\n    kubernetes.io/cluster-service: "true"\n    addonmanager.kubernetes.io/mode: Reconcile\n    kubernetes.io/name: "CoreDNS"\nspec:\n  selector:\n    k8s-app: kube-dns\n  clusterIP: 10.0.0.2 \n  ports:\n  - name: dns\n    port: 53\n    protocol: UDP\n  - name: dns-tcp\n    port: 53\n    protocol: TCP\n  - name: metrics\n    port: 9153\n    protocol: TCP\n\n2.\u90e8\u7f72coredns\n[root@binary-k8s-master1 ~]\\# kubectl apply -f coredns.yaml \nserviceaccount/coredns created\nclusterrole.rbac.authorization.k8s.io/system:coredns created\nclusterrolebinding.rbac.authorization.k8s.io/system:coredns created\nconfigmap/coredns created\ndeployment.apps/coredns created\nservice/kube-dns created\n')),(0,a.kt)("h3",{id:"92\u8fd0\u884c\u4e00\u4e2abusybox\u5bb9\u5668\u6d4b\u8bd5dns"},"9.2.\u8fd0\u884c\u4e00\u4e2abusybox\u5bb9\u5668\u6d4b\u8bd5dns"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"[root@binary-k8s-master1 ~]\\# kubectl run -it --rm dns-test --image=busybox:1.28.4 sh\nIf you don't see a command prompt, try pressing enter.\n/ # nslookup kubernetes\nServer:    10.0.0.2\nAddress 1: 10.0.0.2 kube-dns.kube-system.svc.cluster.local\n\nName:      kubernetes\nAddress 1: 10.0.0.1 kubernetes.default.svc.cluster.local\n\n/ # nslookup kube-dns.kube-system\nServer:    10.0.0.2\nAddress 1: 10.0.0.2 kube-dns.kube-system.svc.cluster.local\n\nName:      kube-dns.kube-system\nAddress 1: 10.0.0.2 kube-dns.kube-system.svc.cluster.local\n/ # exit\n")),(0,a.kt)("h2",{id:"10\u6269\u5bb9master\u8282\u70b9\u7ec4\u5efakubernetes\u9ad8\u53ef\u7528\u96c6\u7fa4"},"10.\u6269\u5bb9master\u8282\u70b9\u7ec4\u5efakubernetes\u9ad8\u53ef\u7528\u96c6\u7fa4"),(0,a.kt)("h3",{id:"101kubernetes\u9ad8\u53ef\u7528\u67b6\u6784\u6982\u5ff5"},"10.1.kubernetes\u9ad8\u53ef\u7528\u67b6\u6784\u6982\u5ff5"),(0,a.kt)("p",null,"kubernetes\u96c6\u7fa4\u901a\u8fc7\u5065\u5eb7\u68c0\u67e5\u548c\u91cd\u542f\u7b56\u7565\u5b9e\u73b0\u4e86Pod\u6545\u969c\u81ea\u6108\u80fd\u529b\uff0c\u4e5f\u901a\u8fc7\u8c03\u5ea6\u7b97\u6cd5\u5b9e\u73b0\u5c06Pod\u5206\u5e03\u5f0f\u90e8\u7f72\uff0c\u5e76\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6ePod\u7684\u526f\u672c\u6570\uff0c\u5b9e\u73b0\u9ad8\u5e76\u53d1\u80fd\u529b\uff0c\u5373\u4f7fNode\u8282\u70b9\u51fa\u73b0\u6545\u969c\uff0cMaster\u8282\u70b9\u4e5f\u4f1a\u5c06\u6545\u969c\u7684Node\u8282\u70b9\u4e0a\u7684Pod\u8fc1\u79fb\u5230\u6b63\u5e38\u5de5\u4f5c\u7684Node\u8282\u70b9\u4e0a\uff0c\u5b9e\u73b0\u5e94\u7528\u5c42\u7684\u9ad8\u53ef\u7528\u6027"),(0,a.kt)("p",null,"\u9488\u5bf9Kubernetes\u96c6\u7fa4\uff0c\u9ad8\u53ef\u7528\u6027\u5305\u62ecEtcd\u6570\u636e\u5e93\u9ad8\u53ef\u7528\u3001Matser\u8282\u70b9\u7ec4\u4ef6\u7684\u9ad8\u53ef\u7528\uff0cEtcd\u53ef\u4ee5\u901a\u8fc7\u96c6\u7fa4\u65b9\u5f0f\u5b9e\u73b0\u9ad8\u53ef\u7528\uff0c\u800c\u53ea\u6709\u5355\u53f0Master\u8282\u70b9\uff0c\u4e00\u65e6Master\u8282\u70b9\u4e0a\u7684\u7ec4\u4ef6\u51fa\u73b0\u4e86\u6545\u969c\uff0c\u6574\u4e2a\u96c6\u7fa4\u5c06\u4f1a\u4e0d\u53ef\u7528\u3002"),(0,a.kt)("p",null,"Master\u8282\u70b9\u662f\u5c5e\u4e8e\u63a7\u5236\u6574\u4e2a\u96c6\u7fa4\u7684\u89d2\u8272\uff0c\u6240\u6709\u7684\u7ec4\u4ef6\u90fd\u9700\u8981\u4e0eMaster\u8282\u70b9\u7684ApiServer\u8fdb\u884c\u4ea4\u4e92\uff0c\u4e0d\u65ad\u4e0eNode\u8282\u70b9\u4e0a\u7684Kubelet\u548cKube-Proxy\u8fdb\u884c\u901a\u4fe1\u6765\u7ef4\u62a4\u6574\u4e2a\u96c6\u7fa4\u7684\u5de5\u4f5c\u72b6\u6001\uff0c\u5982\u679cApiServer\u53d1\u751f\u6545\u969c\uff0c\u5c06\u65e0\u6cd5\u4e0eNode\u8282\u70b9\u8fdb\u884c\u901a\u4fe1\uff0c\u4e5f\u5c31\u65e0\u6cd5\u7ba1\u7406\u96c6\u7fa4\u3002"),(0,a.kt)("p",null,"\u56e0\u6b64Kubernetes\u96c6\u7fa4\u6700\u4e3b\u8981\u7684\u5c31\u662f\u5bf9Master\u8282\u70b9\u8fdb\u884c\u9ad8\u53ef\u7528\u914d\u7f6e\u3002"),(0,a.kt)("p",null,"Master\u8282\u70b9\u4e3b\u8981\u6709\u4e09\u4e2a\u670d\u52a1\uff1akube-apiserver\u3001kube-controller-manage\u3001kube-scheduler\uff0c\u5f53\u96c6\u7fa4\u6709\u591a\u53f0Master\u8282\u70b9\u65f6\uff0c\u5176\u4e2dkube-controller-manage\u548ckube-scheduler\u90fd\u53ef\u4ee5\u901a\u8fc7\u81ea\u8eab\u7684\u9009\u4e3e\u673a\u5236\u5b9e\u73b0\u9ad8\u53ef\u7528\uff0c\u4f46\u662fkube-apiserver\u5c31\u6ca1\u6709\u8fd9\u79cd\u673a\u5236\uff0c\u56e0\u6b64\u4e3b\u8981\u9488\u5bf9kube-apiserver\u914d\u7f6e\u9ad8\u53ef\u7528\u5373\u53ef\uff0ckube-apiserver\u63d0\u4f9b\u7684\u662fHTTP API\u63a5\u53e3\u670d\u52a1\uff0c\u56e0\u6b64\u53ef\u4ee5\u50cfweb\u670d\u52a1\u90a3\u79cd\uff0c\u4f7f\u7528nginx+keepalived\u65b9\u5f0f\u5b9e\u73b0Master\u8282\u70b9\u9ad8\u53ef\u7528\uff0c\u5e76\u4e14\u4e5f\u53ef\u4ee5\u6c34\u5e73\u6269\u5bb9\u3002"),(0,a.kt)("p",null,"\u914d\u7f6ekubernetes\u96c6\u7fa4\u9ad8\u53ef\u7528\u7684\u4e3b\u8981\u6b65\u9aa4\u5c31\u662f\uff1a"),(0,a.kt)("p",null," 1\u3001\u589e\u52a0\u4e00\u53f0\u6216\u591a\u53f0Master\u8282\u70b9\uff0c\u90e8\u7f72Master\u8282\u70b9\u76f8\u5173\u7ec4\u4ef6\uff0c\u5728\u8fd9\u4e2amaster\u8282\u70b9\u4e0a\u914d\u7f6e\u7684\u76d1\u542c\u5730\u5740\u8fd8\u662f\u81ea\u8eab\u7684\u5730\u5740\uff1b"),(0,a.kt)("p",null," 2\u3001\u5728\u65b0\u589e\u7684Master\u8282\u70b9\u4e0a\u90e8\u7f72etcd\uff0c\u4f7fetcd\u52a0\u5165\u73b0\u6709\u7684etcd\u96c6\u7fa4\uff0c\u4f7fetcd\u7684\u6027\u80fd\u66f4\u5f3a\uff1b"),(0,a.kt)("p",null," 3\u3001\u914d\u7f6enginx+keepalived\u5b9e\u73b0Apiserver\u7ec4\u4ef6\u9ad8\u53ef\u7528\uff1b"),(0,a.kt)("p",null," 4\u3001\u914d\u7f6e\u6240\u6709\u7684Node\u8282\u70b9\uff0c\u5c06\u6240\u914d\u7f6e\u7684Apiserver\u5730\u5740\u6539\u6210keepalived\u865a\u62df\u51fa\u6765\u7684VIP\u5730\u5740\uff0c\u5b9e\u73b0\u96c6\u7fa4\u9ad8\u53ef\u7528\uff1b"),(0,a.kt)("p",null,"\u9ad8\u53ef\u7528kubernetes\u96c6\u7fa4\u4e00\u822c3\u53f0master\u8282\u70b9\u8db3\u77e3\uff0c\u4f46\u662fetcd\u6570\u636e\u5e93\u4e00\u5b9a\u8981\u591a\u591a\u76ca\u5584"),(0,a.kt)("h3",{id:"102\u5728\u96c6\u7fa4\u4e2d\u65b0\u589e\u4e00\u4e2aetcd\u8282\u70b9"},"10.2.\u5728\u96c6\u7fa4\u4e2d\u65b0\u589e\u4e00\u4e2aetcd\u8282\u70b9"),(0,a.kt)("p",null,"\u6269\u5bb9etcd\u6b65\u9aa4\uff1a"),(0,a.kt)("p",null," 1\u3001\u90e8\u7f72\u4e00\u53f0\u5355\u8282\u70b9\u7684etcd\uff0c\u80fd\u591f\u6b63\u5e38\u542f\u52a8\u670d\u52a1"),(0,a.kt)("p",null," 2\u3001\u5728\u73b0\u6709etcd\u96c6\u7fa4\u4e2d\u589e\u52a0\u65b0\u7684etcd\u8282\u70b9"),(0,a.kt)("p",null," 3\u3001\u5c06\u5355\u70b9\u7684etcd\u914d\u7f6e\u6210\u96c6\u7fa4\u6a21\u5f0f"),(0,a.kt)("p",null," 4\u3001\u5220\u9664\u5355\u70b9\u9020\u6210\u7684\u6570\u636e\u6587\u4ef6"),(0,a.kt)("p",null," 5\u3001\u6240\u6709\u8282\u70b9\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\u589e\u52a0\u65b0\u7684etcd\u8282\u70b9\u4fe1\u606f"),(0,a.kt)("p",null," 6\u3001\u91cd\u542f\u6240\u6709etcd\u8282\u70b9"),(0,a.kt)("h4",{id:"1021\u9996\u5148\u65b0\u589e\u52a0\u4e00\u53f0\u5355\u70b9\u7684etcd"},"10.2.1.\u9996\u5148\u65b0\u589e\u52a0\u4e00\u53f0\u5355\u70b9\u7684etcd"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'1.\u5b89\u88c5etcd\u7a0b\u5e8f\n[root@binary-k8s-master2 ~]\\# tar xf etcd-v3.4.9-linux-amd64.tar.gz \n[root@binary-k8s-master2 ~]\\# mkdir /data/etcd/{bin,conf,ssl,data} -p\n[root@binary-k8s-master2 ~]\\# mv etcd-v3.4.9-linux-amd64/etcd* /data/etcd/bin/\n\n2.\u521b\u5efa\u5355\u70b9\u914d\u7f6e\u6587\u4ef6\n[root@binary-k8s-master2 ~]\\# vim /data/etcd/conf/etcd.conf \n#[Service]\nETCD_NAME="etcd-4"\nETCD_DATA_DIR="/data/etcd/data"\nETCD_LISTEN_PEER_URLS="https://192.168.20.11:2380"\nETCD_LISTEN_CLIENT_URLS="https://192.168.20.11:2379,http://127.0.0.1:2379"\n\n#[cluster]\nETCD_INITIAL_ADVERTISE_PEER_URLS="https://192.168.20.11:2380"\nETCD_ADVERTISE_CLIENT_URLS="https://192.168.20.11:2379,http://127.0.0.1:2379"\nETCD_INITIAL_CLUSTER="etcd-4=https://192.168.20.11:2380"\nETCD_INITIAL_CLUSTER_STATE="new"\n\n4.\u62f7\u8d1d\u8bc1\u4e66\u6587\u4ef6\n[root@binary-k8s-master2 ~]\\# scp root@192.168.20.10:/data/etcd/ssl/* /data/etcd/ssl/\n\n5.\u62f7\u8d1dsystemctl\u7ba1\u7406\u811a\u672c\n[root@binary-k8s-master2 ~]\\# scp root@192.168.20.10:/usr/lib/systemd/system/etcd.service /usr/lib/systemd/system/\n\n6.\u542f\u52a8etcd\u670d\u52a1\n[root@binary-k8s-master2 ~]\\# systemctl daemon-reload\n[root@binary-k8s-master2 ~]\\#  systemctl start etcd\n\n7.\u67e5\u770b\u7aef\u53e3\n[root@binary-k8s-master2 ~]\\# netstat -lnpt | grep etcd\ntcp        0      0 192.168.20.11:2379      0.0.0.0:*               LISTEN      15753/etcd          \ntcp        0      0 127.0.0.1:2379          0.0.0.0:*               LISTEN      15753/etcd          \ntcp        0      0 192.168.20.11:2380      0.0.0.0:*               LISTEN      15753/etcd \n\n8.\u67e5\u770b\u8282\u70b9\u72b6\u6001\n[root@binary-k8s-master2 ~]\\# /data/etcd/bin/etcdctl endpoint health --write-out=table\n+----------------+--------+------------+-------+\n|    ENDPOINT    | HEALTH |    TOOK    | ERROR |\n+----------------+--------+------------+-------+\n| 127.0.0.1:2379 |   true | 7.146222ms |       |\n+----------------+--------+------------+-------+\n')),(0,a.kt)("h4",{id:"1022\u5728\u73b0\u6709etcd\u96c6\u7fa4\u4efb\u610f\u4e00\u4e2a\u8282\u70b9\u4e0a\u589e\u52a0\u65b0etcd\u8282\u70b9"},"10.2.2.\u5728\u73b0\u6709etcd\u96c6\u7fa4\u4efb\u610f\u4e00\u4e2a\u8282\u70b9\u4e0a\u589e\u52a0\u65b0etcd\u8282\u70b9"),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"\u589e\u52a0\u8282\u70b9\u7684\u547d\u4ee4\u4e3a\uff1a",(0,a.kt)("inlineCode",{parentName:"p"},'/data/etcd/bin/etcdctl member add \u8282\u70b9\u540d\u79f0 --peer-urls="\u901a\u4fe1\u5730\u5740"'))),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'1.\u589e\u52a0etcd-4\u8282\u70b9\n[root@binary-k8s-master1 ~]\\# /data/etcd/bin/etcdctl member add etcd-4 --peer-urls="https://192.168.20.11:2380"\nMember aae107adddd0d3d8 added to cluster 20b119eb5f91aa4b\n\nETCD_NAME="etcd-4"\nETCD_INITIAL_CLUSTER="etcd-2=https://192.168.20.12:2380,etcd-1=https://192.168.20.10:2380,etcd-3=https://192.168.20.13:2380,etcd-4=https://192.168.20.11:2380"\nETCD_INITIAL_ADVERTISE_PEER_URLS="https://192.168.20.11:2380"\nETCD_INITIAL_CLUSTER_STATE="existing"\n#\u8f93\u51fa\u7684\u914d\u7f6e\u4fe1\u606f\u4e00\u5b9a\u8981\u5728\u65b0\u7684etcd-4\u8282\u70b9\u7684\u914d\u7f6e\u6587\u4ef6\u5199\u5165\uff0c\u5426\u5219\u4f1a\u52a0\u5165\u96c6\u7fa4\u5931\u8d25\n\n2.\u67e5\u770b\u96c6\u7fa4\u8282\u70b9\u5217\u8868\n[root@binary-k8s-master1 ~]\\# /data/etcd/bin/etcdctl member list --write-out=table\n+------------------+-----------+--------+----------------------------+--------------------------------------------------+------------+\n|        ID        |  STATUS   |  NAME  |         PEER ADDRS         |                   CLIENT ADDRS                   | IS LEARNER |\n+------------------+-----------+--------+----------------------------+--------------------------------------------------+------------+\n| 12446003b2a53d43 |   started | etcd-2 | https://192.168.20.12:2380 | http://127.0.0.1:2379,https://192.168.20.12:2379 |      false |\n| 51ae3f86f3783687 |   started | etcd-1 | https://192.168.20.10:2380 | http://127.0.0.1:2379,https://192.168.20.10:2379 |      false |\n| 667c9c7ba890c3f7 |   started | etcd-3 | https://192.168.20.13:2380 | http://127.0.0.1:2379,https://192.168.20.13:2379 |      false |\n| aae107adddd0d3d8 | unstarted |        | https://192.168.20.11:2380 |                                                  |      false |\n+------------------+-----------+--------+----------------------------+--------------------------------------------------+------------+\n#\u53d1\u73b0\u521a\u521a\u65b0\u52a0\u5165\u7684etcd-4\u8282\u70b9\u5904\u4e8eunstarted\u72b6\u6001\uff0c\u6211\u4eec\u9700\u8981\u518d\u914d\u7f6eetcd-4\u8282\u70b9\u4f7f\u7528\u80fd\u591f\u52a0\u5165\u96c6\u7fa4\n')),(0,a.kt)("h4",{id:"1023\u914d\u7f6e\u65b0\u589e\u7684etcd\u8282\u70b9\u52a0\u5165\u96c6\u7fa4"},"10.2.3.\u914d\u7f6e\u65b0\u589e\u7684etcd\u8282\u70b9\u52a0\u5165\u96c6\u7fa4"),(0,a.kt)("p",null,"\u5728\u5df2\u6709\u96c6\u7fa4\u589e\u52a0\u5b8c\u65b0\u8282\u70b9\u4e4b\u540e\uff0c\u8fd8\u9700\u8981\u5c06\u65b0\u7684etcd\u8282\u70b9\u914d\u7f6e\u6587\u4ef6\u589e\u52a0\u96c6\u7fa4\u76f8\u5173\u5c5e\u6027\uff0c\u7136\u540e\u5220\u9664\u7531\u5355\u70b9\u65f6\u9020\u6210\u7684etcd\u6570\u636e\u6587\u4ef6\uff0c\u6700\u540e\u5728\u6240\u6709\u8282\u70b9\u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\u589e\u52a0\u65b0\u8282\u70b9\u7684\u901a\u4fe1\u5730\u5740\uff0c\u91cd\u542f\u6240\u6709\u8282\u70b9\u7684etcd\u670d\u52a1\uff0c\u5230\u6b64\u6269\u5bb9\u6210\u529f\u3002"),(0,a.kt)("p",null,"\u4e3b\u8981\u5728\u65b0\u7684etcd\u8282\u70b9\u4e2d\u914d\u7f6eETCD","_","NAME\u3001ETCD","_","INITIAL","_","CLUSTER\u3001ETCD","_","INITIAL","_","CLUSTER","_","TOKEN\u3001ETCD","_","INITIAL","_","CLUSTER","_","STATE\u8fd9\u4e09\u4e2a\u53c2\u6570\u3002"),(0,a.kt)("p",null,"ETCD","_","NAME\uff1a\u96c6\u7fa4\u8282\u70b9\u540d\u79f0"),(0,a.kt)("p",null,"ETCD","_","INITIAL","_","CLUSTER\uff1a\u7531\u5355\u70b9\u7684\u4e00\u4e2a\u8282\u70b9\u4fe1\u606f\u6539\u6210\u96c6\u7fa4\u6240\u6709\u8282\u70b9\u7684\u4fe1\u606f"),(0,a.kt)("p",null,"ETCD","_","INITIAL","_","CLUSTER","_","TOKEN\uff1a\u586b\u5199\u96c6\u7fa4\u7684\u552f\u4e00\u6807\u8bc6\uff0c\u8868\u793a\u52a0\u5165\u54ea\u4e2aetcd\u96c6\u7fa4"),(0,a.kt)("p",null,"ETCD","_","INITIAL","_","CLUSTER","_","STATE\uff1a\u96c6\u7fa4\u72b6\u6001\u8c03\u6574\u4e3a\u52a0\u5165\u5df2\u5b58\u5728\u7684\u96c6\u7fa4"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'1.\u4fee\u6539etcd\u914d\u7f6e\u6587\u4ef6\uff0c\u589e\u52a0\u96c6\u7fa4\u914d\u7f6e\u53c2\u6570\n[root@binary-k8s-master2 ~]\\# vim /data/etcd/conf/etcd.conf \n#[Service]\nETCD_NAME="etcd-4"\nETCD_DATA_DIR="/data/etcd/data"\nETCD_LISTEN_PEER_URLS="https://192.168.20.11:2380"\nETCD_LISTEN_CLIENT_URLS="https://192.168.20.11:2379,http://127.0.0.1:2379"\n\n#[cluster]\nETCD_INITIAL_ADVERTISE_PEER_URLS="https://192.168.20.11:2380"\nETCD_ADVERTISE_CLIENT_URLS="https://192.168.20.11:2379,http://127.0.0.1:2379"\nETCD_INITIAL_CLUSTER="etcd-2=https://192.168.20.12:2380,etcd-1=https://192.168.20.10:2380,etcd-3=https://192.168.20.13:2380,etcd-4=https://192.168.20.11:2380"\nETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster"\nETCD_INITIAL_CLUSTER_STATE="existing"\n\n2.\u5220\u9664\u7531\u5355\u70b9\u65f6\u4ea7\u751f\u7684\u6570\u636e\u6587\u4ef6\n#\u5982\u679c\u4e0d\u5220\u9664\uff0c\u52a0\u5165\u96c6\u7fa4\u65f6\u4f1a\u5931\u8d25\n[root@binary-k8s-master2 ~]\\# rm -rf /data/etcd/data/*\n\n3.\u6240\u6709etcd\u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\u589e\u52a0\u65b0\u8282\u70b9\u7684\u901a\u4fe1\u5730\u5740\n\u6ce8\u610f\uff1a\u6240\u6709etcd\u8282\u70b9\u7684\u914d\u7f6e\u6587\u4ef6\u90fd\u8981\u589e\u52a0\u8fd9\u4e00\u884c\u914d\u7f6e\nvim /data/etcd/conf/etcd.conf \nETCD_INITIAL_CLUSTER="etcd-1=https://192.168.20.10:2380,etcd-2=https://192.168.20.12:2380,etcd-3=https://192.168.20.13:2380,etcd-4=https://192.168.20.11:2380"\n\n4.\u91cd\u542f\u6240\u6709\u8282\u70b9\u7684ectd\u670d\u52a1\n[root@binary-k8s-master1 ~]\\# systemctl restart etcd\n[root@binary-k8s-master2 ~]\\# systemctl restart etcd\n[root@binary-k8s-node1 ~]\\# systemctl restart etcd\n[root@binary-k8s-node2 ~]\\# systemctl restart etcd\n\n5.\u518d\u6b21\u67e5\u770b\u96c6\u7fa4\u7684\u8282\u70b9\u4fe1\u606f\n[root@binary-k8s-master1 ~]\\# /data/etcd/bin/etcdctl member list --write-out=table\n+------------------+---------+--------+----------------------------+--------------------------------------------------+------------+\n|        ID        | STATUS  |  NAME  |         PEER ADDRS         |                   CLIENT ADDRS                   | IS LEARNER |\n+------------------+---------+--------+----------------------------+--------------------------------------------------+------------+\n| 12446003b2a53d43 | started | etcd-2 | https://192.168.20.12:2380 | http://127.0.0.1:2379,https://192.168.20.12:2379 |      false |\n| 51ae3f86f3783687 | started | etcd-1 | https://192.168.20.10:2380 | http://127.0.0.1:2379,https://192.168.20.10:2379 |      false |\n| 667c9c7ba890c3f7 | started | etcd-3 | https://192.168.20.13:2380 | http://127.0.0.1:2379,https://192.168.20.13:2379 |      false |\n| aae107adddd0d3d8 | started | etcd-4 | https://192.168.20.11:2380 | http://127.0.0.1:2379,https://192.168.20.11:2379 |      false |\n+------------------+---------+--------+----------------------------+--------------------------------------------------+------------+\n#etcd\u5230\u6b64\u6269\u5bb9\u6210\u529f\n')),(0,a.kt)("h4",{id:"1024\u914d\u7f6ekube-apiserver\u589e\u52a0\u65b0\u7684etcd\u8282\u70b9"},"10.2.4.\u914d\u7f6ekube-apiserver\u589e\u52a0\u65b0\u7684etcd\u8282\u70b9"),(0,a.kt)("p",null,"etcd\u8282\u70b9\u65b0\u589e\u5b8c\uff0c\u9700\u8981\u914d\u7f6e\u4e0bkube-apiserver\u7ec4\u4ef6\uff0c\u589e\u52a0\u65b0\u7684etcd\u8282\u70b9\u4fe1\u606f\u3002"),(0,a.kt)("p",null,"\u6ce8\u610f\u6240\u6709k8s master\u8282\u70b9\u90fd\u5fc5\u987b\u4fee\u6539\u914d\u7f6ekube-apiserver.conf\u6587\u4ef6\u589e\u52a0\u65b0\u7684etcd\u8282\u70b9\uff0c\u5426\u5219etcd\u4e5f\u4e0d\u4f1a\u4e3ak8s\u6240\u7528\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'1.master\u8282\u70b9\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\u589e\u52a0\u65b0\u7684etcd\u8282\u70b9\n[root@binary-k8s-master1 ~]\\# vim /data/kubernetes/config/kube-apiserver.conf \n\xb7\xb7\xb7\xb7\xb7\xb7\n--etcd-servers=https://192.168.20.10:2379,https://192.168.20.12:2379,https://192.168.20.13:2379,https://192.168.20.11:2379 \\\n\xb7\xb7\xb7\xb7\xb7\xb7\n\n2.\u91cd\u542fapiserver\u7ec4\u4ef6\n[root@binary-k8s-master1 ~]\\# systemctl restart kube-apiserver\n\n3.\u67e5\u770b\u7ec4\u4ef6\u4fe1\u606f\n[root@binary-k8s-master1 ~]\\# kubectl get cs -o wide\nWarning: v1 ComponentStatus is deprecated in v1.19+\nNAME                 STATUS    MESSAGE             ERROR\ncontroller-manager   Healthy   ok                  \nscheduler            Healthy   ok                  \netcd-2               Healthy   {"health":"true"}   \netcd-0               Healthy   {"health":"true"}   \netcd-3               Healthy   {"health":"true"}   \netcd-1               Healthy   {"health":"true"}   \n')),(0,a.kt)("h3",{id:"103\u90e8\u7f72master-2\u8282\u70b9"},"10.3.\u90e8\u7f72master-2\u8282\u70b9"),(0,a.kt)("p",null,"\u7531\u4e8e\u6240\u6709\u7ec4\u4ef6\u90fd\u662f\u4e8c\u8fdb\u5236\u65b9\u5f0f\u90e8\u7f72\u7684\uff0c\u56e0\u6b64\u53ef\u4ee5\u5728master1\u4e0a\u5c06\u76ee\u5f55\u76f4\u63a5\u62f7\u8d1d\u81f3master2\u4e0a\u5373\u53ef\u4f7f\u7528\u3002"),(0,a.kt)("h4",{id:"1031\u90e8\u7f72docker"},"10.3.1.\u90e8\u7f72docker"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"1.\u5b89\u88c5docker\n[root@binary-k8s-master2 ~]\\# tar xf docker-19.03.9.tgz \n[root@binary-k8s-master2 ~]\\# cp docker/* /usr/bin/\n\n2.\u62f7\u8d1dmaster1\u8282\u70b9\u4e0a\u7684docker\u914d\u7f6e\u6587\u4ef6\n[root@binary-k8s-master2 ~]\\# scp -rp root@binary-k8s-master1:/etc/docker /etc/\n\n3.\u62f7\u8d1dmaster1\u8282\u70b9\u4e0a\u7684docker systemctl\u811a\u672c\n[root@binary-k8s-master2 ~]\\# scp -rp root@binary-k8s-master1:/usr/lib/systemd/system/docker.service /usr/lib/systemd/system/\n\n4.\u542f\u52a8docker\n[root@binary-k8s-master2 ~]\\# systemctl daemon-reload\n[root@binary-k8s-master2 ~]\\# systemctl start docker\n[root@binary-k8s-master2 ~]\\# systemctl enable docker\n")),(0,a.kt)("h4",{id:"1032\u90e8\u7f72kubernetes\u5404\u4e2a\u7ec4\u4ef6"},"10.3.2.\u90e8\u7f72kubernetes\u5404\u4e2a\u7ec4\u4ef6"),(0,a.kt)("p",null,"\u7531\u4e8e\u662f\u4e8c\u8fdb\u5236\u90e8\u7f72\uff0c\u76f4\u63a5\u62f7\u8d1dmaster1\u8282\u70b9\u4e0a\u7684/data/kubernetes\u76ee\u5f55\u5373\u53ef\uff0c/data/kubernetes\u76ee\u5f55\u4e0b\u5305\u542b\u4e86\u6240\u6709\u7684master\u4ee5\u53canode\u76f8\u5173\u7ec4\u4ef6"),(0,a.kt)("p",null,"master\u8282\u70b9\u9700\u8981\u5b89\u88c5\u6240\u6709\u7684master\u7ec4\u4ef6\u548cnode\u7ec4\u4ef6\u3002"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"1.\u51c6\u5907\u4e8c\u8fdb\u5236\u7a0b\u5e8f")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"1.\u62f7\u8d1d\u7ec4\u4ef6\u6587\u4ef6\n[root@binary-k8s-master1 ~]\\# scp -rp /data/kubernetes root@binary-k8s-master2:/data\n[root@binary-k8s-master1 ~]\\# scp /usr/bin/kubectl root@binary-k8s-master2:/usr/bin\n[root@binary-k8s-master1 ~]\\# scp -rp /usr/lib/systemd/system/kube* root@binary-k8s-master2:/usr/lib/systemd/system/\n[root@binary-k8s-master1 ~]\\# scp -rp .kube root@binary-k8s-master2:/root\n\n2.\u5982\u679c\u6ca1\u6709\u6269\u5bb9\u65b0\u7684etcd\u8282\u70b9\u7684\u60c5\u51b5\u9700\u8981\u62f7\u8d1detcd\u8bc1\u4e66\n[root@binary-k8s-master1 ~]\\# scp -rp /data/etcd/ssl root@binary-k8s-master2:/data/etcd/ss\n\n3.\u5220\u9664kubelet\u6587\u4ef6\n#kubelet\u67d0\u4e9b\u95ee\u9898\u90fd\u662f\u52a8\u6001\u751f\u6210\u7684\uff0c\u4e14\u6bcf\u4e2a\u8282\u70b9\u90fd\u4e0d\u76f8\u540c\uff0c\u56e0\u6b64\u9700\u8981\u5220\u9664\u91cd\u65b0\u751f\u6210\n[root@binary-k8s-master2 ~]\\# rm -rf /data/kubernetes/config/kubelet.kubeconfig \n[root@binary-k8s-master2 ~]\\# rm -rf /data/kubernetes/ssl/kubelet-client-*\n")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"2.\u4fee\u6539\u5404\u4e2a\u7ec4\u4ef6\u7684\u914d\u7f6e\u6587\u4ef6")),(0,a.kt)("p",null,"\u4e3b\u8981\u5c31\u662f\u4fee\u6539\u5404\u4e2a\u7ec4\u4ef6\u76d1\u542c\u7684\u672c\u673aip\u5730\u5740\u548c\u8282\u70b9\u540d\u79f0\uff0c\u751f\u6210\u7684kubeconfig\u6587\u4ef6\u4e2d\u7684apiserver\u5730\u5740\u65e0\u9700\u66f4\u6539\uff0c\u4fdd\u6301master1\u5373\u53ef\uff0c\u56e0\u4e3a\u6700\u540e\u9ad8\u53ef\u7528\u7684\u65f6\u5019\u8fd8\u662f\u4f1a\u6539\u6210VIP\u5730\u5740\uff0c\u5f53\u524d\u65e0\u9700\u66f4\u6539\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'1.\u4fee\u6539kube-apiserver\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684IP\u5730\u5740\n[root@binary-k8s-master2 ~]\\# vim /data/kubernetes/config/kube-apiserver.conf \n\xb7\xb7\xb7\xb7\xb7\xb7\n--bind-address=192.168.20.11  \\\n--advertise-address=192.168.20.11 \\\n\xb7\xb7\xb7\xb7\xb7\xb7\n\n2.\u4fee\u6539kube-controller-manager\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684IP\u5730\u5740\n[root@binary-k8s-master2 ~]\\# vim /data/kubernetes/config/kube-controller-manager.conf \n\xb7\xb7\xb7\xb7\xb7\xb7\n--bind-address=192.168.20.11 \\\n\xb7\xb7\xb7\xb7\xb7\xb7\n\n3.\u4fee\u6539kube-scheduler\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684IP\u5730\u5740\n[root@binary-k8s-master2 ~]\\# vim /data/kubernetes/config/kube-scheduler.conf \n\xb7\xb7\xb7\xb7\xb7\xb7\n--bind-address=192.168.20.11"\n\xb7\xb7\xb7\xb7\xb7\xb7\n\n4.\u4fee\u6539kubelet\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684IP\u5730\u5740\n[root@binary-k8s-master2 ~]\\# vim /data/kubernetes/config/kubelet.conf \n\xb7\xb7\xb7\xb7\xb7\xb7\n--hostname-override=binary-k8s-master2 \\\n\xb7\xb7\xb7\xb7\xb7\xb7\n\n5.\u4fee\u6539kube-apiserver\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684IP\u5730\u5740\n[root@binary-k8s-master2 ~]\\# vim /data/kubernetes/config/kube-proxy-config.yml \n\xb7\xb7\xb7\xb7\xb7\xb7\nhostnameOverride: binary-k8s-master2\n\xb7\xb7\xb7\xb7\xb7\xb7\n')),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"3.\u542f\u52a8\u5404\u4e2a\u7ec4\u4ef6")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"[root@binary-k8s-master2 ~]\\# systemctl daemon-reload \n[root@binary-k8s-master2 ~]\\# systemctl start kube-apiserver\n[root@binary-k8s-master2 ~]\\# systemctl start kube-controller-manager\n[root@binary-k8s-master2 ~]\\# systemctl start kube-scheduler\n[root@binary-k8s-master2 ~]\\# systemctl start kubelet\n[root@binary-k8s-master2 ~]\\# systemctl start kube-proxy\n[root@binary-k8s-master2 ~]\\# systemctl enable kube-apiserver\n[root@binary-k8s-master2 ~]\\# systemctl enable kube-controller-manager\n[root@binary-k8s-master2 ~]\\# systemctl enable kube-scheduler\n[root@binary-k8s-master2 ~]\\# systemctl enable kubelet\n[root@binary-k8s-master2 ~]\\# systemctl enable kube-proxy\n")),(0,a.kt)("h4",{id:"1033\u6388\u6743master2\u8282\u70b9\u52a0\u5165\u96c6\u7fa4"},"10.3.3.\u6388\u6743master2\u8282\u70b9\u52a0\u5165\u96c6\u7fa4"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'1.\u67e5\u770b\u6388\u6743\u65b0\u7cfb\u5217\u8868\n[root@binary-k8s-master2 ~]\\# kubectl get csr\nNAME                                                   AGE     SIGNERNAME                                    REQUESTOR           CONDITION\nnode-csr-fgCu0hUU4sK9-jaLzl8n-H4MVWi314NhzYssddgThOE   4m45s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending\n\n2.\u6388\u6743\u901a\u8fc7\n[root@binary-k8s-master2 ~]\\# kubectl certificate approve node-csr-fgCu0hUU4sK9-jaLzl8n-H4MVWi314NhzYssddgThOE\ncertificatesigningrequest.certificates.k8s.io/node-csr-fgCu0hUU4sK9-jaLzl8n-H4MVWi314NhzYssddgThOE approved\n\n3.\u67e5\u770b\u662f\u5426\u52a0\u5165\u96c6\u7fa4\n[root@binary-k8s-master2 ~]\\# kubectl get node\nNAME                 STATUS   ROLES    AGE     VERSION\nbinary-k8s-master1   Ready    <none>   4d21h   v1.20.4\nbinary-k8s-master2   Ready    <none>   4m33s   v1.20.4\nbinary-k8s-node1     Ready    <none>   2d3h    v1.20.4\nbinary-k8s-node2     Ready    <none>   45h     v1.20.4\n\n4.\u67e5\u770b\u6838\u5fc3\u7ec4\u4ef6\u72b6\u6001\n[root@binary-k8s-master2 ~]\\# kubectl get cs\nWarning: v1 ComponentStatus is deprecated in v1.19+\nNAME                 STATUS    MESSAGE             ERROR\ncontroller-manager   Healthy   ok                  \nscheduler            Healthy   ok                  \netcd-1               Healthy   {"health":"true"}   \netcd-2               Healthy   {"health":"true"}   \netcd-0               Healthy   {"health":"true"}   \n')),(0,a.kt)("h3",{id:"104\u90e8\u7f72nginxkeepalived\u5b9e\u73b0kubernetes\u9ad8\u53ef\u7528\u96c6\u7fa4"},"10.4.\u90e8\u7f72Nginx+Keepalived\u5b9e\u73b0kubernetes\u9ad8\u53ef\u7528\u96c6\u7fa4"),(0,a.kt)("p",null,"keepalived\u662f\u4e3b\u6d41\u7684\u9ad8\u53ef\u7528\u8f6f\u4ef6\uff0c\u57fa\u4e8eVIP\u7ed1\u5b9a\u5b9e\u73b0\u670d\u52a1\u5668\u7684\u53cc\u673a\u70ed\u5907\uff0c\u53ef\u4ee5\u7406\u89e3\u4e3akeepalived\u662f\u9488\u5bf9\u670d\u52a1\u5668IP\u7684\u9ad8\u53ef\u7528\u96c6\u7fa4\uff0c\u5982\u679cA\u673a\u5668\u5b95\u673a\u4e86\uff0cB\u673a\u5668\u4f1a\u7acb\u523b\u6210\u4e3amaster\u89d2\u8272\uff0c\u62a2\u5360VIP\u5730\u5740\uff0c\u4f7f\u5176\u4e0d\u95f4\u65ad\u7684\u63d0\u4f9b\u670d\u52a1\uff0c\u4ece\u800c\u5f62\u6210\u9ad8\u53ef\u7528\u96c6\u7fa4\u3002"),(0,a.kt)("p",null,"\u4f7f\u7528nginx+keepalived\u505a\u5f97k8s master\u8282\u70b9\u9ad8\u53ef\u7528\u96c6\u7fa4\uff0c\u53ea\u8981master\u8282\u70b9\u4e0a\u9762\u6ca1\u6709etcd\u7ec4\u4ef6\uff0c\u90a3\u4e48\u6574\u4e2a\u96c6\u7fa4master\u8282\u70b9\u53ea\u8981\u6709\u4e00\u4e2a\u5de5\u4f5c\u6b63\u5e38\uff0c\u6574\u4e2a\u96c6\u7fa4\u5c31\u4e0d\u4f1a\u5b95\u673a\u3002"),(0,a.kt)("p",null,"\u751f\u4ea7\u73af\u5883\u4e2dnginx+keepalived\u662f\u72ec\u7acb\u4e8e\u96c6\u7fa4\u4e4b\u5916\u7684\u4e24\u53f0\u670d\u52a1\u5668\uff0c\u9ad8\u53ef\u7528\u96c6\u7fa4\u4e00\u822c\u60c5\u51b5\u4e0b\u90fd\u662f\u4e00\u4e3b\u4e00\u5907\uff0c\u4e24\u4e2a\u8282\u70b9\u5c31\u53ef\u4ee5\u6ee1\u8db3\u6b63\u5e38\u9700\u6c42\uff0c\u6b63\u597dmaster\u8282\u70b9\u67092\u4e2a\uff0c\u53ef\u4ee5\u5728\u4e24\u4e2amaster\u4e0a\u90fd\u90e8\u7f72nginx\u548ckeepalived\u5f62\u6210\u9ad8\u53ef\u7528\u96c6\u7fa4\u3002"),(0,a.kt)("p",null,"\u6211\u4eec\u91c7\u7528nginx\u56db\u5c42\u8d1f\u8f7d\u5747\u8861\uff0c\u56db\u5c42\u8d1f\u8f7d\u5747\u8861\u7684\u4f5c\u7528\u5c31\u662f\u5bf9IP\u8fdb\u884c\u8d1f\u8f7d\uff0c\u4e0d\u6d89\u53ca\u5e94\u7528\u5c42\uff0c\u7531\u4e8e\u6211\u4eec\u4f7f\u7528keepalived\u505a\u9ad8\u53ef\u7528\u96c6\u7fa4\uff0ckeepalived\u5c31\u662f\u9488\u5bf9IP\u5730\u5740\u5b9e\u73b0\u9ad8\u53ef\u7528\uff0c\u56e0\u6b64\u9700\u8981\u914d\u5408nginx\u56db\u5c42\u8d1f\u8f7d\u5747\u8861\u6765\u5b9e\u73b0\uff0c\u5f53\u7528\u6237\u8bbf\u95eekeepalived\u7684VIP\u65f6\uff0c\u76f4\u63a5\u5c06\u8bf7\u6c42\u8f6c\u53d1\u5230\u5bf9\u5e94\u7684master\u89d2\u8272\u4e3b\u673a\u4e0a\uff0c\u5c06VIP\u5730\u5740\u8f6c\u6362\u6210master\u8282\u70b9IP+\u7aef\u53e3\uff0c\u8fd9\u6837\u4e00\u6765\uff0c\u5373\u4f7fmaster1\u6302\u6389\u4e86\uff0cmaster2\u6210\u4e3a\u4e86master\u89d2\u8272\uff0c\u8bf7\u6c42\u8f6c\u53d1\u8fdb\u6765\uff0c\u4e5f\u4f1a\u5c06VIP\u8f6c\u6362\u6210master2\u8282\u70b9\u7684\u5730\u5740\uff0c\u9ad8\u53ef\u7528\u4e5f\u5c31\u5b9e\u73b0\u4e86\u3002"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"kube-apiserver\u9ad8\u53ef\u7528\u67b6\u6784\u56fe")),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/4166bf6696044bc1b4f47efb7cf03acd.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,a.kt)("h4",{id:"1041\u90e8\u7f72nginx\u8d1f\u8f7d\u5747\u8861"},"10.4.1.\u90e8\u7f72Nginx\u8d1f\u8f7d\u5747\u8861"),(0,a.kt)("p",null,"master1\u548cmaster2\u4e0a\u7684nginx\u90e8\u7f72\u548c\u914d\u7f6e\u6587\u4ef6\u5185\u5bb9\u4e00\u6837\uff0c\u8fd9\u91cc\u53ea\u5199master1\u7684\u64cd\u4f5c\u6b65\u9aa4\u3002"),(0,a.kt)("p",null,"nginx\u8d1f\u8f7d\u5747\u8861\u91c7\u7528\u56db\u5c42\u8d1f\u8f7d\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"1.\u5b89\u88c5nginx\u548ckeepalived\u53canginx\u56db\u5c42\u8d1f\u8f7d\u5747\u8861\u6a21\u5757\u7b49\u8f6f\u4ef6\n[root@binary-k8s-master1 ~]\\#  yum -y install nginx keepalived nginx-mod-stream\n\n2.\u4fee\u6539nginx\u4e3b\u914d\u7f6e\u6587\u4ef6\u589e\u52a0include\u6a21\u5757\u5f15\u51654\u5c42\u8d1f\u8f7d\u914d\u7f6e\u6587\u4ef6\n[root@binary-k8s-master1 ~]\\# vim /etc/nginx/nginx.conf\ninclude /etc/nginx/conf.c/*.conf;           #17\u884c\u5de6\u53f3\uff0c\u4e0ehttp\u6a21\u5757\u540c\u7ea7\n\n3.\u7f16\u5199\u914d\u7f6e\u6587\u4ef6\n[root@binary-k8s-master1 ~]\\# mkdir /etc/nginx/conf.c\n[root@binary-k8s-master1 ~]\\# vim /etc/nginx/conf.c/k8s-apiserver.conf \nstream {\n    log_format  main  '$remote_addr $upstream_addr - [$time_local] $status $upstream_bytes_sent';\n\n    access_log /var/log/nginx/k8s-apiserver.log main;\n    \n    upstream k8s-apiserver {\n        server 192.168.20.11:6443;\n        server 192.168.20.12:6443;\n    }\n    \n    server {\n        listen 16443;           #\u7531\u4e8e\u6211\u4eec\u7684nginx\u4e0ek8s master\u5728\u540c\u4e00\u53f0\u673a\u5668\u4e0a\uff0c\u9632\u6b62\u7aef\u53e3\u51b2\u7a81\uff0c\u56e0\u6b64\u6539\u4e3a16443\u7aef\u53e3\n        proxy_pass k8s-apiserver;\n    }\n}\n\n4.\u542f\u52a8nginx\n[root@binary-k8s-master1 ~]\\# nginx -t\nnginx: the configuration file /etc/nginx/nginx.conf syntax is ok\nnginx: configuration file /etc/nginx/nginx.conf test is successful\n[root@binary-k8s-master1 ~]\\# nginx\n\n5.\u67e5\u770b\u7aef\u53e3\n[root@binary-k8s-master1 ~]\\# netstat -lnpt | grep 16443\ntcp        0      0 0.0.0.0:16443           0.0.0.0:*               LISTEN      3181/nginx: worker \n")),(0,a.kt)("h4",{id:"1042\u90e8\u7f72keepalived\u53cc\u673a\u70ed\u5907"},"10.4.2.\u90e8\u7f72keepalived\u53cc\u673a\u70ed\u5907"),(0,a.kt)("p",null,"\u5728\u914d\u7f6ekeepalived\u7684\u65f6\u5019\u4e5f\u9700\u8981\u914d\u7f6e\u4e00\u4e2a",(0,a.kt)("strong",{parentName:"p"},"vrrp","_","script"),"\u6a21\u5757\uff0ckeepalived\u53ea\u80fd\u505a\u5230\u5bf9\u7f51\u7edc\u6545\u969c\u548ckeepalived\u672c\u8eab\u7684\u76d1\u63a7\uff0c\u5373\u5f53\u51fa\u73b0\u7f51\u7edc\u6545\u969c\u6216\u8005keepalived\u672c\u8eab\u51fa\u73b0\u95ee\u9898\u65f6\uff0c\u8fdb\u884c\u5207\u6362\u3002\u4f46\u662f\u8fd9\u4e9b\u8fd8\u4e0d\u591f\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u76d1\u63a7keepalived\u6240\u5728\u670d\u52a1\u5668\u4e0a\u7684\u5176\u4ed6\u4e1a\u52a1\u8fdb\u7a0b\uff0c\u6bd4\u5982\u8bf4nginx\uff0ckeepalived+nginx\u5b9e\u73b0nginx\u7684\u8d1f\u8f7d\u5747\u8861\u9ad8\u53ef\u7528\uff0c\u5982\u679cnginx\u5f02\u5e38\uff0c\u4ec5\u4ec5keepalived\u4fdd\u6301\u6b63\u5e38\uff0c\u662f\u65e0\u6cd5\u5b8c\u6210\u7cfb\u7edf\u7684\u6b63\u5e38\u5de5\u4f5c\u7684\uff0c\u56e0\u6b64\u9700\u8981\u6839\u636e\u4e1a\u52a1\u8fdb\u7a0b\u7684\u8fd0\u884c\u72b6\u6001\u51b3\u5b9a\u662f\u5426\u9700\u8981\u8fdb\u884c\u4e3b\u5907\u5207\u6362\u3002\u8fd9\u4e2a\u65f6\u5019\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u7f16\u5199\u811a\u672c\u5bf9nginx\u8fdb\u7a0b\u8fdb\u884c\u68c0\u6d4b\u76d1\u63a7\u3002"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"1.MASTER\u8282\u70b9\u90e8\u7f72")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'1.\u5b89\u88c5keepalived\n[root@binary-k8s-master1 ~]\\#  yum -y install keepalived\n\n2.\u914d\u7f6ekeepalived\n[root@binary-k8s-master1 ~]\\# vim /etc/keepalived/keepalived.conf \nglobal_defs {\n   notification_email {\n     acassen@firewall.loc\n     failover@firewall.loc\n     sysadmin@firewall.loc\n   }\n   notification_email_from Alexandre.Cassen@firewall.loc\n   smtp_server 127.0.0.1\n   smtp_connect_timeout 30\n   router_id NGINX_MASTER\n}\n\nvrrp_script check_nginx {               #\u5b9a\u4e49\u5065\u5eb7\u68c0\u67e5\u811a\u672c\n    script "/etc/keepalived/check_nginx.sh"\n}\n\nvrrp_instance VI_1 {\n    state MASTER                    #\u72b6\u6001\u4e3aMASTER\n    interface ens192                #\u5c06VIP\u7ed1\u5b9a\u5728\u54ea\u5757\u7f51\u5361\u4e0a\n    virtual_router_id 51            #\u5b9e\u4f8bID\uff0c\u96c6\u7fa4\u6240\u6709\u8282\u70b9\u90fd\u8981\u4fdd\u6301\u4e00\u81f4\n    priority 100                    #\u4f18\u5148\u7ea7\uff0c255\u6700\u9ad8\n    advert_int 1                    #\u6307\u5b9aVRRP\u5fc3\u8df3\u5305\u901a\u544a\u95f4\u9694\u65f6\u95f4\uff0c\u9ed8\u8ba41\u79d2\n    authentication {\n        auth_type PASS\n        auth_pass 1111\n    }\n    virtual_ipaddress {\n        192.168.20.9/23                 #\u5b9a\u4e49VIP\u5730\u5740\n    }\n    track_script {  \n        check_nginx                 \n    }\n}\n\n3.\u7f16\u5199\u68c0\u67e5nginx\u72b6\u6001\u7684\u68c0\u67e5\u811a\u672c\n#\u5f53nginx\u5f02\u5e38\u65f6\uff0c\u81ea\u52a8\u5c06\u5f53\u524d\u4e3b\u673a\u7684keepalived\u8fdb\u7a0b\u5173\u95ed\uff0c\u4f7fBACKUP\u4e0a\u7684keepalived\u6210\u4e3aMASTER\u7ee7\u7eed\u63d0\u4f9b\u670d\u52a1\n[root@binary-k8s-master1 ~]\\# vim /etc/keepalived/check_nginx.sh \nnginx_ch=`netstat -lnpt | grep 16443| egrep -cv grep`\nif [ $nginx_ch -eq 0 ];then\n    systemctl stop keepalived\n    exit 1\nelse\n    exit 0\nfi\n\n4.\u542f\u52a8keepalived\n[root@binary-k8s-master1 ~]\\# systemctl start keepalived\n[root@binary-k8s-master1 ~]\\# systemctl enable keepalived\n\n5.\u67e5\u770bVIP\u5730\u5740\n[root@binary-k8s-master1 ~]\\# ip a | grep ens192\n2: ens192: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP group default qlen 1000\n    inet 192.168.20.10/23 brd 192.168.21.255 scope global noprefixroute ens192\n    inet 192.168.20.9/23 scope global secondary ens192\n#VIP\u5df2\u7ecf\u51c6\u5907\u5c31\u7eea\n')),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"2.BACKUP\u8282\u70b9\u90e8\u7f72")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'1.\u5b89\u88c5keepalived\n[root@binary-k8s-master2 ~]\\#  yum -y install keepalived\n\n2.\u914d\u7f6ekeepalived\n[root@binary-k8s-master2 ~]\\# vim /etc/keepalived/keepalived.conf \nglobal_defs {\n   notification_email {\n     acassen@firewall.loc\n     failover@firewall.loc\n     sysadmin@firewall.loc\n   }\n   notification_email_from Alexandre.Cassen@firewall.loc\n   smtp_server 127.0.0.1\n   smtp_connect_timeout 30\n   router_id NGINX_MASTER\n}\n\nvrrp_script check_nginx {\n    script "/etc/keepalived/check_nginx.sh"\n}\n\nvrrp_instance VI_1 {\n    state BACKUP                #\u72b6\u6001\u4e3aBACKUP\n    interface ens192\n    virtual_router_id 51\n    priority 90             #\u4f18\u5148\u7ea7\u8981\u6bd4MASTER\u4f4e\n    advert_int 1\n    authentication {\n        auth_type PASS\n        auth_pass 1111\n    }\n    virtual_ipaddress {\n        192.168.20.9/23\n    }\n    track_script {\n        check_nginx\n    }\n}\n\n\n3.\u7f16\u5199\u68c0\u67e5nginx\u72b6\u6001\u7684\u68c0\u67e5\u811a\u672c\n#\u5f53nginx\u5f02\u5e38\u65f6\uff0c\u81ea\u52a8\u5c06\u5f53\u524d\u4e3b\u673a\u7684keepalived\u8fdb\u7a0b\u5173\u95ed\uff0c\u4f7fBACKUP\u4e0a\u7684keepalived\u6210\u4e3aMASTER\u7ee7\u7eed\u63d0\u4f9b\u670d\u52a1\n[root@binary-k8s-master1 ~]\\# vim /etc/keepalived/check_nginx.sh \nnginx_ch=`netstat -lnpt | grep 16443| egrep -cv grep`\nif [ $nginx_ch -eq 0 ];then\n    systemctl stop keepalived\n    exit 1\nelse\n    exit 0\nfi\n\n4.\u542f\u52a8keepalived\n[root@binary-k8s-master1 ~]\\# systemctl start keepalived\n[root@binary-k8s-master1 ~]\\# systemctl enable keepalived\n')),(0,a.kt)("h4",{id:"1043\u4f7f\u7528vip\u8bbf\u95eekubernetes\u670d\u52a1"},"10.4.3.\u4f7f\u7528VIP\u8bbf\u95eekubernetes\u670d\u52a1"),(0,a.kt)("p",null,"\u53ef\u4ee5\u6b63\u786e\u83b7\u53d6\u5230K8s\u7248\u672c\u4fe1\u606f\uff0c\u8bf4\u660e\u8d1f\u8f7d\u5747\u8861\u5668\u642d\u5efa\u6b63\u5e38\u3002\u8be5\u8bf7\u6c42\u6570\u636e\u6d41\u7a0b\uff1acurl -> vip(nginx) -> apiserver\u3002"),(0,a.kt)("p",null,"\u65e5\u5fd7\u4e2d\u4e5f\u4f1a\u8bb0\u5f55\u8bbf\u95ee\u8bb0\u5f55\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'[root@binary-k8s-master1 ~]\\# curl -k https://192.168.20.9:16443/version\n{\n  "major": "1",\n  "minor": "20",\n  "gitVersion": "v1.20.4",\n  "gitCommit": "e87da0bd6e03ec3fea7933c4b5263d151aafd07c",\n  "gitTreeState": "clean",\n  "buildDate": "2021-02-18T16:03:00Z",\n  "goVersion": "go1.15.8",\n  "compiler": "gc",\n  "platform": "linux/amd64"\n}\n\n[root@binary-k8s-master1 ~]\\# tail -f /var/log/nginx/k8s-apiserver.log \n127.0.0.1 192.168.20.11:6443 - [09/Sep/2021:11:28:15 +0800] 200 79\n127.0.0.1 192.168.20.11:6443 - [09/Sep/2021:11:28:20 +0800] 200 178\n192.168.20.10 192.168.20.11:6443 - [09/Sep/2021:15:20:29 +0800] 200 178\n192.168.20.10 192.168.20.12:6443, 192.168.20.11:6443 - [09/Sep/2021:16:19:00 +0800] 200 0, 420\n')),(0,a.kt)("h4",{id:"1044\u6d4b\u8bd5keepalived\u9ad8\u53ef\u7528"},"10.4.4.\u6d4b\u8bd5keepalived\u9ad8\u53ef\u7528"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"1.\u505c\u6389master1\u4e0a\u7684keepalived\uff0c\u67e5\u770bVIP\u662f\u5426\u4f1a\u5207\u6362\u5230master2\u8282\u70b9")),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/dba9f62a2a0744c3b3ccc86981ad86a4.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"2.\u91cd\u65b0\u542f\u52a8master1\u4e0a\u7684keepalived\uff0c\u67e5\u770bVIP\u662f\u5426\u4f1a\u81ea\u52a8\u5207\u6362\u5230master1")),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/54cdc63de7c040519287127263385c0c.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,a.kt)("h3",{id:"105\u5207\u6362kubernetes\u96c6\u7fa4\u4e3a\u9ad8\u53ef\u7528\u6a21\u5f0f"},"10.5.\u5207\u6362kubernetes\u96c6\u7fa4\u4e3a\u9ad8\u53ef\u7528\u6a21\u5f0f"),(0,a.kt)("p",null,"\u867d\u7136\u6211\u4eec\u589e\u52a0\u4e86Master2 Node\u548c\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u4f46\u662f\u6211\u4eec\u662f\u4ece\u5355Master\u67b6\u6784\u6269\u5bb9\u7684\uff0c\u4e5f\u5c31\u662f\u8bf4\u76ee\u524d\u6240\u6709\u7684Worker Node\u7ec4\u4ef6\u8fde\u63a5\u90fd\u8fd8\u662fMaster1 Node\uff0c\u5982\u679c\u4e0d\u6539\u4e3a\u8fde\u63a5VIP\u8d70\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u90a3\u4e48Master\u8fd8\u662f\u5355\u70b9\u6545\u969c\u3002"),(0,a.kt)("p",null,"\u7531\u4e8e\u5df2\u7ecf\u53ef\u4ee5\u901a\u8fc7keepalived\u7684VIP\u5730\u5740\u8bbf\u95ee\u5230apiserver\uff0c\u9ad8\u53ef\u7528\u6548\u679c\u5df2\u8fbe\u6210\uff0c\u76ee\u524d\u53ea\u9700\u8981\u5c06\u96c6\u7fa4\u7684\u6240\u6709\u8282\u70b9\uff08kubectl get node\uff09\u80fd\u770b\u5230\u7684\u4e00\u5207\u8282\u70b9\uff0c\u5c06\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684apiserver\u7684\u5730\u5740\u6362\u6210VIP\u5730\u5740\u52a0\u7aef\u53e3\uff0c\u624d\u80fd\u771f\u6b63\u7684\u5b9e\u73b0kubernetes\u9ad8\u53ef\u7528\u3002"),(0,a.kt)("p",null,"\u4e4b\u524d\u524d\u671f\u4f7f\u7528VIP\u6d4b\u8bd5kube-apiserver\u6ca1\u95ee\u9898\uff0c\u5373\u4f7f\u5728\u5207\u6362\u9ad8\u53ef\u7528\u7684\u60c5\u51b5\u4e0b\uff0c\u6240\u6709\u8282\u70b9\u4e5f\u4e0d\u4f1a\u5904\u4e8eNotReady\u72b6\u6001\u3002"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"1.\u5207\u6362\u9ad8\u53ef\u7528\u73af\u5883")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"1.binary-k8s-master1\u8282\u70b9\u5207\u6362\n[root@binary-k8s-master1 ~]\\# sed -ri 's#192.168.20.10:6443#192.168.20.9:16443#' /data/kubernetes/config/*\n[root@binary-k8s-master1 ~]\\# sed -ri 's#192.168.20.10:6443#192.168.20.9:16443#' /root/.kube/config \n[root@binary-k8s-master1 ~]\\# systemctl restart  kube-controller-manager kube-scheduler kubelet kube-proxy\n\n2.binary-k8s-master2\u5207\u6362\n[root@binary-k8s-master2 ~]\\# sed -ri 's#192.168.20.10:6443#192.168.20.9:16443#' /data/kubernetes/config/*\n[root@binary-k8s-master2 ~]\\# sed -ri 's#192.168.20.10:6443#192.168.20.9:16443#' /root/.kube/config\n[root@binary-k8s-master2 ~]\\# systemctl restart  kube-controller-manager kube-scheduler kubelet kube-proxy\n\n3.binary-k8s-node1\u5207\u6362\n[root@binary-k8s-node1 ~]\\# sed -ri 's#192.168.20.10:6443#192.168.20.9:16443#' /data/kubernetes/config/*\n[root@binary-k8s-node1 ~]\\# systemctl restart kubelet kube-proxy\n\n4.binary-k8s-node2\u5207\u6362\n[root@binary-k8s-node2 ~]\\# sed -ri 's#192.168.20.10:6443#192.168.20.9:16443#' /data/kubernetes/config/*\n[root@binary-k8s-node2 ~]\\# systemctl restart kubelet kube-proxy\n")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"2.\u67e5\u770b\u96c6\u7fa4\u72b6\u6001\u53ca\u8d44\u6e90")),(0,a.kt)("p",null,"\u5230\u6b64\u4e3a\u6b62kubernetes\u9ad8\u53ef\u7528\u96c6\u7fa4\u5b9e\u73b0\u5b8c\u6bd5"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'[root@binary-k8s-master1 ~]\\# kubectl get node\nNAME                 STATUS   ROLES    AGE     VERSION\nbinary-k8s-master1   Ready    <none>   5d22h   v1.20.4\nbinary-k8s-master2   Ready    <none>   25h     v1.20.4\nbinary-k8s-node1     Ready    <none>   3d5h    v1.20.4\nbinary-k8s-node2     Ready    <none>   2d23h   v1.20.4\n\n[root@binary-k8s-master1 ~]\\# kubectl get cs\nWarning: v1 ComponentStatus is deprecated in v1.19+\nNAME                 STATUS    MESSAGE             ERROR\ncontroller-manager   Healthy   ok                  \nscheduler            Healthy   ok                  \netcd-0               Healthy   {"health":"true"}   \netcd-1               Healthy   {"health":"true"}   \netcd-2               Healthy   {"health":"true"} \n')),(0,a.kt)("h2",{id:"11\u6d4b\u8bd5kubernetes\u9ad8\u53ef\u7528\u96c6\u7fa4"},"11.\u6d4b\u8bd5kubernetes\u9ad8\u53ef\u7528\u96c6\u7fa4"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"1.\u505c\u6389master1\u4e0a\u7684keepalived\u9a8c\u8bc1\u96c6\u7fa4\u662f\u5426\u53ef\u7528")),(0,a.kt)("p",null,"\u72b6\u6001\uff1a\u201cok\u201d"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/c146811a76994c2eb7ecea1a95bae2ab.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"2.\u505c\u6389master1\u4e0a\u6240\u6709k8s\u7ec4\u4ef6\u9a8c\u8bc1\u96c6\u7fa4\u662f\u5426\u53ef\u7528")),(0,a.kt)("p",null,"\u72b6\u6001\uff1a\u201cok\u201d"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/a5cfe03d354441798591ae5add26898e.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,a.kt)("h2",{id:"12\u5728kubernetes\u96c6\u7fa4\u8fd0\u884c\u4e00\u5957\u670d\u52a1\u9a8c\u8bc1\u96c6\u7fa4\u7684\u53ef\u7528\u6027"},"12.\u5728kubernetes\u96c6\u7fa4\u8fd0\u884c\u4e00\u5957\u670d\u52a1\u9a8c\u8bc1\u96c6\u7fa4\u7684\u53ef\u7528\u6027"),(0,a.kt)("p",null,"\u7b80\u5355\u90e8\u7f72\u4e00\u4e2a\u57fa\u4e8enginx\u7684web\u670d\u52a1\u3002"),(0,a.kt)("h3",{id:"121\u521b\u5efa\u8d44\u6e90yaml\u6587\u4ef6"},"12.1.\u521b\u5efa\u8d44\u6e90yaml\u6587\u4ef6"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"[root@binary-k8s-master1 ~]\\# vim know-system.yaml \napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: deploy-know-system\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: know-system-pod\n  template:\n    metadata:\n      labels:\n        app: know-system-pod\n    spec:\n      containers:\n      - name: know-system\n        image: know-system:v1\n        ports:\n        - containerPort: 80\n      nodeName: binary-k8s-master1\n\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: know-system-service\nspec:\n  selector:\n    app: know-system-pod\n  type: NodePort\n  ports:\n  - port: 80\n    targetPort: 80\n")),(0,a.kt)("h3",{id:"122\u521b\u5efa\u8d44\u6e90\u5e76\u8fdb\u884c\u6d4b\u8bd5"},"12.2.\u521b\u5efa\u8d44\u6e90\u5e76\u8fdb\u884c\u6d4b\u8bd5"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"[root@binary-k8s-master1 ~]\\# kubectl apply -f know-system.yaml \ndeployment.apps/deploy-know-system created\nservice/know-system-service created\n\n[root@binary-k8s-master1 ~]\\# kubectl get pod,svc\nNAME                                     READY   STATUS    RESTARTS   AGE\npod/deploy-know-system-b4c9c55d7-5mf2f   1/1     Running   0          47s\npod/deploy-know-system-b4c9c55d7-97ckx   1/1     Running   0          48s\npod/deploy-know-system-b4c9c55d7-kb97t   1/1     Running   0          47s\n\nNAME                          TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)        AGE\nservice/know-system-service   NodePort    10.0.0.38    <none>        80:32702/TCP   47s\nservice/kubernetes            ClusterIP   10.0.0.1     <none>        443/TCP        10d\n")),(0,a.kt)("p",null,"\u8bbf\u95eehttps://\u96c6\u7fa4\u4efb\u610f\u8282\u70b9+32702\u7aef\u53e3\u5373\u53ef\u6d4f\u89c8web\u670d\u52a1\u3002"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/8c7dc7f2aad14d74a07b8ab6c35e09a9.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,a.kt)("h2",{id:"13\u90e8\u7f72kubernetes-dashboard"},"13.\u90e8\u7f72kubernetes dashboard"),(0,a.kt)("h3",{id:"131\u90e8\u7f72dashboard"},"13.1.\u90e8\u7f72dashboard"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"1.\u90e8\u7f72yaml\n[root@binary-k8s-master1 ~]\\# kubectl apply -f kubernetes-dashboard.yaml \nnamespace/kubernetes-dashboard created\nserviceaccount/kubernetes-dashboard created\nservice/kubernetes-dashboard created\nsecret/kubernetes-dashboard-certs created\nsecret/kubernetes-dashboard-csrf created\nsecret/kubernetes-dashboard-key-holder created\nconfigmap/kubernetes-dashboard-settings created\nrole.rbac.authorization.k8s.io/kubernetes-dashboard created\nclusterrole.rbac.authorization.k8s.io/kubernetes-dashboard created\nrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created\nclusterrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created\ndeployment.apps/kubernetes-dashboard created\nservice/dashboard-metrics-scraper created\ndeployment.apps/dashboard-metrics-scraper created\n\n2.\u521b\u5efa\u6388\u6743\u8d26\u53f7\n[root@binary-k8s-master1 ~]\\# kubectl create serviceaccount dashboard-admin -n kube-system\nserviceaccount/dashboard-admin created\n[root@binary-k8s-master1 ~]\\# kubectl create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin\nclusterrolebinding.rbac.authorization.k8s.io/dashboard-admin created\n\n3.\u67e5\u770b\u767b\u9646\u4f7f\u7528\u7684token\u5b57\u7b26\u4e32\n[root@binary-k8s-master1 ~]\\# kubectl describe secrets -n kube-system $(kubectl -n kube-system get secret | awk '/dashboard-admin/{print $1}')\nName:         dashboard-admin-token-lnm2r\nNamespace:    kube-system\nLabels:       <none>\nAnnotations:  kubernetes.io/service-account.name: dashboard-admin\n              kubernetes.io/service-account.uid: 73b370c9-b1b4-4418-b02d-fee9b6cf6342\n\nType:  kubernetes.io/service-account-token\n\nData\n====\ntoken:      eyJhbGciOiJSUzI1NiIsImtpZCI6IkgwWGJXQ1duVVI4eFh4Ykw2U25JVk9fa2hDOGZVRTRRMVZyVmdwWXM1Nk0ifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkYXNoYm9hcmQtYWRtaW4tdG9rZW4tbG5tMnIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGFzaGJvYXJkLWFkbWluIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiNzNiMzcwYzktYjFiNC00NDE4LWIwMmQtZmVlOWI2Y2Y2MzQyIiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmUtc3lzdGVtOmRhc2hib2FyZC1hZG1pbiJ9.XWJLZDB7mNk_NNpXVv64LrbKy5f1hB2PS5qER5YFATzl3U9ISX05PCrnCEY-6uVSbPkRGZbTQZTBwiGjOfsyLZljvY3cbmGlH2oW2shUS8LDqli4MKA14JyUX1ubbQ8vq9uSqkQMCQBzZTUGIuZt95jw3-IMv2rfZ9ET8_uVuXIoZXbckY6VHFy8QOB6sy1n9j0j4qcOttyKHVXN8Q5KjsIlb44Y5HtiveKxpw_LA81eTwml_aiVvO9rgMKVdSHIg8CY1Mcp06ezz0kD0jsBLt7xaAujSNZnCiXzmpg51xujbR0k-4BVlwPBBpQLaSWGoHR3X7z5E02onXttbbX6-w\nca.crt:     1359 bytes\nnamespace:  11 bytes\n\n4.\u67e5\u770bpod\u7684\u72b6\u6001\n[root@binary-k8s-master1 ~]\\# kubectl get pod,svc -n kubernetes-dashboard\nNAME                                             READY   STATUS    RESTARTS   AGE\npod/dashboard-metrics-scraper-7445d59dfd-bg9c8   1/1     Running   0          8m51s\npod/kubernetes-dashboard-5ddcdf9c99-nkgqw        1/1     Running   0          8m52s\n\nNAME                                TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)         AGE\nservice/dashboard-metrics-scraper   ClusterIP   10.0.0.83    <none>        8000/TCP        8m52s\nservice/kubernetes-dashboard        NodePort    10.0.0.153   <none>        443:30001/TCP   8m53s\n")),(0,a.kt)("h3",{id:"132\u8bbf\u95eedashboard"},"13.2.\u8bbf\u95eedashboard"),(0,a.kt)("p",null,"\u8bbf\u95eehttps://\u96c6\u7fa4\u4efb\u610f\u8282\u70b9+30001\u7aef\u53e3\uff0c\u7136\u540e\u586b\u5199\u521a\u521a\u67e5\u5230\u7684token\u503c\uff0c\u70b9\u51fb\u767b\u9646\u3002"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/2c6c6346e8854ffcb85a23d3569c056e.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,a.kt)("p",null,"\u4eea\u8868\u76d8"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://cdn.agou-ops.cn/others/f2dfdb9364bb4b0e875851131d711e34.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"\u26a0\ufe0f\u8f6c\u8f7d\u81ea\uff1a",(0,a.kt)("a",{parentName:"p",href:"https://jiangxl.blog.csdn.net/article/details/120428703"},"https://jiangxl.blog.csdn.net/article/details/120428703")),(0,a.kt)("p",{parentName:"blockquote"},"\u4ec5\u7565\u4f5c\u4fee\u6539\u3002")))}u.isMDXComponent=!0}}]);